<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>kiwi.system.setup API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../system.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;kiwi.system</a>

            <img src="https://osinside.github.io/kiwi/_static/kiwi-logo.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#log">log</a>
            </li>
            <li>
                    <a class="class" href="#SystemSetup">SystemSetup</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SystemSetup.__init__">SystemSetup</a>
                        </li>
                        <li>
                                <a class="variable" href="#SystemSetup.runtime_config">runtime_config</a>
                        </li>
                        <li>
                                <a class="variable" href="#SystemSetup.arch">arch</a>
                        </li>
                        <li>
                                <a class="variable" href="#SystemSetup.xml_state">xml_state</a>
                        </li>
                        <li>
                                <a class="variable" href="#SystemSetup.description_dir">description_dir</a>
                        </li>
                        <li>
                                <a class="variable" href="#SystemSetup.derived_description_dir">derived_description_dir</a>
                        </li>
                        <li>
                                <a class="variable" href="#SystemSetup.root_dir">root_dir</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.setup_registry_import">setup_registry_import</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.import_description">import_description</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.script_exists">script_exists</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.cleanup">cleanup</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.import_repositories_marked_as_imageinclude">import_repositories_marked_as_imageinclude</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.import_cdroot_files">import_cdroot_files</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.import_files">import_files</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.import_overlay_files">import_overlay_files</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.setup_machine_id">setup_machine_id</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.setup_permissions">setup_permissions</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.setup_keyboard_map">setup_keyboard_map</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.setup_locale">setup_locale</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.setup_timezone">setup_timezone</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.setup_groups">setup_groups</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.setup_users">setup_users</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.setup_plymouth_splash">setup_plymouth_splash</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.import_image_identifier">import_image_identifier</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.set_selinux_file_contexts">set_selinux_file_contexts</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.setup_selinux_file_contexts">setup_selinux_file_contexts</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.export_modprobe_setup">export_modprobe_setup</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.export_flake_pilot_system_file_list">export_flake_pilot_system_file_list</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.export_package_list">export_package_list</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.export_package_changes">export_package_changes</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.export_package_verification">export_package_verification</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.call_disk_script">call_disk_script</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.call_pre_disk_script">call_pre_disk_script</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.call_post_bootstrap_script">call_post_bootstrap_script</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.call_config_script">call_config_script</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.call_config_overlay_script">call_config_overlay_script</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.call_config_host_overlay_script">call_config_host_overlay_script</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.call_image_script">call_image_script</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.call_edit_boot_config_script">call_edit_boot_config_script</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.call_edit_boot_install_script">call_edit_boot_install_script</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.create_system_files">create_system_files</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.create_fstab">create_fstab</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.create_init_link_from_linuxrc">create_init_link_from_linuxrc</a>
                        </li>
                        <li>
                                <a class="function" href="#SystemSetup.create_recovery_archive">create_recovery_archive</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../kiwi.html">kiwi</a><wbr>.<a href="./../system.html">system</a><wbr>.setup    </h1>

                
                        <input id="mod-setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-setup-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="c1"># Copyright (c) 2015 SUSE Linux GmbH.  All rights reserved.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="c1">#</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="c1"># This file is part of kiwi.</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="c1">#</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="c1"># kiwi is free software: you can redistribute it and/or modify</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="c1"># it under the terms of the GNU General Public License as published by</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="c1"># (at your option) any later version.</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="c1">#</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="c1"># kiwi is distributed in the hope that it will be useful,</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="c1"># GNU General Public License for more details.</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="c1">#</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="c1"># You should have received a copy of the GNU General Public License</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="c1"># along with kiwi.  If not, see &lt;http://www.gnu.org/licenses/&gt;</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="c1">#</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExitStack</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">namedtuple</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">textwrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>    <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="p">)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="c1"># project</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">kiwi.defaults</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">defaults</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.xml_parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">repository</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.utils.fstab</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fstab</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.xml_state</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>    <span class="n">XMLState</span><span class="p">,</span> <span class="n">FileT</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="p">)</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.runtime_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">RuntimeConfig</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.mount_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">MountManager</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.system.uri</span><span class="w"> </span><span class="kn">import</span> <span class="n">Uri</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">Repository</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.system.root_bind</span><span class="w"> </span><span class="kn">import</span> <span class="n">RootBind</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.system.root_init</span><span class="w"> </span><span class="kn">import</span> <span class="n">RootInit</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.command</span><span class="w"> </span><span class="kn">import</span> <span class="n">Command</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.command_process</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommandProcess</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.utils.sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataSync</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.defaults</span><span class="w"> </span><span class="kn">import</span> <span class="n">Defaults</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.system.users</span><span class="w"> </span><span class="kn">import</span> <span class="n">Users</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.system.shell</span><span class="w"> </span><span class="kn">import</span> <span class="n">Shell</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.archive.tar</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArchiveTar</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.utils.compress</span><span class="w"> </span><span class="kn">import</span> <span class="n">Compress</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.utils.command_capabilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommandCapabilities</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.utils.rpm_database</span><span class="w"> </span><span class="kn">import</span> <span class="n">RpmDataBase</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.builder.template.container_import</span><span class="w"> </span><span class="kn">import</span> <span class="n">BuilderTemplateSystemdUnit</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.system.profile</span><span class="w"> </span><span class="kn">import</span> <span class="n">Profile</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>    <span class="n">KiwiCommandError</span><span class="p">,</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>    <span class="n">KiwiImportDescriptionError</span><span class="p">,</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>    <span class="n">KiwiScriptFailed</span><span class="p">,</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>    <span class="n">KiwiFileNotFound</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="p">)</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="n">log</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;kiwi&#39;</span><span class="p">)</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SystemSetup</span><span class="p">:</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">    **Implementation of system setup steps supported by kiwi**</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">    Kiwi is not responsible for the system configuration, however</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">    some setup steps needs to be performed in order to provide</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">    a minimal work environment inside of the image according to</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">    the desired image type.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">    :param object xml_state: instance of :class:`XMLState`</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">    :param str root_dir: root directory path name</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_state</span><span class="p">:</span> <span class="n">XMLState</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_config</span> <span class="o">=</span> <span class="n">RuntimeConfig</span><span class="p">()</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_platform_name</span><span class="p">()</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span> <span class="o">=</span> <span class="n">xml_state</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">=</span> \
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>            <span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">description_dir</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">derived_description_dir</span> <span class="o">=</span> \
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>            <span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">derived_description_dir</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">root_dir</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_preferences_lookup</span><span class="p">()</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_oemconfig_lookup</span><span class="p">()</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_registry_import</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">        Fetch container(s) and activate systemd unit to load</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">        containers from local oci-archive file during boot</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="n">container_files_to_load</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="n">container_execs_to_load</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="n">after_services</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_containers</span><span class="p">():</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fetching container: </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>            <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">defaults</span><span class="o">.</span><span class="n">LOCAL_CONTAINERS</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>                <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>            <span class="p">)</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>            <span class="n">container</span><span class="o">.</span><span class="n">fetch_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">load_command</span><span class="p">:</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>                <span class="n">container_files_to_load</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">container_file</span><span class="p">)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>                <span class="n">container_execs_to_load</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">load_command</span><span class="p">)</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>                <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;docker&#39;</span><span class="p">:</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>                    <span class="n">after_services</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;docker.service&#39;</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>                <span class="k">elif</span> <span class="n">container</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;container-snap&#39;</span><span class="p">:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>                    <span class="n">after_services</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;container-snap.service&#39;</span><span class="p">)</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>        <span class="k">if</span> <span class="n">container_files_to_load</span><span class="p">:</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Setup kiwi_containers.service import unit&#39;</span><span class="p">)</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>            <span class="n">service</span> <span class="o">=</span> <span class="n">BuilderTemplateSystemdUnit</span><span class="p">()</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>            <span class="n">unit_template</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_container_import_template</span><span class="p">(</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>                <span class="n">container_files_to_load</span><span class="p">,</span> <span class="n">container_execs_to_load</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>                <span class="nb">list</span><span class="p">(</span><span class="n">after_services</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>            <span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>            <span class="n">unit</span> <span class="o">=</span> <span class="n">unit_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>            <span class="n">unit_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/etc/systemd/system/</span><span class="si">{1}</span><span class="s1">.service&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;kiwi_containers&#39;</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>            <span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">unit_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">systemd</span><span class="p">:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>                <span class="n">systemd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>                <span class="p">[</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>                    <span class="s1">&#39;systemctl&#39;</span><span class="p">,</span> <span class="s1">&#39;enable&#39;</span><span class="p">,</span> <span class="s1">&#39;kiwi_containers&#39;</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>                <span class="p">]</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>            <span class="p">)</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">        Import XML descriptions, custom scripts, archives and</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">        script helper methods</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Importing Image description to system tree&#39;</span><span class="p">)</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>        <span class="n">description</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span><span class="p">,</span> <span class="s1">&#39;config.xml&#39;</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>        <span class="p">)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>            <span class="s1">&#39;--&gt; Importing state XML description to </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>        <span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span><span class="p">)</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>        <span class="p">)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#39;</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">outfile</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_custom_scripts</span><span class="p">()</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_custom_archives</span><span class="p">()</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_custom_files</span><span class="p">()</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_cdroot_archive</span><span class="p">()</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">script_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">        Check if provided script base name exists in the image description</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a><span class="sd">        :param str name: script base name</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">        Delete all traces of a kiwi description which are not</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        required in the later image</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>            <span class="p">[</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>                <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>                <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>                <span class="s1">&#39;.kconfig&#39;</span><span class="p">,</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>                <span class="s1">&#39;.profile&#39;</span><span class="p">,</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>                <span class="s1">&#39;config.bootoptions&#39;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>            <span class="p">]</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>        <span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        <span class="n">meta_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">):</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="n">image_meta</span> <span class="o">=</span> <span class="n">MountManager</span><span class="p">(</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>                <span class="n">device</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">mountpoint</span><span class="o">=</span><span class="n">meta_dir</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>            <span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>            <span class="n">image_meta</span><span class="o">.</span><span class="n">umount</span><span class="p">()</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_repositories_marked_as_imageinclude</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">        Those &lt;repository&gt; sections which are marked with the</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">        imageinclude attribute should be permanently added to</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">        the image repository configuration</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>        <span class="n">repository_sections</span> <span class="o">=</span> \
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_repository_sections_used_in_image</span><span class="p">()</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>        <span class="n">root</span> <span class="o">=</span> <span class="n">RootInit</span><span class="p">(</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>            <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">allow_existing</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="p">)</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>        <span class="k">with</span> <span class="n">Repository</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>            <span class="n">RootBind</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="p">)</span> <span class="k">as</span> <span class="n">repo</span><span class="p">:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>            <span class="n">repo</span><span class="o">.</span><span class="n">use_default_location</span><span class="p">()</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>            <span class="k">for</span> <span class="n">xml_repo</span> <span class="ow">in</span> <span class="n">repository_sections</span><span class="p">:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>                <span class="n">repo_type</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>                <span class="n">repo_source</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_source</span><span class="p">()</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>                <span class="n">repo_architectures</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_architectures</span><span class="p">()</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>                <span class="n">repo_user</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_username</span><span class="p">()</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>                <span class="n">repo_secret</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_password</span><span class="p">()</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>                <span class="n">repo_alias</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_alias</span><span class="p">()</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>                <span class="n">repo_priority</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_priority</span><span class="p">()</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>                <span class="n">repo_dist</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">()</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>                <span class="n">repo_components</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_components</span><span class="p">()</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>                <span class="n">repo_repository_gpgcheck</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_repository_gpgcheck</span><span class="p">()</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>                <span class="n">repo_package_gpgcheck</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_package_gpgcheck</span><span class="p">()</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>                <span class="n">repo_customization_script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_repo_customization_script</span><span class="p">(</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>                    <span class="n">xml_repo</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>                <span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>                <span class="n">repo_sourcetype</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_sourcetype</span><span class="p">()</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>                <span class="n">uri</span> <span class="o">=</span> <span class="n">Uri</span><span class="p">(</span><span class="n">repo_source</span><span class="p">,</span> <span class="n">repo_type</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>                <span class="n">repo_source_translated</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>                    <span class="n">check_build_environment</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>                <span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_alias</span><span class="p">:</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>                    <span class="n">repo_alias</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>                    <span class="s1">&#39;Setting up image repository </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>                        <span class="n">Uri</span><span class="o">.</span><span class="n">print_sensitive</span><span class="p">(</span><span class="n">repo_source</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>                    <span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>                <span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Type: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">repo_type</span><span class="p">))</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>                    <span class="s1">&#39;--&gt; Translated: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>                        <span class="n">Uri</span><span class="o">.</span><span class="n">print_sensitive</span><span class="p">(</span><span class="n">repo_source_translated</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>                    <span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>                <span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Alias: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">repo_alias</span><span class="p">))</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>                <span class="n">repo</span><span class="o">.</span><span class="n">add_repo</span><span class="p">(</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>                    <span class="n">repo_alias</span><span class="p">,</span> <span class="n">repo_source_translated</span><span class="p">,</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>                    <span class="n">repo_type</span><span class="p">,</span> <span class="n">repo_priority</span><span class="p">,</span> <span class="n">repo_dist</span><span class="p">,</span> <span class="n">repo_components</span><span class="p">,</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>                    <span class="n">repo_user</span><span class="p">,</span> <span class="n">repo_secret</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">credentials_file_name</span><span class="p">(),</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>                    <span class="n">repo_repository_gpgcheck</span><span class="p">,</span> <span class="n">repo_package_gpgcheck</span><span class="p">,</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>                    <span class="n">repo_sourcetype</span><span class="p">,</span> <span class="n">repo_customization_script</span><span class="p">,</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>                    <span class="n">repo_architectures</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>                <span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_cdroot_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a><span class="sd">        Copy cdroot files from the image description to the</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a><span class="sd">        specified target directory. Supported is a tar</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a><span class="sd">        archive named config-cdroot.tar[.compression-postfix]</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a><span class="sd">        :param str target_dir: directory to unpack archive to</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        <span class="n">glob_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">+</span> <span class="s1">&#39;/config-cdroot.tar*&#39;</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>        <span class="k">for</span> <span class="n">cdroot_archive</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">glob_match</span><span class="p">)):</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>                <span class="s1">&#39;Extracting ISO user config archive: </span><span class="si">{0}</span><span class="s1"> to: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>                    <span class="n">cdroot_archive</span><span class="p">,</span> <span class="n">target_dir</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>                <span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>            <span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>            <span class="n">archive</span> <span class="o">=</span> <span class="n">ArchiveTar</span><span class="p">(</span><span class="n">cdroot_archive</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>            <span class="n">archive</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>            <span class="k">break</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>        <span class="n">system_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_system_files</span><span class="p">()</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="n">bootstrap_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_bootstrap_files</span><span class="p">()</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>        <span class="k">if</span> <span class="n">system_files</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_files</span><span class="p">(</span><span class="n">system_files</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>        <span class="k">if</span> <span class="n">bootstrap_files</span><span class="p">:</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_files</span><span class="p">(</span><span class="n">bootstrap_files</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_overlay_files</span><span class="p">(</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">follow_links</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">preserve_owner_group</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">        Copy overlay files from the image description to</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">        the image root tree. Supported are a root/ directory</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">        or a root.tar.gz tarball. The root/ directory takes</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">        precedence over the tarball.</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">        In addition the method also supports profile specific</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="sd">        overlay files which are searched in a directory of the</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">        same name as the profile name.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a><span class="sd">        The overall order for including overlay files is as</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="sd">        follows:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">        1. root/ dir or root.tar.gz</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">        2. PROFILE_NAME/ dir(s) in the order of the selected</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">           profiles</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a><span class="sd">        :param bool follow_links: follow symlinks true|false</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="sd">        :param bool preserve_owner_group: preserve permissions true|false</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        <span class="n">overlay_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">+</span> <span class="s1">&#39;/root/&#39;</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>        <span class="n">overlay_archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">+</span> <span class="s1">&#39;/root.tar.gz&#39;</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">overlay_directory</span><span class="p">):</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_overlay_files</span><span class="p">(</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">overlay_directory</span><span class="p">)</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">,</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>                <span class="n">follow_links</span><span class="p">,</span> <span class="n">preserve_owner_group</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>            <span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">overlay_archive</span><span class="p">):</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracting user defined files from archive to image tree&#39;</span><span class="p">)</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>            <span class="n">archive</span> <span class="o">=</span> <span class="n">ArchiveTar</span><span class="p">(</span><span class="n">overlay_archive</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>            <span class="n">archive</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>        <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">profiles</span><span class="p">:</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>            <span class="n">overlay_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">profile</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>            <span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">overlay_directory</span><span class="p">):</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_sync_overlay_files</span><span class="p">(</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>                    <span class="n">overlay_directory</span><span class="p">,</span> <span class="n">follow_links</span><span class="p">,</span> <span class="n">preserve_owner_group</span><span class="p">,</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>                    <span class="n">profile</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>                <span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_machine_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="sd">        Setup systemd machine id</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">        There are various states of /etc/machine-id:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a><span class="sd">        a) Does not exist: Triggers ConditionFirstBoot, but does not work</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a><span class="sd">           if the filesystem is initially read-only (booted without &quot;rw&quot;).</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="sd">        b) Exists, is empty: Does not trigger ConditionFirstBoot, but works</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="sd">           with read-only mounts.</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a><span class="sd">        c) Exists, contains the string &quot;uninitialized&quot;: Same as b), but</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a><span class="sd">           triggers ConditionFirstBoot. Supported by systemd v247+ only.</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a><span class="sd">        d) Exists, contains a valid ID.</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="sd">        See the machine-id(5) man page for details.</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">        In images, d) is not desirable, so truncate the file. This is the</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a><span class="sd">        previous behaviour and what existing images expect. If the image</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">        has one of the other states, keep it as-is.</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="n">machine_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;etc&#39;</span><span class="p">,</span> <span class="s1">&#39;machine-id&#39;</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>        <span class="p">)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">machine_id</span><span class="p">):</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">machine_id</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                <span class="k">if</span> <span class="s1">&#39;uninitialized&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">():</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a><span class="sd">        Check and Fix permissions using chkstat</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a><span class="sd">        Call chkstat in system mode which reads /etc/sysconfig/security</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a><span class="sd">        to determine the configured security level and applies the</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a><span class="sd">        appropriate permission definitions from the /etc/permissions*</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a><span class="sd">        files. It&#39;s possible to provide those files as overlay files</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a><span class="sd">        in the image description to apply a certain permission setup</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a><span class="sd">        when needed. Otherwise the default setup as provided on the</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a><span class="sd">        package level applies.</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="sd">        It&#39;s required that the image root system has chkstat installed.</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">        If not present KIWI skips this step and continuous with a</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a><span class="sd">        warning.</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>        <span class="n">chkstat</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">which</span><span class="p">(</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>            <span class="s1">&#39;chkstat&#39;</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">access_mode</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">X_OK</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>        <span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>        <span class="k">if</span> <span class="n">chkstat</span><span class="p">:</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Check/Fix File Permissions&#39;</span><span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                <span class="p">[</span><span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;chkstat&#39;</span><span class="p">,</span> <span class="s1">&#39;--system&#39;</span><span class="p">,</span> <span class="s1">&#39;--set&#39;</span><span class="p">]</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>            <span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>                <span class="s1">&#39;chkstat not found in image. File Permissions Check skipped&#39;</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>            <span class="p">)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_keyboard_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="sd">        Setup console keyboard</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>        <span class="k">if</span> <span class="s1">&#39;keytable&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>                <span class="s1">&#39;Setting up keytable: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">])</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>            <span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>            <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span> <span class="s1">&#39;--keymap&#39;</span><span class="p">,</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>                <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>            <span class="p">):</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/vconsole.conf&#39;</span><span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>                    <span class="s1">&#39;--keymap=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">],</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>                <span class="p">],</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>                <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>                    <span class="n">message</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\n</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="s1">                        keyboard setup skipped because `systemd-firstboot --keymap` failed (code </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s1">):</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="s1">                        </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">error</span><span class="si">}</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="s1">                        This can happen for example if the specified keytable (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1">) is not available,</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="s1">                        or if your system does not support the systemd way of managing keymaps.</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="s1">                        Note that in both cases, systemd-firstboot&#39;s error message complains that the keymap is not installed.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="s1">                        If the keytable is missing, you might be able to install it for example via an additional package.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="s1">                        If your system doesn&#39;t support systemd&#39;s keymap management,</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="s1">                        then you can use a distribution-specific method to set the keymap in a config.sh script.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="s1">                        You can try `localectl list-keymaps` to see if a particular distro supports systemd keymap management.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="s1">                    &#39;&#39;&#39;</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>                    <span class="k">raise</span> <span class="n">KiwiCommandError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/sysconfig/keyboard&#39;</span><span class="p">):</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>                <span class="n">Shell</span><span class="o">.</span><span class="n">run_common_function</span><span class="p">(</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>                    <span class="s1">&#39;baseUpdateSysConfig&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/sysconfig/keyboard&#39;</span><span class="p">,</span> <span class="s1">&#39;KEYTABLE&#39;</span><span class="p">,</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>                        <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>                    <span class="p">]</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>                <span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>                    <span class="s1">&#39;keyboard setup skipped no capable &#39;</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>                    <span class="s1">&#39;systemd-firstboot or etc/sysconfig/keyboard found&#39;</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>                <span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">        Setup UTF8 system wide locale</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="k">if</span> <span class="s1">&#39;locale&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>            <span class="k">if</span> <span class="s1">&#39;POSIX&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>                <span class="n">locale</span> <span class="o">=</span> <span class="s1">&#39;POSIX&#39;</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>                <span class="n">locale</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.UTF-8&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>                <span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>                <span class="s1">&#39;Setting up locale: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">])</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>            <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>                <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span> <span class="s1">&#39;--locale&#39;</span><span class="p">,</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>                <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>            <span class="p">):</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/locale.conf&#39;</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>                    <span class="s1">&#39;--locale=&#39;</span> <span class="o">+</span> <span class="n">locale</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>                <span class="p">])</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_timezone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="sd">        Setup timezone symlink</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>        <span class="k">if</span> <span class="s1">&#39;timezone&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">:</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>                <span class="s1">&#39;Setting up timezone: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">])</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>            <span class="p">)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>            <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>                <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span> <span class="s1">&#39;--timezone&#39;</span><span class="p">,</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>                <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>            <span class="p">):</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/localtime&#39;</span><span class="p">)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>                    <span class="s1">&#39;--timezone=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">]</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>                <span class="p">])</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>                <span class="n">zoneinfo</span> <span class="o">=</span> <span class="s1">&#39;/usr/share/zoneinfo/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">]</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>                    <span class="s1">&#39;ln&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">zoneinfo</span><span class="p">,</span> <span class="s1">&#39;/etc/localtime&#39;</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>                <span class="p">])</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">        Add groups for configured users</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="n">system_users</span> <span class="o">=</span> <span class="n">Users</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_users</span><span class="p">():</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>            <span class="n">group_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_names_and_ids_for_user</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>            <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="n">group_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">system_users</span><span class="o">.</span><span class="n">group_exists</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding group </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>                    <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_user_options</span><span class="p">(</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>                        <span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>                    <span class="p">)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>                    <span class="n">system_users</span><span class="o">.</span><span class="n">group_add</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">        Add/Modify configured users</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>        <span class="n">system_users</span> <span class="o">=</span> <span class="n">Users</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_users</span><span class="p">():</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting up user </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>            <span class="n">password</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_password</span><span class="p">()</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>            <span class="n">password_format</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_pwdformat</span><span class="p">()</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>            <span class="n">home_path</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_home</span><span class="p">()</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>            <span class="n">user_name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>            <span class="n">user_realname</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_realname</span><span class="p">()</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>            <span class="n">user_shell</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_shell</span><span class="p">()</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>            <span class="n">user_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_names_and_ids_for_user</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>            <span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>            <span class="n">user_exists</span> <span class="o">=</span> <span class="n">system_users</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_name</span><span class="p">)</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>            <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_user_options</span><span class="p">(</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>                <span class="n">password_format</span><span class="o">=</span><span class="n">password_format</span><span class="p">,</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>                <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>                <span class="n">user_shell</span><span class="o">=</span><span class="n">user_shell</span><span class="p">,</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>                <span class="n">user_groups</span><span class="o">=</span><span class="n">user_groups</span><span class="p">,</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>                <span class="n">user_realname</span><span class="o">=</span><span class="n">user_realname</span><span class="p">,</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>                <span class="n">user_exists</span><span class="o">=</span><span class="n">user_exists</span><span class="p">,</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>                <span class="n">home_path</span><span class="o">=</span><span class="n">home_path</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>            <span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>            <span class="n">group_msg</span> <span class="o">=</span> <span class="s1">&#39;--&gt; Primary group for user </span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>                <span class="n">user_name</span><span class="p">,</span> <span class="n">user_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>            <span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_groups</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>            <span class="k">if</span> <span class="n">user_exists</span><span class="p">:</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Modifying user: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_name</span><span class="p">))</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>                <span class="k">if</span> <span class="n">group_msg</span><span class="p">:</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">group_msg</span><span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>                <span class="n">system_users</span><span class="o">.</span><span class="n">user_modify</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Adding user: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_name</span><span class="p">))</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>                <span class="k">if</span> <span class="n">group_msg</span><span class="p">:</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">group_msg</span><span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>                <span class="n">system_users</span><span class="o">.</span><span class="n">user_add</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>                <span class="k">if</span> <span class="n">home_path</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>                        <span class="s1">&#39;--&gt; Setting permissions for </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">home_path</span><span class="p">)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                    <span class="p">)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>                    <span class="c1"># Emtpy group string assumes the login or default group</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>                    <span class="n">system_users</span><span class="o">.</span><span class="n">setup_home_for_user</span><span class="p">(</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>                        <span class="n">user_name</span><span class="p">,</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>                        <span class="n">user_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_groups</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>                        <span class="n">home_path</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>                    <span class="p">)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_plymouth_splash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="sd">        Setup the KIWI configured splash theme as default</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a><span class="sd">        The method uses the plymouth-set-default-theme tool to setup the</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="sd">        theme for the plymouth splash system. Only in case the tool could</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a><span class="sd">        be found in the image root, it is assumed plymouth splash is in</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a><span class="sd">        use and the tool is called in a chroot operation</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>        <span class="n">theme_setup</span> <span class="o">=</span> <span class="s1">&#39;plymouth-set-default-theme&#39;</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>        <span class="k">if</span> <span class="n">Path</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">theme_setup</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">):</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            <span class="k">for</span> <span class="n">preferences</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_preferences_sections</span><span class="p">():</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                <span class="n">splash_section_content</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">get_bootsplash_theme</span><span class="p">()</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>                <span class="k">if</span> <span class="n">splash_section_content</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                    <span class="n">splash_theme</span> <span class="o">=</span> <span class="n">splash_section_content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                    <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                        <span class="p">[</span><span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">theme_setup</span><span class="p">,</span> <span class="n">splash_theme</span><span class="p">]</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                    <span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_image_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a><span class="sd">        Create etc/ImageID identifier file</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>        <span class="n">image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>        <span class="k">if</span> <span class="n">image_id</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc&#39;</span><span class="p">):</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>            <span class="n">image_id_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/ImageID&#39;</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>                <span class="s1">&#39;Creating image identifier: </span><span class="si">{0}</span><span class="s1"> in </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>                    <span class="n">image_id</span><span class="p">,</span> <span class="n">image_id_file</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>                <span class="p">)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>            <span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_id_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">identifier</span><span class="p">:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>                <span class="n">identifier</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">))</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_selinux_file_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">security_context_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">        Initialize the security context fields (extended attributes)</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="sd">        on the files matching the security_context_file</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">        :param str security_context_file: path file name</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing SELinux file security contexts&#39;</span><span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;System is read-only, security context unchanged&#39;</span><span class="p">)</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>            <span class="k">return</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>        <span class="k">for</span> <span class="n">devname</span> <span class="ow">in</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_exclude_list_for_non_physical_devices</span><span class="p">():</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>            <span class="n">exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-e&#39;</span><span class="p">)</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>            <span class="n">exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">devname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>        <span class="c1"># setfiles doesn&#39;t come with a stable command API and older versions</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="c1"># needs a different invocation syntax. On older versions the usage</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>        <span class="c1"># information explicitly lists &quot;setfiles -c policyfile&quot; which is not</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>        <span class="c1"># present in newer versions. As setfiles doesn&#39;t come with a simple</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>        <span class="c1"># --version option, checking for this extra element in the usage</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="c1"># was the only pointer I could come up with to differentiate the</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>        <span class="c1"># call options.</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>        <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>            <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span> <span class="s1">&#39;setfiles -c policyfile&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;--help&#39;</span><span class="p">],</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>            <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="p">):</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>                <span class="p">[</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>                    <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_selinux_policy_file</span><span class="p">(</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_selinux_policy</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;targeted&#39;</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>                    <span class="p">),</span> <span class="n">security_context_file</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>                <span class="p">]</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>            <span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>                <span class="p">[</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>                    <span class="s1">&#39;-F&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>                <span class="p">]</span> <span class="o">+</span> <span class="n">exclude</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>                    <span class="n">security_context_file</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>                <span class="p">]</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>            <span class="p">)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>                <span class="p">[</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                    <span class="s1">&#39;-T0&#39;</span><span class="p">,</span> <span class="s1">&#39;-F&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_selinux_policy_file</span><span class="p">(</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_selinux_policy</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;targeted&#39;</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>                    <span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>                <span class="p">]</span> <span class="o">+</span> <span class="n">exclude</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>                    <span class="n">security_context_file</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>                <span class="p">]</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="p">)</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_selinux_file_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a><span class="sd">        Set SELinux file security contexts if the default context file is found</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>        <span class="n">security_context</span> <span class="o">=</span> <span class="s1">&#39;/etc/selinux/targeted/contexts/files/file_contexts&#39;</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="n">security_context</span><span class="p">):</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>            <span class="k">if</span> <span class="n">Path</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;setfiles&#39;</span><span class="p">,</span> <span class="n">access_mode</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">):</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">set_selinux_file_contexts</span><span class="p">(</span><span class="n">security_context</span><span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>                    <span class="s1">&#39;security_context found but setfiles tool not installed&#39;</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                <span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_modprobe_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a><span class="sd">        Export etc/modprobe.d to given root_dir</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="sd">        :param str target_root_dir: path name</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="n">modprobe_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/modprobe.d&#39;</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">modprobe_config</span><span class="p">):</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export modprobe configuration&#39;</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">target_root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc&#39;</span><span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataSync</span><span class="p">(</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>                <span class="n">modprobe_config</span><span class="p">,</span> <span class="n">target_root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/&#39;</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>            <span class="p">)</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">sync_data</span><span class="p">(</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>                <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-a&#39;</span><span class="p">]</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>            <span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_flake_pilot_system_file_list</span><span class="p">(</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">        Export image package file list to the target_dir</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a><span class="sd">        and filename</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a><span class="sd">        :param str file_name: file name</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>        <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>        <span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>        <span class="n">result_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>        <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_flake_pilot_system_file_list</span><span class="p">(</span><span class="n">result_file</span><span class="p">)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>            <span class="k">return</span> <span class="n">result_file</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_package_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">        Export image package list as metadata reference</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">        used by the open buildservice</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>        <span class="n">image_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_image_version</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;unspecified&#39;</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>            <span class="p">[</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>                <span class="n">target_dir</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>                <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>                <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">image_version</span><span class="p">,</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>                <span class="s1">&#39;.packages&#39;</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>            <span class="p">]</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>        <span class="p">)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>        <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>        <span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>        <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_package_list</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;dpkg&#39;</span><span class="p">:</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_deb_package_list</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>        <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;pacman&#39;</span><span class="p">:</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_pacman_package_list</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_package_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a><span class="sd">        Export image package changelog for comparision of</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a><span class="sd">        actual changes of the installed packages</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>        <span class="n">image_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_image_version</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;unspecified&#39;</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_config</span><span class="o">.</span><span class="n">get_package_changes</span><span class="p">():</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>                <span class="p">[</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>                    <span class="n">target_dir</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>                    <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                    <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">image_version</span><span class="p">,</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>                    <span class="s1">&#39;.changes&#39;</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>                <span class="p">]</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>            <span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>            <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>            <span class="p">)</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>            <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_package_changes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>                <span class="k">return</span> <span class="n">filename</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>            <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;dpkg&#39;</span><span class="p">:</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_export_deb_package_changes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>                <span class="k">return</span> <span class="n">filename</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_package_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">        Export package verification result as metadata reference</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="sd">        used by the open buildservice</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>        <span class="n">image_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_image_version</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;unspecified&#39;</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>            <span class="p">[</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>                <span class="n">target_dir</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>                <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>                <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">image_version</span><span class="p">,</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>                <span class="s1">&#39;.verified&#39;</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>            <span class="p">]</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>        <span class="p">)</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>        <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>        <span class="p">)</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>        <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_package_verification</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;dpkg&#39;</span><span class="p">:</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_deb_package_verification</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_disk_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a><span class="sd">        Call disk.sh script chrooted</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_DISK_SYNC_SCRIPT</span><span class="p">,</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="n">root_is_mountpoint</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>        <span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_pre_disk_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a><span class="sd">        Call pre_disk_sync.sh script chrooted</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">PRE_DISK_SYNC_SCRIPT</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>        <span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_post_bootstrap_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a><span class="sd">        Call post_bootstrap.sh script chrooted</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_BOOTSTRAP_SCRIPT</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>        <span class="p">)</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_config_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a><span class="sd">        Call config.sh script chrooted</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_SCRIPT</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>        <span class="p">)</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_config_overlay_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a><span class="sd">        Call config-overlay.sh script chrooted</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_OVERLAY_SCRIPT</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="p">)</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_config_host_overlay_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="sd">        Call config-host-overlay.sh script _NON_ chrooted</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script_no_chroot</span><span class="p">(</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>            <span class="n">name</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_HOST_PREPARE_OVERLAY_SCRIPT</span><span class="p">,</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>            <span class="n">option_list</span><span class="o">=</span><span class="p">[],</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>        <span class="p">)</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_image_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="sd">        Call images.sh script chrooted</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">PRE_CREATE_SCRIPT</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="p">)</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_edit_boot_config_script</span><span class="p">(</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">filesystem</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">boot_part_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a><span class="sd">        Call configured editbootconfig script _NON_ chrooted</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a><span class="sd">        Pass the boot filesystem name and the partition number of</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a><span class="sd">        the boot partition as parameters to the call</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a><span class="sd">        :param str filesystem: boot filesystem name</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a><span class="sd">        :param int boot_part_id: boot partition number</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="sd">        :param str working_directory: directory name</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script_no_chroot</span><span class="p">(</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>            <span class="n">name</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">EDIT_BOOT_CONFIG_SCRIPT</span><span class="p">,</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>            <span class="n">option_list</span><span class="o">=</span><span class="p">[</span><span class="n">filesystem</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">boot_part_id</span><span class="p">)],</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>        <span class="p">)</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_edit_boot_install_script</span><span class="p">(</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">diskname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">boot_device_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>        <span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="sd">        Call configured editbootinstall script _NON_ chrooted</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">        Pass the disk file name and the device node of the boot partition</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="sd">        as parameters to the call</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a><span class="sd">        :param str diskname: file path name</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a><span class="sd">        :param str boot_device_node: boot device node name</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="sd">        :param str working_directory: directory name</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script_no_chroot</span><span class="p">(</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="n">name</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">EDIT_BOOT_INSTALL_SCRIPT</span><span class="p">,</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            <span class="n">option_list</span><span class="o">=</span><span class="p">[</span><span class="n">diskname</span><span class="p">,</span> <span class="n">boot_device_node</span><span class="p">],</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>        <span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_system_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">        Create file list of packages to be used by flake-pilot</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_provide_system_files</span><span class="p">():</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">export_flake_pilot_system_file_list</span><span class="p">(</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_system_files_name</span><span class="p">()</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>            <span class="p">)</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_fstab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fstab</span><span class="p">:</span> <span class="n">Fstab</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">        Create etc/fstab from given Fstab object</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">        Custom fstab modifications are possible and handled</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">        in the following order:</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">        1. Look for an optional fstab.append file which allows</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a><span class="sd">           to append custom fstab entries to the final fstab. Once</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a><span class="sd">           embedded the fstab.append file will be deleted</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a><span class="sd">        2. Look for an optional fstab.patch file which allows</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a><span class="sd">           to patch the current contents of the fstab file with</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="sd">           a given patch file. Once patched the fstab.patch file will</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">           be deleted</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a><span class="sd">        3. Look for an optional fstab.script file which is called</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a><span class="sd">           chrooted for the purpose of updating the fstab file as</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a><span class="sd">           appropriate. Note: There is no validation in place that</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a><span class="sd">           checks if the script actually handles fstab or any other</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="sd">           file in the image rootfs. Once called the fstab.script</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">           file will be deleted</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="sd">        :param object fstab: instance of Fstab</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>        <span class="n">fstab_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab&#39;</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>        <span class="n">fstab_append_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab.append&#39;</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>        <span class="n">fstab_patch_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab.patch&#39;</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>        <span class="n">fstab_script_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab.script&#39;</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>        <span class="n">fstab</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">)</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fstab_append_file</span><span class="p">):</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fstab_io</span><span class="p">:</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fstab_append_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">append</span><span class="p">:</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>                    <span class="n">fstab_io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">append</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">fstab_append_file</span><span class="p">)</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fstab_patch_file</span><span class="p">):</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>                <span class="p">[</span><span class="s1">&#39;patch&#39;</span><span class="p">,</span> <span class="n">fstab_file</span><span class="p">,</span> <span class="n">fstab_patch_file</span><span class="p">]</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>            <span class="p">)</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">fstab_patch_file</span><span class="p">)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fstab_script_file</span><span class="p">):</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;etc/fstab.script&#39;</span><span class="p">,</span> <span class="n">path_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>            <span class="p">)</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">fstab_script_file</span><span class="p">)</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_init_link_from_linuxrc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a><span class="sd">        kiwi boot images provides the linuxrc script, however the kernel</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a><span class="sd">        also expects an init executable to be present. This method creates</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">        a hard link to the linuxrc file</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>            <span class="p">[</span><span class="s1">&#39;ln&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/linuxrc&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/init&#39;</span><span class="p">]</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_recovery_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">        Create a compressed recovery archive from the root tree</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">        for use with kiwi&#39;s recvoery system. The method creates</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a><span class="sd">        additional data into the image root filesystem which is</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a><span class="sd">        deleted prior to the creation of a new recovery data set</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="c1"># cleanup</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="n">bash_comand</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>            <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.*&#39;</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>        <span class="p">]</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bash_comand</span><span class="p">)])</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span><span class="p">[</span><span class="s1">&#39;recovery&#39;</span><span class="p">]:</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>            <span class="k">return</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>        <span class="c1"># recovery.tar</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating recovery tar archive&#39;</span><span class="p">)</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>            <span class="s1">&#39;archive_name&#39;</span><span class="p">:</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar&#39;</span><span class="p">,</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>            <span class="s1">&#39;archive_filecount&#39;</span><span class="p">:</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar.files&#39;</span><span class="p">,</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>            <span class="s1">&#39;archive_size&#39;</span><span class="p">:</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar.size&#39;</span><span class="p">,</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>            <span class="s1">&#39;partition_size&#39;</span><span class="p">:</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.partition.size&#39;</span><span class="p">,</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>            <span class="s1">&#39;partition_filesystem&#39;</span><span class="p">:</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar.filesystem&#39;</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="p">}</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>        <span class="n">archive</span> <span class="o">=</span> <span class="n">ArchiveTar</span><span class="p">(</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>            <span class="n">filename</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">],</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>            <span class="n">create_from_file_list</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        <span class="p">)</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>        <span class="n">archive</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>            <span class="n">source_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>            <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dev&#39;</span><span class="p">,</span> <span class="s1">&#39;proc&#39;</span><span class="p">,</span> <span class="s1">&#39;sys&#39;</span><span class="p">],</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>            <span class="n">options</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>                <span class="s1">&#39;--numeric-owner&#39;</span><span class="p">,</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>                <span class="s1">&#39;--hard-dereference&#39;</span><span class="p">,</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>                <span class="s1">&#39;--preserve-permissions&#39;</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>            <span class="p">]</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>        <span class="p">)</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>        <span class="c1"># recovery.tar.filesystem</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>        <span class="n">recovery_filesystem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_filesystem</span><span class="p">()</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;partition_filesystem&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">partfs</span><span class="p">:</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>            <span class="n">partfs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_filesystem</span><span class="p">))</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>            <span class="s1">&#39;--&gt; Recovery partition filesystem: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_filesystem</span><span class="p">)</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>        <span class="p">)</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>        <span class="c1"># recovery.tar.files</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>        <span class="n">bash_comand</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>            <span class="s1">&#39;tar&#39;</span><span class="p">,</span> <span class="s1">&#39;-tf&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">],</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;wc&#39;</span><span class="p">,</span> <span class="s1">&#39;-l&#39;</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>        <span class="p">]</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>        <span class="n">tar_files_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="p">[</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bash_comand</span><span class="p">)]</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>        <span class="p">)</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>        <span class="n">tar_files_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tar_files_call</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_filecount&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">files</span><span class="p">:</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>            <span class="n">files</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tar_files_count</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">))</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>            <span class="s1">&#39;--&gt; Recovery file count: </span><span class="si">{0}</span><span class="s1"> files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tar_files_count</span><span class="p">)</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>        <span class="p">)</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>        <span class="c1"># recovery.tar.size</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>        <span class="n">recovery_archive_size_bytes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">])</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_size&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">size</span><span class="p">:</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>            <span class="n">size</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_archive_size_bytes</span><span class="p">))</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>            <span class="s1">&#39;--&gt; Recovery uncompressed size: </span><span class="si">{0}</span><span class="s1"> mbytes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">recovery_archive_size_bytes</span> <span class="o">/</span> <span class="mi">1048576</span><span class="p">)</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>            <span class="p">)</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>        <span class="p">)</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>        <span class="c1"># recovery.tar.gz</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Compressing recovery archive&#39;</span><span class="p">)</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>        <span class="n">compress</span> <span class="o">=</span> <span class="n">Compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar&#39;</span><span class="p">)</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="n">compress</span><span class="o">.</span><span class="n">gzip</span><span class="p">()</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>        <span class="c1"># recovery.partition.size</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="n">recovery_archive_gz_size_mbytes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.gz&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1048576</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>        <span class="p">)</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>        <span class="n">recovery_partition_mbytes</span> <span class="o">=</span> <span class="n">recovery_archive_gz_size_mbytes</span> \
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>            <span class="o">+</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_recovery_spare_mbytes</span><span class="p">()</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;partition_size&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">gzsize</span><span class="p">:</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>            <span class="n">gzsize</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_partition_mbytes</span><span class="p">))</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>            <span class="s1">&#39;--&gt; Recovery partition size: </span><span class="si">{0}</span><span class="s1"> mbytes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>                <span class="n">recovery_partition_mbytes</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>            <span class="p">)</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="p">)</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>        <span class="c1"># delete recovery archive if inplace recovery is requested</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="c1"># In this mode the recovery archive is created at install time</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="c1"># and not at image creation time. However the recovery metadata</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>        <span class="c1"># is preserved in order to be able to check if enough space</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>        <span class="c1"># is available on the disk to create the recovery archive.</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span><span class="p">[</span><span class="s1">&#39;recovery_inplace&#39;</span><span class="p">]:</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>                <span class="s1">&#39;--&gt; Inplace recovery requested, deleting archive&#39;</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>            <span class="p">)</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.gz&#39;</span><span class="p">)</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_user_options</span><span class="p">(</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>        <span class="n">password_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>        <span class="n">user_shell</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>        <span class="n">user_groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>        <span class="n">group_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>        <span class="n">user_realname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        <span class="n">user_exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="n">home_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>    <span class="p">):</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="k">if</span> <span class="n">password_format</span> <span class="o">==</span> <span class="s1">&#39;plain&#39;</span><span class="p">:</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>            <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_passwd_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>        <span class="k">if</span> <span class="n">password</span><span class="p">:</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">)</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>        <span class="k">if</span> <span class="n">user_shell</span><span class="p">:</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">)</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_shell</span><span class="p">)</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_groups</span><span class="p">):</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">)</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-G&#39;</span><span class="p">)</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">)</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="k">if</span> <span class="n">group_id</span><span class="p">:</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">)</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group_id</span><span class="p">))</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="k">if</span> <span class="n">user_realname</span><span class="p">:</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">)</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_realname</span><span class="p">)</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_exists</span><span class="p">:</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">)</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>            <span class="k">if</span> <span class="n">home_path</span><span class="p">:</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">home_path</span><span class="p">)</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        <span class="k">return</span> <span class="n">options</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_import_cdroot_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        <span class="n">glob_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">+</span> <span class="s1">&#39;/config-cdroot.tar*&#39;</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>        <span class="k">for</span> <span class="n">cdroot_archive</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">glob_match</span><span class="p">)):</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>            <span class="n">archive_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>            <span class="p">)</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>                <span class="s1">&#39;--&gt; Importing </span><span class="si">{0}</span><span class="s1"> archive to </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>                    <span class="n">cdroot_archive</span><span class="p">,</span> <span class="n">archive_file</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>                <span class="p">)</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>            <span class="p">)</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>                <span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">cdroot_archive</span><span class="p">,</span> <span class="n">archive_file</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">]</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>            <span class="p">)</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>            <span class="k">break</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_import_custom_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a><span class="sd">        Import custom file files</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>        <span class="n">system_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_system_files</span><span class="p">()</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>        <span class="n">bootstrap_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_bootstrap_files</span><span class="p">()</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>        <span class="k">if</span> <span class="n">system_files</span><span class="p">:</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>            <span class="n">file_list</span> <span class="o">+=</span> <span class="n">system_files</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>        <span class="k">if</span> <span class="n">bootstrap_files</span><span class="p">:</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>            <span class="n">file_list</span> <span class="o">+=</span> <span class="n">bootstrap_files</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>        <span class="n">file_target_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>        <span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>            <span class="n">file_is_absolute</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>            <span class="k">if</span> <span class="n">file_is_absolute</span><span class="p">:</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>                <span class="n">file_file</span> <span class="o">=</span> <span class="n">file</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>                <span class="n">file_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>            <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_file</span><span class="p">)</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">:</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_description_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">file_is_absolute</span><span class="p">:</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>                    <span class="n">file_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_description_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>                    <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_file</span><span class="p">)</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>            <span class="k">if</span> <span class="n">file_exists</span><span class="p">:</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>                    <span class="s1">&#39;--&gt; Importing </span><span class="si">{0}</span><span class="s1"> file to </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>                        <span class="n">file_file</span><span class="p">,</span> <span class="n">file_target_dir</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>                    <span class="p">)</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>                <span class="p">)</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>                    <span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">file_file</span><span class="p">,</span> <span class="n">file_target_dir</span><span class="p">]</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>                <span class="p">)</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>                <span class="k">raise</span> <span class="n">KiwiImportDescriptionError</span><span class="p">(</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>                    <span class="sa">f</span><span class="s1">&#39;Specified file </span><span class="si">{</span><span class="n">file_file</span><span class="si">}</span><span class="s1"> does not exist&#39;</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>                <span class="p">)</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_import_custom_archives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="sd">        Import custom tar archive files</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>        <span class="n">archive_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>        <span class="n">system_archives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_system_archives</span><span class="p">()</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>        <span class="n">bootstrap_archives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_bootstrap_archives</span><span class="p">()</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>        <span class="k">if</span> <span class="n">system_archives</span><span class="p">:</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>            <span class="n">archive_list</span> <span class="o">+=</span> <span class="n">system_archives</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>        <span class="k">if</span> <span class="n">bootstrap_archives</span><span class="p">:</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="n">archive_list</span> <span class="o">+=</span> <span class="n">bootstrap_archives</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>        <span class="n">archive_target_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>        <span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>        <span class="k">for</span> <span class="n">archive</span> <span class="ow">in</span> <span class="n">archive_list</span><span class="p">:</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>            <span class="n">archive_is_absolute</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>            <span class="k">if</span> <span class="n">archive_is_absolute</span><span class="p">:</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>                <span class="n">archive_file</span> <span class="o">=</span> <span class="n">archive</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>                <span class="n">archive_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">archive</span><span class="p">)</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>            <span class="n">archive_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_file</span><span class="p">)</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">archive_exists</span><span class="p">:</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_description_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">archive_is_absolute</span><span class="p">:</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>                    <span class="n">archive_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_description_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">archive</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>                    <span class="n">archive_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_file</span><span class="p">)</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>            <span class="k">if</span> <span class="n">archive_exists</span><span class="p">:</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>                    <span class="s1">&#39;--&gt; Importing </span><span class="si">{0}</span><span class="s1"> archive to </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>                        <span class="n">archive_file</span><span class="p">,</span> <span class="n">archive_target_dir</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>                    <span class="p">)</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>                <span class="p">)</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>                    <span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">archive_file</span><span class="p">,</span> <span class="n">archive_target_dir</span><span class="p">]</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>                <span class="p">)</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>                <span class="k">raise</span> <span class="n">KiwiImportDescriptionError</span><span class="p">(</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>                    <span class="s1">&#39;Specified archive </span><span class="si">{0}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">archive_file</span><span class="p">)</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>                <span class="p">)</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_import_custom_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a><span class="sd">        Import custom scripts</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>        <span class="c1"># custom_scripts defines a dictionary with all script hooks</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>        <span class="c1"># for each script name a the filepath and additional flags</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>        <span class="c1"># are defined. the filepath could be either a relative or</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>        <span class="c1"># absolute information. If filepath is set to None this indicates</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>        <span class="c1"># the script hook is not used. The raise_if_not_exists flag</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>        <span class="c1"># causes kiwi to raise an exception if a specified script</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>        <span class="c1"># filepath does not exist</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="n">script_type</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>            <span class="s1">&#39;script_type&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">,</span> <span class="s1">&#39;raise_if_not_exists&#39;</span><span class="p">]</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>        <span class="p">)</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>        <span class="n">custom_scripts</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_BOOTSTRAP_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_BOOTSTRAP_SCRIPT</span><span class="p">,</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>            <span class="p">),</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_SCRIPT</span><span class="p">,</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>            <span class="p">),</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_OVERLAY_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_OVERLAY_SCRIPT</span><span class="p">,</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>            <span class="p">),</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_HOST_PREPARE_OVERLAY_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_HOST_PREPARE_OVERLAY_SCRIPT</span><span class="p">,</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>            <span class="p">),</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">PRE_CREATE_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">PRE_CREATE_SCRIPT</span><span class="p">,</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>            <span class="p">),</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">PRE_DISK_SYNC_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">PRE_DISK_SYNC_SCRIPT</span><span class="p">,</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>            <span class="p">),</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_DISK_SYNC_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_DISK_SYNC_SCRIPT</span><span class="p">,</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>            <span class="p">),</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">EDIT_BOOT_CONFIG_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_editbootconfig</span><span class="p">(),</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>            <span class="p">),</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">EDIT_BOOT_INSTALL_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_editbootinstall</span><span class="p">(),</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>            <span class="p">)</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>        <span class="p">}</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>        <span class="n">sorted_custom_scripts</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>            <span class="nb">sorted</span><span class="p">(</span><span class="n">custom_scripts</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>        <span class="p">)</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>        <span class="n">script_target_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>        <span class="p">)</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>        <span class="n">need_script_helper_functions</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">script</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sorted_custom_scripts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>            <span class="k">if</span> <span class="n">script</span><span class="o">.</span><span class="n">filepath</span><span class="p">:</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>                <span class="k">if</span> <span class="n">script</span><span class="o">.</span><span class="n">filepath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>                    <span class="n">script_file</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">filepath</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>                    <span class="n">script_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">script</span><span class="o">.</span><span class="n">filepath</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>                    <span class="p">)</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">script_file</span><span class="p">):</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>                    <span class="n">script_target_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>                        <span class="n">script_target_dir</span><span class="p">,</span> <span class="n">name</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>                    <span class="p">)</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>                        <span class="s1">&#39;--&gt; Importing </span><span class="si">{0}</span><span class="s1"> script to </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>                            <span class="n">script</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="n">script_target_file</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>                        <span class="p">)</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>                    <span class="p">)</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>                    <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>                        <span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">script_file</span><span class="p">,</span> <span class="n">script_target_file</span><span class="p">]</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>                    <span class="p">)</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>                    <span class="n">need_script_helper_functions</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>                <span class="k">elif</span> <span class="n">script</span><span class="o">.</span><span class="n">raise_if_not_exists</span><span class="p">:</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>                    <span class="k">raise</span> <span class="n">KiwiImportDescriptionError</span><span class="p">(</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>                        <span class="s1">&#39;Specified script </span><span class="si">{0}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>                            <span class="n">script_file</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>                        <span class="p">)</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>                    <span class="p">)</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>        <span class="k">if</span> <span class="n">need_script_helper_functions</span><span class="p">:</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Importing script helper functions&#39;</span><span class="p">)</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>                <span class="p">[</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>                    <span class="s1">&#39;cp&#39;</span><span class="p">,</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>                    <span class="n">Defaults</span><span class="o">.</span><span class="n">get_common_functions_file</span><span class="p">(),</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/.kconfig&#39;</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>                <span class="p">]</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>            <span class="p">)</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_call_script</span><span class="p">(</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>        <span class="n">option_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>        <span class="n">path_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span><span class="p">,</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>        <span class="n">root_is_mountpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>    <span class="p">):</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>        <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>            <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">path_prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>                <span class="k">if</span> <span class="n">root_is_mountpoint</span><span class="p">:</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>                    <span class="n">chroot_mount</span> <span class="o">=</span> <span class="n">MountManager</span><span class="p">(</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>                        <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">mountpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>                    <span class="p">)</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">chroot_mount</span><span class="o">.</span><span class="n">is_mounted</span><span class="p">():</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>                            <span class="sa">f</span><span class="s1">&#39;Self bind mount </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s1"> for (/) in chroot&#39;</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>                        <span class="p">)</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>                        <span class="n">chroot_mount</span><span class="o">.</span><span class="n">bind_mount</span><span class="p">()</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>                        <span class="n">stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">chroot_mount</span><span class="p">)</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>                <span class="n">options</span> <span class="o">=</span> <span class="n">option_list</span> <span class="ow">or</span> <span class="p">[]</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>                <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">getLogFlags</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run-scripts-in-screen&#39;</span><span class="p">):</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>                    <span class="c1"># Run scripts in a screen session if requested</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>                    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;-X&#39;</span><span class="p">,</span> <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">]</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>                    <span class="c1"># In standard mode run scripts without a terminal</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>                    <span class="c1"># associated to them</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>                    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">]</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>                    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;bash&#39;</span><span class="p">)</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>                <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">path_prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>                <span class="p">)</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>                <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>                <span class="n">profile</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="p">)</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>                <span class="n">caller_environment</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>                <span class="n">caller_environment</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">get_settings</span><span class="p">())</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>                <span class="n">config_script</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">caller_environment</span><span class="p">)</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>                <span class="n">process</span> <span class="o">=</span> <span class="n">CommandProcess</span><span class="p">(</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>                    <span class="n">command</span><span class="o">=</span><span class="n">config_script</span><span class="p">,</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>                    <span class="n">log_topic</span><span class="o">=</span><span class="s1">&#39;Calling &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; script&#39;</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>                <span class="p">)</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">poll_and_watch</span><span class="p">()</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>                    <span class="k">raise</span> <span class="n">KiwiScriptFailed</span><span class="p">(</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> failed with: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>                    <span class="p">)</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>                <span class="c1"># if configured, assign SELinux labels</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">setup_selinux_file_contexts</span><span class="p">()</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_call_script_no_chroot</span><span class="p">(</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">option_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">working_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>    <span class="p">):</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">working_directory</span><span class="p">:</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>            <span class="n">working_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>        <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">])</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>        <span class="p">)</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>            <span class="n">bash_command</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>                <span class="s1">&#39;cd&#39;</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;&amp;&amp;&#39;</span><span class="p">,</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>                <span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;--norc&#39;</span><span class="p">,</span> <span class="n">script_path</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">option_list</span><span class="p">)</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>            <span class="p">]</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">getLogFlags</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run-scripts-in-screen&#39;</span><span class="p">):</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>                <span class="c1"># Run scripts in a screen session if requested</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>                <span class="n">config_script</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>                    <span class="p">[</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;-X&#39;</span><span class="p">,</span> <span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bash_command</span><span class="p">)]</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>                <span class="p">)</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>                <span class="c1"># In standard mode run script through bash</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>                <span class="n">config_script</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>                    <span class="p">[</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bash_command</span><span class="p">)]</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>                <span class="p">)</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">CommandProcess</span><span class="p">(</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>                <span class="n">command</span><span class="o">=</span><span class="n">config_script</span><span class="p">,</span> <span class="n">log_topic</span><span class="o">=</span><span class="s1">&#39;Calling &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; script&#39;</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>            <span class="p">)</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">poll_and_watch</span><span class="p">()</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>                <span class="k">raise</span> <span class="n">KiwiScriptFailed</span><span class="p">(</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>                    <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> failed: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>                <span class="p">)</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_passwd_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>        <span class="n">openssl</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>            <span class="p">[</span><span class="s1">&#39;openssl&#39;</span><span class="p">,</span> <span class="s1">&#39;passwd&#39;</span><span class="p">,</span> <span class="s1">&#39;-1&#39;</span><span class="p">,</span> <span class="s1">&#39;-salt&#39;</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">]</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>        <span class="p">)</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>        <span class="k">return</span> <span class="n">openssl</span><span class="o">.</span><span class="n">output</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_preferences_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>        <span class="k">for</span> <span class="n">preferences</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_preferences_sections</span><span class="p">():</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>            <span class="n">timezone_section</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">get_timezone</span><span class="p">()</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>            <span class="n">locale_section</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">get_locale</span><span class="p">()</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>            <span class="n">keytable_section</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">get_keytable</span><span class="p">()</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>            <span class="k">if</span> <span class="n">timezone_section</span><span class="p">:</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timezone_section</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>            <span class="k">if</span> <span class="n">locale_section</span><span class="p">:</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">locale_section</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>            <span class="k">if</span> <span class="n">keytable_section</span><span class="p">:</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keytable_section</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_oemconfig_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>            <span class="s1">&#39;recovery_inplace&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>            <span class="s1">&#39;recovery&#39;</span><span class="p">:</span> <span class="kc">False</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>        <span class="p">}</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>        <span class="n">oemconfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_build_type_oemconfig_section</span><span class="p">()</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>        <span class="k">if</span> <span class="n">oemconfig</span><span class="p">:</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span><span class="p">[</span><span class="s1">&#39;recovery&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">(</span><span class="n">oemconfig</span><span class="o">.</span><span class="n">get_oem_recovery</span><span class="p">())</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span><span class="p">[</span><span class="s1">&#39;recovery_inplace&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">(</span><span class="n">oemconfig</span><span class="o">.</span><span class="n">get_oem_inplace_recovery</span><span class="p">())</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_content</span><span class="p">):</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a><span class="sd">        Helper method to return the text for XML elements of the</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a><span class="sd">        following structure: &lt;section&gt;text&lt;/section&gt;.</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>        <span class="k">if</span> <span class="n">section_content</span><span class="p">:</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>            <span class="k">return</span> <span class="n">section_content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_rpm_flake_pilot_system_file_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export rpm system files script for flake-pilot&#39;</span><span class="p">)</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>        <span class="n">dbpath_option</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>            <span class="s1">&#39;--dbpath&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rpm_database_location</span><span class="p">()</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>        <span class="p">]</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>        <span class="n">skip_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_system_files_ignore_packages</span><span class="p">()</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>            <span class="p">[</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>                <span class="s1">&#39;rpm&#39;</span><span class="p">,</span> <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;-qa&#39;</span><span class="p">,</span> <span class="s1">&#39;--qf&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{NAME}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>            <span class="p">]</span> <span class="o">+</span> <span class="n">dbpath_option</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>        <span class="p">)</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">systemfiles</span><span class="p">:</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>            <span class="n">systemfiles</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;set -e</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>            <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>                <span class="k">if</span> <span class="n">package</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_list</span><span class="p">:</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>                    <span class="n">systemfiles</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rpm --noghost -ql </span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_rpm_package_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export rpm packages metadata&#39;</span><span class="p">)</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>        <span class="n">dbpath_option</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>            <span class="s1">&#39;--dbpath&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rpm_database_location</span><span class="p">()</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>        <span class="p">]</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>            <span class="p">[</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>                <span class="s1">&#39;rpm&#39;</span><span class="p">,</span> <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;-qa&#39;</span><span class="p">,</span> <span class="s1">&#39;--qf&#39;</span><span class="p">,</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>                <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>                    <span class="p">[</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>                        <span class="s1">&#39;%</span><span class="si">{NAME}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{EPOCH}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{VERSION}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>                        <span class="s1">&#39;%</span><span class="si">{RELEASE}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{ARCH}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{DISTURL}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{LICENSE}</span><span class="s1">&#39;</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>                    <span class="p">]</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>                <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>            <span class="p">]</span> <span class="o">+</span> <span class="n">dbpath_option</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>        <span class="p">)</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">packages</span><span class="p">:</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>            <span class="n">packages</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()))</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>            <span class="p">)</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>            <span class="n">packages</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_deb_package_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export deb packages metadata&#39;</span><span class="p">)</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>            <span class="p">[</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>                <span class="s1">&#39;dpkg-query&#39;</span><span class="p">,</span> <span class="s1">&#39;--admindir&#39;</span><span class="p">,</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;var/lib/dpkg&#39;</span><span class="p">]),</span> <span class="s1">&#39;-W&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>                <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>                    <span class="p">[</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>                        <span class="s1">&#39;$</span><span class="si">{Package}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="si">{Version}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>                        <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="si">{Architecture}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>                    <span class="p">]</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>                <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>            <span class="p">]</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>        <span class="p">)</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">packages</span><span class="p">:</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>            <span class="n">packages</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()))</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>            <span class="p">)</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>            <span class="n">packages</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_pacman_package_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export pacman packages metadata&#39;</span><span class="p">)</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>            <span class="p">[</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>                <span class="s1">&#39;pacman&#39;</span><span class="p">,</span> <span class="s1">&#39;--query&#39;</span><span class="p">,</span> <span class="s1">&#39;--dbpath&#39;</span><span class="p">,</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;var/lib/pacman&#39;</span><span class="p">])</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>            <span class="p">]</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>        <span class="p">)</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">packages</span><span class="p">:</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>                <span class="n">package</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">version_release</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>                <span class="n">version</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">release</span> <span class="o">=</span> <span class="n">version_release</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>                <span class="n">packages</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>                    <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">|None|</span><span class="si">{1}</span><span class="s1">|</span><span class="si">{2}</span><span class="s1">|None|None|None</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>                        <span class="n">package</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>                    <span class="p">)</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>                <span class="p">])</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_rpm_package_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export rpm packages changelog metadata&#39;</span><span class="p">)</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>        <span class="n">dbpath_option</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>            <span class="s1">&#39;--dbpath&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rpm_database_location</span><span class="p">()</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>        <span class="p">]</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>            <span class="p">[</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>                <span class="s1">&#39;rpm&#39;</span><span class="p">,</span> <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>                <span class="s1">&#39;-qa&#39;</span><span class="p">,</span> <span class="s1">&#39;--qf&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{NAME}</span><span class="s1">|</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span> <span class="s1">&#39;--changelog&#39;</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>            <span class="p">]</span> <span class="o">+</span> <span class="n">dbpath_option</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>        <span class="p">)</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">changelog</span><span class="p">:</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>            <span class="n">changelog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_deb_package_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export deb packages changelog metadata&#39;</span><span class="p">)</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>        <span class="n">package_doc_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;/usr/share/doc&#39;</span><span class="p">]</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>        <span class="p">)</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">changelog</span><span class="p">:</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>            <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">package_doc_dir</span><span class="p">)):</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>                <span class="n">changelog_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>                    <span class="p">[</span><span class="n">package_doc_dir</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="s1">&#39;changelog.Debian.gz&#39;</span><span class="p">]</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>                <span class="p">)</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">changelog_file</span><span class="p">):</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>                    <span class="n">changelog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>                        <span class="s1">&#39;</span><span class="si">{0}{1}{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>                    <span class="p">)</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>                    <span class="n">changelog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>                        <span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>                            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;zcat&#39;</span><span class="p">,</span> <span class="n">changelog_file</span><span class="p">])</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>                            <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>                        <span class="p">)</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>                    <span class="p">)</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_rpm_package_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export rpm verification metadata&#39;</span><span class="p">)</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>        <span class="n">dbpath_option</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>            <span class="s1">&#39;--dbpath&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rpm_database_location</span><span class="p">()</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>        <span class="p">]</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>            <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rpm&#39;</span><span class="p">,</span> <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;-Va&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dbpath_option</span><span class="p">,</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>            <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>        <span class="p">)</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">verified</span><span class="p">:</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>            <span class="n">verified</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_deb_package_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export deb verification metadata&#39;</span><span class="p">)</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>            <span class="n">command</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>                <span class="s1">&#39;dpkg&#39;</span><span class="p">,</span> <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>                <span class="s1">&#39;-V&#39;</span><span class="p">,</span> <span class="s1">&#39;--verify-format&#39;</span><span class="p">,</span> <span class="s1">&#39;rpm&#39;</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>            <span class="p">],</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>            <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>        <span class="p">)</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">verified</span><span class="p">:</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>            <span class="n">verified</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_rpm_database_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>        <span class="n">shared_mount</span> <span class="o">=</span> <span class="n">MountManager</span><span class="p">(</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>            <span class="n">device</span><span class="o">=</span><span class="s1">&#39;/dev&#39;</span><span class="p">,</span> <span class="n">mountpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/dev&#39;</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>        <span class="p">)</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">shared_mount</span><span class="o">.</span><span class="n">is_mounted</span><span class="p">():</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>            <span class="n">shared_mount</span><span class="o">.</span><span class="n">bind_mount</span><span class="p">()</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>        <span class="n">rpmdb</span> <span class="o">=</span> <span class="n">RpmDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>        <span class="k">if</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">has_rpm</span><span class="p">():</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>            <span class="n">dbpath</span> <span class="o">=</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">rpmdb_image</span><span class="o">.</span><span class="n">expand_query</span><span class="p">(</span><span class="s1">&#39;%_dbpath&#39;</span><span class="p">)</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>            <span class="n">dbpath</span> <span class="o">=</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">rpmdb_host</span><span class="o">.</span><span class="n">expand_query</span><span class="p">(</span><span class="s1">&#39;%_dbpath&#39;</span><span class="p">)</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>        <span class="k">if</span> <span class="n">shared_mount</span><span class="o">.</span><span class="n">is_mounted</span><span class="p">():</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>            <span class="n">shared_mount</span><span class="o">.</span><span class="n">umount_lazy</span><span class="p">()</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>        <span class="k">return</span> <span class="n">dbpath</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sync_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_list</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FileT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Installing files&quot;</span><span class="p">)</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>        <span class="n">ordered_files</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">file_list</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_t</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ordered_files</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">file_t</span><span class="o">.</span><span class="n">target</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>            <span class="n">target_owner</span> <span class="o">=</span> <span class="n">file_t</span><span class="o">.</span><span class="n">owner</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>            <span class="n">target_permissions</span> <span class="o">=</span> <span class="n">file_t</span><span class="o">.</span><span class="n">permissions</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>            <span class="n">file_file</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">]</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>            <span class="p">)</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>            <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>                <span class="n">target_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">target_name</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>                <span class="p">)</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--&gt; file: </span><span class="si">{</span><span class="n">file_file</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">target_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>            <span class="k">if</span> <span class="n">target_owner</span><span class="p">:</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>                    <span class="p">[</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>                        <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>                        <span class="s1">&#39;chown&#39;</span><span class="p">,</span> <span class="n">target_owner</span><span class="p">,</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>                        <span class="n">file_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>                    <span class="p">]</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>                <span class="p">)</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>            <span class="k">if</span> <span class="n">target_permissions</span><span class="p">:</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>                    <span class="p">[</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>                        <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>                        <span class="s1">&#39;chmod&#39;</span><span class="p">,</span> <span class="n">target_permissions</span><span class="p">,</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>                        <span class="n">file_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>                    <span class="p">]</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>                <span class="p">)</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">target_name</span><span class="p">))</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataSync</span><span class="p">(</span><span class="n">file_file</span><span class="p">,</span> <span class="n">target_name</span><span class="p">)</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">sync_data</span><span class="p">(</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>                <span class="n">options</span><span class="o">=</span><span class="n">Defaults</span><span class="o">.</span><span class="n">get_sync_options</span><span class="p">()</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>            <span class="p">)</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sync_overlay_files</span><span class="p">(</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">overlay_directory</span><span class="p">,</span> <span class="n">follow_links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>        <span class="n">preserve_owner_group</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>    <span class="p">):</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>            <span class="s1">&#39;Copying user defined </span><span class="si">{0}</span><span class="s1"> to image tree&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>                <span class="s1">&#39;files for profile: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span> <span class="k">if</span> <span class="n">profile</span> <span class="k">else</span> <span class="s1">&#39;files&#39;</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>            <span class="p">)</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>        <span class="p">)</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>        <span class="n">sync_options</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>            <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;-D&#39;</span><span class="p">,</span> <span class="s1">&#39;-H&#39;</span><span class="p">,</span> <span class="s1">&#39;-X&#39;</span><span class="p">,</span> <span class="s1">&#39;-A&#39;</span><span class="p">,</span> <span class="s1">&#39;--one-file-system&#39;</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>        <span class="p">]</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>        <span class="k">if</span> <span class="n">follow_links</span><span class="p">:</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>            <span class="n">sync_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--copy-links&#39;</span><span class="p">)</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>            <span class="n">sync_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--links&#39;</span><span class="p">)</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>        <span class="k">if</span> <span class="n">preserve_owner_group</span><span class="p">:</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>            <span class="n">sync_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">)</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>            <span class="n">sync_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">)</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">DataSync</span><span class="p">(</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>            <span class="n">overlay_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>        <span class="p">)</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>        <span class="n">data</span><span class="o">.</span><span class="n">sync_data</span><span class="p">(</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">sync_options</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>        <span class="p">)</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_repo_customization_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_repo</span><span class="p">:</span> <span class="n">repository</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>        <span class="n">script_path</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_customize</span><span class="p">()</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>        <span class="k">if</span> <span class="n">script_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>            <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">script_path</span><span class="p">)</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>        <span class="k">return</span> <span class="n">script_path</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_group_names_and_ids_for_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>        <span class="n">group</span><span class="p">:</span> <span class="n">OrderedDict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>        <span class="k">for</span> <span class="n">group_match</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_user_groups</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>            <span class="n">group_and_id</span> <span class="o">=</span> <span class="n">group_match</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>            <span class="n">group</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>                <span class="p">[(</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>                    <span class="n">group_and_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>                    <span class="n">group_and_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_and_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>                <span class="p">)]</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>            <span class="p">)</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>        <span class="k">return</span> <span class="n">group</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_find_selinux_policy_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>        <span class="n">policy_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/etc/selinux/</span><span class="si">{</span><span class="n">policy_name</span><span class="si">}</span><span class="s1">/policy&#39;</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>        <span class="n">policy_dir_in_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="n">policy_dir</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>        <span class="n">scandir_error</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>            <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">policy_dir_in_root</span><span class="p">)</span> <span class="k">as</span> <span class="n">policy_path</span><span class="p">:</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">policy_path</span><span class="p">:</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>                    <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;policy.&#39;</span><span class="p">):</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>                        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">policy_dir</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">issue</span><span class="p">:</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>            <span class="n">scandir_error</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">issue</span><span class="p">)</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>        <span class="k">raise</span> <span class="n">KiwiFileNotFound</span><span class="p">(</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>            <span class="s1">&#39;Unable to find SELinux policy in </span><span class="si">{0!r}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>                <span class="n">policy_dir_in_root</span><span class="p">,</span> <span class="n">scandir_error</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>            <span class="p">)</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>        <span class="p">)</span>
</span></pre></div>


            </section>
                <section id="log">
                    <div class="attr variable">
            <span class="name">log</span><span class="annotation">: Any</span>        =
<span class="default_value">&lt;Logger kiwi (DEBUG)&gt;</span>

        
    </div>
    <a class="headerlink" href="#log"></a>
    
    

                </section>
                <section id="SystemSetup">
                            <input id="SystemSetup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SystemSetup</span>:

                <label class="view-source-button" for="SystemSetup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup-70"><a href="#SystemSetup-70"><span class="linenos">  70</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SystemSetup</span><span class="p">:</span>
</span><span id="SystemSetup-71"><a href="#SystemSetup-71"><span class="linenos">  71</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-72"><a href="#SystemSetup-72"><span class="linenos">  72</span></a><span class="sd">    **Implementation of system setup steps supported by kiwi**</span>
</span><span id="SystemSetup-73"><a href="#SystemSetup-73"><span class="linenos">  73</span></a>
</span><span id="SystemSetup-74"><a href="#SystemSetup-74"><span class="linenos">  74</span></a><span class="sd">    Kiwi is not responsible for the system configuration, however</span>
</span><span id="SystemSetup-75"><a href="#SystemSetup-75"><span class="linenos">  75</span></a><span class="sd">    some setup steps needs to be performed in order to provide</span>
</span><span id="SystemSetup-76"><a href="#SystemSetup-76"><span class="linenos">  76</span></a><span class="sd">    a minimal work environment inside of the image according to</span>
</span><span id="SystemSetup-77"><a href="#SystemSetup-77"><span class="linenos">  77</span></a><span class="sd">    the desired image type.</span>
</span><span id="SystemSetup-78"><a href="#SystemSetup-78"><span class="linenos">  78</span></a>
</span><span id="SystemSetup-79"><a href="#SystemSetup-79"><span class="linenos">  79</span></a><span class="sd">    :param object xml_state: instance of :class:`XMLState`</span>
</span><span id="SystemSetup-80"><a href="#SystemSetup-80"><span class="linenos">  80</span></a><span class="sd">    :param str root_dir: root directory path name</span>
</span><span id="SystemSetup-81"><a href="#SystemSetup-81"><span class="linenos">  81</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SystemSetup-82"><a href="#SystemSetup-82"><span class="linenos">  82</span></a>
</span><span id="SystemSetup-83"><a href="#SystemSetup-83"><span class="linenos">  83</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_state</span><span class="p">:</span> <span class="n">XMLState</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SystemSetup-84"><a href="#SystemSetup-84"><span class="linenos">  84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_config</span> <span class="o">=</span> <span class="n">RuntimeConfig</span><span class="p">()</span>
</span><span id="SystemSetup-85"><a href="#SystemSetup-85"><span class="linenos">  85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_platform_name</span><span class="p">()</span>
</span><span id="SystemSetup-86"><a href="#SystemSetup-86"><span class="linenos">  86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span> <span class="o">=</span> <span class="n">xml_state</span>
</span><span id="SystemSetup-87"><a href="#SystemSetup-87"><span class="linenos">  87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">=</span> \
</span><span id="SystemSetup-88"><a href="#SystemSetup-88"><span class="linenos">  88</span></a>            <span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">description_dir</span>
</span><span id="SystemSetup-89"><a href="#SystemSetup-89"><span class="linenos">  89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">derived_description_dir</span> <span class="o">=</span> \
</span><span id="SystemSetup-90"><a href="#SystemSetup-90"><span class="linenos">  90</span></a>            <span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">derived_description_dir</span>
</span><span id="SystemSetup-91"><a href="#SystemSetup-91"><span class="linenos">  91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">root_dir</span>
</span><span id="SystemSetup-92"><a href="#SystemSetup-92"><span class="linenos">  92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_preferences_lookup</span><span class="p">()</span>
</span><span id="SystemSetup-93"><a href="#SystemSetup-93"><span class="linenos">  93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_oemconfig_lookup</span><span class="p">()</span>
</span><span id="SystemSetup-94"><a href="#SystemSetup-94"><span class="linenos">  94</span></a>
</span><span id="SystemSetup-95"><a href="#SystemSetup-95"><span class="linenos">  95</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_registry_import</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-96"><a href="#SystemSetup-96"><span class="linenos">  96</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-97"><a href="#SystemSetup-97"><span class="linenos">  97</span></a><span class="sd">        Fetch container(s) and activate systemd unit to load</span>
</span><span id="SystemSetup-98"><a href="#SystemSetup-98"><span class="linenos">  98</span></a><span class="sd">        containers from local oci-archive file during boot</span>
</span><span id="SystemSetup-99"><a href="#SystemSetup-99"><span class="linenos">  99</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-100"><a href="#SystemSetup-100"><span class="linenos"> 100</span></a>        <span class="n">container_files_to_load</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SystemSetup-101"><a href="#SystemSetup-101"><span class="linenos"> 101</span></a>        <span class="n">container_execs_to_load</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SystemSetup-102"><a href="#SystemSetup-102"><span class="linenos"> 102</span></a>        <span class="n">after_services</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="SystemSetup-103"><a href="#SystemSetup-103"><span class="linenos"> 103</span></a>        <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_containers</span><span class="p">():</span>
</span><span id="SystemSetup-104"><a href="#SystemSetup-104"><span class="linenos"> 104</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fetching container: </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-105"><a href="#SystemSetup-105"><span class="linenos"> 105</span></a>            <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">defaults</span><span class="o">.</span><span class="n">LOCAL_CONTAINERS</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span>
</span><span id="SystemSetup-106"><a href="#SystemSetup-106"><span class="linenos"> 106</span></a>                <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span>
</span><span id="SystemSetup-107"><a href="#SystemSetup-107"><span class="linenos"> 107</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-108"><a href="#SystemSetup-108"><span class="linenos"> 108</span></a>            <span class="n">container</span><span class="o">.</span><span class="n">fetch_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="SystemSetup-109"><a href="#SystemSetup-109"><span class="linenos"> 109</span></a>            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">load_command</span><span class="p">:</span>
</span><span id="SystemSetup-110"><a href="#SystemSetup-110"><span class="linenos"> 110</span></a>                <span class="n">container_files_to_load</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">container_file</span><span class="p">)</span>
</span><span id="SystemSetup-111"><a href="#SystemSetup-111"><span class="linenos"> 111</span></a>                <span class="n">container_execs_to_load</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">load_command</span><span class="p">)</span>
</span><span id="SystemSetup-112"><a href="#SystemSetup-112"><span class="linenos"> 112</span></a>                <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;docker&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-113"><a href="#SystemSetup-113"><span class="linenos"> 113</span></a>                    <span class="n">after_services</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;docker.service&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-114"><a href="#SystemSetup-114"><span class="linenos"> 114</span></a>                <span class="k">elif</span> <span class="n">container</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;container-snap&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-115"><a href="#SystemSetup-115"><span class="linenos"> 115</span></a>                    <span class="n">after_services</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;container-snap.service&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-116"><a href="#SystemSetup-116"><span class="linenos"> 116</span></a>
</span><span id="SystemSetup-117"><a href="#SystemSetup-117"><span class="linenos"> 117</span></a>        <span class="k">if</span> <span class="n">container_files_to_load</span><span class="p">:</span>
</span><span id="SystemSetup-118"><a href="#SystemSetup-118"><span class="linenos"> 118</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Setup kiwi_containers.service import unit&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-119"><a href="#SystemSetup-119"><span class="linenos"> 119</span></a>            <span class="n">service</span> <span class="o">=</span> <span class="n">BuilderTemplateSystemdUnit</span><span class="p">()</span>
</span><span id="SystemSetup-120"><a href="#SystemSetup-120"><span class="linenos"> 120</span></a>            <span class="n">unit_template</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_container_import_template</span><span class="p">(</span>
</span><span id="SystemSetup-121"><a href="#SystemSetup-121"><span class="linenos"> 121</span></a>                <span class="n">container_files_to_load</span><span class="p">,</span> <span class="n">container_execs_to_load</span><span class="p">,</span>
</span><span id="SystemSetup-122"><a href="#SystemSetup-122"><span class="linenos"> 122</span></a>                <span class="nb">list</span><span class="p">(</span><span class="n">after_services</span><span class="p">)</span>
</span><span id="SystemSetup-123"><a href="#SystemSetup-123"><span class="linenos"> 123</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-124"><a href="#SystemSetup-124"><span class="linenos"> 124</span></a>            <span class="n">unit</span> <span class="o">=</span> <span class="n">unit_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>
</span><span id="SystemSetup-125"><a href="#SystemSetup-125"><span class="linenos"> 125</span></a>            <span class="n">unit_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/etc/systemd/system/</span><span class="si">{1}</span><span class="s1">.service&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-126"><a href="#SystemSetup-126"><span class="linenos"> 126</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;kiwi_containers&#39;</span>
</span><span id="SystemSetup-127"><a href="#SystemSetup-127"><span class="linenos"> 127</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-128"><a href="#SystemSetup-128"><span class="linenos"> 128</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">unit_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">systemd</span><span class="p">:</span>
</span><span id="SystemSetup-129"><a href="#SystemSetup-129"><span class="linenos"> 129</span></a>                <span class="n">systemd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span><span id="SystemSetup-130"><a href="#SystemSetup-130"><span class="linenos"> 130</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-131"><a href="#SystemSetup-131"><span class="linenos"> 131</span></a>                <span class="p">[</span>
</span><span id="SystemSetup-132"><a href="#SystemSetup-132"><span class="linenos"> 132</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup-133"><a href="#SystemSetup-133"><span class="linenos"> 133</span></a>                    <span class="s1">&#39;systemctl&#39;</span><span class="p">,</span> <span class="s1">&#39;enable&#39;</span><span class="p">,</span> <span class="s1">&#39;kiwi_containers&#39;</span>
</span><span id="SystemSetup-134"><a href="#SystemSetup-134"><span class="linenos"> 134</span></a>                <span class="p">]</span>
</span><span id="SystemSetup-135"><a href="#SystemSetup-135"><span class="linenos"> 135</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-136"><a href="#SystemSetup-136"><span class="linenos"> 136</span></a>
</span><span id="SystemSetup-137"><a href="#SystemSetup-137"><span class="linenos"> 137</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-138"><a href="#SystemSetup-138"><span class="linenos"> 138</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-139"><a href="#SystemSetup-139"><span class="linenos"> 139</span></a><span class="sd">        Import XML descriptions, custom scripts, archives and</span>
</span><span id="SystemSetup-140"><a href="#SystemSetup-140"><span class="linenos"> 140</span></a><span class="sd">        script helper methods</span>
</span><span id="SystemSetup-141"><a href="#SystemSetup-141"><span class="linenos"> 141</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-142"><a href="#SystemSetup-142"><span class="linenos"> 142</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Importing Image description to system tree&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-143"><a href="#SystemSetup-143"><span class="linenos"> 143</span></a>        <span class="n">description</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-144"><a href="#SystemSetup-144"><span class="linenos"> 144</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span><span class="p">,</span> <span class="s1">&#39;config.xml&#39;</span>
</span><span id="SystemSetup-145"><a href="#SystemSetup-145"><span class="linenos"> 145</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-146"><a href="#SystemSetup-146"><span class="linenos"> 146</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-147"><a href="#SystemSetup-147"><span class="linenos"> 147</span></a>            <span class="s1">&#39;--&gt; Importing state XML description to </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
</span><span id="SystemSetup-148"><a href="#SystemSetup-148"><span class="linenos"> 148</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-149"><a href="#SystemSetup-149"><span class="linenos"> 149</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="SystemSetup-150"><a href="#SystemSetup-150"><span class="linenos"> 150</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span><span class="p">)</span>
</span><span id="SystemSetup-151"><a href="#SystemSetup-151"><span class="linenos"> 151</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-152"><a href="#SystemSetup-152"><span class="linenos"> 152</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
</span><span id="SystemSetup-153"><a href="#SystemSetup-153"><span class="linenos"> 153</span></a>            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-154"><a href="#SystemSetup-154"><span class="linenos"> 154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">outfile</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="SystemSetup-155"><a href="#SystemSetup-155"><span class="linenos"> 155</span></a>
</span><span id="SystemSetup-156"><a href="#SystemSetup-156"><span class="linenos"> 156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_custom_scripts</span><span class="p">()</span>
</span><span id="SystemSetup-157"><a href="#SystemSetup-157"><span class="linenos"> 157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_custom_archives</span><span class="p">()</span>
</span><span id="SystemSetup-158"><a href="#SystemSetup-158"><span class="linenos"> 158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_custom_files</span><span class="p">()</span>
</span><span id="SystemSetup-159"><a href="#SystemSetup-159"><span class="linenos"> 159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_cdroot_archive</span><span class="p">()</span>
</span><span id="SystemSetup-160"><a href="#SystemSetup-160"><span class="linenos"> 160</span></a>
</span><span id="SystemSetup-161"><a href="#SystemSetup-161"><span class="linenos"> 161</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">script_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="SystemSetup-162"><a href="#SystemSetup-162"><span class="linenos"> 162</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-163"><a href="#SystemSetup-163"><span class="linenos"> 163</span></a><span class="sd">        Check if provided script base name exists in the image description</span>
</span><span id="SystemSetup-164"><a href="#SystemSetup-164"><span class="linenos"> 164</span></a>
</span><span id="SystemSetup-165"><a href="#SystemSetup-165"><span class="linenos"> 165</span></a><span class="sd">        :param str name: script base name</span>
</span><span id="SystemSetup-166"><a href="#SystemSetup-166"><span class="linenos"> 166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-167"><a href="#SystemSetup-167"><span class="linenos"> 167</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span><span id="SystemSetup-168"><a href="#SystemSetup-168"><span class="linenos"> 168</span></a>
</span><span id="SystemSetup-169"><a href="#SystemSetup-169"><span class="linenos"> 169</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-170"><a href="#SystemSetup-170"><span class="linenos"> 170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-171"><a href="#SystemSetup-171"><span class="linenos"> 171</span></a><span class="sd">        Delete all traces of a kiwi description which are not</span>
</span><span id="SystemSetup-172"><a href="#SystemSetup-172"><span class="linenos"> 172</span></a><span class="sd">        required in the later image</span>
</span><span id="SystemSetup-173"><a href="#SystemSetup-173"><span class="linenos"> 173</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-174"><a href="#SystemSetup-174"><span class="linenos"> 174</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-175"><a href="#SystemSetup-175"><span class="linenos"> 175</span></a>            <span class="p">[</span>
</span><span id="SystemSetup-176"><a href="#SystemSetup-176"><span class="linenos"> 176</span></a>                <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup-177"><a href="#SystemSetup-177"><span class="linenos"> 177</span></a>                <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-178"><a href="#SystemSetup-178"><span class="linenos"> 178</span></a>                <span class="s1">&#39;.kconfig&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-179"><a href="#SystemSetup-179"><span class="linenos"> 179</span></a>                <span class="s1">&#39;.profile&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-180"><a href="#SystemSetup-180"><span class="linenos"> 180</span></a>                <span class="s1">&#39;config.bootoptions&#39;</span>
</span><span id="SystemSetup-181"><a href="#SystemSetup-181"><span class="linenos"> 181</span></a>            <span class="p">]</span>
</span><span id="SystemSetup-182"><a href="#SystemSetup-182"><span class="linenos"> 182</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-183"><a href="#SystemSetup-183"><span class="linenos"> 183</span></a>        <span class="n">meta_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="SystemSetup-184"><a href="#SystemSetup-184"><span class="linenos"> 184</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">):</span>
</span><span id="SystemSetup-185"><a href="#SystemSetup-185"><span class="linenos"> 185</span></a>            <span class="n">image_meta</span> <span class="o">=</span> <span class="n">MountManager</span><span class="p">(</span>
</span><span id="SystemSetup-186"><a href="#SystemSetup-186"><span class="linenos"> 186</span></a>                <span class="n">device</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">mountpoint</span><span class="o">=</span><span class="n">meta_dir</span>
</span><span id="SystemSetup-187"><a href="#SystemSetup-187"><span class="linenos"> 187</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-188"><a href="#SystemSetup-188"><span class="linenos"> 188</span></a>            <span class="n">image_meta</span><span class="o">.</span><span class="n">umount</span><span class="p">()</span>
</span><span id="SystemSetup-189"><a href="#SystemSetup-189"><span class="linenos"> 189</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">)</span>
</span><span id="SystemSetup-190"><a href="#SystemSetup-190"><span class="linenos"> 190</span></a>
</span><span id="SystemSetup-191"><a href="#SystemSetup-191"><span class="linenos"> 191</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_repositories_marked_as_imageinclude</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-192"><a href="#SystemSetup-192"><span class="linenos"> 192</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-193"><a href="#SystemSetup-193"><span class="linenos"> 193</span></a><span class="sd">        Those &lt;repository&gt; sections which are marked with the</span>
</span><span id="SystemSetup-194"><a href="#SystemSetup-194"><span class="linenos"> 194</span></a><span class="sd">        imageinclude attribute should be permanently added to</span>
</span><span id="SystemSetup-195"><a href="#SystemSetup-195"><span class="linenos"> 195</span></a><span class="sd">        the image repository configuration</span>
</span><span id="SystemSetup-196"><a href="#SystemSetup-196"><span class="linenos"> 196</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-197"><a href="#SystemSetup-197"><span class="linenos"> 197</span></a>        <span class="n">repository_sections</span> <span class="o">=</span> \
</span><span id="SystemSetup-198"><a href="#SystemSetup-198"><span class="linenos"> 198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_repository_sections_used_in_image</span><span class="p">()</span>
</span><span id="SystemSetup-199"><a href="#SystemSetup-199"><span class="linenos"> 199</span></a>        <span class="n">root</span> <span class="o">=</span> <span class="n">RootInit</span><span class="p">(</span>
</span><span id="SystemSetup-200"><a href="#SystemSetup-200"><span class="linenos"> 200</span></a>            <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">allow_existing</span><span class="o">=</span><span class="kc">True</span>
</span><span id="SystemSetup-201"><a href="#SystemSetup-201"><span class="linenos"> 201</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-202"><a href="#SystemSetup-202"><span class="linenos"> 202</span></a>        <span class="k">with</span> <span class="n">Repository</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span id="SystemSetup-203"><a href="#SystemSetup-203"><span class="linenos"> 203</span></a>            <span class="n">RootBind</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="SystemSetup-204"><a href="#SystemSetup-204"><span class="linenos"> 204</span></a>        <span class="p">)</span> <span class="k">as</span> <span class="n">repo</span><span class="p">:</span>
</span><span id="SystemSetup-205"><a href="#SystemSetup-205"><span class="linenos"> 205</span></a>            <span class="n">repo</span><span class="o">.</span><span class="n">use_default_location</span><span class="p">()</span>
</span><span id="SystemSetup-206"><a href="#SystemSetup-206"><span class="linenos"> 206</span></a>            <span class="k">for</span> <span class="n">xml_repo</span> <span class="ow">in</span> <span class="n">repository_sections</span><span class="p">:</span>
</span><span id="SystemSetup-207"><a href="#SystemSetup-207"><span class="linenos"> 207</span></a>                <span class="n">repo_type</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
</span><span id="SystemSetup-208"><a href="#SystemSetup-208"><span class="linenos"> 208</span></a>                <span class="n">repo_source</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_source</span><span class="p">()</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>
</span><span id="SystemSetup-209"><a href="#SystemSetup-209"><span class="linenos"> 209</span></a>                <span class="n">repo_architectures</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_architectures</span><span class="p">()</span>
</span><span id="SystemSetup-210"><a href="#SystemSetup-210"><span class="linenos"> 210</span></a>                <span class="n">repo_user</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_username</span><span class="p">()</span>
</span><span id="SystemSetup-211"><a href="#SystemSetup-211"><span class="linenos"> 211</span></a>                <span class="n">repo_secret</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_password</span><span class="p">()</span>
</span><span id="SystemSetup-212"><a href="#SystemSetup-212"><span class="linenos"> 212</span></a>                <span class="n">repo_alias</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_alias</span><span class="p">()</span>
</span><span id="SystemSetup-213"><a href="#SystemSetup-213"><span class="linenos"> 213</span></a>                <span class="n">repo_priority</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_priority</span><span class="p">()</span>
</span><span id="SystemSetup-214"><a href="#SystemSetup-214"><span class="linenos"> 214</span></a>                <span class="n">repo_dist</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">()</span>
</span><span id="SystemSetup-215"><a href="#SystemSetup-215"><span class="linenos"> 215</span></a>                <span class="n">repo_components</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_components</span><span class="p">()</span>
</span><span id="SystemSetup-216"><a href="#SystemSetup-216"><span class="linenos"> 216</span></a>                <span class="n">repo_repository_gpgcheck</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_repository_gpgcheck</span><span class="p">()</span>
</span><span id="SystemSetup-217"><a href="#SystemSetup-217"><span class="linenos"> 217</span></a>                <span class="n">repo_package_gpgcheck</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_package_gpgcheck</span><span class="p">()</span>
</span><span id="SystemSetup-218"><a href="#SystemSetup-218"><span class="linenos"> 218</span></a>                <span class="n">repo_customization_script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_repo_customization_script</span><span class="p">(</span>
</span><span id="SystemSetup-219"><a href="#SystemSetup-219"><span class="linenos"> 219</span></a>                    <span class="n">xml_repo</span>
</span><span id="SystemSetup-220"><a href="#SystemSetup-220"><span class="linenos"> 220</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-221"><a href="#SystemSetup-221"><span class="linenos"> 221</span></a>                <span class="n">repo_sourcetype</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_sourcetype</span><span class="p">()</span>
</span><span id="SystemSetup-222"><a href="#SystemSetup-222"><span class="linenos"> 222</span></a>                <span class="n">uri</span> <span class="o">=</span> <span class="n">Uri</span><span class="p">(</span><span class="n">repo_source</span><span class="p">,</span> <span class="n">repo_type</span><span class="p">)</span>
</span><span id="SystemSetup-223"><a href="#SystemSetup-223"><span class="linenos"> 223</span></a>                <span class="n">repo_source_translated</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="SystemSetup-224"><a href="#SystemSetup-224"><span class="linenos"> 224</span></a>                    <span class="n">check_build_environment</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-225"><a href="#SystemSetup-225"><span class="linenos"> 225</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-226"><a href="#SystemSetup-226"><span class="linenos"> 226</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_alias</span><span class="p">:</span>
</span><span id="SystemSetup-227"><a href="#SystemSetup-227"><span class="linenos"> 227</span></a>                    <span class="n">repo_alias</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
</span><span id="SystemSetup-228"><a href="#SystemSetup-228"><span class="linenos"> 228</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-229"><a href="#SystemSetup-229"><span class="linenos"> 229</span></a>                    <span class="s1">&#39;Setting up image repository </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-230"><a href="#SystemSetup-230"><span class="linenos"> 230</span></a>                        <span class="n">Uri</span><span class="o">.</span><span class="n">print_sensitive</span><span class="p">(</span><span class="n">repo_source</span><span class="p">)</span>
</span><span id="SystemSetup-231"><a href="#SystemSetup-231"><span class="linenos"> 231</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-232"><a href="#SystemSetup-232"><span class="linenos"> 232</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-233"><a href="#SystemSetup-233"><span class="linenos"> 233</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Type: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">repo_type</span><span class="p">))</span>
</span><span id="SystemSetup-234"><a href="#SystemSetup-234"><span class="linenos"> 234</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-235"><a href="#SystemSetup-235"><span class="linenos"> 235</span></a>                    <span class="s1">&#39;--&gt; Translated: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-236"><a href="#SystemSetup-236"><span class="linenos"> 236</span></a>                        <span class="n">Uri</span><span class="o">.</span><span class="n">print_sensitive</span><span class="p">(</span><span class="n">repo_source_translated</span><span class="p">)</span>
</span><span id="SystemSetup-237"><a href="#SystemSetup-237"><span class="linenos"> 237</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-238"><a href="#SystemSetup-238"><span class="linenos"> 238</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-239"><a href="#SystemSetup-239"><span class="linenos"> 239</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Alias: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">repo_alias</span><span class="p">))</span>
</span><span id="SystemSetup-240"><a href="#SystemSetup-240"><span class="linenos"> 240</span></a>                <span class="n">repo</span><span class="o">.</span><span class="n">add_repo</span><span class="p">(</span>
</span><span id="SystemSetup-241"><a href="#SystemSetup-241"><span class="linenos"> 241</span></a>                    <span class="n">repo_alias</span><span class="p">,</span> <span class="n">repo_source_translated</span><span class="p">,</span>
</span><span id="SystemSetup-242"><a href="#SystemSetup-242"><span class="linenos"> 242</span></a>                    <span class="n">repo_type</span><span class="p">,</span> <span class="n">repo_priority</span><span class="p">,</span> <span class="n">repo_dist</span><span class="p">,</span> <span class="n">repo_components</span><span class="p">,</span>
</span><span id="SystemSetup-243"><a href="#SystemSetup-243"><span class="linenos"> 243</span></a>                    <span class="n">repo_user</span><span class="p">,</span> <span class="n">repo_secret</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">credentials_file_name</span><span class="p">(),</span>
</span><span id="SystemSetup-244"><a href="#SystemSetup-244"><span class="linenos"> 244</span></a>                    <span class="n">repo_repository_gpgcheck</span><span class="p">,</span> <span class="n">repo_package_gpgcheck</span><span class="p">,</span>
</span><span id="SystemSetup-245"><a href="#SystemSetup-245"><span class="linenos"> 245</span></a>                    <span class="n">repo_sourcetype</span><span class="p">,</span> <span class="n">repo_customization_script</span><span class="p">,</span>
</span><span id="SystemSetup-246"><a href="#SystemSetup-246"><span class="linenos"> 246</span></a>                    <span class="n">repo_architectures</span>
</span><span id="SystemSetup-247"><a href="#SystemSetup-247"><span class="linenos"> 247</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-248"><a href="#SystemSetup-248"><span class="linenos"> 248</span></a>
</span><span id="SystemSetup-249"><a href="#SystemSetup-249"><span class="linenos"> 249</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_cdroot_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-250"><a href="#SystemSetup-250"><span class="linenos"> 250</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-251"><a href="#SystemSetup-251"><span class="linenos"> 251</span></a><span class="sd">        Copy cdroot files from the image description to the</span>
</span><span id="SystemSetup-252"><a href="#SystemSetup-252"><span class="linenos"> 252</span></a><span class="sd">        specified target directory. Supported is a tar</span>
</span><span id="SystemSetup-253"><a href="#SystemSetup-253"><span class="linenos"> 253</span></a><span class="sd">        archive named config-cdroot.tar[.compression-postfix]</span>
</span><span id="SystemSetup-254"><a href="#SystemSetup-254"><span class="linenos"> 254</span></a>
</span><span id="SystemSetup-255"><a href="#SystemSetup-255"><span class="linenos"> 255</span></a><span class="sd">        :param str target_dir: directory to unpack archive to</span>
</span><span id="SystemSetup-256"><a href="#SystemSetup-256"><span class="linenos"> 256</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-257"><a href="#SystemSetup-257"><span class="linenos"> 257</span></a>        <span class="n">glob_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">+</span> <span class="s1">&#39;/config-cdroot.tar*&#39;</span>
</span><span id="SystemSetup-258"><a href="#SystemSetup-258"><span class="linenos"> 258</span></a>        <span class="k">for</span> <span class="n">cdroot_archive</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">glob_match</span><span class="p">)):</span>
</span><span id="SystemSetup-259"><a href="#SystemSetup-259"><span class="linenos"> 259</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-260"><a href="#SystemSetup-260"><span class="linenos"> 260</span></a>                <span class="s1">&#39;Extracting ISO user config archive: </span><span class="si">{0}</span><span class="s1"> to: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-261"><a href="#SystemSetup-261"><span class="linenos"> 261</span></a>                    <span class="n">cdroot_archive</span><span class="p">,</span> <span class="n">target_dir</span>
</span><span id="SystemSetup-262"><a href="#SystemSetup-262"><span class="linenos"> 262</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-263"><a href="#SystemSetup-263"><span class="linenos"> 263</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-264"><a href="#SystemSetup-264"><span class="linenos"> 264</span></a>            <span class="n">archive</span> <span class="o">=</span> <span class="n">ArchiveTar</span><span class="p">(</span><span class="n">cdroot_archive</span><span class="p">)</span>
</span><span id="SystemSetup-265"><a href="#SystemSetup-265"><span class="linenos"> 265</span></a>            <span class="n">archive</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
</span><span id="SystemSetup-266"><a href="#SystemSetup-266"><span class="linenos"> 266</span></a>            <span class="k">break</span>
</span><span id="SystemSetup-267"><a href="#SystemSetup-267"><span class="linenos"> 267</span></a>
</span><span id="SystemSetup-268"><a href="#SystemSetup-268"><span class="linenos"> 268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-269"><a href="#SystemSetup-269"><span class="linenos"> 269</span></a>        <span class="n">system_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_system_files</span><span class="p">()</span>
</span><span id="SystemSetup-270"><a href="#SystemSetup-270"><span class="linenos"> 270</span></a>        <span class="n">bootstrap_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_bootstrap_files</span><span class="p">()</span>
</span><span id="SystemSetup-271"><a href="#SystemSetup-271"><span class="linenos"> 271</span></a>        <span class="k">if</span> <span class="n">system_files</span><span class="p">:</span>
</span><span id="SystemSetup-272"><a href="#SystemSetup-272"><span class="linenos"> 272</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_files</span><span class="p">(</span><span class="n">system_files</span><span class="p">)</span>
</span><span id="SystemSetup-273"><a href="#SystemSetup-273"><span class="linenos"> 273</span></a>        <span class="k">if</span> <span class="n">bootstrap_files</span><span class="p">:</span>
</span><span id="SystemSetup-274"><a href="#SystemSetup-274"><span class="linenos"> 274</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_files</span><span class="p">(</span><span class="n">bootstrap_files</span><span class="p">)</span>
</span><span id="SystemSetup-275"><a href="#SystemSetup-275"><span class="linenos"> 275</span></a>
</span><span id="SystemSetup-276"><a href="#SystemSetup-276"><span class="linenos"> 276</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_overlay_files</span><span class="p">(</span>
</span><span id="SystemSetup-277"><a href="#SystemSetup-277"><span class="linenos"> 277</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">follow_links</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">preserve_owner_group</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SystemSetup-278"><a href="#SystemSetup-278"><span class="linenos"> 278</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-279"><a href="#SystemSetup-279"><span class="linenos"> 279</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-280"><a href="#SystemSetup-280"><span class="linenos"> 280</span></a><span class="sd">        Copy overlay files from the image description to</span>
</span><span id="SystemSetup-281"><a href="#SystemSetup-281"><span class="linenos"> 281</span></a><span class="sd">        the image root tree. Supported are a root/ directory</span>
</span><span id="SystemSetup-282"><a href="#SystemSetup-282"><span class="linenos"> 282</span></a><span class="sd">        or a root.tar.gz tarball. The root/ directory takes</span>
</span><span id="SystemSetup-283"><a href="#SystemSetup-283"><span class="linenos"> 283</span></a><span class="sd">        precedence over the tarball.</span>
</span><span id="SystemSetup-284"><a href="#SystemSetup-284"><span class="linenos"> 284</span></a>
</span><span id="SystemSetup-285"><a href="#SystemSetup-285"><span class="linenos"> 285</span></a><span class="sd">        In addition the method also supports profile specific</span>
</span><span id="SystemSetup-286"><a href="#SystemSetup-286"><span class="linenos"> 286</span></a><span class="sd">        overlay files which are searched in a directory of the</span>
</span><span id="SystemSetup-287"><a href="#SystemSetup-287"><span class="linenos"> 287</span></a><span class="sd">        same name as the profile name.</span>
</span><span id="SystemSetup-288"><a href="#SystemSetup-288"><span class="linenos"> 288</span></a>
</span><span id="SystemSetup-289"><a href="#SystemSetup-289"><span class="linenos"> 289</span></a><span class="sd">        The overall order for including overlay files is as</span>
</span><span id="SystemSetup-290"><a href="#SystemSetup-290"><span class="linenos"> 290</span></a><span class="sd">        follows:</span>
</span><span id="SystemSetup-291"><a href="#SystemSetup-291"><span class="linenos"> 291</span></a>
</span><span id="SystemSetup-292"><a href="#SystemSetup-292"><span class="linenos"> 292</span></a><span class="sd">        1. root/ dir or root.tar.gz</span>
</span><span id="SystemSetup-293"><a href="#SystemSetup-293"><span class="linenos"> 293</span></a><span class="sd">        2. PROFILE_NAME/ dir(s) in the order of the selected</span>
</span><span id="SystemSetup-294"><a href="#SystemSetup-294"><span class="linenos"> 294</span></a><span class="sd">           profiles</span>
</span><span id="SystemSetup-295"><a href="#SystemSetup-295"><span class="linenos"> 295</span></a>
</span><span id="SystemSetup-296"><a href="#SystemSetup-296"><span class="linenos"> 296</span></a><span class="sd">        :param bool follow_links: follow symlinks true|false</span>
</span><span id="SystemSetup-297"><a href="#SystemSetup-297"><span class="linenos"> 297</span></a><span class="sd">        :param bool preserve_owner_group: preserve permissions true|false</span>
</span><span id="SystemSetup-298"><a href="#SystemSetup-298"><span class="linenos"> 298</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-299"><a href="#SystemSetup-299"><span class="linenos"> 299</span></a>        <span class="n">overlay_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">+</span> <span class="s1">&#39;/root/&#39;</span>
</span><span id="SystemSetup-300"><a href="#SystemSetup-300"><span class="linenos"> 300</span></a>        <span class="n">overlay_archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">+</span> <span class="s1">&#39;/root.tar.gz&#39;</span>
</span><span id="SystemSetup-301"><a href="#SystemSetup-301"><span class="linenos"> 301</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">overlay_directory</span><span class="p">):</span>
</span><span id="SystemSetup-302"><a href="#SystemSetup-302"><span class="linenos"> 302</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_overlay_files</span><span class="p">(</span>
</span><span id="SystemSetup-303"><a href="#SystemSetup-303"><span class="linenos"> 303</span></a>                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">overlay_directory</span><span class="p">)</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-304"><a href="#SystemSetup-304"><span class="linenos"> 304</span></a>                <span class="n">follow_links</span><span class="p">,</span> <span class="n">preserve_owner_group</span>
</span><span id="SystemSetup-305"><a href="#SystemSetup-305"><span class="linenos"> 305</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-306"><a href="#SystemSetup-306"><span class="linenos"> 306</span></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">overlay_archive</span><span class="p">):</span>
</span><span id="SystemSetup-307"><a href="#SystemSetup-307"><span class="linenos"> 307</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracting user defined files from archive to image tree&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-308"><a href="#SystemSetup-308"><span class="linenos"> 308</span></a>            <span class="n">archive</span> <span class="o">=</span> <span class="n">ArchiveTar</span><span class="p">(</span><span class="n">overlay_archive</span><span class="p">)</span>
</span><span id="SystemSetup-309"><a href="#SystemSetup-309"><span class="linenos"> 309</span></a>            <span class="n">archive</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="SystemSetup-310"><a href="#SystemSetup-310"><span class="linenos"> 310</span></a>
</span><span id="SystemSetup-311"><a href="#SystemSetup-311"><span class="linenos"> 311</span></a>        <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">profiles</span><span class="p">:</span>
</span><span id="SystemSetup-312"><a href="#SystemSetup-312"><span class="linenos"> 312</span></a>            <span class="n">overlay_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-313"><a href="#SystemSetup-313"><span class="linenos"> 313</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">profile</span>
</span><span id="SystemSetup-314"><a href="#SystemSetup-314"><span class="linenos"> 314</span></a>            <span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
</span><span id="SystemSetup-315"><a href="#SystemSetup-315"><span class="linenos"> 315</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">overlay_directory</span><span class="p">):</span>
</span><span id="SystemSetup-316"><a href="#SystemSetup-316"><span class="linenos"> 316</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_sync_overlay_files</span><span class="p">(</span>
</span><span id="SystemSetup-317"><a href="#SystemSetup-317"><span class="linenos"> 317</span></a>                    <span class="n">overlay_directory</span><span class="p">,</span> <span class="n">follow_links</span><span class="p">,</span> <span class="n">preserve_owner_group</span><span class="p">,</span>
</span><span id="SystemSetup-318"><a href="#SystemSetup-318"><span class="linenos"> 318</span></a>                    <span class="n">profile</span>
</span><span id="SystemSetup-319"><a href="#SystemSetup-319"><span class="linenos"> 319</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-320"><a href="#SystemSetup-320"><span class="linenos"> 320</span></a>
</span><span id="SystemSetup-321"><a href="#SystemSetup-321"><span class="linenos"> 321</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_machine_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-322"><a href="#SystemSetup-322"><span class="linenos"> 322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-323"><a href="#SystemSetup-323"><span class="linenos"> 323</span></a><span class="sd">        Setup systemd machine id</span>
</span><span id="SystemSetup-324"><a href="#SystemSetup-324"><span class="linenos"> 324</span></a>
</span><span id="SystemSetup-325"><a href="#SystemSetup-325"><span class="linenos"> 325</span></a><span class="sd">        There are various states of /etc/machine-id:</span>
</span><span id="SystemSetup-326"><a href="#SystemSetup-326"><span class="linenos"> 326</span></a>
</span><span id="SystemSetup-327"><a href="#SystemSetup-327"><span class="linenos"> 327</span></a><span class="sd">        a) Does not exist: Triggers ConditionFirstBoot, but does not work</span>
</span><span id="SystemSetup-328"><a href="#SystemSetup-328"><span class="linenos"> 328</span></a><span class="sd">           if the filesystem is initially read-only (booted without &quot;rw&quot;).</span>
</span><span id="SystemSetup-329"><a href="#SystemSetup-329"><span class="linenos"> 329</span></a><span class="sd">        b) Exists, is empty: Does not trigger ConditionFirstBoot, but works</span>
</span><span id="SystemSetup-330"><a href="#SystemSetup-330"><span class="linenos"> 330</span></a><span class="sd">           with read-only mounts.</span>
</span><span id="SystemSetup-331"><a href="#SystemSetup-331"><span class="linenos"> 331</span></a><span class="sd">        c) Exists, contains the string &quot;uninitialized&quot;: Same as b), but</span>
</span><span id="SystemSetup-332"><a href="#SystemSetup-332"><span class="linenos"> 332</span></a><span class="sd">           triggers ConditionFirstBoot. Supported by systemd v247+ only.</span>
</span><span id="SystemSetup-333"><a href="#SystemSetup-333"><span class="linenos"> 333</span></a><span class="sd">        d) Exists, contains a valid ID.</span>
</span><span id="SystemSetup-334"><a href="#SystemSetup-334"><span class="linenos"> 334</span></a>
</span><span id="SystemSetup-335"><a href="#SystemSetup-335"><span class="linenos"> 335</span></a><span class="sd">        See the machine-id(5) man page for details.</span>
</span><span id="SystemSetup-336"><a href="#SystemSetup-336"><span class="linenos"> 336</span></a>
</span><span id="SystemSetup-337"><a href="#SystemSetup-337"><span class="linenos"> 337</span></a><span class="sd">        In images, d) is not desirable, so truncate the file. This is the</span>
</span><span id="SystemSetup-338"><a href="#SystemSetup-338"><span class="linenos"> 338</span></a><span class="sd">        previous behaviour and what existing images expect. If the image</span>
</span><span id="SystemSetup-339"><a href="#SystemSetup-339"><span class="linenos"> 339</span></a><span class="sd">        has one of the other states, keep it as-is.</span>
</span><span id="SystemSetup-340"><a href="#SystemSetup-340"><span class="linenos"> 340</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-341"><a href="#SystemSetup-341"><span class="linenos"> 341</span></a>        <span class="n">machine_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-342"><a href="#SystemSetup-342"><span class="linenos"> 342</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;etc&#39;</span><span class="p">,</span> <span class="s1">&#39;machine-id&#39;</span>
</span><span id="SystemSetup-343"><a href="#SystemSetup-343"><span class="linenos"> 343</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-344"><a href="#SystemSetup-344"><span class="linenos"> 344</span></a>
</span><span id="SystemSetup-345"><a href="#SystemSetup-345"><span class="linenos"> 345</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">machine_id</span><span class="p">):</span>
</span><span id="SystemSetup-346"><a href="#SystemSetup-346"><span class="linenos"> 346</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">machine_id</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="SystemSetup-347"><a href="#SystemSetup-347"><span class="linenos"> 347</span></a>                <span class="k">if</span> <span class="s1">&#39;uninitialized&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">():</span>
</span><span id="SystemSetup-348"><a href="#SystemSetup-348"><span class="linenos"> 348</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="SystemSetup-349"><a href="#SystemSetup-349"><span class="linenos"> 349</span></a>
</span><span id="SystemSetup-350"><a href="#SystemSetup-350"><span class="linenos"> 350</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-351"><a href="#SystemSetup-351"><span class="linenos"> 351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-352"><a href="#SystemSetup-352"><span class="linenos"> 352</span></a><span class="sd">        Check and Fix permissions using chkstat</span>
</span><span id="SystemSetup-353"><a href="#SystemSetup-353"><span class="linenos"> 353</span></a>
</span><span id="SystemSetup-354"><a href="#SystemSetup-354"><span class="linenos"> 354</span></a><span class="sd">        Call chkstat in system mode which reads /etc/sysconfig/security</span>
</span><span id="SystemSetup-355"><a href="#SystemSetup-355"><span class="linenos"> 355</span></a><span class="sd">        to determine the configured security level and applies the</span>
</span><span id="SystemSetup-356"><a href="#SystemSetup-356"><span class="linenos"> 356</span></a><span class="sd">        appropriate permission definitions from the /etc/permissions*</span>
</span><span id="SystemSetup-357"><a href="#SystemSetup-357"><span class="linenos"> 357</span></a><span class="sd">        files. It&#39;s possible to provide those files as overlay files</span>
</span><span id="SystemSetup-358"><a href="#SystemSetup-358"><span class="linenos"> 358</span></a><span class="sd">        in the image description to apply a certain permission setup</span>
</span><span id="SystemSetup-359"><a href="#SystemSetup-359"><span class="linenos"> 359</span></a><span class="sd">        when needed. Otherwise the default setup as provided on the</span>
</span><span id="SystemSetup-360"><a href="#SystemSetup-360"><span class="linenos"> 360</span></a><span class="sd">        package level applies.</span>
</span><span id="SystemSetup-361"><a href="#SystemSetup-361"><span class="linenos"> 361</span></a>
</span><span id="SystemSetup-362"><a href="#SystemSetup-362"><span class="linenos"> 362</span></a><span class="sd">        It&#39;s required that the image root system has chkstat installed.</span>
</span><span id="SystemSetup-363"><a href="#SystemSetup-363"><span class="linenos"> 363</span></a><span class="sd">        If not present KIWI skips this step and continuous with a</span>
</span><span id="SystemSetup-364"><a href="#SystemSetup-364"><span class="linenos"> 364</span></a><span class="sd">        warning.</span>
</span><span id="SystemSetup-365"><a href="#SystemSetup-365"><span class="linenos"> 365</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-366"><a href="#SystemSetup-366"><span class="linenos"> 366</span></a>        <span class="n">chkstat</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">which</span><span class="p">(</span>
</span><span id="SystemSetup-367"><a href="#SystemSetup-367"><span class="linenos"> 367</span></a>            <span class="s1">&#39;chkstat&#39;</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">access_mode</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">X_OK</span>
</span><span id="SystemSetup-368"><a href="#SystemSetup-368"><span class="linenos"> 368</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-369"><a href="#SystemSetup-369"><span class="linenos"> 369</span></a>        <span class="k">if</span> <span class="n">chkstat</span><span class="p">:</span>
</span><span id="SystemSetup-370"><a href="#SystemSetup-370"><span class="linenos"> 370</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Check/Fix File Permissions&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-371"><a href="#SystemSetup-371"><span class="linenos"> 371</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-372"><a href="#SystemSetup-372"><span class="linenos"> 372</span></a>                <span class="p">[</span><span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;chkstat&#39;</span><span class="p">,</span> <span class="s1">&#39;--system&#39;</span><span class="p">,</span> <span class="s1">&#39;--set&#39;</span><span class="p">]</span>
</span><span id="SystemSetup-373"><a href="#SystemSetup-373"><span class="linenos"> 373</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-374"><a href="#SystemSetup-374"><span class="linenos"> 374</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-375"><a href="#SystemSetup-375"><span class="linenos"> 375</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="SystemSetup-376"><a href="#SystemSetup-376"><span class="linenos"> 376</span></a>                <span class="s1">&#39;chkstat not found in image. File Permissions Check skipped&#39;</span>
</span><span id="SystemSetup-377"><a href="#SystemSetup-377"><span class="linenos"> 377</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-378"><a href="#SystemSetup-378"><span class="linenos"> 378</span></a>
</span><span id="SystemSetup-379"><a href="#SystemSetup-379"><span class="linenos"> 379</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_keyboard_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-380"><a href="#SystemSetup-380"><span class="linenos"> 380</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-381"><a href="#SystemSetup-381"><span class="linenos"> 381</span></a><span class="sd">        Setup console keyboard</span>
</span><span id="SystemSetup-382"><a href="#SystemSetup-382"><span class="linenos"> 382</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-383"><a href="#SystemSetup-383"><span class="linenos"> 383</span></a>        <span class="k">if</span> <span class="s1">&#39;keytable&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">:</span>
</span><span id="SystemSetup-384"><a href="#SystemSetup-384"><span class="linenos"> 384</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-385"><a href="#SystemSetup-385"><span class="linenos"> 385</span></a>                <span class="s1">&#39;Setting up keytable: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">])</span>
</span><span id="SystemSetup-386"><a href="#SystemSetup-386"><span class="linenos"> 386</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-387"><a href="#SystemSetup-387"><span class="linenos"> 387</span></a>            <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="SystemSetup-388"><a href="#SystemSetup-388"><span class="linenos"> 388</span></a>                <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span> <span class="s1">&#39;--keymap&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-389"><a href="#SystemSetup-389"><span class="linenos"> 389</span></a>                <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-390"><a href="#SystemSetup-390"><span class="linenos"> 390</span></a>            <span class="p">):</span>
</span><span id="SystemSetup-391"><a href="#SystemSetup-391"><span class="linenos"> 391</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/vconsole.conf&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-392"><a href="#SystemSetup-392"><span class="linenos"> 392</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="SystemSetup-393"><a href="#SystemSetup-393"><span class="linenos"> 393</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-394"><a href="#SystemSetup-394"><span class="linenos"> 394</span></a>                    <span class="s1">&#39;--keymap=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">],</span>
</span><span id="SystemSetup-395"><a href="#SystemSetup-395"><span class="linenos"> 395</span></a>                <span class="p">],</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="SystemSetup-396"><a href="#SystemSetup-396"><span class="linenos"> 396</span></a>                <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SystemSetup-397"><a href="#SystemSetup-397"><span class="linenos"> 397</span></a>                    <span class="n">message</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\n</span>
</span><span id="SystemSetup-398"><a href="#SystemSetup-398"><span class="linenos"> 398</span></a><span class="s1">                        keyboard setup skipped because `systemd-firstboot --keymap` failed (code </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s1">):</span>
</span><span id="SystemSetup-399"><a href="#SystemSetup-399"><span class="linenos"> 399</span></a><span class="s1">                        </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">error</span><span class="si">}</span>
</span><span id="SystemSetup-400"><a href="#SystemSetup-400"><span class="linenos"> 400</span></a>
</span><span id="SystemSetup-401"><a href="#SystemSetup-401"><span class="linenos"> 401</span></a><span class="s1">                        This can happen for example if the specified keytable (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1">) is not available,</span>
</span><span id="SystemSetup-402"><a href="#SystemSetup-402"><span class="linenos"> 402</span></a><span class="s1">                        or if your system does not support the systemd way of managing keymaps.</span>
</span><span id="SystemSetup-403"><a href="#SystemSetup-403"><span class="linenos"> 403</span></a><span class="s1">                        Note that in both cases, systemd-firstboot&#39;s error message complains that the keymap is not installed.</span>
</span><span id="SystemSetup-404"><a href="#SystemSetup-404"><span class="linenos"> 404</span></a>
</span><span id="SystemSetup-405"><a href="#SystemSetup-405"><span class="linenos"> 405</span></a><span class="s1">                        If the keytable is missing, you might be able to install it for example via an additional package.</span>
</span><span id="SystemSetup-406"><a href="#SystemSetup-406"><span class="linenos"> 406</span></a><span class="s1">                        If your system doesn&#39;t support systemd&#39;s keymap management,</span>
</span><span id="SystemSetup-407"><a href="#SystemSetup-407"><span class="linenos"> 407</span></a><span class="s1">                        then you can use a distribution-specific method to set the keymap in a config.sh script.</span>
</span><span id="SystemSetup-408"><a href="#SystemSetup-408"><span class="linenos"> 408</span></a>
</span><span id="SystemSetup-409"><a href="#SystemSetup-409"><span class="linenos"> 409</span></a><span class="s1">                        You can try `localectl list-keymaps` to see if a particular distro supports systemd keymap management.</span>
</span><span id="SystemSetup-410"><a href="#SystemSetup-410"><span class="linenos"> 410</span></a><span class="s1">                    &#39;&#39;&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-411"><a href="#SystemSetup-411"><span class="linenos"> 411</span></a>                    <span class="k">raise</span> <span class="n">KiwiCommandError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="SystemSetup-412"><a href="#SystemSetup-412"><span class="linenos"> 412</span></a>            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/sysconfig/keyboard&#39;</span><span class="p">):</span>
</span><span id="SystemSetup-413"><a href="#SystemSetup-413"><span class="linenos"> 413</span></a>                <span class="n">Shell</span><span class="o">.</span><span class="n">run_common_function</span><span class="p">(</span>
</span><span id="SystemSetup-414"><a href="#SystemSetup-414"><span class="linenos"> 414</span></a>                    <span class="s1">&#39;baseUpdateSysConfig&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="SystemSetup-415"><a href="#SystemSetup-415"><span class="linenos"> 415</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/sysconfig/keyboard&#39;</span><span class="p">,</span> <span class="s1">&#39;KEYTABLE&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-416"><a href="#SystemSetup-416"><span class="linenos"> 416</span></a>                        <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
</span><span id="SystemSetup-417"><a href="#SystemSetup-417"><span class="linenos"> 417</span></a>                    <span class="p">]</span>
</span><span id="SystemSetup-418"><a href="#SystemSetup-418"><span class="linenos"> 418</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-419"><a href="#SystemSetup-419"><span class="linenos"> 419</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-420"><a href="#SystemSetup-420"><span class="linenos"> 420</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="SystemSetup-421"><a href="#SystemSetup-421"><span class="linenos"> 421</span></a>                    <span class="s1">&#39;keyboard setup skipped no capable &#39;</span>
</span><span id="SystemSetup-422"><a href="#SystemSetup-422"><span class="linenos"> 422</span></a>                    <span class="s1">&#39;systemd-firstboot or etc/sysconfig/keyboard found&#39;</span>
</span><span id="SystemSetup-423"><a href="#SystemSetup-423"><span class="linenos"> 423</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-424"><a href="#SystemSetup-424"><span class="linenos"> 424</span></a>
</span><span id="SystemSetup-425"><a href="#SystemSetup-425"><span class="linenos"> 425</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-426"><a href="#SystemSetup-426"><span class="linenos"> 426</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-427"><a href="#SystemSetup-427"><span class="linenos"> 427</span></a><span class="sd">        Setup UTF8 system wide locale</span>
</span><span id="SystemSetup-428"><a href="#SystemSetup-428"><span class="linenos"> 428</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-429"><a href="#SystemSetup-429"><span class="linenos"> 429</span></a>        <span class="k">if</span> <span class="s1">&#39;locale&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">:</span>
</span><span id="SystemSetup-430"><a href="#SystemSetup-430"><span class="linenos"> 430</span></a>            <span class="k">if</span> <span class="s1">&#39;POSIX&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
</span><span id="SystemSetup-431"><a href="#SystemSetup-431"><span class="linenos"> 431</span></a>                <span class="n">locale</span> <span class="o">=</span> <span class="s1">&#39;POSIX&#39;</span>
</span><span id="SystemSetup-432"><a href="#SystemSetup-432"><span class="linenos"> 432</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-433"><a href="#SystemSetup-433"><span class="linenos"> 433</span></a>                <span class="n">locale</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.UTF-8&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-434"><a href="#SystemSetup-434"><span class="linenos"> 434</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SystemSetup-435"><a href="#SystemSetup-435"><span class="linenos"> 435</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-436"><a href="#SystemSetup-436"><span class="linenos"> 436</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-437"><a href="#SystemSetup-437"><span class="linenos"> 437</span></a>                <span class="s1">&#39;Setting up locale: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">])</span>
</span><span id="SystemSetup-438"><a href="#SystemSetup-438"><span class="linenos"> 438</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-439"><a href="#SystemSetup-439"><span class="linenos"> 439</span></a>            <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="SystemSetup-440"><a href="#SystemSetup-440"><span class="linenos"> 440</span></a>                <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span> <span class="s1">&#39;--locale&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-441"><a href="#SystemSetup-441"><span class="linenos"> 441</span></a>                <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-442"><a href="#SystemSetup-442"><span class="linenos"> 442</span></a>            <span class="p">):</span>
</span><span id="SystemSetup-443"><a href="#SystemSetup-443"><span class="linenos"> 443</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/locale.conf&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-444"><a href="#SystemSetup-444"><span class="linenos"> 444</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="SystemSetup-445"><a href="#SystemSetup-445"><span class="linenos"> 445</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-446"><a href="#SystemSetup-446"><span class="linenos"> 446</span></a>                    <span class="s1">&#39;--locale=&#39;</span> <span class="o">+</span> <span class="n">locale</span>
</span><span id="SystemSetup-447"><a href="#SystemSetup-447"><span class="linenos"> 447</span></a>                <span class="p">])</span>
</span><span id="SystemSetup-448"><a href="#SystemSetup-448"><span class="linenos"> 448</span></a>
</span><span id="SystemSetup-449"><a href="#SystemSetup-449"><span class="linenos"> 449</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_timezone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-450"><a href="#SystemSetup-450"><span class="linenos"> 450</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-451"><a href="#SystemSetup-451"><span class="linenos"> 451</span></a><span class="sd">        Setup timezone symlink</span>
</span><span id="SystemSetup-452"><a href="#SystemSetup-452"><span class="linenos"> 452</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-453"><a href="#SystemSetup-453"><span class="linenos"> 453</span></a>        <span class="k">if</span> <span class="s1">&#39;timezone&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">:</span>
</span><span id="SystemSetup-454"><a href="#SystemSetup-454"><span class="linenos"> 454</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-455"><a href="#SystemSetup-455"><span class="linenos"> 455</span></a>                <span class="s1">&#39;Setting up timezone: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">])</span>
</span><span id="SystemSetup-456"><a href="#SystemSetup-456"><span class="linenos"> 456</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-457"><a href="#SystemSetup-457"><span class="linenos"> 457</span></a>            <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="SystemSetup-458"><a href="#SystemSetup-458"><span class="linenos"> 458</span></a>                <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span> <span class="s1">&#39;--timezone&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-459"><a href="#SystemSetup-459"><span class="linenos"> 459</span></a>                <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-460"><a href="#SystemSetup-460"><span class="linenos"> 460</span></a>            <span class="p">):</span>
</span><span id="SystemSetup-461"><a href="#SystemSetup-461"><span class="linenos"> 461</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/localtime&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-462"><a href="#SystemSetup-462"><span class="linenos"> 462</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="SystemSetup-463"><a href="#SystemSetup-463"><span class="linenos"> 463</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-464"><a href="#SystemSetup-464"><span class="linenos"> 464</span></a>                    <span class="s1">&#39;--timezone=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">]</span>
</span><span id="SystemSetup-465"><a href="#SystemSetup-465"><span class="linenos"> 465</span></a>                <span class="p">])</span>
</span><span id="SystemSetup-466"><a href="#SystemSetup-466"><span class="linenos"> 466</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-467"><a href="#SystemSetup-467"><span class="linenos"> 467</span></a>                <span class="n">zoneinfo</span> <span class="o">=</span> <span class="s1">&#39;/usr/share/zoneinfo/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">]</span>
</span><span id="SystemSetup-468"><a href="#SystemSetup-468"><span class="linenos"> 468</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="SystemSetup-469"><a href="#SystemSetup-469"><span class="linenos"> 469</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup-470"><a href="#SystemSetup-470"><span class="linenos"> 470</span></a>                    <span class="s1">&#39;ln&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">zoneinfo</span><span class="p">,</span> <span class="s1">&#39;/etc/localtime&#39;</span>
</span><span id="SystemSetup-471"><a href="#SystemSetup-471"><span class="linenos"> 471</span></a>                <span class="p">])</span>
</span><span id="SystemSetup-472"><a href="#SystemSetup-472"><span class="linenos"> 472</span></a>
</span><span id="SystemSetup-473"><a href="#SystemSetup-473"><span class="linenos"> 473</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-474"><a href="#SystemSetup-474"><span class="linenos"> 474</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-475"><a href="#SystemSetup-475"><span class="linenos"> 475</span></a><span class="sd">        Add groups for configured users</span>
</span><span id="SystemSetup-476"><a href="#SystemSetup-476"><span class="linenos"> 476</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-477"><a href="#SystemSetup-477"><span class="linenos"> 477</span></a>        <span class="n">system_users</span> <span class="o">=</span> <span class="n">Users</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="SystemSetup-478"><a href="#SystemSetup-478"><span class="linenos"> 478</span></a>
</span><span id="SystemSetup-479"><a href="#SystemSetup-479"><span class="linenos"> 479</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_users</span><span class="p">():</span>
</span><span id="SystemSetup-480"><a href="#SystemSetup-480"><span class="linenos"> 480</span></a>            <span class="n">group_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_names_and_ids_for_user</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
</span><span id="SystemSetup-481"><a href="#SystemSetup-481"><span class="linenos"> 481</span></a>            <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="n">group_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="SystemSetup-482"><a href="#SystemSetup-482"><span class="linenos"> 482</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">system_users</span><span class="o">.</span><span class="n">group_exists</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
</span><span id="SystemSetup-483"><a href="#SystemSetup-483"><span class="linenos"> 483</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding group </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
</span><span id="SystemSetup-484"><a href="#SystemSetup-484"><span class="linenos"> 484</span></a>                    <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_user_options</span><span class="p">(</span>
</span><span id="SystemSetup-485"><a href="#SystemSetup-485"><span class="linenos"> 485</span></a>                        <span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span>
</span><span id="SystemSetup-486"><a href="#SystemSetup-486"><span class="linenos"> 486</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-487"><a href="#SystemSetup-487"><span class="linenos"> 487</span></a>                    <span class="n">system_users</span><span class="o">.</span><span class="n">group_add</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="SystemSetup-488"><a href="#SystemSetup-488"><span class="linenos"> 488</span></a>
</span><span id="SystemSetup-489"><a href="#SystemSetup-489"><span class="linenos"> 489</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-490"><a href="#SystemSetup-490"><span class="linenos"> 490</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-491"><a href="#SystemSetup-491"><span class="linenos"> 491</span></a><span class="sd">        Add/Modify configured users</span>
</span><span id="SystemSetup-492"><a href="#SystemSetup-492"><span class="linenos"> 492</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-493"><a href="#SystemSetup-493"><span class="linenos"> 493</span></a>        <span class="n">system_users</span> <span class="o">=</span> <span class="n">Users</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="SystemSetup-494"><a href="#SystemSetup-494"><span class="linenos"> 494</span></a>
</span><span id="SystemSetup-495"><a href="#SystemSetup-495"><span class="linenos"> 495</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_users</span><span class="p">():</span>
</span><span id="SystemSetup-496"><a href="#SystemSetup-496"><span class="linenos"> 496</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting up user </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
</span><span id="SystemSetup-497"><a href="#SystemSetup-497"><span class="linenos"> 497</span></a>            <span class="n">password</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_password</span><span class="p">()</span>
</span><span id="SystemSetup-498"><a href="#SystemSetup-498"><span class="linenos"> 498</span></a>            <span class="n">password_format</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_pwdformat</span><span class="p">()</span>
</span><span id="SystemSetup-499"><a href="#SystemSetup-499"><span class="linenos"> 499</span></a>            <span class="n">home_path</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_home</span><span class="p">()</span>
</span><span id="SystemSetup-500"><a href="#SystemSetup-500"><span class="linenos"> 500</span></a>            <span class="n">user_name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
</span><span id="SystemSetup-501"><a href="#SystemSetup-501"><span class="linenos"> 501</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
</span><span id="SystemSetup-502"><a href="#SystemSetup-502"><span class="linenos"> 502</span></a>            <span class="n">user_realname</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_realname</span><span class="p">()</span>
</span><span id="SystemSetup-503"><a href="#SystemSetup-503"><span class="linenos"> 503</span></a>            <span class="n">user_shell</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_shell</span><span class="p">()</span>
</span><span id="SystemSetup-504"><a href="#SystemSetup-504"><span class="linenos"> 504</span></a>            <span class="n">user_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="SystemSetup-505"><a href="#SystemSetup-505"><span class="linenos"> 505</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_names_and_ids_for_user</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="SystemSetup-506"><a href="#SystemSetup-506"><span class="linenos"> 506</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-507"><a href="#SystemSetup-507"><span class="linenos"> 507</span></a>
</span><span id="SystemSetup-508"><a href="#SystemSetup-508"><span class="linenos"> 508</span></a>            <span class="n">user_exists</span> <span class="o">=</span> <span class="n">system_users</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_name</span><span class="p">)</span>
</span><span id="SystemSetup-509"><a href="#SystemSetup-509"><span class="linenos"> 509</span></a>
</span><span id="SystemSetup-510"><a href="#SystemSetup-510"><span class="linenos"> 510</span></a>            <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_user_options</span><span class="p">(</span>
</span><span id="SystemSetup-511"><a href="#SystemSetup-511"><span class="linenos"> 511</span></a>                <span class="n">password_format</span><span class="o">=</span><span class="n">password_format</span><span class="p">,</span>
</span><span id="SystemSetup-512"><a href="#SystemSetup-512"><span class="linenos"> 512</span></a>                <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
</span><span id="SystemSetup-513"><a href="#SystemSetup-513"><span class="linenos"> 513</span></a>                <span class="n">user_shell</span><span class="o">=</span><span class="n">user_shell</span><span class="p">,</span>
</span><span id="SystemSetup-514"><a href="#SystemSetup-514"><span class="linenos"> 514</span></a>                <span class="n">user_groups</span><span class="o">=</span><span class="n">user_groups</span><span class="p">,</span>
</span><span id="SystemSetup-515"><a href="#SystemSetup-515"><span class="linenos"> 515</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SystemSetup-516"><a href="#SystemSetup-516"><span class="linenos"> 516</span></a>                <span class="n">user_realname</span><span class="o">=</span><span class="n">user_realname</span><span class="p">,</span>
</span><span id="SystemSetup-517"><a href="#SystemSetup-517"><span class="linenos"> 517</span></a>                <span class="n">user_exists</span><span class="o">=</span><span class="n">user_exists</span><span class="p">,</span>
</span><span id="SystemSetup-518"><a href="#SystemSetup-518"><span class="linenos"> 518</span></a>                <span class="n">home_path</span><span class="o">=</span><span class="n">home_path</span>
</span><span id="SystemSetup-519"><a href="#SystemSetup-519"><span class="linenos"> 519</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-520"><a href="#SystemSetup-520"><span class="linenos"> 520</span></a>
</span><span id="SystemSetup-521"><a href="#SystemSetup-521"><span class="linenos"> 521</span></a>            <span class="n">group_msg</span> <span class="o">=</span> <span class="s1">&#39;--&gt; Primary group for user </span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-522"><a href="#SystemSetup-522"><span class="linenos"> 522</span></a>                <span class="n">user_name</span><span class="p">,</span> <span class="n">user_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SystemSetup-523"><a href="#SystemSetup-523"><span class="linenos"> 523</span></a>            <span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_groups</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</span><span id="SystemSetup-524"><a href="#SystemSetup-524"><span class="linenos"> 524</span></a>
</span><span id="SystemSetup-525"><a href="#SystemSetup-525"><span class="linenos"> 525</span></a>            <span class="k">if</span> <span class="n">user_exists</span><span class="p">:</span>
</span><span id="SystemSetup-526"><a href="#SystemSetup-526"><span class="linenos"> 526</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Modifying user: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_name</span><span class="p">))</span>
</span><span id="SystemSetup-527"><a href="#SystemSetup-527"><span class="linenos"> 527</span></a>                <span class="k">if</span> <span class="n">group_msg</span><span class="p">:</span>
</span><span id="SystemSetup-528"><a href="#SystemSetup-528"><span class="linenos"> 528</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">group_msg</span><span class="p">)</span>
</span><span id="SystemSetup-529"><a href="#SystemSetup-529"><span class="linenos"> 529</span></a>                <span class="n">system_users</span><span class="o">.</span><span class="n">user_modify</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="SystemSetup-530"><a href="#SystemSetup-530"><span class="linenos"> 530</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-531"><a href="#SystemSetup-531"><span class="linenos"> 531</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Adding user: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_name</span><span class="p">))</span>
</span><span id="SystemSetup-532"><a href="#SystemSetup-532"><span class="linenos"> 532</span></a>                <span class="k">if</span> <span class="n">group_msg</span><span class="p">:</span>
</span><span id="SystemSetup-533"><a href="#SystemSetup-533"><span class="linenos"> 533</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">group_msg</span><span class="p">)</span>
</span><span id="SystemSetup-534"><a href="#SystemSetup-534"><span class="linenos"> 534</span></a>                <span class="n">system_users</span><span class="o">.</span><span class="n">user_add</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="SystemSetup-535"><a href="#SystemSetup-535"><span class="linenos"> 535</span></a>                <span class="k">if</span> <span class="n">home_path</span><span class="p">:</span>
</span><span id="SystemSetup-536"><a href="#SystemSetup-536"><span class="linenos"> 536</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-537"><a href="#SystemSetup-537"><span class="linenos"> 537</span></a>                        <span class="s1">&#39;--&gt; Setting permissions for </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">home_path</span><span class="p">)</span>
</span><span id="SystemSetup-538"><a href="#SystemSetup-538"><span class="linenos"> 538</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-539"><a href="#SystemSetup-539"><span class="linenos"> 539</span></a>                    <span class="c1"># Emtpy group string assumes the login or default group</span>
</span><span id="SystemSetup-540"><a href="#SystemSetup-540"><span class="linenos"> 540</span></a>                    <span class="n">system_users</span><span class="o">.</span><span class="n">setup_home_for_user</span><span class="p">(</span>
</span><span id="SystemSetup-541"><a href="#SystemSetup-541"><span class="linenos"> 541</span></a>                        <span class="n">user_name</span><span class="p">,</span>
</span><span id="SystemSetup-542"><a href="#SystemSetup-542"><span class="linenos"> 542</span></a>                        <span class="n">user_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_groups</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-543"><a href="#SystemSetup-543"><span class="linenos"> 543</span></a>                        <span class="n">home_path</span>
</span><span id="SystemSetup-544"><a href="#SystemSetup-544"><span class="linenos"> 544</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-545"><a href="#SystemSetup-545"><span class="linenos"> 545</span></a>
</span><span id="SystemSetup-546"><a href="#SystemSetup-546"><span class="linenos"> 546</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_plymouth_splash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-547"><a href="#SystemSetup-547"><span class="linenos"> 547</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-548"><a href="#SystemSetup-548"><span class="linenos"> 548</span></a><span class="sd">        Setup the KIWI configured splash theme as default</span>
</span><span id="SystemSetup-549"><a href="#SystemSetup-549"><span class="linenos"> 549</span></a>
</span><span id="SystemSetup-550"><a href="#SystemSetup-550"><span class="linenos"> 550</span></a><span class="sd">        The method uses the plymouth-set-default-theme tool to setup the</span>
</span><span id="SystemSetup-551"><a href="#SystemSetup-551"><span class="linenos"> 551</span></a><span class="sd">        theme for the plymouth splash system. Only in case the tool could</span>
</span><span id="SystemSetup-552"><a href="#SystemSetup-552"><span class="linenos"> 552</span></a><span class="sd">        be found in the image root, it is assumed plymouth splash is in</span>
</span><span id="SystemSetup-553"><a href="#SystemSetup-553"><span class="linenos"> 553</span></a><span class="sd">        use and the tool is called in a chroot operation</span>
</span><span id="SystemSetup-554"><a href="#SystemSetup-554"><span class="linenos"> 554</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-555"><a href="#SystemSetup-555"><span class="linenos"> 555</span></a>        <span class="n">theme_setup</span> <span class="o">=</span> <span class="s1">&#39;plymouth-set-default-theme&#39;</span>
</span><span id="SystemSetup-556"><a href="#SystemSetup-556"><span class="linenos"> 556</span></a>        <span class="k">if</span> <span class="n">Path</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">theme_setup</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">):</span>
</span><span id="SystemSetup-557"><a href="#SystemSetup-557"><span class="linenos"> 557</span></a>            <span class="k">for</span> <span class="n">preferences</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_preferences_sections</span><span class="p">():</span>
</span><span id="SystemSetup-558"><a href="#SystemSetup-558"><span class="linenos"> 558</span></a>                <span class="n">splash_section_content</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">get_bootsplash_theme</span><span class="p">()</span>
</span><span id="SystemSetup-559"><a href="#SystemSetup-559"><span class="linenos"> 559</span></a>                <span class="k">if</span> <span class="n">splash_section_content</span><span class="p">:</span>
</span><span id="SystemSetup-560"><a href="#SystemSetup-560"><span class="linenos"> 560</span></a>                    <span class="n">splash_theme</span> <span class="o">=</span> <span class="n">splash_section_content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SystemSetup-561"><a href="#SystemSetup-561"><span class="linenos"> 561</span></a>                    <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-562"><a href="#SystemSetup-562"><span class="linenos"> 562</span></a>                        <span class="p">[</span><span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">theme_setup</span><span class="p">,</span> <span class="n">splash_theme</span><span class="p">]</span>
</span><span id="SystemSetup-563"><a href="#SystemSetup-563"><span class="linenos"> 563</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-564"><a href="#SystemSetup-564"><span class="linenos"> 564</span></a>
</span><span id="SystemSetup-565"><a href="#SystemSetup-565"><span class="linenos"> 565</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_image_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-566"><a href="#SystemSetup-566"><span class="linenos"> 566</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-567"><a href="#SystemSetup-567"><span class="linenos"> 567</span></a><span class="sd">        Create etc/ImageID identifier file</span>
</span><span id="SystemSetup-568"><a href="#SystemSetup-568"><span class="linenos"> 568</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-569"><a href="#SystemSetup-569"><span class="linenos"> 569</span></a>        <span class="n">image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
</span><span id="SystemSetup-570"><a href="#SystemSetup-570"><span class="linenos"> 570</span></a>        <span class="k">if</span> <span class="n">image_id</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc&#39;</span><span class="p">):</span>
</span><span id="SystemSetup-571"><a href="#SystemSetup-571"><span class="linenos"> 571</span></a>            <span class="n">image_id_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/ImageID&#39;</span>
</span><span id="SystemSetup-572"><a href="#SystemSetup-572"><span class="linenos"> 572</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-573"><a href="#SystemSetup-573"><span class="linenos"> 573</span></a>                <span class="s1">&#39;Creating image identifier: </span><span class="si">{0}</span><span class="s1"> in </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-574"><a href="#SystemSetup-574"><span class="linenos"> 574</span></a>                    <span class="n">image_id</span><span class="p">,</span> <span class="n">image_id_file</span>
</span><span id="SystemSetup-575"><a href="#SystemSetup-575"><span class="linenos"> 575</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-576"><a href="#SystemSetup-576"><span class="linenos"> 576</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-577"><a href="#SystemSetup-577"><span class="linenos"> 577</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_id_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">identifier</span><span class="p">:</span>
</span><span id="SystemSetup-578"><a href="#SystemSetup-578"><span class="linenos"> 578</span></a>                <span class="n">identifier</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">))</span>
</span><span id="SystemSetup-579"><a href="#SystemSetup-579"><span class="linenos"> 579</span></a>
</span><span id="SystemSetup-580"><a href="#SystemSetup-580"><span class="linenos"> 580</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_selinux_file_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">security_context_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-581"><a href="#SystemSetup-581"><span class="linenos"> 581</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-582"><a href="#SystemSetup-582"><span class="linenos"> 582</span></a><span class="sd">        Initialize the security context fields (extended attributes)</span>
</span><span id="SystemSetup-583"><a href="#SystemSetup-583"><span class="linenos"> 583</span></a><span class="sd">        on the files matching the security_context_file</span>
</span><span id="SystemSetup-584"><a href="#SystemSetup-584"><span class="linenos"> 584</span></a>
</span><span id="SystemSetup-585"><a href="#SystemSetup-585"><span class="linenos"> 585</span></a><span class="sd">        :param str security_context_file: path file name</span>
</span><span id="SystemSetup-586"><a href="#SystemSetup-586"><span class="linenos"> 586</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-587"><a href="#SystemSetup-587"><span class="linenos"> 587</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing SELinux file security contexts&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-588"><a href="#SystemSetup-588"><span class="linenos"> 588</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
</span><span id="SystemSetup-589"><a href="#SystemSetup-589"><span class="linenos"> 589</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;System is read-only, security context unchanged&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-590"><a href="#SystemSetup-590"><span class="linenos"> 590</span></a>            <span class="k">return</span>
</span><span id="SystemSetup-591"><a href="#SystemSetup-591"><span class="linenos"> 591</span></a>        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SystemSetup-592"><a href="#SystemSetup-592"><span class="linenos"> 592</span></a>        <span class="k">for</span> <span class="n">devname</span> <span class="ow">in</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_exclude_list_for_non_physical_devices</span><span class="p">():</span>
</span><span id="SystemSetup-593"><a href="#SystemSetup-593"><span class="linenos"> 593</span></a>            <span class="n">exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-e&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-594"><a href="#SystemSetup-594"><span class="linenos"> 594</span></a>            <span class="n">exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">devname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-595"><a href="#SystemSetup-595"><span class="linenos"> 595</span></a>        <span class="c1"># setfiles doesn&#39;t come with a stable command API and older versions</span>
</span><span id="SystemSetup-596"><a href="#SystemSetup-596"><span class="linenos"> 596</span></a>        <span class="c1"># needs a different invocation syntax. On older versions the usage</span>
</span><span id="SystemSetup-597"><a href="#SystemSetup-597"><span class="linenos"> 597</span></a>        <span class="c1"># information explicitly lists &quot;setfiles -c policyfile&quot; which is not</span>
</span><span id="SystemSetup-598"><a href="#SystemSetup-598"><span class="linenos"> 598</span></a>        <span class="c1"># present in newer versions. As setfiles doesn&#39;t come with a simple</span>
</span><span id="SystemSetup-599"><a href="#SystemSetup-599"><span class="linenos"> 599</span></a>        <span class="c1"># --version option, checking for this extra element in the usage</span>
</span><span id="SystemSetup-600"><a href="#SystemSetup-600"><span class="linenos"> 600</span></a>        <span class="c1"># was the only pointer I could come up with to differentiate the</span>
</span><span id="SystemSetup-601"><a href="#SystemSetup-601"><span class="linenos"> 601</span></a>        <span class="c1"># call options.</span>
</span><span id="SystemSetup-602"><a href="#SystemSetup-602"><span class="linenos"> 602</span></a>        <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="SystemSetup-603"><a href="#SystemSetup-603"><span class="linenos"> 603</span></a>            <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span> <span class="s1">&#39;setfiles -c policyfile&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;--help&#39;</span><span class="p">],</span>
</span><span id="SystemSetup-604"><a href="#SystemSetup-604"><span class="linenos"> 604</span></a>            <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span>
</span><span id="SystemSetup-605"><a href="#SystemSetup-605"><span class="linenos"> 605</span></a>        <span class="p">):</span>
</span><span id="SystemSetup-606"><a href="#SystemSetup-606"><span class="linenos"> 606</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-607"><a href="#SystemSetup-607"><span class="linenos"> 607</span></a>                <span class="p">[</span>
</span><span id="SystemSetup-608"><a href="#SystemSetup-608"><span class="linenos"> 608</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-609"><a href="#SystemSetup-609"><span class="linenos"> 609</span></a>                    <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_selinux_policy_file</span><span class="p">(</span>
</span><span id="SystemSetup-610"><a href="#SystemSetup-610"><span class="linenos"> 610</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_selinux_policy</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;targeted&#39;</span>
</span><span id="SystemSetup-611"><a href="#SystemSetup-611"><span class="linenos"> 611</span></a>                    <span class="p">),</span> <span class="n">security_context_file</span>
</span><span id="SystemSetup-612"><a href="#SystemSetup-612"><span class="linenos"> 612</span></a>                <span class="p">]</span>
</span><span id="SystemSetup-613"><a href="#SystemSetup-613"><span class="linenos"> 613</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-614"><a href="#SystemSetup-614"><span class="linenos"> 614</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-615"><a href="#SystemSetup-615"><span class="linenos"> 615</span></a>                <span class="p">[</span>
</span><span id="SystemSetup-616"><a href="#SystemSetup-616"><span class="linenos"> 616</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-617"><a href="#SystemSetup-617"><span class="linenos"> 617</span></a>                    <span class="s1">&#39;-F&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span>
</span><span id="SystemSetup-618"><a href="#SystemSetup-618"><span class="linenos"> 618</span></a>                <span class="p">]</span> <span class="o">+</span> <span class="n">exclude</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="SystemSetup-619"><a href="#SystemSetup-619"><span class="linenos"> 619</span></a>                    <span class="n">security_context_file</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span>
</span><span id="SystemSetup-620"><a href="#SystemSetup-620"><span class="linenos"> 620</span></a>                <span class="p">]</span>
</span><span id="SystemSetup-621"><a href="#SystemSetup-621"><span class="linenos"> 621</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-622"><a href="#SystemSetup-622"><span class="linenos"> 622</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-623"><a href="#SystemSetup-623"><span class="linenos"> 623</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-624"><a href="#SystemSetup-624"><span class="linenos"> 624</span></a>                <span class="p">[</span>
</span><span id="SystemSetup-625"><a href="#SystemSetup-625"><span class="linenos"> 625</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-626"><a href="#SystemSetup-626"><span class="linenos"> 626</span></a>                    <span class="s1">&#39;-T0&#39;</span><span class="p">,</span> <span class="s1">&#39;-F&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_selinux_policy_file</span><span class="p">(</span>
</span><span id="SystemSetup-627"><a href="#SystemSetup-627"><span class="linenos"> 627</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_selinux_policy</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;targeted&#39;</span>
</span><span id="SystemSetup-628"><a href="#SystemSetup-628"><span class="linenos"> 628</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-629"><a href="#SystemSetup-629"><span class="linenos"> 629</span></a>                <span class="p">]</span> <span class="o">+</span> <span class="n">exclude</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="SystemSetup-630"><a href="#SystemSetup-630"><span class="linenos"> 630</span></a>                    <span class="n">security_context_file</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span>
</span><span id="SystemSetup-631"><a href="#SystemSetup-631"><span class="linenos"> 631</span></a>                <span class="p">]</span>
</span><span id="SystemSetup-632"><a href="#SystemSetup-632"><span class="linenos"> 632</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-633"><a href="#SystemSetup-633"><span class="linenos"> 633</span></a>
</span><span id="SystemSetup-634"><a href="#SystemSetup-634"><span class="linenos"> 634</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_selinux_file_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-635"><a href="#SystemSetup-635"><span class="linenos"> 635</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-636"><a href="#SystemSetup-636"><span class="linenos"> 636</span></a><span class="sd">        Set SELinux file security contexts if the default context file is found</span>
</span><span id="SystemSetup-637"><a href="#SystemSetup-637"><span class="linenos"> 637</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-638"><a href="#SystemSetup-638"><span class="linenos"> 638</span></a>        <span class="n">security_context</span> <span class="o">=</span> <span class="s1">&#39;/etc/selinux/targeted/contexts/files/file_contexts&#39;</span>
</span><span id="SystemSetup-639"><a href="#SystemSetup-639"><span class="linenos"> 639</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="n">security_context</span><span class="p">):</span>
</span><span id="SystemSetup-640"><a href="#SystemSetup-640"><span class="linenos"> 640</span></a>            <span class="k">if</span> <span class="n">Path</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;setfiles&#39;</span><span class="p">,</span> <span class="n">access_mode</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">):</span>
</span><span id="SystemSetup-641"><a href="#SystemSetup-641"><span class="linenos"> 641</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">set_selinux_file_contexts</span><span class="p">(</span><span class="n">security_context</span><span class="p">)</span>
</span><span id="SystemSetup-642"><a href="#SystemSetup-642"><span class="linenos"> 642</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-643"><a href="#SystemSetup-643"><span class="linenos"> 643</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="SystemSetup-644"><a href="#SystemSetup-644"><span class="linenos"> 644</span></a>                    <span class="s1">&#39;security_context found but setfiles tool not installed&#39;</span>
</span><span id="SystemSetup-645"><a href="#SystemSetup-645"><span class="linenos"> 645</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-646"><a href="#SystemSetup-646"><span class="linenos"> 646</span></a>
</span><span id="SystemSetup-647"><a href="#SystemSetup-647"><span class="linenos"> 647</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_modprobe_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-648"><a href="#SystemSetup-648"><span class="linenos"> 648</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-649"><a href="#SystemSetup-649"><span class="linenos"> 649</span></a><span class="sd">        Export etc/modprobe.d to given root_dir</span>
</span><span id="SystemSetup-650"><a href="#SystemSetup-650"><span class="linenos"> 650</span></a>
</span><span id="SystemSetup-651"><a href="#SystemSetup-651"><span class="linenos"> 651</span></a><span class="sd">        :param str target_root_dir: path name</span>
</span><span id="SystemSetup-652"><a href="#SystemSetup-652"><span class="linenos"> 652</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-653"><a href="#SystemSetup-653"><span class="linenos"> 653</span></a>        <span class="n">modprobe_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/modprobe.d&#39;</span>
</span><span id="SystemSetup-654"><a href="#SystemSetup-654"><span class="linenos"> 654</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">modprobe_config</span><span class="p">):</span>
</span><span id="SystemSetup-655"><a href="#SystemSetup-655"><span class="linenos"> 655</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export modprobe configuration&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-656"><a href="#SystemSetup-656"><span class="linenos"> 656</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">target_root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-657"><a href="#SystemSetup-657"><span class="linenos"> 657</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataSync</span><span class="p">(</span>
</span><span id="SystemSetup-658"><a href="#SystemSetup-658"><span class="linenos"> 658</span></a>                <span class="n">modprobe_config</span><span class="p">,</span> <span class="n">target_root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/&#39;</span>
</span><span id="SystemSetup-659"><a href="#SystemSetup-659"><span class="linenos"> 659</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-660"><a href="#SystemSetup-660"><span class="linenos"> 660</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">sync_data</span><span class="p">(</span>
</span><span id="SystemSetup-661"><a href="#SystemSetup-661"><span class="linenos"> 661</span></a>                <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-a&#39;</span><span class="p">]</span>
</span><span id="SystemSetup-662"><a href="#SystemSetup-662"><span class="linenos"> 662</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-663"><a href="#SystemSetup-663"><span class="linenos"> 663</span></a>
</span><span id="SystemSetup-664"><a href="#SystemSetup-664"><span class="linenos"> 664</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_flake_pilot_system_file_list</span><span class="p">(</span>
</span><span id="SystemSetup-665"><a href="#SystemSetup-665"><span class="linenos"> 665</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="SystemSetup-666"><a href="#SystemSetup-666"><span class="linenos"> 666</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SystemSetup-667"><a href="#SystemSetup-667"><span class="linenos"> 667</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-668"><a href="#SystemSetup-668"><span class="linenos"> 668</span></a><span class="sd">        Export image package file list to the target_dir</span>
</span><span id="SystemSetup-669"><a href="#SystemSetup-669"><span class="linenos"> 669</span></a><span class="sd">        and filename</span>
</span><span id="SystemSetup-670"><a href="#SystemSetup-670"><span class="linenos"> 670</span></a>
</span><span id="SystemSetup-671"><a href="#SystemSetup-671"><span class="linenos"> 671</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="SystemSetup-672"><a href="#SystemSetup-672"><span class="linenos"> 672</span></a><span class="sd">        :param str file_name: file name</span>
</span><span id="SystemSetup-673"><a href="#SystemSetup-673"><span class="linenos"> 673</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-674"><a href="#SystemSetup-674"><span class="linenos"> 674</span></a>        <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="SystemSetup-675"><a href="#SystemSetup-675"><span class="linenos"> 675</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="SystemSetup-676"><a href="#SystemSetup-676"><span class="linenos"> 676</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-677"><a href="#SystemSetup-677"><span class="linenos"> 677</span></a>        <span class="n">result_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-678"><a href="#SystemSetup-678"><span class="linenos"> 678</span></a>        <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-679"><a href="#SystemSetup-679"><span class="linenos"> 679</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_flake_pilot_system_file_list</span><span class="p">(</span><span class="n">result_file</span><span class="p">)</span>
</span><span id="SystemSetup-680"><a href="#SystemSetup-680"><span class="linenos"> 680</span></a>            <span class="k">return</span> <span class="n">result_file</span>
</span><span id="SystemSetup-681"><a href="#SystemSetup-681"><span class="linenos"> 681</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span><span id="SystemSetup-682"><a href="#SystemSetup-682"><span class="linenos"> 682</span></a>
</span><span id="SystemSetup-683"><a href="#SystemSetup-683"><span class="linenos"> 683</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_package_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SystemSetup-684"><a href="#SystemSetup-684"><span class="linenos"> 684</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-685"><a href="#SystemSetup-685"><span class="linenos"> 685</span></a><span class="sd">        Export image package list as metadata reference</span>
</span><span id="SystemSetup-686"><a href="#SystemSetup-686"><span class="linenos"> 686</span></a><span class="sd">        used by the open buildservice</span>
</span><span id="SystemSetup-687"><a href="#SystemSetup-687"><span class="linenos"> 687</span></a>
</span><span id="SystemSetup-688"><a href="#SystemSetup-688"><span class="linenos"> 688</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="SystemSetup-689"><a href="#SystemSetup-689"><span class="linenos"> 689</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-690"><a href="#SystemSetup-690"><span class="linenos"> 690</span></a>        <span class="n">image_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_image_version</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;unspecified&#39;</span>
</span><span id="SystemSetup-691"><a href="#SystemSetup-691"><span class="linenos"> 691</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-692"><a href="#SystemSetup-692"><span class="linenos"> 692</span></a>            <span class="p">[</span>
</span><span id="SystemSetup-693"><a href="#SystemSetup-693"><span class="linenos"> 693</span></a>                <span class="n">target_dir</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-694"><a href="#SystemSetup-694"><span class="linenos"> 694</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
</span><span id="SystemSetup-695"><a href="#SystemSetup-695"><span class="linenos"> 695</span></a>                <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span>
</span><span id="SystemSetup-696"><a href="#SystemSetup-696"><span class="linenos"> 696</span></a>                <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">image_version</span><span class="p">,</span>
</span><span id="SystemSetup-697"><a href="#SystemSetup-697"><span class="linenos"> 697</span></a>                <span class="s1">&#39;.packages&#39;</span>
</span><span id="SystemSetup-698"><a href="#SystemSetup-698"><span class="linenos"> 698</span></a>            <span class="p">]</span>
</span><span id="SystemSetup-699"><a href="#SystemSetup-699"><span class="linenos"> 699</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-700"><a href="#SystemSetup-700"><span class="linenos"> 700</span></a>        <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="SystemSetup-701"><a href="#SystemSetup-701"><span class="linenos"> 701</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="SystemSetup-702"><a href="#SystemSetup-702"><span class="linenos"> 702</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-703"><a href="#SystemSetup-703"><span class="linenos"> 703</span></a>        <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-704"><a href="#SystemSetup-704"><span class="linenos"> 704</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_package_list</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup-705"><a href="#SystemSetup-705"><span class="linenos"> 705</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup-706"><a href="#SystemSetup-706"><span class="linenos"> 706</span></a>        <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;dpkg&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-707"><a href="#SystemSetup-707"><span class="linenos"> 707</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_deb_package_list</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup-708"><a href="#SystemSetup-708"><span class="linenos"> 708</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup-709"><a href="#SystemSetup-709"><span class="linenos"> 709</span></a>        <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;pacman&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-710"><a href="#SystemSetup-710"><span class="linenos"> 710</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_pacman_package_list</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup-711"><a href="#SystemSetup-711"><span class="linenos"> 711</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup-712"><a href="#SystemSetup-712"><span class="linenos"> 712</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span><span id="SystemSetup-713"><a href="#SystemSetup-713"><span class="linenos"> 713</span></a>
</span><span id="SystemSetup-714"><a href="#SystemSetup-714"><span class="linenos"> 714</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_package_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SystemSetup-715"><a href="#SystemSetup-715"><span class="linenos"> 715</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-716"><a href="#SystemSetup-716"><span class="linenos"> 716</span></a><span class="sd">        Export image package changelog for comparision of</span>
</span><span id="SystemSetup-717"><a href="#SystemSetup-717"><span class="linenos"> 717</span></a><span class="sd">        actual changes of the installed packages</span>
</span><span id="SystemSetup-718"><a href="#SystemSetup-718"><span class="linenos"> 718</span></a>
</span><span id="SystemSetup-719"><a href="#SystemSetup-719"><span class="linenos"> 719</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="SystemSetup-720"><a href="#SystemSetup-720"><span class="linenos"> 720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-721"><a href="#SystemSetup-721"><span class="linenos"> 721</span></a>        <span class="n">image_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_image_version</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;unspecified&#39;</span>
</span><span id="SystemSetup-722"><a href="#SystemSetup-722"><span class="linenos"> 722</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_config</span><span class="o">.</span><span class="n">get_package_changes</span><span class="p">():</span>
</span><span id="SystemSetup-723"><a href="#SystemSetup-723"><span class="linenos"> 723</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-724"><a href="#SystemSetup-724"><span class="linenos"> 724</span></a>                <span class="p">[</span>
</span><span id="SystemSetup-725"><a href="#SystemSetup-725"><span class="linenos"> 725</span></a>                    <span class="n">target_dir</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-726"><a href="#SystemSetup-726"><span class="linenos"> 726</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
</span><span id="SystemSetup-727"><a href="#SystemSetup-727"><span class="linenos"> 727</span></a>                    <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span>
</span><span id="SystemSetup-728"><a href="#SystemSetup-728"><span class="linenos"> 728</span></a>                    <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">image_version</span><span class="p">,</span>
</span><span id="SystemSetup-729"><a href="#SystemSetup-729"><span class="linenos"> 729</span></a>                    <span class="s1">&#39;.changes&#39;</span>
</span><span id="SystemSetup-730"><a href="#SystemSetup-730"><span class="linenos"> 730</span></a>                <span class="p">]</span>
</span><span id="SystemSetup-731"><a href="#SystemSetup-731"><span class="linenos"> 731</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-732"><a href="#SystemSetup-732"><span class="linenos"> 732</span></a>            <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="SystemSetup-733"><a href="#SystemSetup-733"><span class="linenos"> 733</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="SystemSetup-734"><a href="#SystemSetup-734"><span class="linenos"> 734</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-735"><a href="#SystemSetup-735"><span class="linenos"> 735</span></a>            <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-736"><a href="#SystemSetup-736"><span class="linenos"> 736</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_package_changes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup-737"><a href="#SystemSetup-737"><span class="linenos"> 737</span></a>                <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup-738"><a href="#SystemSetup-738"><span class="linenos"> 738</span></a>            <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;dpkg&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-739"><a href="#SystemSetup-739"><span class="linenos"> 739</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_export_deb_package_changes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup-740"><a href="#SystemSetup-740"><span class="linenos"> 740</span></a>                <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup-741"><a href="#SystemSetup-741"><span class="linenos"> 741</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span><span id="SystemSetup-742"><a href="#SystemSetup-742"><span class="linenos"> 742</span></a>
</span><span id="SystemSetup-743"><a href="#SystemSetup-743"><span class="linenos"> 743</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_package_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SystemSetup-744"><a href="#SystemSetup-744"><span class="linenos"> 744</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-745"><a href="#SystemSetup-745"><span class="linenos"> 745</span></a><span class="sd">        Export package verification result as metadata reference</span>
</span><span id="SystemSetup-746"><a href="#SystemSetup-746"><span class="linenos"> 746</span></a><span class="sd">        used by the open buildservice</span>
</span><span id="SystemSetup-747"><a href="#SystemSetup-747"><span class="linenos"> 747</span></a>
</span><span id="SystemSetup-748"><a href="#SystemSetup-748"><span class="linenos"> 748</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="SystemSetup-749"><a href="#SystemSetup-749"><span class="linenos"> 749</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-750"><a href="#SystemSetup-750"><span class="linenos"> 750</span></a>        <span class="n">image_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_image_version</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;unspecified&#39;</span>
</span><span id="SystemSetup-751"><a href="#SystemSetup-751"><span class="linenos"> 751</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-752"><a href="#SystemSetup-752"><span class="linenos"> 752</span></a>            <span class="p">[</span>
</span><span id="SystemSetup-753"><a href="#SystemSetup-753"><span class="linenos"> 753</span></a>                <span class="n">target_dir</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-754"><a href="#SystemSetup-754"><span class="linenos"> 754</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
</span><span id="SystemSetup-755"><a href="#SystemSetup-755"><span class="linenos"> 755</span></a>                <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span>
</span><span id="SystemSetup-756"><a href="#SystemSetup-756"><span class="linenos"> 756</span></a>                <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">image_version</span><span class="p">,</span>
</span><span id="SystemSetup-757"><a href="#SystemSetup-757"><span class="linenos"> 757</span></a>                <span class="s1">&#39;.verified&#39;</span>
</span><span id="SystemSetup-758"><a href="#SystemSetup-758"><span class="linenos"> 758</span></a>            <span class="p">]</span>
</span><span id="SystemSetup-759"><a href="#SystemSetup-759"><span class="linenos"> 759</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-760"><a href="#SystemSetup-760"><span class="linenos"> 760</span></a>        <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="SystemSetup-761"><a href="#SystemSetup-761"><span class="linenos"> 761</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="SystemSetup-762"><a href="#SystemSetup-762"><span class="linenos"> 762</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-763"><a href="#SystemSetup-763"><span class="linenos"> 763</span></a>        <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-764"><a href="#SystemSetup-764"><span class="linenos"> 764</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_package_verification</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup-765"><a href="#SystemSetup-765"><span class="linenos"> 765</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup-766"><a href="#SystemSetup-766"><span class="linenos"> 766</span></a>        <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;dpkg&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-767"><a href="#SystemSetup-767"><span class="linenos"> 767</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_deb_package_verification</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup-768"><a href="#SystemSetup-768"><span class="linenos"> 768</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup-769"><a href="#SystemSetup-769"><span class="linenos"> 769</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span><span id="SystemSetup-770"><a href="#SystemSetup-770"><span class="linenos"> 770</span></a>
</span><span id="SystemSetup-771"><a href="#SystemSetup-771"><span class="linenos"> 771</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_disk_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-772"><a href="#SystemSetup-772"><span class="linenos"> 772</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-773"><a href="#SystemSetup-773"><span class="linenos"> 773</span></a><span class="sd">        Call disk.sh script chrooted</span>
</span><span id="SystemSetup-774"><a href="#SystemSetup-774"><span class="linenos"> 774</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-775"><a href="#SystemSetup-775"><span class="linenos"> 775</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup-776"><a href="#SystemSetup-776"><span class="linenos"> 776</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_DISK_SYNC_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup-777"><a href="#SystemSetup-777"><span class="linenos"> 777</span></a>            <span class="n">root_is_mountpoint</span><span class="o">=</span><span class="kc">True</span>
</span><span id="SystemSetup-778"><a href="#SystemSetup-778"><span class="linenos"> 778</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-779"><a href="#SystemSetup-779"><span class="linenos"> 779</span></a>
</span><span id="SystemSetup-780"><a href="#SystemSetup-780"><span class="linenos"> 780</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_pre_disk_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-781"><a href="#SystemSetup-781"><span class="linenos"> 781</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-782"><a href="#SystemSetup-782"><span class="linenos"> 782</span></a><span class="sd">        Call pre_disk_sync.sh script chrooted</span>
</span><span id="SystemSetup-783"><a href="#SystemSetup-783"><span class="linenos"> 783</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-784"><a href="#SystemSetup-784"><span class="linenos"> 784</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup-785"><a href="#SystemSetup-785"><span class="linenos"> 785</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">PRE_DISK_SYNC_SCRIPT</span>
</span><span id="SystemSetup-786"><a href="#SystemSetup-786"><span class="linenos"> 786</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-787"><a href="#SystemSetup-787"><span class="linenos"> 787</span></a>
</span><span id="SystemSetup-788"><a href="#SystemSetup-788"><span class="linenos"> 788</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_post_bootstrap_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-789"><a href="#SystemSetup-789"><span class="linenos"> 789</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-790"><a href="#SystemSetup-790"><span class="linenos"> 790</span></a><span class="sd">        Call post_bootstrap.sh script chrooted</span>
</span><span id="SystemSetup-791"><a href="#SystemSetup-791"><span class="linenos"> 791</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-792"><a href="#SystemSetup-792"><span class="linenos"> 792</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup-793"><a href="#SystemSetup-793"><span class="linenos"> 793</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_BOOTSTRAP_SCRIPT</span>
</span><span id="SystemSetup-794"><a href="#SystemSetup-794"><span class="linenos"> 794</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-795"><a href="#SystemSetup-795"><span class="linenos"> 795</span></a>
</span><span id="SystemSetup-796"><a href="#SystemSetup-796"><span class="linenos"> 796</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_config_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-797"><a href="#SystemSetup-797"><span class="linenos"> 797</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-798"><a href="#SystemSetup-798"><span class="linenos"> 798</span></a><span class="sd">        Call config.sh script chrooted</span>
</span><span id="SystemSetup-799"><a href="#SystemSetup-799"><span class="linenos"> 799</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-800"><a href="#SystemSetup-800"><span class="linenos"> 800</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup-801"><a href="#SystemSetup-801"><span class="linenos"> 801</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_SCRIPT</span>
</span><span id="SystemSetup-802"><a href="#SystemSetup-802"><span class="linenos"> 802</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-803"><a href="#SystemSetup-803"><span class="linenos"> 803</span></a>
</span><span id="SystemSetup-804"><a href="#SystemSetup-804"><span class="linenos"> 804</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_config_overlay_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-805"><a href="#SystemSetup-805"><span class="linenos"> 805</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-806"><a href="#SystemSetup-806"><span class="linenos"> 806</span></a><span class="sd">        Call config-overlay.sh script chrooted</span>
</span><span id="SystemSetup-807"><a href="#SystemSetup-807"><span class="linenos"> 807</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-808"><a href="#SystemSetup-808"><span class="linenos"> 808</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup-809"><a href="#SystemSetup-809"><span class="linenos"> 809</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_OVERLAY_SCRIPT</span>
</span><span id="SystemSetup-810"><a href="#SystemSetup-810"><span class="linenos"> 810</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-811"><a href="#SystemSetup-811"><span class="linenos"> 811</span></a>
</span><span id="SystemSetup-812"><a href="#SystemSetup-812"><span class="linenos"> 812</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_config_host_overlay_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-813"><a href="#SystemSetup-813"><span class="linenos"> 813</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-814"><a href="#SystemSetup-814"><span class="linenos"> 814</span></a><span class="sd">        Call config-host-overlay.sh script _NON_ chrooted</span>
</span><span id="SystemSetup-815"><a href="#SystemSetup-815"><span class="linenos"> 815</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-816"><a href="#SystemSetup-816"><span class="linenos"> 816</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script_no_chroot</span><span class="p">(</span>
</span><span id="SystemSetup-817"><a href="#SystemSetup-817"><span class="linenos"> 817</span></a>            <span class="n">name</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_HOST_PREPARE_OVERLAY_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup-818"><a href="#SystemSetup-818"><span class="linenos"> 818</span></a>            <span class="n">option_list</span><span class="o">=</span><span class="p">[],</span>
</span><span id="SystemSetup-819"><a href="#SystemSetup-819"><span class="linenos"> 819</span></a>            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span>
</span><span id="SystemSetup-820"><a href="#SystemSetup-820"><span class="linenos"> 820</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-821"><a href="#SystemSetup-821"><span class="linenos"> 821</span></a>
</span><span id="SystemSetup-822"><a href="#SystemSetup-822"><span class="linenos"> 822</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_image_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-823"><a href="#SystemSetup-823"><span class="linenos"> 823</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-824"><a href="#SystemSetup-824"><span class="linenos"> 824</span></a><span class="sd">        Call images.sh script chrooted</span>
</span><span id="SystemSetup-825"><a href="#SystemSetup-825"><span class="linenos"> 825</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-826"><a href="#SystemSetup-826"><span class="linenos"> 826</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup-827"><a href="#SystemSetup-827"><span class="linenos"> 827</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">PRE_CREATE_SCRIPT</span>
</span><span id="SystemSetup-828"><a href="#SystemSetup-828"><span class="linenos"> 828</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-829"><a href="#SystemSetup-829"><span class="linenos"> 829</span></a>
</span><span id="SystemSetup-830"><a href="#SystemSetup-830"><span class="linenos"> 830</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_edit_boot_config_script</span><span class="p">(</span>
</span><span id="SystemSetup-831"><a href="#SystemSetup-831"><span class="linenos"> 831</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">filesystem</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">boot_part_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SystemSetup-832"><a href="#SystemSetup-832"><span class="linenos"> 832</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-833"><a href="#SystemSetup-833"><span class="linenos"> 833</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-834"><a href="#SystemSetup-834"><span class="linenos"> 834</span></a><span class="sd">        Call configured editbootconfig script _NON_ chrooted</span>
</span><span id="SystemSetup-835"><a href="#SystemSetup-835"><span class="linenos"> 835</span></a>
</span><span id="SystemSetup-836"><a href="#SystemSetup-836"><span class="linenos"> 836</span></a><span class="sd">        Pass the boot filesystem name and the partition number of</span>
</span><span id="SystemSetup-837"><a href="#SystemSetup-837"><span class="linenos"> 837</span></a><span class="sd">        the boot partition as parameters to the call</span>
</span><span id="SystemSetup-838"><a href="#SystemSetup-838"><span class="linenos"> 838</span></a>
</span><span id="SystemSetup-839"><a href="#SystemSetup-839"><span class="linenos"> 839</span></a><span class="sd">        :param str filesystem: boot filesystem name</span>
</span><span id="SystemSetup-840"><a href="#SystemSetup-840"><span class="linenos"> 840</span></a><span class="sd">        :param int boot_part_id: boot partition number</span>
</span><span id="SystemSetup-841"><a href="#SystemSetup-841"><span class="linenos"> 841</span></a><span class="sd">        :param str working_directory: directory name</span>
</span><span id="SystemSetup-842"><a href="#SystemSetup-842"><span class="linenos"> 842</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-843"><a href="#SystemSetup-843"><span class="linenos"> 843</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script_no_chroot</span><span class="p">(</span>
</span><span id="SystemSetup-844"><a href="#SystemSetup-844"><span class="linenos"> 844</span></a>            <span class="n">name</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">EDIT_BOOT_CONFIG_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup-845"><a href="#SystemSetup-845"><span class="linenos"> 845</span></a>            <span class="n">option_list</span><span class="o">=</span><span class="p">[</span><span class="n">filesystem</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">boot_part_id</span><span class="p">)],</span>
</span><span id="SystemSetup-846"><a href="#SystemSetup-846"><span class="linenos"> 846</span></a>            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span>
</span><span id="SystemSetup-847"><a href="#SystemSetup-847"><span class="linenos"> 847</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-848"><a href="#SystemSetup-848"><span class="linenos"> 848</span></a>
</span><span id="SystemSetup-849"><a href="#SystemSetup-849"><span class="linenos"> 849</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_edit_boot_install_script</span><span class="p">(</span>
</span><span id="SystemSetup-850"><a href="#SystemSetup-850"><span class="linenos"> 850</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">diskname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">boot_device_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SystemSetup-851"><a href="#SystemSetup-851"><span class="linenos"> 851</span></a>        <span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SystemSetup-852"><a href="#SystemSetup-852"><span class="linenos"> 852</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-853"><a href="#SystemSetup-853"><span class="linenos"> 853</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-854"><a href="#SystemSetup-854"><span class="linenos"> 854</span></a><span class="sd">        Call configured editbootinstall script _NON_ chrooted</span>
</span><span id="SystemSetup-855"><a href="#SystemSetup-855"><span class="linenos"> 855</span></a>
</span><span id="SystemSetup-856"><a href="#SystemSetup-856"><span class="linenos"> 856</span></a><span class="sd">        Pass the disk file name and the device node of the boot partition</span>
</span><span id="SystemSetup-857"><a href="#SystemSetup-857"><span class="linenos"> 857</span></a><span class="sd">        as parameters to the call</span>
</span><span id="SystemSetup-858"><a href="#SystemSetup-858"><span class="linenos"> 858</span></a>
</span><span id="SystemSetup-859"><a href="#SystemSetup-859"><span class="linenos"> 859</span></a><span class="sd">        :param str diskname: file path name</span>
</span><span id="SystemSetup-860"><a href="#SystemSetup-860"><span class="linenos"> 860</span></a><span class="sd">        :param str boot_device_node: boot device node name</span>
</span><span id="SystemSetup-861"><a href="#SystemSetup-861"><span class="linenos"> 861</span></a><span class="sd">        :param str working_directory: directory name</span>
</span><span id="SystemSetup-862"><a href="#SystemSetup-862"><span class="linenos"> 862</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-863"><a href="#SystemSetup-863"><span class="linenos"> 863</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script_no_chroot</span><span class="p">(</span>
</span><span id="SystemSetup-864"><a href="#SystemSetup-864"><span class="linenos"> 864</span></a>            <span class="n">name</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">EDIT_BOOT_INSTALL_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup-865"><a href="#SystemSetup-865"><span class="linenos"> 865</span></a>            <span class="n">option_list</span><span class="o">=</span><span class="p">[</span><span class="n">diskname</span><span class="p">,</span> <span class="n">boot_device_node</span><span class="p">],</span>
</span><span id="SystemSetup-866"><a href="#SystemSetup-866"><span class="linenos"> 866</span></a>            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span>
</span><span id="SystemSetup-867"><a href="#SystemSetup-867"><span class="linenos"> 867</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-868"><a href="#SystemSetup-868"><span class="linenos"> 868</span></a>
</span><span id="SystemSetup-869"><a href="#SystemSetup-869"><span class="linenos"> 869</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_system_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-870"><a href="#SystemSetup-870"><span class="linenos"> 870</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-871"><a href="#SystemSetup-871"><span class="linenos"> 871</span></a><span class="sd">        Create file list of packages to be used by flake-pilot</span>
</span><span id="SystemSetup-872"><a href="#SystemSetup-872"><span class="linenos"> 872</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-873"><a href="#SystemSetup-873"><span class="linenos"> 873</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_provide_system_files</span><span class="p">():</span>
</span><span id="SystemSetup-874"><a href="#SystemSetup-874"><span class="linenos"> 874</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">export_flake_pilot_system_file_list</span><span class="p">(</span>
</span><span id="SystemSetup-875"><a href="#SystemSetup-875"><span class="linenos"> 875</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_system_files_name</span><span class="p">()</span>
</span><span id="SystemSetup-876"><a href="#SystemSetup-876"><span class="linenos"> 876</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-877"><a href="#SystemSetup-877"><span class="linenos"> 877</span></a>
</span><span id="SystemSetup-878"><a href="#SystemSetup-878"><span class="linenos"> 878</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_fstab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fstab</span><span class="p">:</span> <span class="n">Fstab</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-879"><a href="#SystemSetup-879"><span class="linenos"> 879</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-880"><a href="#SystemSetup-880"><span class="linenos"> 880</span></a><span class="sd">        Create etc/fstab from given Fstab object</span>
</span><span id="SystemSetup-881"><a href="#SystemSetup-881"><span class="linenos"> 881</span></a>
</span><span id="SystemSetup-882"><a href="#SystemSetup-882"><span class="linenos"> 882</span></a><span class="sd">        Custom fstab modifications are possible and handled</span>
</span><span id="SystemSetup-883"><a href="#SystemSetup-883"><span class="linenos"> 883</span></a><span class="sd">        in the following order:</span>
</span><span id="SystemSetup-884"><a href="#SystemSetup-884"><span class="linenos"> 884</span></a>
</span><span id="SystemSetup-885"><a href="#SystemSetup-885"><span class="linenos"> 885</span></a><span class="sd">        1. Look for an optional fstab.append file which allows</span>
</span><span id="SystemSetup-886"><a href="#SystemSetup-886"><span class="linenos"> 886</span></a><span class="sd">           to append custom fstab entries to the final fstab. Once</span>
</span><span id="SystemSetup-887"><a href="#SystemSetup-887"><span class="linenos"> 887</span></a><span class="sd">           embedded the fstab.append file will be deleted</span>
</span><span id="SystemSetup-888"><a href="#SystemSetup-888"><span class="linenos"> 888</span></a>
</span><span id="SystemSetup-889"><a href="#SystemSetup-889"><span class="linenos"> 889</span></a><span class="sd">        2. Look for an optional fstab.patch file which allows</span>
</span><span id="SystemSetup-890"><a href="#SystemSetup-890"><span class="linenos"> 890</span></a><span class="sd">           to patch the current contents of the fstab file with</span>
</span><span id="SystemSetup-891"><a href="#SystemSetup-891"><span class="linenos"> 891</span></a><span class="sd">           a given patch file. Once patched the fstab.patch file will</span>
</span><span id="SystemSetup-892"><a href="#SystemSetup-892"><span class="linenos"> 892</span></a><span class="sd">           be deleted</span>
</span><span id="SystemSetup-893"><a href="#SystemSetup-893"><span class="linenos"> 893</span></a>
</span><span id="SystemSetup-894"><a href="#SystemSetup-894"><span class="linenos"> 894</span></a><span class="sd">        3. Look for an optional fstab.script file which is called</span>
</span><span id="SystemSetup-895"><a href="#SystemSetup-895"><span class="linenos"> 895</span></a><span class="sd">           chrooted for the purpose of updating the fstab file as</span>
</span><span id="SystemSetup-896"><a href="#SystemSetup-896"><span class="linenos"> 896</span></a><span class="sd">           appropriate. Note: There is no validation in place that</span>
</span><span id="SystemSetup-897"><a href="#SystemSetup-897"><span class="linenos"> 897</span></a><span class="sd">           checks if the script actually handles fstab or any other</span>
</span><span id="SystemSetup-898"><a href="#SystemSetup-898"><span class="linenos"> 898</span></a><span class="sd">           file in the image rootfs. Once called the fstab.script</span>
</span><span id="SystemSetup-899"><a href="#SystemSetup-899"><span class="linenos"> 899</span></a><span class="sd">           file will be deleted</span>
</span><span id="SystemSetup-900"><a href="#SystemSetup-900"><span class="linenos"> 900</span></a>
</span><span id="SystemSetup-901"><a href="#SystemSetup-901"><span class="linenos"> 901</span></a><span class="sd">        :param object fstab: instance of Fstab</span>
</span><span id="SystemSetup-902"><a href="#SystemSetup-902"><span class="linenos"> 902</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-903"><a href="#SystemSetup-903"><span class="linenos"> 903</span></a>        <span class="n">fstab_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab&#39;</span>
</span><span id="SystemSetup-904"><a href="#SystemSetup-904"><span class="linenos"> 904</span></a>        <span class="n">fstab_append_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab.append&#39;</span>
</span><span id="SystemSetup-905"><a href="#SystemSetup-905"><span class="linenos"> 905</span></a>        <span class="n">fstab_patch_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab.patch&#39;</span>
</span><span id="SystemSetup-906"><a href="#SystemSetup-906"><span class="linenos"> 906</span></a>        <span class="n">fstab_script_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab.script&#39;</span>
</span><span id="SystemSetup-907"><a href="#SystemSetup-907"><span class="linenos"> 907</span></a>
</span><span id="SystemSetup-908"><a href="#SystemSetup-908"><span class="linenos"> 908</span></a>        <span class="n">fstab</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">)</span>
</span><span id="SystemSetup-909"><a href="#SystemSetup-909"><span class="linenos"> 909</span></a>
</span><span id="SystemSetup-910"><a href="#SystemSetup-910"><span class="linenos"> 910</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fstab_append_file</span><span class="p">):</span>
</span><span id="SystemSetup-911"><a href="#SystemSetup-911"><span class="linenos"> 911</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fstab_io</span><span class="p">:</span>
</span><span id="SystemSetup-912"><a href="#SystemSetup-912"><span class="linenos"> 912</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fstab_append_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">append</span><span class="p">:</span>
</span><span id="SystemSetup-913"><a href="#SystemSetup-913"><span class="linenos"> 913</span></a>                    <span class="n">fstab_io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">append</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span id="SystemSetup-914"><a href="#SystemSetup-914"><span class="linenos"> 914</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">fstab_append_file</span><span class="p">)</span>
</span><span id="SystemSetup-915"><a href="#SystemSetup-915"><span class="linenos"> 915</span></a>
</span><span id="SystemSetup-916"><a href="#SystemSetup-916"><span class="linenos"> 916</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fstab_patch_file</span><span class="p">):</span>
</span><span id="SystemSetup-917"><a href="#SystemSetup-917"><span class="linenos"> 917</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-918"><a href="#SystemSetup-918"><span class="linenos"> 918</span></a>                <span class="p">[</span><span class="s1">&#39;patch&#39;</span><span class="p">,</span> <span class="n">fstab_file</span><span class="p">,</span> <span class="n">fstab_patch_file</span><span class="p">]</span>
</span><span id="SystemSetup-919"><a href="#SystemSetup-919"><span class="linenos"> 919</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-920"><a href="#SystemSetup-920"><span class="linenos"> 920</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">fstab_patch_file</span><span class="p">)</span>
</span><span id="SystemSetup-921"><a href="#SystemSetup-921"><span class="linenos"> 921</span></a>
</span><span id="SystemSetup-922"><a href="#SystemSetup-922"><span class="linenos"> 922</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fstab_script_file</span><span class="p">):</span>
</span><span id="SystemSetup-923"><a href="#SystemSetup-923"><span class="linenos"> 923</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup-924"><a href="#SystemSetup-924"><span class="linenos"> 924</span></a>                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;etc/fstab.script&#39;</span><span class="p">,</span> <span class="n">path_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
</span><span id="SystemSetup-925"><a href="#SystemSetup-925"><span class="linenos"> 925</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-926"><a href="#SystemSetup-926"><span class="linenos"> 926</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">fstab_script_file</span><span class="p">)</span>
</span><span id="SystemSetup-927"><a href="#SystemSetup-927"><span class="linenos"> 927</span></a>
</span><span id="SystemSetup-928"><a href="#SystemSetup-928"><span class="linenos"> 928</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_init_link_from_linuxrc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-929"><a href="#SystemSetup-929"><span class="linenos"> 929</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-930"><a href="#SystemSetup-930"><span class="linenos"> 930</span></a><span class="sd">        kiwi boot images provides the linuxrc script, however the kernel</span>
</span><span id="SystemSetup-931"><a href="#SystemSetup-931"><span class="linenos"> 931</span></a><span class="sd">        also expects an init executable to be present. This method creates</span>
</span><span id="SystemSetup-932"><a href="#SystemSetup-932"><span class="linenos"> 932</span></a><span class="sd">        a hard link to the linuxrc file</span>
</span><span id="SystemSetup-933"><a href="#SystemSetup-933"><span class="linenos"> 933</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-934"><a href="#SystemSetup-934"><span class="linenos"> 934</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-935"><a href="#SystemSetup-935"><span class="linenos"> 935</span></a>            <span class="p">[</span><span class="s1">&#39;ln&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/linuxrc&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/init&#39;</span><span class="p">]</span>
</span><span id="SystemSetup-936"><a href="#SystemSetup-936"><span class="linenos"> 936</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-937"><a href="#SystemSetup-937"><span class="linenos"> 937</span></a>
</span><span id="SystemSetup-938"><a href="#SystemSetup-938"><span class="linenos"> 938</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_recovery_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-939"><a href="#SystemSetup-939"><span class="linenos"> 939</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-940"><a href="#SystemSetup-940"><span class="linenos"> 940</span></a><span class="sd">        Create a compressed recovery archive from the root tree</span>
</span><span id="SystemSetup-941"><a href="#SystemSetup-941"><span class="linenos"> 941</span></a><span class="sd">        for use with kiwi&#39;s recvoery system. The method creates</span>
</span><span id="SystemSetup-942"><a href="#SystemSetup-942"><span class="linenos"> 942</span></a><span class="sd">        additional data into the image root filesystem which is</span>
</span><span id="SystemSetup-943"><a href="#SystemSetup-943"><span class="linenos"> 943</span></a><span class="sd">        deleted prior to the creation of a new recovery data set</span>
</span><span id="SystemSetup-944"><a href="#SystemSetup-944"><span class="linenos"> 944</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-945"><a href="#SystemSetup-945"><span class="linenos"> 945</span></a>        <span class="c1"># cleanup</span>
</span><span id="SystemSetup-946"><a href="#SystemSetup-946"><span class="linenos"> 946</span></a>        <span class="n">bash_comand</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SystemSetup-947"><a href="#SystemSetup-947"><span class="linenos"> 947</span></a>            <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.*&#39;</span>
</span><span id="SystemSetup-948"><a href="#SystemSetup-948"><span class="linenos"> 948</span></a>        <span class="p">]</span>
</span><span id="SystemSetup-949"><a href="#SystemSetup-949"><span class="linenos"> 949</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bash_comand</span><span class="p">)])</span>
</span><span id="SystemSetup-950"><a href="#SystemSetup-950"><span class="linenos"> 950</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span><span class="p">[</span><span class="s1">&#39;recovery&#39;</span><span class="p">]:</span>
</span><span id="SystemSetup-951"><a href="#SystemSetup-951"><span class="linenos"> 951</span></a>            <span class="k">return</span>
</span><span id="SystemSetup-952"><a href="#SystemSetup-952"><span class="linenos"> 952</span></a>        <span class="c1"># recovery.tar</span>
</span><span id="SystemSetup-953"><a href="#SystemSetup-953"><span class="linenos"> 953</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating recovery tar archive&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-954"><a href="#SystemSetup-954"><span class="linenos"> 954</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SystemSetup-955"><a href="#SystemSetup-955"><span class="linenos"> 955</span></a>            <span class="s1">&#39;archive_name&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-956"><a href="#SystemSetup-956"><span class="linenos"> 956</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-957"><a href="#SystemSetup-957"><span class="linenos"> 957</span></a>            <span class="s1">&#39;archive_filecount&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-958"><a href="#SystemSetup-958"><span class="linenos"> 958</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar.files&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-959"><a href="#SystemSetup-959"><span class="linenos"> 959</span></a>            <span class="s1">&#39;archive_size&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-960"><a href="#SystemSetup-960"><span class="linenos"> 960</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar.size&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-961"><a href="#SystemSetup-961"><span class="linenos"> 961</span></a>            <span class="s1">&#39;partition_size&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-962"><a href="#SystemSetup-962"><span class="linenos"> 962</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.partition.size&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-963"><a href="#SystemSetup-963"><span class="linenos"> 963</span></a>            <span class="s1">&#39;partition_filesystem&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-964"><a href="#SystemSetup-964"><span class="linenos"> 964</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar.filesystem&#39;</span>
</span><span id="SystemSetup-965"><a href="#SystemSetup-965"><span class="linenos"> 965</span></a>        <span class="p">}</span>
</span><span id="SystemSetup-966"><a href="#SystemSetup-966"><span class="linenos"> 966</span></a>        <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
</span><span id="SystemSetup-967"><a href="#SystemSetup-967"><span class="linenos"> 967</span></a>        <span class="n">archive</span> <span class="o">=</span> <span class="n">ArchiveTar</span><span class="p">(</span>
</span><span id="SystemSetup-968"><a href="#SystemSetup-968"><span class="linenos"> 968</span></a>            <span class="n">filename</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">],</span>
</span><span id="SystemSetup-969"><a href="#SystemSetup-969"><span class="linenos"> 969</span></a>            <span class="n">create_from_file_list</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-970"><a href="#SystemSetup-970"><span class="linenos"> 970</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-971"><a href="#SystemSetup-971"><span class="linenos"> 971</span></a>        <span class="n">archive</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="SystemSetup-972"><a href="#SystemSetup-972"><span class="linenos"> 972</span></a>            <span class="n">source_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup-973"><a href="#SystemSetup-973"><span class="linenos"> 973</span></a>            <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dev&#39;</span><span class="p">,</span> <span class="s1">&#39;proc&#39;</span><span class="p">,</span> <span class="s1">&#39;sys&#39;</span><span class="p">],</span>
</span><span id="SystemSetup-974"><a href="#SystemSetup-974"><span class="linenos"> 974</span></a>            <span class="n">options</span><span class="o">=</span><span class="p">[</span>
</span><span id="SystemSetup-975"><a href="#SystemSetup-975"><span class="linenos"> 975</span></a>                <span class="s1">&#39;--numeric-owner&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-976"><a href="#SystemSetup-976"><span class="linenos"> 976</span></a>                <span class="s1">&#39;--hard-dereference&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-977"><a href="#SystemSetup-977"><span class="linenos"> 977</span></a>                <span class="s1">&#39;--preserve-permissions&#39;</span>
</span><span id="SystemSetup-978"><a href="#SystemSetup-978"><span class="linenos"> 978</span></a>            <span class="p">]</span>
</span><span id="SystemSetup-979"><a href="#SystemSetup-979"><span class="linenos"> 979</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-980"><a href="#SystemSetup-980"><span class="linenos"> 980</span></a>        <span class="c1"># recovery.tar.filesystem</span>
</span><span id="SystemSetup-981"><a href="#SystemSetup-981"><span class="linenos"> 981</span></a>        <span class="n">recovery_filesystem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_filesystem</span><span class="p">()</span>
</span><span id="SystemSetup-982"><a href="#SystemSetup-982"><span class="linenos"> 982</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;partition_filesystem&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">partfs</span><span class="p">:</span>
</span><span id="SystemSetup-983"><a href="#SystemSetup-983"><span class="linenos"> 983</span></a>            <span class="n">partfs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_filesystem</span><span class="p">))</span>
</span><span id="SystemSetup-984"><a href="#SystemSetup-984"><span class="linenos"> 984</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-985"><a href="#SystemSetup-985"><span class="linenos"> 985</span></a>            <span class="s1">&#39;--&gt; Recovery partition filesystem: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_filesystem</span><span class="p">)</span>
</span><span id="SystemSetup-986"><a href="#SystemSetup-986"><span class="linenos"> 986</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-987"><a href="#SystemSetup-987"><span class="linenos"> 987</span></a>        <span class="c1"># recovery.tar.files</span>
</span><span id="SystemSetup-988"><a href="#SystemSetup-988"><span class="linenos"> 988</span></a>        <span class="n">bash_comand</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SystemSetup-989"><a href="#SystemSetup-989"><span class="linenos"> 989</span></a>            <span class="s1">&#39;tar&#39;</span><span class="p">,</span> <span class="s1">&#39;-tf&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">],</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;wc&#39;</span><span class="p">,</span> <span class="s1">&#39;-l&#39;</span>
</span><span id="SystemSetup-990"><a href="#SystemSetup-990"><span class="linenos"> 990</span></a>        <span class="p">]</span>
</span><span id="SystemSetup-991"><a href="#SystemSetup-991"><span class="linenos"> 991</span></a>        <span class="n">tar_files_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-992"><a href="#SystemSetup-992"><span class="linenos"> 992</span></a>            <span class="p">[</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bash_comand</span><span class="p">)]</span>
</span><span id="SystemSetup-993"><a href="#SystemSetup-993"><span class="linenos"> 993</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-994"><a href="#SystemSetup-994"><span class="linenos"> 994</span></a>        <span class="n">tar_files_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tar_files_call</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
</span><span id="SystemSetup-995"><a href="#SystemSetup-995"><span class="linenos"> 995</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_filecount&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">files</span><span class="p">:</span>
</span><span id="SystemSetup-996"><a href="#SystemSetup-996"><span class="linenos"> 996</span></a>            <span class="n">files</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tar_files_count</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">))</span>
</span><span id="SystemSetup-997"><a href="#SystemSetup-997"><span class="linenos"> 997</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-998"><a href="#SystemSetup-998"><span class="linenos"> 998</span></a>            <span class="s1">&#39;--&gt; Recovery file count: </span><span class="si">{0}</span><span class="s1"> files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tar_files_count</span><span class="p">)</span>
</span><span id="SystemSetup-999"><a href="#SystemSetup-999"><span class="linenos"> 999</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1000"><a href="#SystemSetup-1000"><span class="linenos">1000</span></a>        <span class="c1"># recovery.tar.size</span>
</span><span id="SystemSetup-1001"><a href="#SystemSetup-1001"><span class="linenos">1001</span></a>        <span class="n">recovery_archive_size_bytes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">])</span>
</span><span id="SystemSetup-1002"><a href="#SystemSetup-1002"><span class="linenos">1002</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_size&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">size</span><span class="p">:</span>
</span><span id="SystemSetup-1003"><a href="#SystemSetup-1003"><span class="linenos">1003</span></a>            <span class="n">size</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_archive_size_bytes</span><span class="p">))</span>
</span><span id="SystemSetup-1004"><a href="#SystemSetup-1004"><span class="linenos">1004</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-1005"><a href="#SystemSetup-1005"><span class="linenos">1005</span></a>            <span class="s1">&#39;--&gt; Recovery uncompressed size: </span><span class="si">{0}</span><span class="s1"> mbytes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-1006"><a href="#SystemSetup-1006"><span class="linenos">1006</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">recovery_archive_size_bytes</span> <span class="o">/</span> <span class="mi">1048576</span><span class="p">)</span>
</span><span id="SystemSetup-1007"><a href="#SystemSetup-1007"><span class="linenos">1007</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1008"><a href="#SystemSetup-1008"><span class="linenos">1008</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1009"><a href="#SystemSetup-1009"><span class="linenos">1009</span></a>        <span class="c1"># recovery.tar.gz</span>
</span><span id="SystemSetup-1010"><a href="#SystemSetup-1010"><span class="linenos">1010</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Compressing recovery archive&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1011"><a href="#SystemSetup-1011"><span class="linenos">1011</span></a>        <span class="n">compress</span> <span class="o">=</span> <span class="n">Compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1012"><a href="#SystemSetup-1012"><span class="linenos">1012</span></a>        <span class="n">compress</span><span class="o">.</span><span class="n">gzip</span><span class="p">()</span>
</span><span id="SystemSetup-1013"><a href="#SystemSetup-1013"><span class="linenos">1013</span></a>        <span class="c1"># recovery.partition.size</span>
</span><span id="SystemSetup-1014"><a href="#SystemSetup-1014"><span class="linenos">1014</span></a>        <span class="n">recovery_archive_gz_size_mbytes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="SystemSetup-1015"><a href="#SystemSetup-1015"><span class="linenos">1015</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.gz&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1048576</span>
</span><span id="SystemSetup-1016"><a href="#SystemSetup-1016"><span class="linenos">1016</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1017"><a href="#SystemSetup-1017"><span class="linenos">1017</span></a>        <span class="n">recovery_partition_mbytes</span> <span class="o">=</span> <span class="n">recovery_archive_gz_size_mbytes</span> \
</span><span id="SystemSetup-1018"><a href="#SystemSetup-1018"><span class="linenos">1018</span></a>            <span class="o">+</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_recovery_spare_mbytes</span><span class="p">()</span>
</span><span id="SystemSetup-1019"><a href="#SystemSetup-1019"><span class="linenos">1019</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;partition_size&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">gzsize</span><span class="p">:</span>
</span><span id="SystemSetup-1020"><a href="#SystemSetup-1020"><span class="linenos">1020</span></a>            <span class="n">gzsize</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_partition_mbytes</span><span class="p">))</span>
</span><span id="SystemSetup-1021"><a href="#SystemSetup-1021"><span class="linenos">1021</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-1022"><a href="#SystemSetup-1022"><span class="linenos">1022</span></a>            <span class="s1">&#39;--&gt; Recovery partition size: </span><span class="si">{0}</span><span class="s1"> mbytes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-1023"><a href="#SystemSetup-1023"><span class="linenos">1023</span></a>                <span class="n">recovery_partition_mbytes</span>
</span><span id="SystemSetup-1024"><a href="#SystemSetup-1024"><span class="linenos">1024</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1025"><a href="#SystemSetup-1025"><span class="linenos">1025</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1026"><a href="#SystemSetup-1026"><span class="linenos">1026</span></a>        <span class="c1"># delete recovery archive if inplace recovery is requested</span>
</span><span id="SystemSetup-1027"><a href="#SystemSetup-1027"><span class="linenos">1027</span></a>        <span class="c1"># In this mode the recovery archive is created at install time</span>
</span><span id="SystemSetup-1028"><a href="#SystemSetup-1028"><span class="linenos">1028</span></a>        <span class="c1"># and not at image creation time. However the recovery metadata</span>
</span><span id="SystemSetup-1029"><a href="#SystemSetup-1029"><span class="linenos">1029</span></a>        <span class="c1"># is preserved in order to be able to check if enough space</span>
</span><span id="SystemSetup-1030"><a href="#SystemSetup-1030"><span class="linenos">1030</span></a>        <span class="c1"># is available on the disk to create the recovery archive.</span>
</span><span id="SystemSetup-1031"><a href="#SystemSetup-1031"><span class="linenos">1031</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span><span class="p">[</span><span class="s1">&#39;recovery_inplace&#39;</span><span class="p">]:</span>
</span><span id="SystemSetup-1032"><a href="#SystemSetup-1032"><span class="linenos">1032</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-1033"><a href="#SystemSetup-1033"><span class="linenos">1033</span></a>                <span class="s1">&#39;--&gt; Inplace recovery requested, deleting archive&#39;</span>
</span><span id="SystemSetup-1034"><a href="#SystemSetup-1034"><span class="linenos">1034</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1035"><a href="#SystemSetup-1035"><span class="linenos">1035</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.gz&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1036"><a href="#SystemSetup-1036"><span class="linenos">1036</span></a>
</span><span id="SystemSetup-1037"><a href="#SystemSetup-1037"><span class="linenos">1037</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_user_options</span><span class="p">(</span>
</span><span id="SystemSetup-1038"><a href="#SystemSetup-1038"><span class="linenos">1038</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SystemSetup-1039"><a href="#SystemSetup-1039"><span class="linenos">1039</span></a>        <span class="n">password_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1040"><a href="#SystemSetup-1040"><span class="linenos">1040</span></a>        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1041"><a href="#SystemSetup-1041"><span class="linenos">1041</span></a>        <span class="n">user_shell</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1042"><a href="#SystemSetup-1042"><span class="linenos">1042</span></a>        <span class="n">user_groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="SystemSetup-1043"><a href="#SystemSetup-1043"><span class="linenos">1043</span></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1044"><a href="#SystemSetup-1044"><span class="linenos">1044</span></a>        <span class="n">group_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1045"><a href="#SystemSetup-1045"><span class="linenos">1045</span></a>        <span class="n">user_realname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1046"><a href="#SystemSetup-1046"><span class="linenos">1046</span></a>        <span class="n">user_exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SystemSetup-1047"><a href="#SystemSetup-1047"><span class="linenos">1047</span></a>        <span class="n">home_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="SystemSetup-1048"><a href="#SystemSetup-1048"><span class="linenos">1048</span></a>    <span class="p">):</span>
</span><span id="SystemSetup-1049"><a href="#SystemSetup-1049"><span class="linenos">1049</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SystemSetup-1050"><a href="#SystemSetup-1050"><span class="linenos">1050</span></a>        <span class="k">if</span> <span class="n">password_format</span> <span class="o">==</span> <span class="s1">&#39;plain&#39;</span><span class="p">:</span>
</span><span id="SystemSetup-1051"><a href="#SystemSetup-1051"><span class="linenos">1051</span></a>            <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_passwd_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="SystemSetup-1052"><a href="#SystemSetup-1052"><span class="linenos">1052</span></a>        <span class="k">if</span> <span class="n">password</span><span class="p">:</span>
</span><span id="SystemSetup-1053"><a href="#SystemSetup-1053"><span class="linenos">1053</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1054"><a href="#SystemSetup-1054"><span class="linenos">1054</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</span><span id="SystemSetup-1055"><a href="#SystemSetup-1055"><span class="linenos">1055</span></a>        <span class="k">if</span> <span class="n">user_shell</span><span class="p">:</span>
</span><span id="SystemSetup-1056"><a href="#SystemSetup-1056"><span class="linenos">1056</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1057"><a href="#SystemSetup-1057"><span class="linenos">1057</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_shell</span><span class="p">)</span>
</span><span id="SystemSetup-1058"><a href="#SystemSetup-1058"><span class="linenos">1058</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_groups</span><span class="p">):</span>
</span><span id="SystemSetup-1059"><a href="#SystemSetup-1059"><span class="linenos">1059</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1060"><a href="#SystemSetup-1060"><span class="linenos">1060</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="SystemSetup-1061"><a href="#SystemSetup-1061"><span class="linenos">1061</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SystemSetup-1062"><a href="#SystemSetup-1062"><span class="linenos">1062</span></a>                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-G&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1063"><a href="#SystemSetup-1063"><span class="linenos">1063</span></a>                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
</span><span id="SystemSetup-1064"><a href="#SystemSetup-1064"><span class="linenos">1064</span></a>        <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
</span><span id="SystemSetup-1065"><a href="#SystemSetup-1065"><span class="linenos">1065</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1066"><a href="#SystemSetup-1066"><span class="linenos">1066</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
</span><span id="SystemSetup-1067"><a href="#SystemSetup-1067"><span class="linenos">1067</span></a>        <span class="k">if</span> <span class="n">group_id</span><span class="p">:</span>
</span><span id="SystemSetup-1068"><a href="#SystemSetup-1068"><span class="linenos">1068</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1069"><a href="#SystemSetup-1069"><span class="linenos">1069</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group_id</span><span class="p">))</span>
</span><span id="SystemSetup-1070"><a href="#SystemSetup-1070"><span class="linenos">1070</span></a>        <span class="k">if</span> <span class="n">user_realname</span><span class="p">:</span>
</span><span id="SystemSetup-1071"><a href="#SystemSetup-1071"><span class="linenos">1071</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1072"><a href="#SystemSetup-1072"><span class="linenos">1072</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_realname</span><span class="p">)</span>
</span><span id="SystemSetup-1073"><a href="#SystemSetup-1073"><span class="linenos">1073</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_exists</span><span class="p">:</span>
</span><span id="SystemSetup-1074"><a href="#SystemSetup-1074"><span class="linenos">1074</span></a>            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1075"><a href="#SystemSetup-1075"><span class="linenos">1075</span></a>            <span class="k">if</span> <span class="n">home_path</span><span class="p">:</span>
</span><span id="SystemSetup-1076"><a href="#SystemSetup-1076"><span class="linenos">1076</span></a>                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1077"><a href="#SystemSetup-1077"><span class="linenos">1077</span></a>                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">home_path</span><span class="p">)</span>
</span><span id="SystemSetup-1078"><a href="#SystemSetup-1078"><span class="linenos">1078</span></a>        <span class="k">return</span> <span class="n">options</span>
</span><span id="SystemSetup-1079"><a href="#SystemSetup-1079"><span class="linenos">1079</span></a>
</span><span id="SystemSetup-1080"><a href="#SystemSetup-1080"><span class="linenos">1080</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_import_cdroot_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SystemSetup-1081"><a href="#SystemSetup-1081"><span class="linenos">1081</span></a>        <span class="n">glob_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">+</span> <span class="s1">&#39;/config-cdroot.tar*&#39;</span>
</span><span id="SystemSetup-1082"><a href="#SystemSetup-1082"><span class="linenos">1082</span></a>        <span class="k">for</span> <span class="n">cdroot_archive</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">glob_match</span><span class="p">)):</span>
</span><span id="SystemSetup-1083"><a href="#SystemSetup-1083"><span class="linenos">1083</span></a>            <span class="n">archive_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-1084"><a href="#SystemSetup-1084"><span class="linenos">1084</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span>
</span><span id="SystemSetup-1085"><a href="#SystemSetup-1085"><span class="linenos">1085</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1086"><a href="#SystemSetup-1086"><span class="linenos">1086</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-1087"><a href="#SystemSetup-1087"><span class="linenos">1087</span></a>                <span class="s1">&#39;--&gt; Importing </span><span class="si">{0}</span><span class="s1"> archive to </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-1088"><a href="#SystemSetup-1088"><span class="linenos">1088</span></a>                    <span class="n">cdroot_archive</span><span class="p">,</span> <span class="n">archive_file</span>
</span><span id="SystemSetup-1089"><a href="#SystemSetup-1089"><span class="linenos">1089</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1090"><a href="#SystemSetup-1090"><span class="linenos">1090</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1091"><a href="#SystemSetup-1091"><span class="linenos">1091</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1092"><a href="#SystemSetup-1092"><span class="linenos">1092</span></a>                <span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">cdroot_archive</span><span class="p">,</span> <span class="n">archive_file</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">]</span>
</span><span id="SystemSetup-1093"><a href="#SystemSetup-1093"><span class="linenos">1093</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1094"><a href="#SystemSetup-1094"><span class="linenos">1094</span></a>            <span class="k">break</span>
</span><span id="SystemSetup-1095"><a href="#SystemSetup-1095"><span class="linenos">1095</span></a>
</span><span id="SystemSetup-1096"><a href="#SystemSetup-1096"><span class="linenos">1096</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_import_custom_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SystemSetup-1097"><a href="#SystemSetup-1097"><span class="linenos">1097</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-1098"><a href="#SystemSetup-1098"><span class="linenos">1098</span></a><span class="sd">        Import custom file files</span>
</span><span id="SystemSetup-1099"><a href="#SystemSetup-1099"><span class="linenos">1099</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-1100"><a href="#SystemSetup-1100"><span class="linenos">1100</span></a>        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SystemSetup-1101"><a href="#SystemSetup-1101"><span class="linenos">1101</span></a>        <span class="n">system_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_system_files</span><span class="p">()</span>
</span><span id="SystemSetup-1102"><a href="#SystemSetup-1102"><span class="linenos">1102</span></a>        <span class="n">bootstrap_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_bootstrap_files</span><span class="p">()</span>
</span><span id="SystemSetup-1103"><a href="#SystemSetup-1103"><span class="linenos">1103</span></a>        <span class="k">if</span> <span class="n">system_files</span><span class="p">:</span>
</span><span id="SystemSetup-1104"><a href="#SystemSetup-1104"><span class="linenos">1104</span></a>            <span class="n">file_list</span> <span class="o">+=</span> <span class="n">system_files</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="SystemSetup-1105"><a href="#SystemSetup-1105"><span class="linenos">1105</span></a>        <span class="k">if</span> <span class="n">bootstrap_files</span><span class="p">:</span>
</span><span id="SystemSetup-1106"><a href="#SystemSetup-1106"><span class="linenos">1106</span></a>            <span class="n">file_list</span> <span class="o">+=</span> <span class="n">bootstrap_files</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="SystemSetup-1107"><a href="#SystemSetup-1107"><span class="linenos">1107</span></a>
</span><span id="SystemSetup-1108"><a href="#SystemSetup-1108"><span class="linenos">1108</span></a>        <span class="n">file_target_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-1109"><a href="#SystemSetup-1109"><span class="linenos">1109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span>
</span><span id="SystemSetup-1110"><a href="#SystemSetup-1110"><span class="linenos">1110</span></a>        <span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
</span><span id="SystemSetup-1111"><a href="#SystemSetup-1111"><span class="linenos">1111</span></a>
</span><span id="SystemSetup-1112"><a href="#SystemSetup-1112"><span class="linenos">1112</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
</span><span id="SystemSetup-1113"><a href="#SystemSetup-1113"><span class="linenos">1113</span></a>            <span class="n">file_is_absolute</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
</span><span id="SystemSetup-1114"><a href="#SystemSetup-1114"><span class="linenos">1114</span></a>            <span class="k">if</span> <span class="n">file_is_absolute</span><span class="p">:</span>
</span><span id="SystemSetup-1115"><a href="#SystemSetup-1115"><span class="linenos">1115</span></a>                <span class="n">file_file</span> <span class="o">=</span> <span class="n">file</span>
</span><span id="SystemSetup-1116"><a href="#SystemSetup-1116"><span class="linenos">1116</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-1117"><a href="#SystemSetup-1117"><span class="linenos">1117</span></a>                <span class="n">file_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="SystemSetup-1118"><a href="#SystemSetup-1118"><span class="linenos">1118</span></a>
</span><span id="SystemSetup-1119"><a href="#SystemSetup-1119"><span class="linenos">1119</span></a>            <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_file</span><span class="p">)</span>
</span><span id="SystemSetup-1120"><a href="#SystemSetup-1120"><span class="linenos">1120</span></a>
</span><span id="SystemSetup-1121"><a href="#SystemSetup-1121"><span class="linenos">1121</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">:</span>
</span><span id="SystemSetup-1122"><a href="#SystemSetup-1122"><span class="linenos">1122</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_description_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">file_is_absolute</span><span class="p">:</span>
</span><span id="SystemSetup-1123"><a href="#SystemSetup-1123"><span class="linenos">1123</span></a>                    <span class="n">file_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_description_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span>
</span><span id="SystemSetup-1124"><a href="#SystemSetup-1124"><span class="linenos">1124</span></a>                    <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_file</span><span class="p">)</span>
</span><span id="SystemSetup-1125"><a href="#SystemSetup-1125"><span class="linenos">1125</span></a>
</span><span id="SystemSetup-1126"><a href="#SystemSetup-1126"><span class="linenos">1126</span></a>            <span class="k">if</span> <span class="n">file_exists</span><span class="p">:</span>
</span><span id="SystemSetup-1127"><a href="#SystemSetup-1127"><span class="linenos">1127</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-1128"><a href="#SystemSetup-1128"><span class="linenos">1128</span></a>                    <span class="s1">&#39;--&gt; Importing </span><span class="si">{0}</span><span class="s1"> file to </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-1129"><a href="#SystemSetup-1129"><span class="linenos">1129</span></a>                        <span class="n">file_file</span><span class="p">,</span> <span class="n">file_target_dir</span>
</span><span id="SystemSetup-1130"><a href="#SystemSetup-1130"><span class="linenos">1130</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1131"><a href="#SystemSetup-1131"><span class="linenos">1131</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1132"><a href="#SystemSetup-1132"><span class="linenos">1132</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1133"><a href="#SystemSetup-1133"><span class="linenos">1133</span></a>                    <span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">file_file</span><span class="p">,</span> <span class="n">file_target_dir</span><span class="p">]</span>
</span><span id="SystemSetup-1134"><a href="#SystemSetup-1134"><span class="linenos">1134</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1135"><a href="#SystemSetup-1135"><span class="linenos">1135</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-1136"><a href="#SystemSetup-1136"><span class="linenos">1136</span></a>                <span class="k">raise</span> <span class="n">KiwiImportDescriptionError</span><span class="p">(</span>
</span><span id="SystemSetup-1137"><a href="#SystemSetup-1137"><span class="linenos">1137</span></a>                    <span class="sa">f</span><span class="s1">&#39;Specified file </span><span class="si">{</span><span class="n">file_file</span><span class="si">}</span><span class="s1"> does not exist&#39;</span>
</span><span id="SystemSetup-1138"><a href="#SystemSetup-1138"><span class="linenos">1138</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1139"><a href="#SystemSetup-1139"><span class="linenos">1139</span></a>
</span><span id="SystemSetup-1140"><a href="#SystemSetup-1140"><span class="linenos">1140</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_import_custom_archives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SystemSetup-1141"><a href="#SystemSetup-1141"><span class="linenos">1141</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-1142"><a href="#SystemSetup-1142"><span class="linenos">1142</span></a><span class="sd">        Import custom tar archive files</span>
</span><span id="SystemSetup-1143"><a href="#SystemSetup-1143"><span class="linenos">1143</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-1144"><a href="#SystemSetup-1144"><span class="linenos">1144</span></a>        <span class="n">archive_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SystemSetup-1145"><a href="#SystemSetup-1145"><span class="linenos">1145</span></a>        <span class="n">system_archives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_system_archives</span><span class="p">()</span>
</span><span id="SystemSetup-1146"><a href="#SystemSetup-1146"><span class="linenos">1146</span></a>        <span class="n">bootstrap_archives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_bootstrap_archives</span><span class="p">()</span>
</span><span id="SystemSetup-1147"><a href="#SystemSetup-1147"><span class="linenos">1147</span></a>        <span class="k">if</span> <span class="n">system_archives</span><span class="p">:</span>
</span><span id="SystemSetup-1148"><a href="#SystemSetup-1148"><span class="linenos">1148</span></a>            <span class="n">archive_list</span> <span class="o">+=</span> <span class="n">system_archives</span>
</span><span id="SystemSetup-1149"><a href="#SystemSetup-1149"><span class="linenos">1149</span></a>        <span class="k">if</span> <span class="n">bootstrap_archives</span><span class="p">:</span>
</span><span id="SystemSetup-1150"><a href="#SystemSetup-1150"><span class="linenos">1150</span></a>            <span class="n">archive_list</span> <span class="o">+=</span> <span class="n">bootstrap_archives</span>
</span><span id="SystemSetup-1151"><a href="#SystemSetup-1151"><span class="linenos">1151</span></a>
</span><span id="SystemSetup-1152"><a href="#SystemSetup-1152"><span class="linenos">1152</span></a>        <span class="n">archive_target_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-1153"><a href="#SystemSetup-1153"><span class="linenos">1153</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span>
</span><span id="SystemSetup-1154"><a href="#SystemSetup-1154"><span class="linenos">1154</span></a>        <span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
</span><span id="SystemSetup-1155"><a href="#SystemSetup-1155"><span class="linenos">1155</span></a>
</span><span id="SystemSetup-1156"><a href="#SystemSetup-1156"><span class="linenos">1156</span></a>        <span class="k">for</span> <span class="n">archive</span> <span class="ow">in</span> <span class="n">archive_list</span><span class="p">:</span>
</span><span id="SystemSetup-1157"><a href="#SystemSetup-1157"><span class="linenos">1157</span></a>            <span class="n">archive_is_absolute</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
</span><span id="SystemSetup-1158"><a href="#SystemSetup-1158"><span class="linenos">1158</span></a>            <span class="k">if</span> <span class="n">archive_is_absolute</span><span class="p">:</span>
</span><span id="SystemSetup-1159"><a href="#SystemSetup-1159"><span class="linenos">1159</span></a>                <span class="n">archive_file</span> <span class="o">=</span> <span class="n">archive</span>
</span><span id="SystemSetup-1160"><a href="#SystemSetup-1160"><span class="linenos">1160</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-1161"><a href="#SystemSetup-1161"><span class="linenos">1161</span></a>                <span class="n">archive_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">archive</span><span class="p">)</span>
</span><span id="SystemSetup-1162"><a href="#SystemSetup-1162"><span class="linenos">1162</span></a>
</span><span id="SystemSetup-1163"><a href="#SystemSetup-1163"><span class="linenos">1163</span></a>            <span class="n">archive_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_file</span><span class="p">)</span>
</span><span id="SystemSetup-1164"><a href="#SystemSetup-1164"><span class="linenos">1164</span></a>
</span><span id="SystemSetup-1165"><a href="#SystemSetup-1165"><span class="linenos">1165</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">archive_exists</span><span class="p">:</span>
</span><span id="SystemSetup-1166"><a href="#SystemSetup-1166"><span class="linenos">1166</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_description_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">archive_is_absolute</span><span class="p">:</span>
</span><span id="SystemSetup-1167"><a href="#SystemSetup-1167"><span class="linenos">1167</span></a>                    <span class="n">archive_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_description_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">archive</span>
</span><span id="SystemSetup-1168"><a href="#SystemSetup-1168"><span class="linenos">1168</span></a>                    <span class="n">archive_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_file</span><span class="p">)</span>
</span><span id="SystemSetup-1169"><a href="#SystemSetup-1169"><span class="linenos">1169</span></a>
</span><span id="SystemSetup-1170"><a href="#SystemSetup-1170"><span class="linenos">1170</span></a>            <span class="k">if</span> <span class="n">archive_exists</span><span class="p">:</span>
</span><span id="SystemSetup-1171"><a href="#SystemSetup-1171"><span class="linenos">1171</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-1172"><a href="#SystemSetup-1172"><span class="linenos">1172</span></a>                    <span class="s1">&#39;--&gt; Importing </span><span class="si">{0}</span><span class="s1"> archive to </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-1173"><a href="#SystemSetup-1173"><span class="linenos">1173</span></a>                        <span class="n">archive_file</span><span class="p">,</span> <span class="n">archive_target_dir</span>
</span><span id="SystemSetup-1174"><a href="#SystemSetup-1174"><span class="linenos">1174</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1175"><a href="#SystemSetup-1175"><span class="linenos">1175</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1176"><a href="#SystemSetup-1176"><span class="linenos">1176</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1177"><a href="#SystemSetup-1177"><span class="linenos">1177</span></a>                    <span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">archive_file</span><span class="p">,</span> <span class="n">archive_target_dir</span><span class="p">]</span>
</span><span id="SystemSetup-1178"><a href="#SystemSetup-1178"><span class="linenos">1178</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1179"><a href="#SystemSetup-1179"><span class="linenos">1179</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-1180"><a href="#SystemSetup-1180"><span class="linenos">1180</span></a>                <span class="k">raise</span> <span class="n">KiwiImportDescriptionError</span><span class="p">(</span>
</span><span id="SystemSetup-1181"><a href="#SystemSetup-1181"><span class="linenos">1181</span></a>                    <span class="s1">&#39;Specified archive </span><span class="si">{0}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">archive_file</span><span class="p">)</span>
</span><span id="SystemSetup-1182"><a href="#SystemSetup-1182"><span class="linenos">1182</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1183"><a href="#SystemSetup-1183"><span class="linenos">1183</span></a>
</span><span id="SystemSetup-1184"><a href="#SystemSetup-1184"><span class="linenos">1184</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_import_custom_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SystemSetup-1185"><a href="#SystemSetup-1185"><span class="linenos">1185</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-1186"><a href="#SystemSetup-1186"><span class="linenos">1186</span></a><span class="sd">        Import custom scripts</span>
</span><span id="SystemSetup-1187"><a href="#SystemSetup-1187"><span class="linenos">1187</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-1188"><a href="#SystemSetup-1188"><span class="linenos">1188</span></a>        <span class="c1"># custom_scripts defines a dictionary with all script hooks</span>
</span><span id="SystemSetup-1189"><a href="#SystemSetup-1189"><span class="linenos">1189</span></a>        <span class="c1"># for each script name a the filepath and additional flags</span>
</span><span id="SystemSetup-1190"><a href="#SystemSetup-1190"><span class="linenos">1190</span></a>        <span class="c1"># are defined. the filepath could be either a relative or</span>
</span><span id="SystemSetup-1191"><a href="#SystemSetup-1191"><span class="linenos">1191</span></a>        <span class="c1"># absolute information. If filepath is set to None this indicates</span>
</span><span id="SystemSetup-1192"><a href="#SystemSetup-1192"><span class="linenos">1192</span></a>        <span class="c1"># the script hook is not used. The raise_if_not_exists flag</span>
</span><span id="SystemSetup-1193"><a href="#SystemSetup-1193"><span class="linenos">1193</span></a>        <span class="c1"># causes kiwi to raise an exception if a specified script</span>
</span><span id="SystemSetup-1194"><a href="#SystemSetup-1194"><span class="linenos">1194</span></a>        <span class="c1"># filepath does not exist</span>
</span><span id="SystemSetup-1195"><a href="#SystemSetup-1195"><span class="linenos">1195</span></a>        <span class="n">script_type</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
</span><span id="SystemSetup-1196"><a href="#SystemSetup-1196"><span class="linenos">1196</span></a>            <span class="s1">&#39;script_type&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">,</span> <span class="s1">&#39;raise_if_not_exists&#39;</span><span class="p">]</span>
</span><span id="SystemSetup-1197"><a href="#SystemSetup-1197"><span class="linenos">1197</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1198"><a href="#SystemSetup-1198"><span class="linenos">1198</span></a>        <span class="n">custom_scripts</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SystemSetup-1199"><a href="#SystemSetup-1199"><span class="linenos">1199</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_BOOTSTRAP_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="SystemSetup-1200"><a href="#SystemSetup-1200"><span class="linenos">1200</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_BOOTSTRAP_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup-1201"><a href="#SystemSetup-1201"><span class="linenos">1201</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-1202"><a href="#SystemSetup-1202"><span class="linenos">1202</span></a>            <span class="p">),</span>
</span><span id="SystemSetup-1203"><a href="#SystemSetup-1203"><span class="linenos">1203</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="SystemSetup-1204"><a href="#SystemSetup-1204"><span class="linenos">1204</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup-1205"><a href="#SystemSetup-1205"><span class="linenos">1205</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-1206"><a href="#SystemSetup-1206"><span class="linenos">1206</span></a>            <span class="p">),</span>
</span><span id="SystemSetup-1207"><a href="#SystemSetup-1207"><span class="linenos">1207</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_OVERLAY_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="SystemSetup-1208"><a href="#SystemSetup-1208"><span class="linenos">1208</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_OVERLAY_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup-1209"><a href="#SystemSetup-1209"><span class="linenos">1209</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-1210"><a href="#SystemSetup-1210"><span class="linenos">1210</span></a>            <span class="p">),</span>
</span><span id="SystemSetup-1211"><a href="#SystemSetup-1211"><span class="linenos">1211</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_HOST_PREPARE_OVERLAY_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="SystemSetup-1212"><a href="#SystemSetup-1212"><span class="linenos">1212</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_HOST_PREPARE_OVERLAY_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup-1213"><a href="#SystemSetup-1213"><span class="linenos">1213</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-1214"><a href="#SystemSetup-1214"><span class="linenos">1214</span></a>            <span class="p">),</span>
</span><span id="SystemSetup-1215"><a href="#SystemSetup-1215"><span class="linenos">1215</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">PRE_CREATE_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="SystemSetup-1216"><a href="#SystemSetup-1216"><span class="linenos">1216</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">PRE_CREATE_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup-1217"><a href="#SystemSetup-1217"><span class="linenos">1217</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-1218"><a href="#SystemSetup-1218"><span class="linenos">1218</span></a>            <span class="p">),</span>
</span><span id="SystemSetup-1219"><a href="#SystemSetup-1219"><span class="linenos">1219</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">PRE_DISK_SYNC_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="SystemSetup-1220"><a href="#SystemSetup-1220"><span class="linenos">1220</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">PRE_DISK_SYNC_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup-1221"><a href="#SystemSetup-1221"><span class="linenos">1221</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-1222"><a href="#SystemSetup-1222"><span class="linenos">1222</span></a>            <span class="p">),</span>
</span><span id="SystemSetup-1223"><a href="#SystemSetup-1223"><span class="linenos">1223</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_DISK_SYNC_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="SystemSetup-1224"><a href="#SystemSetup-1224"><span class="linenos">1224</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_DISK_SYNC_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup-1225"><a href="#SystemSetup-1225"><span class="linenos">1225</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-1226"><a href="#SystemSetup-1226"><span class="linenos">1226</span></a>            <span class="p">),</span>
</span><span id="SystemSetup-1227"><a href="#SystemSetup-1227"><span class="linenos">1227</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">EDIT_BOOT_CONFIG_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="SystemSetup-1228"><a href="#SystemSetup-1228"><span class="linenos">1228</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_editbootconfig</span><span class="p">(),</span>
</span><span id="SystemSetup-1229"><a href="#SystemSetup-1229"><span class="linenos">1229</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">True</span>
</span><span id="SystemSetup-1230"><a href="#SystemSetup-1230"><span class="linenos">1230</span></a>            <span class="p">),</span>
</span><span id="SystemSetup-1231"><a href="#SystemSetup-1231"><span class="linenos">1231</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">EDIT_BOOT_INSTALL_SCRIPT</span><span class="p">:</span> <span class="n">script_type</span><span class="p">(</span>
</span><span id="SystemSetup-1232"><a href="#SystemSetup-1232"><span class="linenos">1232</span></a>                <span class="n">filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_editbootinstall</span><span class="p">(),</span>
</span><span id="SystemSetup-1233"><a href="#SystemSetup-1233"><span class="linenos">1233</span></a>                <span class="n">raise_if_not_exists</span><span class="o">=</span><span class="kc">True</span>
</span><span id="SystemSetup-1234"><a href="#SystemSetup-1234"><span class="linenos">1234</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1235"><a href="#SystemSetup-1235"><span class="linenos">1235</span></a>        <span class="p">}</span>
</span><span id="SystemSetup-1236"><a href="#SystemSetup-1236"><span class="linenos">1236</span></a>        <span class="n">sorted_custom_scripts</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
</span><span id="SystemSetup-1237"><a href="#SystemSetup-1237"><span class="linenos">1237</span></a>            <span class="nb">sorted</span><span class="p">(</span><span class="n">custom_scripts</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span><span id="SystemSetup-1238"><a href="#SystemSetup-1238"><span class="linenos">1238</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1239"><a href="#SystemSetup-1239"><span class="linenos">1239</span></a>
</span><span id="SystemSetup-1240"><a href="#SystemSetup-1240"><span class="linenos">1240</span></a>        <span class="n">script_target_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-1241"><a href="#SystemSetup-1241"><span class="linenos">1241</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span>
</span><span id="SystemSetup-1242"><a href="#SystemSetup-1242"><span class="linenos">1242</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1243"><a href="#SystemSetup-1243"><span class="linenos">1243</span></a>        <span class="n">need_script_helper_functions</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SystemSetup-1244"><a href="#SystemSetup-1244"><span class="linenos">1244</span></a>
</span><span id="SystemSetup-1245"><a href="#SystemSetup-1245"><span class="linenos">1245</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">script</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sorted_custom_scripts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="SystemSetup-1246"><a href="#SystemSetup-1246"><span class="linenos">1246</span></a>            <span class="k">if</span> <span class="n">script</span><span class="o">.</span><span class="n">filepath</span><span class="p">:</span>
</span><span id="SystemSetup-1247"><a href="#SystemSetup-1247"><span class="linenos">1247</span></a>                <span class="k">if</span> <span class="n">script</span><span class="o">.</span><span class="n">filepath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
</span><span id="SystemSetup-1248"><a href="#SystemSetup-1248"><span class="linenos">1248</span></a>                    <span class="n">script_file</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">filepath</span>
</span><span id="SystemSetup-1249"><a href="#SystemSetup-1249"><span class="linenos">1249</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-1250"><a href="#SystemSetup-1250"><span class="linenos">1250</span></a>                    <span class="n">script_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-1251"><a href="#SystemSetup-1251"><span class="linenos">1251</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">script</span><span class="o">.</span><span class="n">filepath</span>
</span><span id="SystemSetup-1252"><a href="#SystemSetup-1252"><span class="linenos">1252</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1253"><a href="#SystemSetup-1253"><span class="linenos">1253</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">script_file</span><span class="p">):</span>
</span><span id="SystemSetup-1254"><a href="#SystemSetup-1254"><span class="linenos">1254</span></a>                    <span class="n">script_target_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-1255"><a href="#SystemSetup-1255"><span class="linenos">1255</span></a>                        <span class="n">script_target_dir</span><span class="p">,</span> <span class="n">name</span>
</span><span id="SystemSetup-1256"><a href="#SystemSetup-1256"><span class="linenos">1256</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1257"><a href="#SystemSetup-1257"><span class="linenos">1257</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-1258"><a href="#SystemSetup-1258"><span class="linenos">1258</span></a>                        <span class="s1">&#39;--&gt; Importing </span><span class="si">{0}</span><span class="s1"> script to </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-1259"><a href="#SystemSetup-1259"><span class="linenos">1259</span></a>                            <span class="n">script</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="n">script_target_file</span>
</span><span id="SystemSetup-1260"><a href="#SystemSetup-1260"><span class="linenos">1260</span></a>                        <span class="p">)</span>
</span><span id="SystemSetup-1261"><a href="#SystemSetup-1261"><span class="linenos">1261</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1262"><a href="#SystemSetup-1262"><span class="linenos">1262</span></a>                    <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1263"><a href="#SystemSetup-1263"><span class="linenos">1263</span></a>                        <span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">script_file</span><span class="p">,</span> <span class="n">script_target_file</span><span class="p">]</span>
</span><span id="SystemSetup-1264"><a href="#SystemSetup-1264"><span class="linenos">1264</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1265"><a href="#SystemSetup-1265"><span class="linenos">1265</span></a>                    <span class="n">need_script_helper_functions</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SystemSetup-1266"><a href="#SystemSetup-1266"><span class="linenos">1266</span></a>                <span class="k">elif</span> <span class="n">script</span><span class="o">.</span><span class="n">raise_if_not_exists</span><span class="p">:</span>
</span><span id="SystemSetup-1267"><a href="#SystemSetup-1267"><span class="linenos">1267</span></a>                    <span class="k">raise</span> <span class="n">KiwiImportDescriptionError</span><span class="p">(</span>
</span><span id="SystemSetup-1268"><a href="#SystemSetup-1268"><span class="linenos">1268</span></a>                        <span class="s1">&#39;Specified script </span><span class="si">{0}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-1269"><a href="#SystemSetup-1269"><span class="linenos">1269</span></a>                            <span class="n">script_file</span>
</span><span id="SystemSetup-1270"><a href="#SystemSetup-1270"><span class="linenos">1270</span></a>                        <span class="p">)</span>
</span><span id="SystemSetup-1271"><a href="#SystemSetup-1271"><span class="linenos">1271</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1272"><a href="#SystemSetup-1272"><span class="linenos">1272</span></a>
</span><span id="SystemSetup-1273"><a href="#SystemSetup-1273"><span class="linenos">1273</span></a>        <span class="k">if</span> <span class="n">need_script_helper_functions</span><span class="p">:</span>
</span><span id="SystemSetup-1274"><a href="#SystemSetup-1274"><span class="linenos">1274</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Importing script helper functions&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1275"><a href="#SystemSetup-1275"><span class="linenos">1275</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1276"><a href="#SystemSetup-1276"><span class="linenos">1276</span></a>                <span class="p">[</span>
</span><span id="SystemSetup-1277"><a href="#SystemSetup-1277"><span class="linenos">1277</span></a>                    <span class="s1">&#39;cp&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1278"><a href="#SystemSetup-1278"><span class="linenos">1278</span></a>                    <span class="n">Defaults</span><span class="o">.</span><span class="n">get_common_functions_file</span><span class="p">(),</span>
</span><span id="SystemSetup-1279"><a href="#SystemSetup-1279"><span class="linenos">1279</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/.kconfig&#39;</span>
</span><span id="SystemSetup-1280"><a href="#SystemSetup-1280"><span class="linenos">1280</span></a>                <span class="p">]</span>
</span><span id="SystemSetup-1281"><a href="#SystemSetup-1281"><span class="linenos">1281</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1282"><a href="#SystemSetup-1282"><span class="linenos">1282</span></a>
</span><span id="SystemSetup-1283"><a href="#SystemSetup-1283"><span class="linenos">1283</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup-1284"><a href="#SystemSetup-1284"><span class="linenos">1284</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SystemSetup-1285"><a href="#SystemSetup-1285"><span class="linenos">1285</span></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SystemSetup-1286"><a href="#SystemSetup-1286"><span class="linenos">1286</span></a>        <span class="n">option_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="SystemSetup-1287"><a href="#SystemSetup-1287"><span class="linenos">1287</span></a>        <span class="n">path_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span><span class="p">,</span>
</span><span id="SystemSetup-1288"><a href="#SystemSetup-1288"><span class="linenos">1288</span></a>        <span class="n">root_is_mountpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SystemSetup-1289"><a href="#SystemSetup-1289"><span class="linenos">1289</span></a>    <span class="p">):</span>
</span><span id="SystemSetup-1290"><a href="#SystemSetup-1290"><span class="linenos">1290</span></a>        <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
</span><span id="SystemSetup-1291"><a href="#SystemSetup-1291"><span class="linenos">1291</span></a>            <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">path_prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="SystemSetup-1292"><a href="#SystemSetup-1292"><span class="linenos">1292</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
</span><span id="SystemSetup-1293"><a href="#SystemSetup-1293"><span class="linenos">1293</span></a>                <span class="k">if</span> <span class="n">root_is_mountpoint</span><span class="p">:</span>
</span><span id="SystemSetup-1294"><a href="#SystemSetup-1294"><span class="linenos">1294</span></a>                    <span class="n">chroot_mount</span> <span class="o">=</span> <span class="n">MountManager</span><span class="p">(</span>
</span><span id="SystemSetup-1295"><a href="#SystemSetup-1295"><span class="linenos">1295</span></a>                        <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">mountpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span>
</span><span id="SystemSetup-1296"><a href="#SystemSetup-1296"><span class="linenos">1296</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1297"><a href="#SystemSetup-1297"><span class="linenos">1297</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">chroot_mount</span><span class="o">.</span><span class="n">is_mounted</span><span class="p">():</span>
</span><span id="SystemSetup-1298"><a href="#SystemSetup-1298"><span class="linenos">1298</span></a>                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="SystemSetup-1299"><a href="#SystemSetup-1299"><span class="linenos">1299</span></a>                            <span class="sa">f</span><span class="s1">&#39;Self bind mount </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s1"> for (/) in chroot&#39;</span>
</span><span id="SystemSetup-1300"><a href="#SystemSetup-1300"><span class="linenos">1300</span></a>                        <span class="p">)</span>
</span><span id="SystemSetup-1301"><a href="#SystemSetup-1301"><span class="linenos">1301</span></a>                        <span class="n">chroot_mount</span><span class="o">.</span><span class="n">bind_mount</span><span class="p">()</span>
</span><span id="SystemSetup-1302"><a href="#SystemSetup-1302"><span class="linenos">1302</span></a>                        <span class="n">stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">chroot_mount</span><span class="p">)</span>
</span><span id="SystemSetup-1303"><a href="#SystemSetup-1303"><span class="linenos">1303</span></a>                <span class="n">options</span> <span class="o">=</span> <span class="n">option_list</span> <span class="ow">or</span> <span class="p">[]</span>
</span><span id="SystemSetup-1304"><a href="#SystemSetup-1304"><span class="linenos">1304</span></a>                <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">getLogFlags</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run-scripts-in-screen&#39;</span><span class="p">):</span>
</span><span id="SystemSetup-1305"><a href="#SystemSetup-1305"><span class="linenos">1305</span></a>                    <span class="c1"># Run scripts in a screen session if requested</span>
</span><span id="SystemSetup-1306"><a href="#SystemSetup-1306"><span class="linenos">1306</span></a>                    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;-X&#39;</span><span class="p">,</span> <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">]</span>
</span><span id="SystemSetup-1307"><a href="#SystemSetup-1307"><span class="linenos">1307</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-1308"><a href="#SystemSetup-1308"><span class="linenos">1308</span></a>                    <span class="c1"># In standard mode run scripts without a terminal</span>
</span><span id="SystemSetup-1309"><a href="#SystemSetup-1309"><span class="linenos">1309</span></a>                    <span class="c1"># associated to them</span>
</span><span id="SystemSetup-1310"><a href="#SystemSetup-1310"><span class="linenos">1310</span></a>                    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">]</span>
</span><span id="SystemSetup-1311"><a href="#SystemSetup-1311"><span class="linenos">1311</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
</span><span id="SystemSetup-1312"><a href="#SystemSetup-1312"><span class="linenos">1312</span></a>                    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;bash&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1313"><a href="#SystemSetup-1313"><span class="linenos">1313</span></a>                <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SystemSetup-1314"><a href="#SystemSetup-1314"><span class="linenos">1314</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">path_prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="SystemSetup-1315"><a href="#SystemSetup-1315"><span class="linenos">1315</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1316"><a href="#SystemSetup-1316"><span class="linenos">1316</span></a>                <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="SystemSetup-1317"><a href="#SystemSetup-1317"><span class="linenos">1317</span></a>                <span class="n">profile</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="p">)</span>
</span><span id="SystemSetup-1318"><a href="#SystemSetup-1318"><span class="linenos">1318</span></a>                <span class="n">caller_environment</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
</span><span id="SystemSetup-1319"><a href="#SystemSetup-1319"><span class="linenos">1319</span></a>                <span class="n">caller_environment</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">get_settings</span><span class="p">())</span>
</span><span id="SystemSetup-1320"><a href="#SystemSetup-1320"><span class="linenos">1320</span></a>                <span class="n">config_script</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">caller_environment</span><span class="p">)</span>
</span><span id="SystemSetup-1321"><a href="#SystemSetup-1321"><span class="linenos">1321</span></a>                <span class="n">process</span> <span class="o">=</span> <span class="n">CommandProcess</span><span class="p">(</span>
</span><span id="SystemSetup-1322"><a href="#SystemSetup-1322"><span class="linenos">1322</span></a>                    <span class="n">command</span><span class="o">=</span><span class="n">config_script</span><span class="p">,</span>
</span><span id="SystemSetup-1323"><a href="#SystemSetup-1323"><span class="linenos">1323</span></a>                    <span class="n">log_topic</span><span class="o">=</span><span class="s1">&#39;Calling &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; script&#39;</span>
</span><span id="SystemSetup-1324"><a href="#SystemSetup-1324"><span class="linenos">1324</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1325"><a href="#SystemSetup-1325"><span class="linenos">1325</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">poll_and_watch</span><span class="p">()</span>
</span><span id="SystemSetup-1326"><a href="#SystemSetup-1326"><span class="linenos">1326</span></a>                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SystemSetup-1327"><a href="#SystemSetup-1327"><span class="linenos">1327</span></a>                    <span class="k">raise</span> <span class="n">KiwiScriptFailed</span><span class="p">(</span>
</span><span id="SystemSetup-1328"><a href="#SystemSetup-1328"><span class="linenos">1328</span></a>                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> failed with: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="SystemSetup-1329"><a href="#SystemSetup-1329"><span class="linenos">1329</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1330"><a href="#SystemSetup-1330"><span class="linenos">1330</span></a>                <span class="c1"># if configured, assign SELinux labels</span>
</span><span id="SystemSetup-1331"><a href="#SystemSetup-1331"><span class="linenos">1331</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">setup_selinux_file_contexts</span><span class="p">()</span>
</span><span id="SystemSetup-1332"><a href="#SystemSetup-1332"><span class="linenos">1332</span></a>
</span><span id="SystemSetup-1333"><a href="#SystemSetup-1333"><span class="linenos">1333</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_call_script_no_chroot</span><span class="p">(</span>
</span><span id="SystemSetup-1334"><a href="#SystemSetup-1334"><span class="linenos">1334</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">option_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">working_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="SystemSetup-1335"><a href="#SystemSetup-1335"><span class="linenos">1335</span></a>    <span class="p">):</span>
</span><span id="SystemSetup-1336"><a href="#SystemSetup-1336"><span class="linenos">1336</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">working_directory</span><span class="p">:</span>
</span><span id="SystemSetup-1337"><a href="#SystemSetup-1337"><span class="linenos">1337</span></a>            <span class="n">working_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span>
</span><span id="SystemSetup-1338"><a href="#SystemSetup-1338"><span class="linenos">1338</span></a>        <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
</span><span id="SystemSetup-1339"><a href="#SystemSetup-1339"><span class="linenos">1339</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">])</span>
</span><span id="SystemSetup-1340"><a href="#SystemSetup-1340"><span class="linenos">1340</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1341"><a href="#SystemSetup-1341"><span class="linenos">1341</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
</span><span id="SystemSetup-1342"><a href="#SystemSetup-1342"><span class="linenos">1342</span></a>            <span class="n">bash_command</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SystemSetup-1343"><a href="#SystemSetup-1343"><span class="linenos">1343</span></a>                <span class="s1">&#39;cd&#39;</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;&amp;&amp;&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1344"><a href="#SystemSetup-1344"><span class="linenos">1344</span></a>                <span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;--norc&#39;</span><span class="p">,</span> <span class="n">script_path</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">option_list</span><span class="p">)</span>
</span><span id="SystemSetup-1345"><a href="#SystemSetup-1345"><span class="linenos">1345</span></a>            <span class="p">]</span>
</span><span id="SystemSetup-1346"><a href="#SystemSetup-1346"><span class="linenos">1346</span></a>            <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">getLogFlags</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run-scripts-in-screen&#39;</span><span class="p">):</span>
</span><span id="SystemSetup-1347"><a href="#SystemSetup-1347"><span class="linenos">1347</span></a>                <span class="c1"># Run scripts in a screen session if requested</span>
</span><span id="SystemSetup-1348"><a href="#SystemSetup-1348"><span class="linenos">1348</span></a>                <span class="n">config_script</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
</span><span id="SystemSetup-1349"><a href="#SystemSetup-1349"><span class="linenos">1349</span></a>                    <span class="p">[</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;-X&#39;</span><span class="p">,</span> <span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bash_command</span><span class="p">)]</span>
</span><span id="SystemSetup-1350"><a href="#SystemSetup-1350"><span class="linenos">1350</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1351"><a href="#SystemSetup-1351"><span class="linenos">1351</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-1352"><a href="#SystemSetup-1352"><span class="linenos">1352</span></a>                <span class="c1"># In standard mode run script through bash</span>
</span><span id="SystemSetup-1353"><a href="#SystemSetup-1353"><span class="linenos">1353</span></a>                <span class="n">config_script</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
</span><span id="SystemSetup-1354"><a href="#SystemSetup-1354"><span class="linenos">1354</span></a>                    <span class="p">[</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bash_command</span><span class="p">)]</span>
</span><span id="SystemSetup-1355"><a href="#SystemSetup-1355"><span class="linenos">1355</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1356"><a href="#SystemSetup-1356"><span class="linenos">1356</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">CommandProcess</span><span class="p">(</span>
</span><span id="SystemSetup-1357"><a href="#SystemSetup-1357"><span class="linenos">1357</span></a>                <span class="n">command</span><span class="o">=</span><span class="n">config_script</span><span class="p">,</span> <span class="n">log_topic</span><span class="o">=</span><span class="s1">&#39;Calling &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; script&#39;</span>
</span><span id="SystemSetup-1358"><a href="#SystemSetup-1358"><span class="linenos">1358</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1359"><a href="#SystemSetup-1359"><span class="linenos">1359</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">poll_and_watch</span><span class="p">()</span>
</span><span id="SystemSetup-1360"><a href="#SystemSetup-1360"><span class="linenos">1360</span></a>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SystemSetup-1361"><a href="#SystemSetup-1361"><span class="linenos">1361</span></a>                <span class="k">raise</span> <span class="n">KiwiScriptFailed</span><span class="p">(</span>
</span><span id="SystemSetup-1362"><a href="#SystemSetup-1362"><span class="linenos">1362</span></a>                    <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> failed: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="SystemSetup-1363"><a href="#SystemSetup-1363"><span class="linenos">1363</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1364"><a href="#SystemSetup-1364"><span class="linenos">1364</span></a>
</span><span id="SystemSetup-1365"><a href="#SystemSetup-1365"><span class="linenos">1365</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_passwd_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span><span id="SystemSetup-1366"><a href="#SystemSetup-1366"><span class="linenos">1366</span></a>        <span class="n">openssl</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1367"><a href="#SystemSetup-1367"><span class="linenos">1367</span></a>            <span class="p">[</span><span class="s1">&#39;openssl&#39;</span><span class="p">,</span> <span class="s1">&#39;passwd&#39;</span><span class="p">,</span> <span class="s1">&#39;-1&#39;</span><span class="p">,</span> <span class="s1">&#39;-salt&#39;</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">]</span>
</span><span id="SystemSetup-1368"><a href="#SystemSetup-1368"><span class="linenos">1368</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1369"><a href="#SystemSetup-1369"><span class="linenos">1369</span></a>        <span class="k">return</span> <span class="n">openssl</span><span class="o">.</span><span class="n">output</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SystemSetup-1370"><a href="#SystemSetup-1370"><span class="linenos">1370</span></a>
</span><span id="SystemSetup-1371"><a href="#SystemSetup-1371"><span class="linenos">1371</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_preferences_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SystemSetup-1372"><a href="#SystemSetup-1372"><span class="linenos">1372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SystemSetup-1373"><a href="#SystemSetup-1373"><span class="linenos">1373</span></a>        <span class="k">for</span> <span class="n">preferences</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_preferences_sections</span><span class="p">():</span>
</span><span id="SystemSetup-1374"><a href="#SystemSetup-1374"><span class="linenos">1374</span></a>            <span class="n">timezone_section</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">get_timezone</span><span class="p">()</span>
</span><span id="SystemSetup-1375"><a href="#SystemSetup-1375"><span class="linenos">1375</span></a>            <span class="n">locale_section</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">get_locale</span><span class="p">()</span>
</span><span id="SystemSetup-1376"><a href="#SystemSetup-1376"><span class="linenos">1376</span></a>            <span class="n">keytable_section</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">get_keytable</span><span class="p">()</span>
</span><span id="SystemSetup-1377"><a href="#SystemSetup-1377"><span class="linenos">1377</span></a>            <span class="k">if</span> <span class="n">timezone_section</span><span class="p">:</span>
</span><span id="SystemSetup-1378"><a href="#SystemSetup-1378"><span class="linenos">1378</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timezone_section</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SystemSetup-1379"><a href="#SystemSetup-1379"><span class="linenos">1379</span></a>            <span class="k">if</span> <span class="n">locale_section</span><span class="p">:</span>
</span><span id="SystemSetup-1380"><a href="#SystemSetup-1380"><span class="linenos">1380</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">locale_section</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SystemSetup-1381"><a href="#SystemSetup-1381"><span class="linenos">1381</span></a>            <span class="k">if</span> <span class="n">keytable_section</span><span class="p">:</span>
</span><span id="SystemSetup-1382"><a href="#SystemSetup-1382"><span class="linenos">1382</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keytable_section</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SystemSetup-1383"><a href="#SystemSetup-1383"><span class="linenos">1383</span></a>
</span><span id="SystemSetup-1384"><a href="#SystemSetup-1384"><span class="linenos">1384</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_oemconfig_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SystemSetup-1385"><a href="#SystemSetup-1385"><span class="linenos">1385</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SystemSetup-1386"><a href="#SystemSetup-1386"><span class="linenos">1386</span></a>            <span class="s1">&#39;recovery_inplace&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="SystemSetup-1387"><a href="#SystemSetup-1387"><span class="linenos">1387</span></a>            <span class="s1">&#39;recovery&#39;</span><span class="p">:</span> <span class="kc">False</span>
</span><span id="SystemSetup-1388"><a href="#SystemSetup-1388"><span class="linenos">1388</span></a>        <span class="p">}</span>
</span><span id="SystemSetup-1389"><a href="#SystemSetup-1389"><span class="linenos">1389</span></a>        <span class="n">oemconfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_build_type_oemconfig_section</span><span class="p">()</span>
</span><span id="SystemSetup-1390"><a href="#SystemSetup-1390"><span class="linenos">1390</span></a>        <span class="k">if</span> <span class="n">oemconfig</span><span class="p">:</span>
</span><span id="SystemSetup-1391"><a href="#SystemSetup-1391"><span class="linenos">1391</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span><span class="p">[</span><span class="s1">&#39;recovery&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="SystemSetup-1392"><a href="#SystemSetup-1392"><span class="linenos">1392</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">(</span><span class="n">oemconfig</span><span class="o">.</span><span class="n">get_oem_recovery</span><span class="p">())</span>
</span><span id="SystemSetup-1393"><a href="#SystemSetup-1393"><span class="linenos">1393</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span><span class="p">[</span><span class="s1">&#39;recovery_inplace&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="SystemSetup-1394"><a href="#SystemSetup-1394"><span class="linenos">1394</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">(</span><span class="n">oemconfig</span><span class="o">.</span><span class="n">get_oem_inplace_recovery</span><span class="p">())</span>
</span><span id="SystemSetup-1395"><a href="#SystemSetup-1395"><span class="linenos">1395</span></a>
</span><span id="SystemSetup-1396"><a href="#SystemSetup-1396"><span class="linenos">1396</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_content</span><span class="p">):</span>
</span><span id="SystemSetup-1397"><a href="#SystemSetup-1397"><span class="linenos">1397</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup-1398"><a href="#SystemSetup-1398"><span class="linenos">1398</span></a><span class="sd">        Helper method to return the text for XML elements of the</span>
</span><span id="SystemSetup-1399"><a href="#SystemSetup-1399"><span class="linenos">1399</span></a><span class="sd">        following structure: &lt;section&gt;text&lt;/section&gt;.</span>
</span><span id="SystemSetup-1400"><a href="#SystemSetup-1400"><span class="linenos">1400</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup-1401"><a href="#SystemSetup-1401"><span class="linenos">1401</span></a>        <span class="k">if</span> <span class="n">section_content</span><span class="p">:</span>
</span><span id="SystemSetup-1402"><a href="#SystemSetup-1402"><span class="linenos">1402</span></a>            <span class="k">return</span> <span class="n">section_content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SystemSetup-1403"><a href="#SystemSetup-1403"><span class="linenos">1403</span></a>
</span><span id="SystemSetup-1404"><a href="#SystemSetup-1404"><span class="linenos">1404</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_rpm_flake_pilot_system_file_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="SystemSetup-1405"><a href="#SystemSetup-1405"><span class="linenos">1405</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export rpm system files script for flake-pilot&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1406"><a href="#SystemSetup-1406"><span class="linenos">1406</span></a>        <span class="n">dbpath_option</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SystemSetup-1407"><a href="#SystemSetup-1407"><span class="linenos">1407</span></a>            <span class="s1">&#39;--dbpath&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rpm_database_location</span><span class="p">()</span>
</span><span id="SystemSetup-1408"><a href="#SystemSetup-1408"><span class="linenos">1408</span></a>        <span class="p">]</span>
</span><span id="SystemSetup-1409"><a href="#SystemSetup-1409"><span class="linenos">1409</span></a>        <span class="n">skip_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_system_files_ignore_packages</span><span class="p">()</span>
</span><span id="SystemSetup-1410"><a href="#SystemSetup-1410"><span class="linenos">1410</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1411"><a href="#SystemSetup-1411"><span class="linenos">1411</span></a>            <span class="p">[</span>
</span><span id="SystemSetup-1412"><a href="#SystemSetup-1412"><span class="linenos">1412</span></a>                <span class="s1">&#39;rpm&#39;</span><span class="p">,</span> <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;-qa&#39;</span><span class="p">,</span> <span class="s1">&#39;--qf&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{NAME}</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SystemSetup-1413"><a href="#SystemSetup-1413"><span class="linenos">1413</span></a>            <span class="p">]</span> <span class="o">+</span> <span class="n">dbpath_option</span>
</span><span id="SystemSetup-1414"><a href="#SystemSetup-1414"><span class="linenos">1414</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1415"><a href="#SystemSetup-1415"><span class="linenos">1415</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">systemfiles</span><span class="p">:</span>
</span><span id="SystemSetup-1416"><a href="#SystemSetup-1416"><span class="linenos">1416</span></a>            <span class="n">systemfiles</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;set -e</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1417"><a href="#SystemSetup-1417"><span class="linenos">1417</span></a>            <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span><span id="SystemSetup-1418"><a href="#SystemSetup-1418"><span class="linenos">1418</span></a>                <span class="k">if</span> <span class="n">package</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_list</span><span class="p">:</span>
</span><span id="SystemSetup-1419"><a href="#SystemSetup-1419"><span class="linenos">1419</span></a>                    <span class="n">systemfiles</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rpm --noghost -ql </span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1420"><a href="#SystemSetup-1420"><span class="linenos">1420</span></a>
</span><span id="SystemSetup-1421"><a href="#SystemSetup-1421"><span class="linenos">1421</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_rpm_package_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="SystemSetup-1422"><a href="#SystemSetup-1422"><span class="linenos">1422</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export rpm packages metadata&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1423"><a href="#SystemSetup-1423"><span class="linenos">1423</span></a>        <span class="n">dbpath_option</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SystemSetup-1424"><a href="#SystemSetup-1424"><span class="linenos">1424</span></a>            <span class="s1">&#39;--dbpath&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rpm_database_location</span><span class="p">()</span>
</span><span id="SystemSetup-1425"><a href="#SystemSetup-1425"><span class="linenos">1425</span></a>        <span class="p">]</span>
</span><span id="SystemSetup-1426"><a href="#SystemSetup-1426"><span class="linenos">1426</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1427"><a href="#SystemSetup-1427"><span class="linenos">1427</span></a>            <span class="p">[</span>
</span><span id="SystemSetup-1428"><a href="#SystemSetup-1428"><span class="linenos">1428</span></a>                <span class="s1">&#39;rpm&#39;</span><span class="p">,</span> <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;-qa&#39;</span><span class="p">,</span> <span class="s1">&#39;--qf&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1429"><a href="#SystemSetup-1429"><span class="linenos">1429</span></a>                <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-1430"><a href="#SystemSetup-1430"><span class="linenos">1430</span></a>                    <span class="p">[</span>
</span><span id="SystemSetup-1431"><a href="#SystemSetup-1431"><span class="linenos">1431</span></a>                        <span class="s1">&#39;%</span><span class="si">{NAME}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{EPOCH}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{VERSION}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1432"><a href="#SystemSetup-1432"><span class="linenos">1432</span></a>                        <span class="s1">&#39;%</span><span class="si">{RELEASE}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{ARCH}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{DISTURL}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{LICENSE}</span><span class="s1">&#39;</span>
</span><span id="SystemSetup-1433"><a href="#SystemSetup-1433"><span class="linenos">1433</span></a>                    <span class="p">]</span>
</span><span id="SystemSetup-1434"><a href="#SystemSetup-1434"><span class="linenos">1434</span></a>                <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span>
</span><span id="SystemSetup-1435"><a href="#SystemSetup-1435"><span class="linenos">1435</span></a>            <span class="p">]</span> <span class="o">+</span> <span class="n">dbpath_option</span>
</span><span id="SystemSetup-1436"><a href="#SystemSetup-1436"><span class="linenos">1436</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1437"><a href="#SystemSetup-1437"><span class="linenos">1437</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">packages</span><span class="p">:</span>
</span><span id="SystemSetup-1438"><a href="#SystemSetup-1438"><span class="linenos">1438</span></a>            <span class="n">packages</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="SystemSetup-1439"><a href="#SystemSetup-1439"><span class="linenos">1439</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()))</span>
</span><span id="SystemSetup-1440"><a href="#SystemSetup-1440"><span class="linenos">1440</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1441"><a href="#SystemSetup-1441"><span class="linenos">1441</span></a>            <span class="n">packages</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="SystemSetup-1442"><a href="#SystemSetup-1442"><span class="linenos">1442</span></a>
</span><span id="SystemSetup-1443"><a href="#SystemSetup-1443"><span class="linenos">1443</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_deb_package_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="SystemSetup-1444"><a href="#SystemSetup-1444"><span class="linenos">1444</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export deb packages metadata&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1445"><a href="#SystemSetup-1445"><span class="linenos">1445</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1446"><a href="#SystemSetup-1446"><span class="linenos">1446</span></a>            <span class="p">[</span>
</span><span id="SystemSetup-1447"><a href="#SystemSetup-1447"><span class="linenos">1447</span></a>                <span class="s1">&#39;dpkg-query&#39;</span><span class="p">,</span> <span class="s1">&#39;--admindir&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1448"><a href="#SystemSetup-1448"><span class="linenos">1448</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;var/lib/dpkg&#39;</span><span class="p">]),</span> <span class="s1">&#39;-W&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1449"><a href="#SystemSetup-1449"><span class="linenos">1449</span></a>                <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-1450"><a href="#SystemSetup-1450"><span class="linenos">1450</span></a>                    <span class="p">[</span>
</span><span id="SystemSetup-1451"><a href="#SystemSetup-1451"><span class="linenos">1451</span></a>                        <span class="s1">&#39;$</span><span class="si">{Package}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="si">{Version}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1452"><a href="#SystemSetup-1452"><span class="linenos">1452</span></a>                        <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="si">{Architecture}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span>
</span><span id="SystemSetup-1453"><a href="#SystemSetup-1453"><span class="linenos">1453</span></a>                    <span class="p">]</span>
</span><span id="SystemSetup-1454"><a href="#SystemSetup-1454"><span class="linenos">1454</span></a>                <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span>
</span><span id="SystemSetup-1455"><a href="#SystemSetup-1455"><span class="linenos">1455</span></a>            <span class="p">]</span>
</span><span id="SystemSetup-1456"><a href="#SystemSetup-1456"><span class="linenos">1456</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1457"><a href="#SystemSetup-1457"><span class="linenos">1457</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">packages</span><span class="p">:</span>
</span><span id="SystemSetup-1458"><a href="#SystemSetup-1458"><span class="linenos">1458</span></a>            <span class="n">packages</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="SystemSetup-1459"><a href="#SystemSetup-1459"><span class="linenos">1459</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()))</span>
</span><span id="SystemSetup-1460"><a href="#SystemSetup-1460"><span class="linenos">1460</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1461"><a href="#SystemSetup-1461"><span class="linenos">1461</span></a>            <span class="n">packages</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="SystemSetup-1462"><a href="#SystemSetup-1462"><span class="linenos">1462</span></a>
</span><span id="SystemSetup-1463"><a href="#SystemSetup-1463"><span class="linenos">1463</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_pacman_package_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="SystemSetup-1464"><a href="#SystemSetup-1464"><span class="linenos">1464</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export pacman packages metadata&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1465"><a href="#SystemSetup-1465"><span class="linenos">1465</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1466"><a href="#SystemSetup-1466"><span class="linenos">1466</span></a>            <span class="p">[</span>
</span><span id="SystemSetup-1467"><a href="#SystemSetup-1467"><span class="linenos">1467</span></a>                <span class="s1">&#39;pacman&#39;</span><span class="p">,</span> <span class="s1">&#39;--query&#39;</span><span class="p">,</span> <span class="s1">&#39;--dbpath&#39;</span><span class="p">,</span>
</span><span id="SystemSetup-1468"><a href="#SystemSetup-1468"><span class="linenos">1468</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;var/lib/pacman&#39;</span><span class="p">])</span>
</span><span id="SystemSetup-1469"><a href="#SystemSetup-1469"><span class="linenos">1469</span></a>            <span class="p">]</span>
</span><span id="SystemSetup-1470"><a href="#SystemSetup-1470"><span class="linenos">1470</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1471"><a href="#SystemSetup-1471"><span class="linenos">1471</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">packages</span><span class="p">:</span>
</span><span id="SystemSetup-1472"><a href="#SystemSetup-1472"><span class="linenos">1472</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span><span id="SystemSetup-1473"><a href="#SystemSetup-1473"><span class="linenos">1473</span></a>                <span class="n">package</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">version_release</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1474"><a href="#SystemSetup-1474"><span class="linenos">1474</span></a>                <span class="n">version</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">release</span> <span class="o">=</span> <span class="n">version_release</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1475"><a href="#SystemSetup-1475"><span class="linenos">1475</span></a>                <span class="n">packages</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span>
</span><span id="SystemSetup-1476"><a href="#SystemSetup-1476"><span class="linenos">1476</span></a>                    <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">|None|</span><span class="si">{1}</span><span class="s1">|</span><span class="si">{2}</span><span class="s1">|None|None|None</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-1477"><a href="#SystemSetup-1477"><span class="linenos">1477</span></a>                        <span class="n">package</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
</span><span id="SystemSetup-1478"><a href="#SystemSetup-1478"><span class="linenos">1478</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1479"><a href="#SystemSetup-1479"><span class="linenos">1479</span></a>                <span class="p">])</span>
</span><span id="SystemSetup-1480"><a href="#SystemSetup-1480"><span class="linenos">1480</span></a>
</span><span id="SystemSetup-1481"><a href="#SystemSetup-1481"><span class="linenos">1481</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_rpm_package_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="SystemSetup-1482"><a href="#SystemSetup-1482"><span class="linenos">1482</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export rpm packages changelog metadata&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1483"><a href="#SystemSetup-1483"><span class="linenos">1483</span></a>        <span class="n">dbpath_option</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SystemSetup-1484"><a href="#SystemSetup-1484"><span class="linenos">1484</span></a>            <span class="s1">&#39;--dbpath&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rpm_database_location</span><span class="p">()</span>
</span><span id="SystemSetup-1485"><a href="#SystemSetup-1485"><span class="linenos">1485</span></a>        <span class="p">]</span>
</span><span id="SystemSetup-1486"><a href="#SystemSetup-1486"><span class="linenos">1486</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1487"><a href="#SystemSetup-1487"><span class="linenos">1487</span></a>            <span class="p">[</span>
</span><span id="SystemSetup-1488"><a href="#SystemSetup-1488"><span class="linenos">1488</span></a>                <span class="s1">&#39;rpm&#39;</span><span class="p">,</span> <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup-1489"><a href="#SystemSetup-1489"><span class="linenos">1489</span></a>                <span class="s1">&#39;-qa&#39;</span><span class="p">,</span> <span class="s1">&#39;--qf&#39;</span><span class="p">,</span> <span class="s1">&#39;%</span><span class="si">{NAME}</span><span class="s1">|</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span> <span class="s1">&#39;--changelog&#39;</span>
</span><span id="SystemSetup-1490"><a href="#SystemSetup-1490"><span class="linenos">1490</span></a>            <span class="p">]</span> <span class="o">+</span> <span class="n">dbpath_option</span>
</span><span id="SystemSetup-1491"><a href="#SystemSetup-1491"><span class="linenos">1491</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1492"><a href="#SystemSetup-1492"><span class="linenos">1492</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">changelog</span><span class="p">:</span>
</span><span id="SystemSetup-1493"><a href="#SystemSetup-1493"><span class="linenos">1493</span></a>            <span class="n">changelog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</span><span id="SystemSetup-1494"><a href="#SystemSetup-1494"><span class="linenos">1494</span></a>
</span><span id="SystemSetup-1495"><a href="#SystemSetup-1495"><span class="linenos">1495</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_deb_package_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="SystemSetup-1496"><a href="#SystemSetup-1496"><span class="linenos">1496</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export deb packages changelog metadata&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1497"><a href="#SystemSetup-1497"><span class="linenos">1497</span></a>        <span class="n">package_doc_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-1498"><a href="#SystemSetup-1498"><span class="linenos">1498</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;/usr/share/doc&#39;</span><span class="p">]</span>
</span><span id="SystemSetup-1499"><a href="#SystemSetup-1499"><span class="linenos">1499</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1500"><a href="#SystemSetup-1500"><span class="linenos">1500</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">changelog</span><span class="p">:</span>
</span><span id="SystemSetup-1501"><a href="#SystemSetup-1501"><span class="linenos">1501</span></a>            <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">package_doc_dir</span><span class="p">)):</span>
</span><span id="SystemSetup-1502"><a href="#SystemSetup-1502"><span class="linenos">1502</span></a>                <span class="n">changelog_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-1503"><a href="#SystemSetup-1503"><span class="linenos">1503</span></a>                    <span class="p">[</span><span class="n">package_doc_dir</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="s1">&#39;changelog.Debian.gz&#39;</span><span class="p">]</span>
</span><span id="SystemSetup-1504"><a href="#SystemSetup-1504"><span class="linenos">1504</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1505"><a href="#SystemSetup-1505"><span class="linenos">1505</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">changelog_file</span><span class="p">):</span>
</span><span id="SystemSetup-1506"><a href="#SystemSetup-1506"><span class="linenos">1506</span></a>                    <span class="n">changelog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="SystemSetup-1507"><a href="#SystemSetup-1507"><span class="linenos">1507</span></a>                        <span class="s1">&#39;</span><span class="si">{0}{1}{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="SystemSetup-1508"><a href="#SystemSetup-1508"><span class="linenos">1508</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1509"><a href="#SystemSetup-1509"><span class="linenos">1509</span></a>                    <span class="n">changelog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span id="SystemSetup-1510"><a href="#SystemSetup-1510"><span class="linenos">1510</span></a>                        <span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-1511"><a href="#SystemSetup-1511"><span class="linenos">1511</span></a>                            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;zcat&#39;</span><span class="p">,</span> <span class="n">changelog_file</span><span class="p">])</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
</span><span id="SystemSetup-1512"><a href="#SystemSetup-1512"><span class="linenos">1512</span></a>                            <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
</span><span id="SystemSetup-1513"><a href="#SystemSetup-1513"><span class="linenos">1513</span></a>                        <span class="p">)</span>
</span><span id="SystemSetup-1514"><a href="#SystemSetup-1514"><span class="linenos">1514</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup-1515"><a href="#SystemSetup-1515"><span class="linenos">1515</span></a>
</span><span id="SystemSetup-1516"><a href="#SystemSetup-1516"><span class="linenos">1516</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_rpm_package_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="SystemSetup-1517"><a href="#SystemSetup-1517"><span class="linenos">1517</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export rpm verification metadata&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1518"><a href="#SystemSetup-1518"><span class="linenos">1518</span></a>        <span class="n">dbpath_option</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SystemSetup-1519"><a href="#SystemSetup-1519"><span class="linenos">1519</span></a>            <span class="s1">&#39;--dbpath&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rpm_database_location</span><span class="p">()</span>
</span><span id="SystemSetup-1520"><a href="#SystemSetup-1520"><span class="linenos">1520</span></a>        <span class="p">]</span>
</span><span id="SystemSetup-1521"><a href="#SystemSetup-1521"><span class="linenos">1521</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1522"><a href="#SystemSetup-1522"><span class="linenos">1522</span></a>            <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rpm&#39;</span><span class="p">,</span> <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;-Va&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dbpath_option</span><span class="p">,</span>
</span><span id="SystemSetup-1523"><a href="#SystemSetup-1523"><span class="linenos">1523</span></a>            <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-1524"><a href="#SystemSetup-1524"><span class="linenos">1524</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1525"><a href="#SystemSetup-1525"><span class="linenos">1525</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">verified</span><span class="p">:</span>
</span><span id="SystemSetup-1526"><a href="#SystemSetup-1526"><span class="linenos">1526</span></a>            <span class="n">verified</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</span><span id="SystemSetup-1527"><a href="#SystemSetup-1527"><span class="linenos">1527</span></a>
</span><span id="SystemSetup-1528"><a href="#SystemSetup-1528"><span class="linenos">1528</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_export_deb_package_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span id="SystemSetup-1529"><a href="#SystemSetup-1529"><span class="linenos">1529</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export deb verification metadata&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1530"><a href="#SystemSetup-1530"><span class="linenos">1530</span></a>        <span class="n">query_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1531"><a href="#SystemSetup-1531"><span class="linenos">1531</span></a>            <span class="n">command</span><span class="o">=</span><span class="p">[</span>
</span><span id="SystemSetup-1532"><a href="#SystemSetup-1532"><span class="linenos">1532</span></a>                <span class="s1">&#39;dpkg&#39;</span><span class="p">,</span> <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup-1533"><a href="#SystemSetup-1533"><span class="linenos">1533</span></a>                <span class="s1">&#39;-V&#39;</span><span class="p">,</span> <span class="s1">&#39;--verify-format&#39;</span><span class="p">,</span> <span class="s1">&#39;rpm&#39;</span>
</span><span id="SystemSetup-1534"><a href="#SystemSetup-1534"><span class="linenos">1534</span></a>            <span class="p">],</span>
</span><span id="SystemSetup-1535"><a href="#SystemSetup-1535"><span class="linenos">1535</span></a>            <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup-1536"><a href="#SystemSetup-1536"><span class="linenos">1536</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1537"><a href="#SystemSetup-1537"><span class="linenos">1537</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">verified</span><span class="p">:</span>
</span><span id="SystemSetup-1538"><a href="#SystemSetup-1538"><span class="linenos">1538</span></a>            <span class="n">verified</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">query_call</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</span><span id="SystemSetup-1539"><a href="#SystemSetup-1539"><span class="linenos">1539</span></a>
</span><span id="SystemSetup-1540"><a href="#SystemSetup-1540"><span class="linenos">1540</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_rpm_database_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SystemSetup-1541"><a href="#SystemSetup-1541"><span class="linenos">1541</span></a>        <span class="n">shared_mount</span> <span class="o">=</span> <span class="n">MountManager</span><span class="p">(</span>
</span><span id="SystemSetup-1542"><a href="#SystemSetup-1542"><span class="linenos">1542</span></a>            <span class="n">device</span><span class="o">=</span><span class="s1">&#39;/dev&#39;</span><span class="p">,</span> <span class="n">mountpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/dev&#39;</span>
</span><span id="SystemSetup-1543"><a href="#SystemSetup-1543"><span class="linenos">1543</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1544"><a href="#SystemSetup-1544"><span class="linenos">1544</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">shared_mount</span><span class="o">.</span><span class="n">is_mounted</span><span class="p">():</span>
</span><span id="SystemSetup-1545"><a href="#SystemSetup-1545"><span class="linenos">1545</span></a>            <span class="n">shared_mount</span><span class="o">.</span><span class="n">bind_mount</span><span class="p">()</span>
</span><span id="SystemSetup-1546"><a href="#SystemSetup-1546"><span class="linenos">1546</span></a>        <span class="n">rpmdb</span> <span class="o">=</span> <span class="n">RpmDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="SystemSetup-1547"><a href="#SystemSetup-1547"><span class="linenos">1547</span></a>        <span class="k">if</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">has_rpm</span><span class="p">():</span>
</span><span id="SystemSetup-1548"><a href="#SystemSetup-1548"><span class="linenos">1548</span></a>            <span class="n">dbpath</span> <span class="o">=</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">rpmdb_image</span><span class="o">.</span><span class="n">expand_query</span><span class="p">(</span><span class="s1">&#39;%_dbpath&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1549"><a href="#SystemSetup-1549"><span class="linenos">1549</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-1550"><a href="#SystemSetup-1550"><span class="linenos">1550</span></a>            <span class="n">dbpath</span> <span class="o">=</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">rpmdb_host</span><span class="o">.</span><span class="n">expand_query</span><span class="p">(</span><span class="s1">&#39;%_dbpath&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1551"><a href="#SystemSetup-1551"><span class="linenos">1551</span></a>        <span class="k">if</span> <span class="n">shared_mount</span><span class="o">.</span><span class="n">is_mounted</span><span class="p">():</span>
</span><span id="SystemSetup-1552"><a href="#SystemSetup-1552"><span class="linenos">1552</span></a>            <span class="n">shared_mount</span><span class="o">.</span><span class="n">umount_lazy</span><span class="p">()</span>
</span><span id="SystemSetup-1553"><a href="#SystemSetup-1553"><span class="linenos">1553</span></a>        <span class="k">return</span> <span class="n">dbpath</span>
</span><span id="SystemSetup-1554"><a href="#SystemSetup-1554"><span class="linenos">1554</span></a>
</span><span id="SystemSetup-1555"><a href="#SystemSetup-1555"><span class="linenos">1555</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sync_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_list</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FileT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup-1556"><a href="#SystemSetup-1556"><span class="linenos">1556</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Installing files&quot;</span><span class="p">)</span>
</span><span id="SystemSetup-1557"><a href="#SystemSetup-1557"><span class="linenos">1557</span></a>        <span class="n">ordered_files</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">file_list</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
</span><span id="SystemSetup-1558"><a href="#SystemSetup-1558"><span class="linenos">1558</span></a>        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_t</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ordered_files</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="SystemSetup-1559"><a href="#SystemSetup-1559"><span class="linenos">1559</span></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">file_t</span><span class="o">.</span><span class="n">target</span>
</span><span id="SystemSetup-1560"><a href="#SystemSetup-1560"><span class="linenos">1560</span></a>            <span class="n">target_owner</span> <span class="o">=</span> <span class="n">file_t</span><span class="o">.</span><span class="n">owner</span>
</span><span id="SystemSetup-1561"><a href="#SystemSetup-1561"><span class="linenos">1561</span></a>            <span class="n">target_permissions</span> <span class="o">=</span> <span class="n">file_t</span><span class="o">.</span><span class="n">permissions</span>
</span><span id="SystemSetup-1562"><a href="#SystemSetup-1562"><span class="linenos">1562</span></a>            <span class="n">file_file</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup-1563"><a href="#SystemSetup-1563"><span class="linenos">1563</span></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">]</span>
</span><span id="SystemSetup-1564"><a href="#SystemSetup-1564"><span class="linenos">1564</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1565"><a href="#SystemSetup-1565"><span class="linenos">1565</span></a>            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span>
</span><span id="SystemSetup-1566"><a href="#SystemSetup-1566"><span class="linenos">1566</span></a>            <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
</span><span id="SystemSetup-1567"><a href="#SystemSetup-1567"><span class="linenos">1567</span></a>                <span class="n">target_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span>
</span><span id="SystemSetup-1568"><a href="#SystemSetup-1568"><span class="linenos">1568</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">target_name</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span>
</span><span id="SystemSetup-1569"><a href="#SystemSetup-1569"><span class="linenos">1569</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1570"><a href="#SystemSetup-1570"><span class="linenos">1570</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--&gt; file: </span><span class="si">{</span><span class="n">file_file</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">target_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1571"><a href="#SystemSetup-1571"><span class="linenos">1571</span></a>            <span class="k">if</span> <span class="n">target_owner</span><span class="p">:</span>
</span><span id="SystemSetup-1572"><a href="#SystemSetup-1572"><span class="linenos">1572</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1573"><a href="#SystemSetup-1573"><span class="linenos">1573</span></a>                    <span class="p">[</span>
</span><span id="SystemSetup-1574"><a href="#SystemSetup-1574"><span class="linenos">1574</span></a>                        <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup-1575"><a href="#SystemSetup-1575"><span class="linenos">1575</span></a>                        <span class="s1">&#39;chown&#39;</span><span class="p">,</span> <span class="n">target_owner</span><span class="p">,</span>
</span><span id="SystemSetup-1576"><a href="#SystemSetup-1576"><span class="linenos">1576</span></a>                        <span class="n">file_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1577"><a href="#SystemSetup-1577"><span class="linenos">1577</span></a>                    <span class="p">]</span>
</span><span id="SystemSetup-1578"><a href="#SystemSetup-1578"><span class="linenos">1578</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1579"><a href="#SystemSetup-1579"><span class="linenos">1579</span></a>            <span class="k">if</span> <span class="n">target_permissions</span><span class="p">:</span>
</span><span id="SystemSetup-1580"><a href="#SystemSetup-1580"><span class="linenos">1580</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup-1581"><a href="#SystemSetup-1581"><span class="linenos">1581</span></a>                    <span class="p">[</span>
</span><span id="SystemSetup-1582"><a href="#SystemSetup-1582"><span class="linenos">1582</span></a>                        <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup-1583"><a href="#SystemSetup-1583"><span class="linenos">1583</span></a>                        <span class="s1">&#39;chmod&#39;</span><span class="p">,</span> <span class="n">target_permissions</span><span class="p">,</span>
</span><span id="SystemSetup-1584"><a href="#SystemSetup-1584"><span class="linenos">1584</span></a>                        <span class="n">file_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1585"><a href="#SystemSetup-1585"><span class="linenos">1585</span></a>                    <span class="p">]</span>
</span><span id="SystemSetup-1586"><a href="#SystemSetup-1586"><span class="linenos">1586</span></a>                <span class="p">)</span>
</span><span id="SystemSetup-1587"><a href="#SystemSetup-1587"><span class="linenos">1587</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
</span><span id="SystemSetup-1588"><a href="#SystemSetup-1588"><span class="linenos">1588</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">target_name</span><span class="p">))</span>
</span><span id="SystemSetup-1589"><a href="#SystemSetup-1589"><span class="linenos">1589</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataSync</span><span class="p">(</span><span class="n">file_file</span><span class="p">,</span> <span class="n">target_name</span><span class="p">)</span>
</span><span id="SystemSetup-1590"><a href="#SystemSetup-1590"><span class="linenos">1590</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">sync_data</span><span class="p">(</span>
</span><span id="SystemSetup-1591"><a href="#SystemSetup-1591"><span class="linenos">1591</span></a>                <span class="n">options</span><span class="o">=</span><span class="n">Defaults</span><span class="o">.</span><span class="n">get_sync_options</span><span class="p">()</span>
</span><span id="SystemSetup-1592"><a href="#SystemSetup-1592"><span class="linenos">1592</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1593"><a href="#SystemSetup-1593"><span class="linenos">1593</span></a>
</span><span id="SystemSetup-1594"><a href="#SystemSetup-1594"><span class="linenos">1594</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sync_overlay_files</span><span class="p">(</span>
</span><span id="SystemSetup-1595"><a href="#SystemSetup-1595"><span class="linenos">1595</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">overlay_directory</span><span class="p">,</span> <span class="n">follow_links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="SystemSetup-1596"><a href="#SystemSetup-1596"><span class="linenos">1596</span></a>        <span class="n">preserve_owner_group</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="kc">None</span>
</span><span id="SystemSetup-1597"><a href="#SystemSetup-1597"><span class="linenos">1597</span></a>    <span class="p">):</span>
</span><span id="SystemSetup-1598"><a href="#SystemSetup-1598"><span class="linenos">1598</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup-1599"><a href="#SystemSetup-1599"><span class="linenos">1599</span></a>            <span class="s1">&#39;Copying user defined </span><span class="si">{0}</span><span class="s1"> to image tree&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-1600"><a href="#SystemSetup-1600"><span class="linenos">1600</span></a>                <span class="s1">&#39;files for profile: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span> <span class="k">if</span> <span class="n">profile</span> <span class="k">else</span> <span class="s1">&#39;files&#39;</span>
</span><span id="SystemSetup-1601"><a href="#SystemSetup-1601"><span class="linenos">1601</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1602"><a href="#SystemSetup-1602"><span class="linenos">1602</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1603"><a href="#SystemSetup-1603"><span class="linenos">1603</span></a>        <span class="n">sync_options</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SystemSetup-1604"><a href="#SystemSetup-1604"><span class="linenos">1604</span></a>            <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;-D&#39;</span><span class="p">,</span> <span class="s1">&#39;-H&#39;</span><span class="p">,</span> <span class="s1">&#39;-X&#39;</span><span class="p">,</span> <span class="s1">&#39;-A&#39;</span><span class="p">,</span> <span class="s1">&#39;--one-file-system&#39;</span>
</span><span id="SystemSetup-1605"><a href="#SystemSetup-1605"><span class="linenos">1605</span></a>        <span class="p">]</span>
</span><span id="SystemSetup-1606"><a href="#SystemSetup-1606"><span class="linenos">1606</span></a>        <span class="k">if</span> <span class="n">follow_links</span><span class="p">:</span>
</span><span id="SystemSetup-1607"><a href="#SystemSetup-1607"><span class="linenos">1607</span></a>            <span class="n">sync_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--copy-links&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1608"><a href="#SystemSetup-1608"><span class="linenos">1608</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup-1609"><a href="#SystemSetup-1609"><span class="linenos">1609</span></a>            <span class="n">sync_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--links&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1610"><a href="#SystemSetup-1610"><span class="linenos">1610</span></a>        <span class="k">if</span> <span class="n">preserve_owner_group</span><span class="p">:</span>
</span><span id="SystemSetup-1611"><a href="#SystemSetup-1611"><span class="linenos">1611</span></a>            <span class="n">sync_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1612"><a href="#SystemSetup-1612"><span class="linenos">1612</span></a>            <span class="n">sync_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1613"><a href="#SystemSetup-1613"><span class="linenos">1613</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">DataSync</span><span class="p">(</span>
</span><span id="SystemSetup-1614"><a href="#SystemSetup-1614"><span class="linenos">1614</span></a>            <span class="n">overlay_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span>
</span><span id="SystemSetup-1615"><a href="#SystemSetup-1615"><span class="linenos">1615</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1616"><a href="#SystemSetup-1616"><span class="linenos">1616</span></a>        <span class="n">data</span><span class="o">.</span><span class="n">sync_data</span><span class="p">(</span>
</span><span id="SystemSetup-1617"><a href="#SystemSetup-1617"><span class="linenos">1617</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">sync_options</span>
</span><span id="SystemSetup-1618"><a href="#SystemSetup-1618"><span class="linenos">1618</span></a>        <span class="p">)</span>
</span><span id="SystemSetup-1619"><a href="#SystemSetup-1619"><span class="linenos">1619</span></a>
</span><span id="SystemSetup-1620"><a href="#SystemSetup-1620"><span class="linenos">1620</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_repo_customization_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_repo</span><span class="p">:</span> <span class="n">repository</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SystemSetup-1621"><a href="#SystemSetup-1621"><span class="linenos">1621</span></a>        <span class="n">script_path</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_customize</span><span class="p">()</span>
</span><span id="SystemSetup-1622"><a href="#SystemSetup-1622"><span class="linenos">1622</span></a>        <span class="k">if</span> <span class="n">script_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
</span><span id="SystemSetup-1623"><a href="#SystemSetup-1623"><span class="linenos">1623</span></a>            <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">script_path</span><span class="p">)</span>
</span><span id="SystemSetup-1624"><a href="#SystemSetup-1624"><span class="linenos">1624</span></a>        <span class="k">return</span> <span class="n">script_path</span>
</span><span id="SystemSetup-1625"><a href="#SystemSetup-1625"><span class="linenos">1625</span></a>
</span><span id="SystemSetup-1626"><a href="#SystemSetup-1626"><span class="linenos">1626</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_group_names_and_ids_for_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
</span><span id="SystemSetup-1627"><a href="#SystemSetup-1627"><span class="linenos">1627</span></a>        <span class="n">group</span><span class="p">:</span> <span class="n">OrderedDict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</span><span id="SystemSetup-1628"><a href="#SystemSetup-1628"><span class="linenos">1628</span></a>        <span class="k">for</span> <span class="n">group_match</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_user_groups</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
</span><span id="SystemSetup-1629"><a href="#SystemSetup-1629"><span class="linenos">1629</span></a>            <span class="n">group_and_id</span> <span class="o">=</span> <span class="n">group_match</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
</span><span id="SystemSetup-1630"><a href="#SystemSetup-1630"><span class="linenos">1630</span></a>            <span class="n">group</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="SystemSetup-1631"><a href="#SystemSetup-1631"><span class="linenos">1631</span></a>                <span class="p">[(</span>
</span><span id="SystemSetup-1632"><a href="#SystemSetup-1632"><span class="linenos">1632</span></a>                    <span class="n">group_and_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="SystemSetup-1633"><a href="#SystemSetup-1633"><span class="linenos">1633</span></a>                    <span class="n">group_and_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_and_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</span><span id="SystemSetup-1634"><a href="#SystemSetup-1634"><span class="linenos">1634</span></a>                <span class="p">)]</span>
</span><span id="SystemSetup-1635"><a href="#SystemSetup-1635"><span class="linenos">1635</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1636"><a href="#SystemSetup-1636"><span class="linenos">1636</span></a>        <span class="k">return</span> <span class="n">group</span>
</span><span id="SystemSetup-1637"><a href="#SystemSetup-1637"><span class="linenos">1637</span></a>
</span><span id="SystemSetup-1638"><a href="#SystemSetup-1638"><span class="linenos">1638</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_find_selinux_policy_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SystemSetup-1639"><a href="#SystemSetup-1639"><span class="linenos">1639</span></a>        <span class="n">policy_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/etc/selinux/</span><span class="si">{</span><span class="n">policy_name</span><span class="si">}</span><span class="s1">/policy&#39;</span>
</span><span id="SystemSetup-1640"><a href="#SystemSetup-1640"><span class="linenos">1640</span></a>        <span class="n">policy_dir_in_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="n">policy_dir</span>
</span><span id="SystemSetup-1641"><a href="#SystemSetup-1641"><span class="linenos">1641</span></a>        <span class="n">scandir_error</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="SystemSetup-1642"><a href="#SystemSetup-1642"><span class="linenos">1642</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SystemSetup-1643"><a href="#SystemSetup-1643"><span class="linenos">1643</span></a>            <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">policy_dir_in_root</span><span class="p">)</span> <span class="k">as</span> <span class="n">policy_path</span><span class="p">:</span>
</span><span id="SystemSetup-1644"><a href="#SystemSetup-1644"><span class="linenos">1644</span></a>                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">policy_path</span><span class="p">:</span>
</span><span id="SystemSetup-1645"><a href="#SystemSetup-1645"><span class="linenos">1645</span></a>                    <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;policy.&#39;</span><span class="p">):</span>
</span><span id="SystemSetup-1646"><a href="#SystemSetup-1646"><span class="linenos">1646</span></a>                        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">policy_dir</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="SystemSetup-1647"><a href="#SystemSetup-1647"><span class="linenos">1647</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">issue</span><span class="p">:</span>
</span><span id="SystemSetup-1648"><a href="#SystemSetup-1648"><span class="linenos">1648</span></a>            <span class="n">scandir_error</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">issue</span><span class="p">)</span>
</span><span id="SystemSetup-1649"><a href="#SystemSetup-1649"><span class="linenos">1649</span></a>        <span class="k">raise</span> <span class="n">KiwiFileNotFound</span><span class="p">(</span>
</span><span id="SystemSetup-1650"><a href="#SystemSetup-1650"><span class="linenos">1650</span></a>            <span class="s1">&#39;Unable to find SELinux policy in </span><span class="si">{0!r}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup-1651"><a href="#SystemSetup-1651"><span class="linenos">1651</span></a>                <span class="n">policy_dir_in_root</span><span class="p">,</span> <span class="n">scandir_error</span>
</span><span id="SystemSetup-1652"><a href="#SystemSetup-1652"><span class="linenos">1652</span></a>            <span class="p">)</span>
</span><span id="SystemSetup-1653"><a href="#SystemSetup-1653"><span class="linenos">1653</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p><strong>Implementation of system setup steps supported by kiwi</strong></p>

<p>Kiwi is not responsible for the system configuration, however
some setup steps needs to be performed in order to provide
a minimal work environment inside of the image according to
the desired image type.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>object xml_state</strong>:  instance of <code>XMLState</code></li>
<li><strong>str root_dir</strong>:  root directory path name</li>
</ul>
</div>


                            <div id="SystemSetup.__init__" class="classattr">
                                        <input id="SystemSetup.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SystemSetup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">xml_state</span><span class="p">:</span> <span class="n"><a href="../xml_state.html#XMLState">kiwi.xml_state.XMLState</a></span>, </span><span class="param"><span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="SystemSetup.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.__init__-83"><a href="#SystemSetup.__init__-83"><span class="linenos">83</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_state</span><span class="p">:</span> <span class="n">XMLState</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SystemSetup.__init__-84"><a href="#SystemSetup.__init__-84"><span class="linenos">84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_config</span> <span class="o">=</span> <span class="n">RuntimeConfig</span><span class="p">()</span>
</span><span id="SystemSetup.__init__-85"><a href="#SystemSetup.__init__-85"><span class="linenos">85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_platform_name</span><span class="p">()</span>
</span><span id="SystemSetup.__init__-86"><a href="#SystemSetup.__init__-86"><span class="linenos">86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span> <span class="o">=</span> <span class="n">xml_state</span>
</span><span id="SystemSetup.__init__-87"><a href="#SystemSetup.__init__-87"><span class="linenos">87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">=</span> \
</span><span id="SystemSetup.__init__-88"><a href="#SystemSetup.__init__-88"><span class="linenos">88</span></a>            <span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">description_dir</span>
</span><span id="SystemSetup.__init__-89"><a href="#SystemSetup.__init__-89"><span class="linenos">89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">derived_description_dir</span> <span class="o">=</span> \
</span><span id="SystemSetup.__init__-90"><a href="#SystemSetup.__init__-90"><span class="linenos">90</span></a>            <span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">derived_description_dir</span>
</span><span id="SystemSetup.__init__-91"><a href="#SystemSetup.__init__-91"><span class="linenos">91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">root_dir</span>
</span><span id="SystemSetup.__init__-92"><a href="#SystemSetup.__init__-92"><span class="linenos">92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_preferences_lookup</span><span class="p">()</span>
</span><span id="SystemSetup.__init__-93"><a href="#SystemSetup.__init__-93"><span class="linenos">93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_oemconfig_lookup</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="SystemSetup.runtime_config" class="classattr">
                                <div class="attr variable">
            <span class="name">runtime_config</span>

        
    </div>
    <a class="headerlink" href="#SystemSetup.runtime_config"></a>
    
    

                            </div>
                            <div id="SystemSetup.arch" class="classattr">
                                <div class="attr variable">
            <span class="name">arch</span>

        
    </div>
    <a class="headerlink" href="#SystemSetup.arch"></a>
    
    

                            </div>
                            <div id="SystemSetup.xml_state" class="classattr">
                                <div class="attr variable">
            <span class="name">xml_state</span>

        
    </div>
    <a class="headerlink" href="#SystemSetup.xml_state"></a>
    
    

                            </div>
                            <div id="SystemSetup.description_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">description_dir</span>

        
    </div>
    <a class="headerlink" href="#SystemSetup.description_dir"></a>
    
    

                            </div>
                            <div id="SystemSetup.derived_description_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">derived_description_dir</span>

        
    </div>
    <a class="headerlink" href="#SystemSetup.derived_description_dir"></a>
    
    

                            </div>
                            <div id="SystemSetup.root_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">root_dir</span>

        
    </div>
    <a class="headerlink" href="#SystemSetup.root_dir"></a>
    
    

                            </div>
                            <div id="SystemSetup.setup_registry_import" class="classattr">
                                        <input id="SystemSetup.setup_registry_import-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_registry_import</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.setup_registry_import-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.setup_registry_import"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.setup_registry_import-95"><a href="#SystemSetup.setup_registry_import-95"><span class="linenos"> 95</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_registry_import</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.setup_registry_import-96"><a href="#SystemSetup.setup_registry_import-96"><span class="linenos"> 96</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_registry_import-97"><a href="#SystemSetup.setup_registry_import-97"><span class="linenos"> 97</span></a><span class="sd">        Fetch container(s) and activate systemd unit to load</span>
</span><span id="SystemSetup.setup_registry_import-98"><a href="#SystemSetup.setup_registry_import-98"><span class="linenos"> 98</span></a><span class="sd">        containers from local oci-archive file during boot</span>
</span><span id="SystemSetup.setup_registry_import-99"><a href="#SystemSetup.setup_registry_import-99"><span class="linenos"> 99</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_registry_import-100"><a href="#SystemSetup.setup_registry_import-100"><span class="linenos">100</span></a>        <span class="n">container_files_to_load</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SystemSetup.setup_registry_import-101"><a href="#SystemSetup.setup_registry_import-101"><span class="linenos">101</span></a>        <span class="n">container_execs_to_load</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SystemSetup.setup_registry_import-102"><a href="#SystemSetup.setup_registry_import-102"><span class="linenos">102</span></a>        <span class="n">after_services</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="SystemSetup.setup_registry_import-103"><a href="#SystemSetup.setup_registry_import-103"><span class="linenos">103</span></a>        <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_containers</span><span class="p">():</span>
</span><span id="SystemSetup.setup_registry_import-104"><a href="#SystemSetup.setup_registry_import-104"><span class="linenos">104</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fetching container: </span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-105"><a href="#SystemSetup.setup_registry_import-105"><span class="linenos">105</span></a>            <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">defaults</span><span class="o">.</span><span class="n">LOCAL_CONTAINERS</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span>
</span><span id="SystemSetup.setup_registry_import-106"><a href="#SystemSetup.setup_registry_import-106"><span class="linenos">106</span></a>                <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span>
</span><span id="SystemSetup.setup_registry_import-107"><a href="#SystemSetup.setup_registry_import-107"><span class="linenos">107</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-108"><a href="#SystemSetup.setup_registry_import-108"><span class="linenos">108</span></a>            <span class="n">container</span><span class="o">.</span><span class="n">fetch_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-109"><a href="#SystemSetup.setup_registry_import-109"><span class="linenos">109</span></a>            <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">load_command</span><span class="p">:</span>
</span><span id="SystemSetup.setup_registry_import-110"><a href="#SystemSetup.setup_registry_import-110"><span class="linenos">110</span></a>                <span class="n">container_files_to_load</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">container_file</span><span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-111"><a href="#SystemSetup.setup_registry_import-111"><span class="linenos">111</span></a>                <span class="n">container_execs_to_load</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">load_command</span><span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-112"><a href="#SystemSetup.setup_registry_import-112"><span class="linenos">112</span></a>                <span class="k">if</span> <span class="n">container</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;docker&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.setup_registry_import-113"><a href="#SystemSetup.setup_registry_import-113"><span class="linenos">113</span></a>                    <span class="n">after_services</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;docker.service&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-114"><a href="#SystemSetup.setup_registry_import-114"><span class="linenos">114</span></a>                <span class="k">elif</span> <span class="n">container</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s1">&#39;container-snap&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.setup_registry_import-115"><a href="#SystemSetup.setup_registry_import-115"><span class="linenos">115</span></a>                    <span class="n">after_services</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;container-snap.service&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-116"><a href="#SystemSetup.setup_registry_import-116"><span class="linenos">116</span></a>
</span><span id="SystemSetup.setup_registry_import-117"><a href="#SystemSetup.setup_registry_import-117"><span class="linenos">117</span></a>        <span class="k">if</span> <span class="n">container_files_to_load</span><span class="p">:</span>
</span><span id="SystemSetup.setup_registry_import-118"><a href="#SystemSetup.setup_registry_import-118"><span class="linenos">118</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Setup kiwi_containers.service import unit&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-119"><a href="#SystemSetup.setup_registry_import-119"><span class="linenos">119</span></a>            <span class="n">service</span> <span class="o">=</span> <span class="n">BuilderTemplateSystemdUnit</span><span class="p">()</span>
</span><span id="SystemSetup.setup_registry_import-120"><a href="#SystemSetup.setup_registry_import-120"><span class="linenos">120</span></a>            <span class="n">unit_template</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_container_import_template</span><span class="p">(</span>
</span><span id="SystemSetup.setup_registry_import-121"><a href="#SystemSetup.setup_registry_import-121"><span class="linenos">121</span></a>                <span class="n">container_files_to_load</span><span class="p">,</span> <span class="n">container_execs_to_load</span><span class="p">,</span>
</span><span id="SystemSetup.setup_registry_import-122"><a href="#SystemSetup.setup_registry_import-122"><span class="linenos">122</span></a>                <span class="nb">list</span><span class="p">(</span><span class="n">after_services</span><span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-123"><a href="#SystemSetup.setup_registry_import-123"><span class="linenos">123</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-124"><a href="#SystemSetup.setup_registry_import-124"><span class="linenos">124</span></a>            <span class="n">unit</span> <span class="o">=</span> <span class="n">unit_template</span><span class="o">.</span><span class="n">substitute</span><span class="p">()</span>
</span><span id="SystemSetup.setup_registry_import-125"><a href="#SystemSetup.setup_registry_import-125"><span class="linenos">125</span></a>            <span class="n">unit_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/etc/systemd/system/</span><span class="si">{1}</span><span class="s1">.service&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup.setup_registry_import-126"><a href="#SystemSetup.setup_registry_import-126"><span class="linenos">126</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;kiwi_containers&#39;</span>
</span><span id="SystemSetup.setup_registry_import-127"><a href="#SystemSetup.setup_registry_import-127"><span class="linenos">127</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-128"><a href="#SystemSetup.setup_registry_import-128"><span class="linenos">128</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">unit_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">systemd</span><span class="p">:</span>
</span><span id="SystemSetup.setup_registry_import-129"><a href="#SystemSetup.setup_registry_import-129"><span class="linenos">129</span></a>                <span class="n">systemd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span><span id="SystemSetup.setup_registry_import-130"><a href="#SystemSetup.setup_registry_import-130"><span class="linenos">130</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup.setup_registry_import-131"><a href="#SystemSetup.setup_registry_import-131"><span class="linenos">131</span></a>                <span class="p">[</span>
</span><span id="SystemSetup.setup_registry_import-132"><a href="#SystemSetup.setup_registry_import-132"><span class="linenos">132</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup.setup_registry_import-133"><a href="#SystemSetup.setup_registry_import-133"><span class="linenos">133</span></a>                    <span class="s1">&#39;systemctl&#39;</span><span class="p">,</span> <span class="s1">&#39;enable&#39;</span><span class="p">,</span> <span class="s1">&#39;kiwi_containers&#39;</span>
</span><span id="SystemSetup.setup_registry_import-134"><a href="#SystemSetup.setup_registry_import-134"><span class="linenos">134</span></a>                <span class="p">]</span>
</span><span id="SystemSetup.setup_registry_import-135"><a href="#SystemSetup.setup_registry_import-135"><span class="linenos">135</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Fetch container(s) and activate systemd unit to load
containers from local oci-archive file during boot</p>
</div>


                            </div>
                            <div id="SystemSetup.import_description" class="classattr">
                                        <input id="SystemSetup.import_description-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">import_description</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.import_description-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.import_description"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.import_description-137"><a href="#SystemSetup.import_description-137"><span class="linenos">137</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.import_description-138"><a href="#SystemSetup.import_description-138"><span class="linenos">138</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.import_description-139"><a href="#SystemSetup.import_description-139"><span class="linenos">139</span></a><span class="sd">        Import XML descriptions, custom scripts, archives and</span>
</span><span id="SystemSetup.import_description-140"><a href="#SystemSetup.import_description-140"><span class="linenos">140</span></a><span class="sd">        script helper methods</span>
</span><span id="SystemSetup.import_description-141"><a href="#SystemSetup.import_description-141"><span class="linenos">141</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.import_description-142"><a href="#SystemSetup.import_description-142"><span class="linenos">142</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Importing Image description to system tree&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.import_description-143"><a href="#SystemSetup.import_description-143"><span class="linenos">143</span></a>        <span class="n">description</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup.import_description-144"><a href="#SystemSetup.import_description-144"><span class="linenos">144</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span><span class="p">,</span> <span class="s1">&#39;config.xml&#39;</span>
</span><span id="SystemSetup.import_description-145"><a href="#SystemSetup.import_description-145"><span class="linenos">145</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.import_description-146"><a href="#SystemSetup.import_description-146"><span class="linenos">146</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.import_description-147"><a href="#SystemSetup.import_description-147"><span class="linenos">147</span></a>            <span class="s1">&#39;--&gt; Importing state XML description to </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
</span><span id="SystemSetup.import_description-148"><a href="#SystemSetup.import_description-148"><span class="linenos">148</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.import_description-149"><a href="#SystemSetup.import_description-149"><span class="linenos">149</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="SystemSetup.import_description-150"><a href="#SystemSetup.import_description-150"><span class="linenos">150</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span><span class="p">)</span>
</span><span id="SystemSetup.import_description-151"><a href="#SystemSetup.import_description-151"><span class="linenos">151</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.import_description-152"><a href="#SystemSetup.import_description-152"><span class="linenos">152</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
</span><span id="SystemSetup.import_description-153"><a href="#SystemSetup.import_description-153"><span class="linenos">153</span></a>            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.import_description-154"><a href="#SystemSetup.import_description-154"><span class="linenos">154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">outfile</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="SystemSetup.import_description-155"><a href="#SystemSetup.import_description-155"><span class="linenos">155</span></a>
</span><span id="SystemSetup.import_description-156"><a href="#SystemSetup.import_description-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_custom_scripts</span><span class="p">()</span>
</span><span id="SystemSetup.import_description-157"><a href="#SystemSetup.import_description-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_custom_archives</span><span class="p">()</span>
</span><span id="SystemSetup.import_description-158"><a href="#SystemSetup.import_description-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_custom_files</span><span class="p">()</span>
</span><span id="SystemSetup.import_description-159"><a href="#SystemSetup.import_description-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_import_cdroot_archive</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Import XML descriptions, custom scripts, archives and
script helper methods</p>
</div>


                            </div>
                            <div id="SystemSetup.script_exists" class="classattr">
                                        <input id="SystemSetup.script_exists-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">script_exists</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.script_exists-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.script_exists"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.script_exists-161"><a href="#SystemSetup.script_exists-161"><span class="linenos">161</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">script_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="SystemSetup.script_exists-162"><a href="#SystemSetup.script_exists-162"><span class="linenos">162</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.script_exists-163"><a href="#SystemSetup.script_exists-163"><span class="linenos">163</span></a><span class="sd">        Check if provided script base name exists in the image description</span>
</span><span id="SystemSetup.script_exists-164"><a href="#SystemSetup.script_exists-164"><span class="linenos">164</span></a>
</span><span id="SystemSetup.script_exists-165"><a href="#SystemSetup.script_exists-165"><span class="linenos">165</span></a><span class="sd">        :param str name: script base name</span>
</span><span id="SystemSetup.script_exists-166"><a href="#SystemSetup.script_exists-166"><span class="linenos">166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.script_exists-167"><a href="#SystemSetup.script_exists-167"><span class="linenos">167</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Check if provided script base name exists in the image description</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str name</strong>:  script base name</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.cleanup" class="classattr">
                                        <input id="SystemSetup.cleanup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cleanup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.cleanup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.cleanup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.cleanup-169"><a href="#SystemSetup.cleanup-169"><span class="linenos">169</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.cleanup-170"><a href="#SystemSetup.cleanup-170"><span class="linenos">170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.cleanup-171"><a href="#SystemSetup.cleanup-171"><span class="linenos">171</span></a><span class="sd">        Delete all traces of a kiwi description which are not</span>
</span><span id="SystemSetup.cleanup-172"><a href="#SystemSetup.cleanup-172"><span class="linenos">172</span></a><span class="sd">        required in the later image</span>
</span><span id="SystemSetup.cleanup-173"><a href="#SystemSetup.cleanup-173"><span class="linenos">173</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.cleanup-174"><a href="#SystemSetup.cleanup-174"><span class="linenos">174</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup.cleanup-175"><a href="#SystemSetup.cleanup-175"><span class="linenos">175</span></a>            <span class="p">[</span>
</span><span id="SystemSetup.cleanup-176"><a href="#SystemSetup.cleanup-176"><span class="linenos">176</span></a>                <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup.cleanup-177"><a href="#SystemSetup.cleanup-177"><span class="linenos">177</span></a>                <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.cleanup-178"><a href="#SystemSetup.cleanup-178"><span class="linenos">178</span></a>                <span class="s1">&#39;.kconfig&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.cleanup-179"><a href="#SystemSetup.cleanup-179"><span class="linenos">179</span></a>                <span class="s1">&#39;.profile&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.cleanup-180"><a href="#SystemSetup.cleanup-180"><span class="linenos">180</span></a>                <span class="s1">&#39;config.bootoptions&#39;</span>
</span><span id="SystemSetup.cleanup-181"><a href="#SystemSetup.cleanup-181"><span class="linenos">181</span></a>            <span class="p">]</span>
</span><span id="SystemSetup.cleanup-182"><a href="#SystemSetup.cleanup-182"><span class="linenos">182</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.cleanup-183"><a href="#SystemSetup.cleanup-183"><span class="linenos">183</span></a>        <span class="n">meta_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">defaults</span><span class="o">.</span><span class="n">IMAGE_METADATA_DIR</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="SystemSetup.cleanup-184"><a href="#SystemSetup.cleanup-184"><span class="linenos">184</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">):</span>
</span><span id="SystemSetup.cleanup-185"><a href="#SystemSetup.cleanup-185"><span class="linenos">185</span></a>            <span class="n">image_meta</span> <span class="o">=</span> <span class="n">MountManager</span><span class="p">(</span>
</span><span id="SystemSetup.cleanup-186"><a href="#SystemSetup.cleanup-186"><span class="linenos">186</span></a>                <span class="n">device</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">mountpoint</span><span class="o">=</span><span class="n">meta_dir</span>
</span><span id="SystemSetup.cleanup-187"><a href="#SystemSetup.cleanup-187"><span class="linenos">187</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.cleanup-188"><a href="#SystemSetup.cleanup-188"><span class="linenos">188</span></a>            <span class="n">image_meta</span><span class="o">.</span><span class="n">umount</span><span class="p">()</span>
</span><span id="SystemSetup.cleanup-189"><a href="#SystemSetup.cleanup-189"><span class="linenos">189</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">meta_dir</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Delete all traces of a kiwi description which are not
required in the later image</p>
</div>


                            </div>
                            <div id="SystemSetup.import_repositories_marked_as_imageinclude" class="classattr">
                                        <input id="SystemSetup.import_repositories_marked_as_imageinclude-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">import_repositories_marked_as_imageinclude</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.import_repositories_marked_as_imageinclude-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.import_repositories_marked_as_imageinclude"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.import_repositories_marked_as_imageinclude-191"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-191"><span class="linenos">191</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_repositories_marked_as_imageinclude</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-192"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-192"><span class="linenos">192</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-193"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-193"><span class="linenos">193</span></a><span class="sd">        Those &lt;repository&gt; sections which are marked with the</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-194"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-194"><span class="linenos">194</span></a><span class="sd">        imageinclude attribute should be permanently added to</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-195"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-195"><span class="linenos">195</span></a><span class="sd">        the image repository configuration</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-196"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-196"><span class="linenos">196</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-197"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-197"><span class="linenos">197</span></a>        <span class="n">repository_sections</span> <span class="o">=</span> \
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-198"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-198"><span class="linenos">198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_repository_sections_used_in_image</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-199"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-199"><span class="linenos">199</span></a>        <span class="n">root</span> <span class="o">=</span> <span class="n">RootInit</span><span class="p">(</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-200"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-200"><span class="linenos">200</span></a>            <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">allow_existing</span><span class="o">=</span><span class="kc">True</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-201"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-201"><span class="linenos">201</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-202"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-202"><span class="linenos">202</span></a>        <span class="k">with</span> <span class="n">Repository</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-203"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-203"><span class="linenos">203</span></a>            <span class="n">RootBind</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-204"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-204"><span class="linenos">204</span></a>        <span class="p">)</span> <span class="k">as</span> <span class="n">repo</span><span class="p">:</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-205"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-205"><span class="linenos">205</span></a>            <span class="n">repo</span><span class="o">.</span><span class="n">use_default_location</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-206"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-206"><span class="linenos">206</span></a>            <span class="k">for</span> <span class="n">xml_repo</span> <span class="ow">in</span> <span class="n">repository_sections</span><span class="p">:</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-207"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-207"><span class="linenos">207</span></a>                <span class="n">repo_type</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-208"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-208"><span class="linenos">208</span></a>                <span class="n">repo_source</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_source</span><span class="p">()</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-209"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-209"><span class="linenos">209</span></a>                <span class="n">repo_architectures</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_architectures</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-210"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-210"><span class="linenos">210</span></a>                <span class="n">repo_user</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_username</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-211"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-211"><span class="linenos">211</span></a>                <span class="n">repo_secret</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_password</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-212"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-212"><span class="linenos">212</span></a>                <span class="n">repo_alias</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_alias</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-213"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-213"><span class="linenos">213</span></a>                <span class="n">repo_priority</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_priority</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-214"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-214"><span class="linenos">214</span></a>                <span class="n">repo_dist</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-215"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-215"><span class="linenos">215</span></a>                <span class="n">repo_components</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_components</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-216"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-216"><span class="linenos">216</span></a>                <span class="n">repo_repository_gpgcheck</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_repository_gpgcheck</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-217"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-217"><span class="linenos">217</span></a>                <span class="n">repo_package_gpgcheck</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_package_gpgcheck</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-218"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-218"><span class="linenos">218</span></a>                <span class="n">repo_customization_script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_repo_customization_script</span><span class="p">(</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-219"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-219"><span class="linenos">219</span></a>                    <span class="n">xml_repo</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-220"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-220"><span class="linenos">220</span></a>                <span class="p">)</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-221"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-221"><span class="linenos">221</span></a>                <span class="n">repo_sourcetype</span> <span class="o">=</span> <span class="n">xml_repo</span><span class="o">.</span><span class="n">get_sourcetype</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-222"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-222"><span class="linenos">222</span></a>                <span class="n">uri</span> <span class="o">=</span> <span class="n">Uri</span><span class="p">(</span><span class="n">repo_source</span><span class="p">,</span> <span class="n">repo_type</span><span class="p">)</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-223"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-223"><span class="linenos">223</span></a>                <span class="n">repo_source_translated</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-224"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-224"><span class="linenos">224</span></a>                    <span class="n">check_build_environment</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-225"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-225"><span class="linenos">225</span></a>                <span class="p">)</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-226"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-226"><span class="linenos">226</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">repo_alias</span><span class="p">:</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-227"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-227"><span class="linenos">227</span></a>                    <span class="n">repo_alias</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-228"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-228"><span class="linenos">228</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-229"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-229"><span class="linenos">229</span></a>                    <span class="s1">&#39;Setting up image repository </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-230"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-230"><span class="linenos">230</span></a>                        <span class="n">Uri</span><span class="o">.</span><span class="n">print_sensitive</span><span class="p">(</span><span class="n">repo_source</span><span class="p">)</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-231"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-231"><span class="linenos">231</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-232"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-232"><span class="linenos">232</span></a>                <span class="p">)</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-233"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-233"><span class="linenos">233</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Type: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">repo_type</span><span class="p">))</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-234"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-234"><span class="linenos">234</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-235"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-235"><span class="linenos">235</span></a>                    <span class="s1">&#39;--&gt; Translated: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-236"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-236"><span class="linenos">236</span></a>                        <span class="n">Uri</span><span class="o">.</span><span class="n">print_sensitive</span><span class="p">(</span><span class="n">repo_source_translated</span><span class="p">)</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-237"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-237"><span class="linenos">237</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-238"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-238"><span class="linenos">238</span></a>                <span class="p">)</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-239"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-239"><span class="linenos">239</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Alias: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">repo_alias</span><span class="p">))</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-240"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-240"><span class="linenos">240</span></a>                <span class="n">repo</span><span class="o">.</span><span class="n">add_repo</span><span class="p">(</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-241"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-241"><span class="linenos">241</span></a>                    <span class="n">repo_alias</span><span class="p">,</span> <span class="n">repo_source_translated</span><span class="p">,</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-242"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-242"><span class="linenos">242</span></a>                    <span class="n">repo_type</span><span class="p">,</span> <span class="n">repo_priority</span><span class="p">,</span> <span class="n">repo_dist</span><span class="p">,</span> <span class="n">repo_components</span><span class="p">,</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-243"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-243"><span class="linenos">243</span></a>                    <span class="n">repo_user</span><span class="p">,</span> <span class="n">repo_secret</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">credentials_file_name</span><span class="p">(),</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-244"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-244"><span class="linenos">244</span></a>                    <span class="n">repo_repository_gpgcheck</span><span class="p">,</span> <span class="n">repo_package_gpgcheck</span><span class="p">,</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-245"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-245"><span class="linenos">245</span></a>                    <span class="n">repo_sourcetype</span><span class="p">,</span> <span class="n">repo_customization_script</span><span class="p">,</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-246"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-246"><span class="linenos">246</span></a>                    <span class="n">repo_architectures</span>
</span><span id="SystemSetup.import_repositories_marked_as_imageinclude-247"><a href="#SystemSetup.import_repositories_marked_as_imageinclude-247"><span class="linenos">247</span></a>                <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Those <repository> sections which are marked with the
imageinclude attribute should be permanently added to
the image repository configuration</p>
</div>


                            </div>
                            <div id="SystemSetup.import_cdroot_files" class="classattr">
                                        <input id="SystemSetup.import_cdroot_files-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">import_cdroot_files</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.import_cdroot_files-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.import_cdroot_files"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.import_cdroot_files-249"><a href="#SystemSetup.import_cdroot_files-249"><span class="linenos">249</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_cdroot_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.import_cdroot_files-250"><a href="#SystemSetup.import_cdroot_files-250"><span class="linenos">250</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.import_cdroot_files-251"><a href="#SystemSetup.import_cdroot_files-251"><span class="linenos">251</span></a><span class="sd">        Copy cdroot files from the image description to the</span>
</span><span id="SystemSetup.import_cdroot_files-252"><a href="#SystemSetup.import_cdroot_files-252"><span class="linenos">252</span></a><span class="sd">        specified target directory. Supported is a tar</span>
</span><span id="SystemSetup.import_cdroot_files-253"><a href="#SystemSetup.import_cdroot_files-253"><span class="linenos">253</span></a><span class="sd">        archive named config-cdroot.tar[.compression-postfix]</span>
</span><span id="SystemSetup.import_cdroot_files-254"><a href="#SystemSetup.import_cdroot_files-254"><span class="linenos">254</span></a>
</span><span id="SystemSetup.import_cdroot_files-255"><a href="#SystemSetup.import_cdroot_files-255"><span class="linenos">255</span></a><span class="sd">        :param str target_dir: directory to unpack archive to</span>
</span><span id="SystemSetup.import_cdroot_files-256"><a href="#SystemSetup.import_cdroot_files-256"><span class="linenos">256</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.import_cdroot_files-257"><a href="#SystemSetup.import_cdroot_files-257"><span class="linenos">257</span></a>        <span class="n">glob_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">+</span> <span class="s1">&#39;/config-cdroot.tar*&#39;</span>
</span><span id="SystemSetup.import_cdroot_files-258"><a href="#SystemSetup.import_cdroot_files-258"><span class="linenos">258</span></a>        <span class="k">for</span> <span class="n">cdroot_archive</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">glob_match</span><span class="p">)):</span>
</span><span id="SystemSetup.import_cdroot_files-259"><a href="#SystemSetup.import_cdroot_files-259"><span class="linenos">259</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.import_cdroot_files-260"><a href="#SystemSetup.import_cdroot_files-260"><span class="linenos">260</span></a>                <span class="s1">&#39;Extracting ISO user config archive: </span><span class="si">{0}</span><span class="s1"> to: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup.import_cdroot_files-261"><a href="#SystemSetup.import_cdroot_files-261"><span class="linenos">261</span></a>                    <span class="n">cdroot_archive</span><span class="p">,</span> <span class="n">target_dir</span>
</span><span id="SystemSetup.import_cdroot_files-262"><a href="#SystemSetup.import_cdroot_files-262"><span class="linenos">262</span></a>                <span class="p">)</span>
</span><span id="SystemSetup.import_cdroot_files-263"><a href="#SystemSetup.import_cdroot_files-263"><span class="linenos">263</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.import_cdroot_files-264"><a href="#SystemSetup.import_cdroot_files-264"><span class="linenos">264</span></a>            <span class="n">archive</span> <span class="o">=</span> <span class="n">ArchiveTar</span><span class="p">(</span><span class="n">cdroot_archive</span><span class="p">)</span>
</span><span id="SystemSetup.import_cdroot_files-265"><a href="#SystemSetup.import_cdroot_files-265"><span class="linenos">265</span></a>            <span class="n">archive</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
</span><span id="SystemSetup.import_cdroot_files-266"><a href="#SystemSetup.import_cdroot_files-266"><span class="linenos">266</span></a>            <span class="k">break</span>
</span></pre></div>


            <div class="docstring"><p>Copy cdroot files from the image description to the
specified target directory. Supported is a tar
archive named config-cdroot.tar[.compression-postfix]</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str target_dir</strong>:  directory to unpack archive to</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.import_files" class="classattr">
                                        <input id="SystemSetup.import_files-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">import_files</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.import_files-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.import_files"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.import_files-268"><a href="#SystemSetup.import_files-268"><span class="linenos">268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.import_files-269"><a href="#SystemSetup.import_files-269"><span class="linenos">269</span></a>        <span class="n">system_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_system_files</span><span class="p">()</span>
</span><span id="SystemSetup.import_files-270"><a href="#SystemSetup.import_files-270"><span class="linenos">270</span></a>        <span class="n">bootstrap_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_bootstrap_files</span><span class="p">()</span>
</span><span id="SystemSetup.import_files-271"><a href="#SystemSetup.import_files-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="n">system_files</span><span class="p">:</span>
</span><span id="SystemSetup.import_files-272"><a href="#SystemSetup.import_files-272"><span class="linenos">272</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_files</span><span class="p">(</span><span class="n">system_files</span><span class="p">)</span>
</span><span id="SystemSetup.import_files-273"><a href="#SystemSetup.import_files-273"><span class="linenos">273</span></a>        <span class="k">if</span> <span class="n">bootstrap_files</span><span class="p">:</span>
</span><span id="SystemSetup.import_files-274"><a href="#SystemSetup.import_files-274"><span class="linenos">274</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_files</span><span class="p">(</span><span class="n">bootstrap_files</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="SystemSetup.import_overlay_files" class="classattr">
                                        <input id="SystemSetup.import_overlay_files-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">import_overlay_files</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">follow_links</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">preserve_owner_group</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.import_overlay_files-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.import_overlay_files"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.import_overlay_files-276"><a href="#SystemSetup.import_overlay_files-276"><span class="linenos">276</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_overlay_files</span><span class="p">(</span>
</span><span id="SystemSetup.import_overlay_files-277"><a href="#SystemSetup.import_overlay_files-277"><span class="linenos">277</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">follow_links</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">preserve_owner_group</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SystemSetup.import_overlay_files-278"><a href="#SystemSetup.import_overlay_files-278"><span class="linenos">278</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.import_overlay_files-279"><a href="#SystemSetup.import_overlay_files-279"><span class="linenos">279</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.import_overlay_files-280"><a href="#SystemSetup.import_overlay_files-280"><span class="linenos">280</span></a><span class="sd">        Copy overlay files from the image description to</span>
</span><span id="SystemSetup.import_overlay_files-281"><a href="#SystemSetup.import_overlay_files-281"><span class="linenos">281</span></a><span class="sd">        the image root tree. Supported are a root/ directory</span>
</span><span id="SystemSetup.import_overlay_files-282"><a href="#SystemSetup.import_overlay_files-282"><span class="linenos">282</span></a><span class="sd">        or a root.tar.gz tarball. The root/ directory takes</span>
</span><span id="SystemSetup.import_overlay_files-283"><a href="#SystemSetup.import_overlay_files-283"><span class="linenos">283</span></a><span class="sd">        precedence over the tarball.</span>
</span><span id="SystemSetup.import_overlay_files-284"><a href="#SystemSetup.import_overlay_files-284"><span class="linenos">284</span></a>
</span><span id="SystemSetup.import_overlay_files-285"><a href="#SystemSetup.import_overlay_files-285"><span class="linenos">285</span></a><span class="sd">        In addition the method also supports profile specific</span>
</span><span id="SystemSetup.import_overlay_files-286"><a href="#SystemSetup.import_overlay_files-286"><span class="linenos">286</span></a><span class="sd">        overlay files which are searched in a directory of the</span>
</span><span id="SystemSetup.import_overlay_files-287"><a href="#SystemSetup.import_overlay_files-287"><span class="linenos">287</span></a><span class="sd">        same name as the profile name.</span>
</span><span id="SystemSetup.import_overlay_files-288"><a href="#SystemSetup.import_overlay_files-288"><span class="linenos">288</span></a>
</span><span id="SystemSetup.import_overlay_files-289"><a href="#SystemSetup.import_overlay_files-289"><span class="linenos">289</span></a><span class="sd">        The overall order for including overlay files is as</span>
</span><span id="SystemSetup.import_overlay_files-290"><a href="#SystemSetup.import_overlay_files-290"><span class="linenos">290</span></a><span class="sd">        follows:</span>
</span><span id="SystemSetup.import_overlay_files-291"><a href="#SystemSetup.import_overlay_files-291"><span class="linenos">291</span></a>
</span><span id="SystemSetup.import_overlay_files-292"><a href="#SystemSetup.import_overlay_files-292"><span class="linenos">292</span></a><span class="sd">        1. root/ dir or root.tar.gz</span>
</span><span id="SystemSetup.import_overlay_files-293"><a href="#SystemSetup.import_overlay_files-293"><span class="linenos">293</span></a><span class="sd">        2. PROFILE_NAME/ dir(s) in the order of the selected</span>
</span><span id="SystemSetup.import_overlay_files-294"><a href="#SystemSetup.import_overlay_files-294"><span class="linenos">294</span></a><span class="sd">           profiles</span>
</span><span id="SystemSetup.import_overlay_files-295"><a href="#SystemSetup.import_overlay_files-295"><span class="linenos">295</span></a>
</span><span id="SystemSetup.import_overlay_files-296"><a href="#SystemSetup.import_overlay_files-296"><span class="linenos">296</span></a><span class="sd">        :param bool follow_links: follow symlinks true|false</span>
</span><span id="SystemSetup.import_overlay_files-297"><a href="#SystemSetup.import_overlay_files-297"><span class="linenos">297</span></a><span class="sd">        :param bool preserve_owner_group: preserve permissions true|false</span>
</span><span id="SystemSetup.import_overlay_files-298"><a href="#SystemSetup.import_overlay_files-298"><span class="linenos">298</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.import_overlay_files-299"><a href="#SystemSetup.import_overlay_files-299"><span class="linenos">299</span></a>        <span class="n">overlay_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">+</span> <span class="s1">&#39;/root/&#39;</span>
</span><span id="SystemSetup.import_overlay_files-300"><a href="#SystemSetup.import_overlay_files-300"><span class="linenos">300</span></a>        <span class="n">overlay_archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span> <span class="o">+</span> <span class="s1">&#39;/root.tar.gz&#39;</span>
</span><span id="SystemSetup.import_overlay_files-301"><a href="#SystemSetup.import_overlay_files-301"><span class="linenos">301</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">overlay_directory</span><span class="p">):</span>
</span><span id="SystemSetup.import_overlay_files-302"><a href="#SystemSetup.import_overlay_files-302"><span class="linenos">302</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_overlay_files</span><span class="p">(</span>
</span><span id="SystemSetup.import_overlay_files-303"><a href="#SystemSetup.import_overlay_files-303"><span class="linenos">303</span></a>                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">overlay_directory</span><span class="p">)</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.import_overlay_files-304"><a href="#SystemSetup.import_overlay_files-304"><span class="linenos">304</span></a>                <span class="n">follow_links</span><span class="p">,</span> <span class="n">preserve_owner_group</span>
</span><span id="SystemSetup.import_overlay_files-305"><a href="#SystemSetup.import_overlay_files-305"><span class="linenos">305</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.import_overlay_files-306"><a href="#SystemSetup.import_overlay_files-306"><span class="linenos">306</span></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">overlay_archive</span><span class="p">):</span>
</span><span id="SystemSetup.import_overlay_files-307"><a href="#SystemSetup.import_overlay_files-307"><span class="linenos">307</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracting user defined files from archive to image tree&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.import_overlay_files-308"><a href="#SystemSetup.import_overlay_files-308"><span class="linenos">308</span></a>            <span class="n">archive</span> <span class="o">=</span> <span class="n">ArchiveTar</span><span class="p">(</span><span class="n">overlay_archive</span><span class="p">)</span>
</span><span id="SystemSetup.import_overlay_files-309"><a href="#SystemSetup.import_overlay_files-309"><span class="linenos">309</span></a>            <span class="n">archive</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="SystemSetup.import_overlay_files-310"><a href="#SystemSetup.import_overlay_files-310"><span class="linenos">310</span></a>
</span><span id="SystemSetup.import_overlay_files-311"><a href="#SystemSetup.import_overlay_files-311"><span class="linenos">311</span></a>        <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">profiles</span><span class="p">:</span>
</span><span id="SystemSetup.import_overlay_files-312"><a href="#SystemSetup.import_overlay_files-312"><span class="linenos">312</span></a>            <span class="n">overlay_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup.import_overlay_files-313"><a href="#SystemSetup.import_overlay_files-313"><span class="linenos">313</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">description_dir</span><span class="p">,</span> <span class="n">profile</span>
</span><span id="SystemSetup.import_overlay_files-314"><a href="#SystemSetup.import_overlay_files-314"><span class="linenos">314</span></a>            <span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
</span><span id="SystemSetup.import_overlay_files-315"><a href="#SystemSetup.import_overlay_files-315"><span class="linenos">315</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">overlay_directory</span><span class="p">):</span>
</span><span id="SystemSetup.import_overlay_files-316"><a href="#SystemSetup.import_overlay_files-316"><span class="linenos">316</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_sync_overlay_files</span><span class="p">(</span>
</span><span id="SystemSetup.import_overlay_files-317"><a href="#SystemSetup.import_overlay_files-317"><span class="linenos">317</span></a>                    <span class="n">overlay_directory</span><span class="p">,</span> <span class="n">follow_links</span><span class="p">,</span> <span class="n">preserve_owner_group</span><span class="p">,</span>
</span><span id="SystemSetup.import_overlay_files-318"><a href="#SystemSetup.import_overlay_files-318"><span class="linenos">318</span></a>                    <span class="n">profile</span>
</span><span id="SystemSetup.import_overlay_files-319"><a href="#SystemSetup.import_overlay_files-319"><span class="linenos">319</span></a>                <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Copy overlay files from the image description to
the image root tree. Supported are a root/ directory
or a root.tar.gz tarball. The root/ directory takes
precedence over the tarball.</p>

<p>In addition the method also supports profile specific
overlay files which are searched in a directory of the
same name as the profile name.</p>

<p>The overall order for including overlay files is as
follows:</p>

<ol>
<li>root/ dir or root.tar.gz</li>
<li>PROFILE_NAME/ dir(s) in the order of the selected
profiles</li>
</ol>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>bool follow_links</strong>:  follow symlinks true|false</li>
<li><strong>bool preserve_owner_group</strong>:  preserve permissions true|false</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.setup_machine_id" class="classattr">
                                        <input id="SystemSetup.setup_machine_id-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_machine_id</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.setup_machine_id-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.setup_machine_id"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.setup_machine_id-321"><a href="#SystemSetup.setup_machine_id-321"><span class="linenos">321</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_machine_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.setup_machine_id-322"><a href="#SystemSetup.setup_machine_id-322"><span class="linenos">322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_machine_id-323"><a href="#SystemSetup.setup_machine_id-323"><span class="linenos">323</span></a><span class="sd">        Setup systemd machine id</span>
</span><span id="SystemSetup.setup_machine_id-324"><a href="#SystemSetup.setup_machine_id-324"><span class="linenos">324</span></a>
</span><span id="SystemSetup.setup_machine_id-325"><a href="#SystemSetup.setup_machine_id-325"><span class="linenos">325</span></a><span class="sd">        There are various states of /etc/machine-id:</span>
</span><span id="SystemSetup.setup_machine_id-326"><a href="#SystemSetup.setup_machine_id-326"><span class="linenos">326</span></a>
</span><span id="SystemSetup.setup_machine_id-327"><a href="#SystemSetup.setup_machine_id-327"><span class="linenos">327</span></a><span class="sd">        a) Does not exist: Triggers ConditionFirstBoot, but does not work</span>
</span><span id="SystemSetup.setup_machine_id-328"><a href="#SystemSetup.setup_machine_id-328"><span class="linenos">328</span></a><span class="sd">           if the filesystem is initially read-only (booted without &quot;rw&quot;).</span>
</span><span id="SystemSetup.setup_machine_id-329"><a href="#SystemSetup.setup_machine_id-329"><span class="linenos">329</span></a><span class="sd">        b) Exists, is empty: Does not trigger ConditionFirstBoot, but works</span>
</span><span id="SystemSetup.setup_machine_id-330"><a href="#SystemSetup.setup_machine_id-330"><span class="linenos">330</span></a><span class="sd">           with read-only mounts.</span>
</span><span id="SystemSetup.setup_machine_id-331"><a href="#SystemSetup.setup_machine_id-331"><span class="linenos">331</span></a><span class="sd">        c) Exists, contains the string &quot;uninitialized&quot;: Same as b), but</span>
</span><span id="SystemSetup.setup_machine_id-332"><a href="#SystemSetup.setup_machine_id-332"><span class="linenos">332</span></a><span class="sd">           triggers ConditionFirstBoot. Supported by systemd v247+ only.</span>
</span><span id="SystemSetup.setup_machine_id-333"><a href="#SystemSetup.setup_machine_id-333"><span class="linenos">333</span></a><span class="sd">        d) Exists, contains a valid ID.</span>
</span><span id="SystemSetup.setup_machine_id-334"><a href="#SystemSetup.setup_machine_id-334"><span class="linenos">334</span></a>
</span><span id="SystemSetup.setup_machine_id-335"><a href="#SystemSetup.setup_machine_id-335"><span class="linenos">335</span></a><span class="sd">        See the machine-id(5) man page for details.</span>
</span><span id="SystemSetup.setup_machine_id-336"><a href="#SystemSetup.setup_machine_id-336"><span class="linenos">336</span></a>
</span><span id="SystemSetup.setup_machine_id-337"><a href="#SystemSetup.setup_machine_id-337"><span class="linenos">337</span></a><span class="sd">        In images, d) is not desirable, so truncate the file. This is the</span>
</span><span id="SystemSetup.setup_machine_id-338"><a href="#SystemSetup.setup_machine_id-338"><span class="linenos">338</span></a><span class="sd">        previous behaviour and what existing images expect. If the image</span>
</span><span id="SystemSetup.setup_machine_id-339"><a href="#SystemSetup.setup_machine_id-339"><span class="linenos">339</span></a><span class="sd">        has one of the other states, keep it as-is.</span>
</span><span id="SystemSetup.setup_machine_id-340"><a href="#SystemSetup.setup_machine_id-340"><span class="linenos">340</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_machine_id-341"><a href="#SystemSetup.setup_machine_id-341"><span class="linenos">341</span></a>        <span class="n">machine_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup.setup_machine_id-342"><a href="#SystemSetup.setup_machine_id-342"><span class="linenos">342</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;etc&#39;</span><span class="p">,</span> <span class="s1">&#39;machine-id&#39;</span>
</span><span id="SystemSetup.setup_machine_id-343"><a href="#SystemSetup.setup_machine_id-343"><span class="linenos">343</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.setup_machine_id-344"><a href="#SystemSetup.setup_machine_id-344"><span class="linenos">344</span></a>
</span><span id="SystemSetup.setup_machine_id-345"><a href="#SystemSetup.setup_machine_id-345"><span class="linenos">345</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">machine_id</span><span class="p">):</span>
</span><span id="SystemSetup.setup_machine_id-346"><a href="#SystemSetup.setup_machine_id-346"><span class="linenos">346</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">machine_id</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="SystemSetup.setup_machine_id-347"><a href="#SystemSetup.setup_machine_id-347"><span class="linenos">347</span></a>                <span class="k">if</span> <span class="s1">&#39;uninitialized&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">():</span>
</span><span id="SystemSetup.setup_machine_id-348"><a href="#SystemSetup.setup_machine_id-348"><span class="linenos">348</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Setup systemd machine id</p>

<p>There are various states of /etc/machine-id:</p>

<p>a) Does not exist: Triggers ConditionFirstBoot, but does not work
   if the filesystem is initially read-only (booted without "rw").
b) Exists, is empty: Does not trigger ConditionFirstBoot, but works
   with read-only mounts.
c) Exists, contains the string "uninitialized": Same as b), but
   triggers ConditionFirstBoot. Supported by systemd v247+ only.
d) Exists, contains a valid ID.</p>

<p>See the machine-id(5) man page for details.</p>

<p>In images, d) is not desirable, so truncate the file. This is the
previous behaviour and what existing images expect. If the image
has one of the other states, keep it as-is.</p>
</div>


                            </div>
                            <div id="SystemSetup.setup_permissions" class="classattr">
                                        <input id="SystemSetup.setup_permissions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_permissions</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.setup_permissions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.setup_permissions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.setup_permissions-350"><a href="#SystemSetup.setup_permissions-350"><span class="linenos">350</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.setup_permissions-351"><a href="#SystemSetup.setup_permissions-351"><span class="linenos">351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_permissions-352"><a href="#SystemSetup.setup_permissions-352"><span class="linenos">352</span></a><span class="sd">        Check and Fix permissions using chkstat</span>
</span><span id="SystemSetup.setup_permissions-353"><a href="#SystemSetup.setup_permissions-353"><span class="linenos">353</span></a>
</span><span id="SystemSetup.setup_permissions-354"><a href="#SystemSetup.setup_permissions-354"><span class="linenos">354</span></a><span class="sd">        Call chkstat in system mode which reads /etc/sysconfig/security</span>
</span><span id="SystemSetup.setup_permissions-355"><a href="#SystemSetup.setup_permissions-355"><span class="linenos">355</span></a><span class="sd">        to determine the configured security level and applies the</span>
</span><span id="SystemSetup.setup_permissions-356"><a href="#SystemSetup.setup_permissions-356"><span class="linenos">356</span></a><span class="sd">        appropriate permission definitions from the /etc/permissions*</span>
</span><span id="SystemSetup.setup_permissions-357"><a href="#SystemSetup.setup_permissions-357"><span class="linenos">357</span></a><span class="sd">        files. It&#39;s possible to provide those files as overlay files</span>
</span><span id="SystemSetup.setup_permissions-358"><a href="#SystemSetup.setup_permissions-358"><span class="linenos">358</span></a><span class="sd">        in the image description to apply a certain permission setup</span>
</span><span id="SystemSetup.setup_permissions-359"><a href="#SystemSetup.setup_permissions-359"><span class="linenos">359</span></a><span class="sd">        when needed. Otherwise the default setup as provided on the</span>
</span><span id="SystemSetup.setup_permissions-360"><a href="#SystemSetup.setup_permissions-360"><span class="linenos">360</span></a><span class="sd">        package level applies.</span>
</span><span id="SystemSetup.setup_permissions-361"><a href="#SystemSetup.setup_permissions-361"><span class="linenos">361</span></a>
</span><span id="SystemSetup.setup_permissions-362"><a href="#SystemSetup.setup_permissions-362"><span class="linenos">362</span></a><span class="sd">        It&#39;s required that the image root system has chkstat installed.</span>
</span><span id="SystemSetup.setup_permissions-363"><a href="#SystemSetup.setup_permissions-363"><span class="linenos">363</span></a><span class="sd">        If not present KIWI skips this step and continuous with a</span>
</span><span id="SystemSetup.setup_permissions-364"><a href="#SystemSetup.setup_permissions-364"><span class="linenos">364</span></a><span class="sd">        warning.</span>
</span><span id="SystemSetup.setup_permissions-365"><a href="#SystemSetup.setup_permissions-365"><span class="linenos">365</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_permissions-366"><a href="#SystemSetup.setup_permissions-366"><span class="linenos">366</span></a>        <span class="n">chkstat</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">which</span><span class="p">(</span>
</span><span id="SystemSetup.setup_permissions-367"><a href="#SystemSetup.setup_permissions-367"><span class="linenos">367</span></a>            <span class="s1">&#39;chkstat&#39;</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">access_mode</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">X_OK</span>
</span><span id="SystemSetup.setup_permissions-368"><a href="#SystemSetup.setup_permissions-368"><span class="linenos">368</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.setup_permissions-369"><a href="#SystemSetup.setup_permissions-369"><span class="linenos">369</span></a>        <span class="k">if</span> <span class="n">chkstat</span><span class="p">:</span>
</span><span id="SystemSetup.setup_permissions-370"><a href="#SystemSetup.setup_permissions-370"><span class="linenos">370</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Check/Fix File Permissions&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.setup_permissions-371"><a href="#SystemSetup.setup_permissions-371"><span class="linenos">371</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup.setup_permissions-372"><a href="#SystemSetup.setup_permissions-372"><span class="linenos">372</span></a>                <span class="p">[</span><span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;chkstat&#39;</span><span class="p">,</span> <span class="s1">&#39;--system&#39;</span><span class="p">,</span> <span class="s1">&#39;--set&#39;</span><span class="p">]</span>
</span><span id="SystemSetup.setup_permissions-373"><a href="#SystemSetup.setup_permissions-373"><span class="linenos">373</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.setup_permissions-374"><a href="#SystemSetup.setup_permissions-374"><span class="linenos">374</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup.setup_permissions-375"><a href="#SystemSetup.setup_permissions-375"><span class="linenos">375</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="SystemSetup.setup_permissions-376"><a href="#SystemSetup.setup_permissions-376"><span class="linenos">376</span></a>                <span class="s1">&#39;chkstat not found in image. File Permissions Check skipped&#39;</span>
</span><span id="SystemSetup.setup_permissions-377"><a href="#SystemSetup.setup_permissions-377"><span class="linenos">377</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Check and Fix permissions using chkstat</p>

<p>Call chkstat in system mode which reads /etc/sysconfig/security
to determine the configured security level and applies the
appropriate permission definitions from the /etc/permissions*
files. It's possible to provide those files as overlay files
in the image description to apply a certain permission setup
when needed. Otherwise the default setup as provided on the
package level applies.</p>

<p>It's required that the image root system has chkstat installed.
If not present KIWI skips this step and continuous with a
warning.</p>
</div>


                            </div>
                            <div id="SystemSetup.setup_keyboard_map" class="classattr">
                                        <input id="SystemSetup.setup_keyboard_map-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_keyboard_map</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.setup_keyboard_map-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.setup_keyboard_map"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.setup_keyboard_map-379"><a href="#SystemSetup.setup_keyboard_map-379"><span class="linenos">379</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_keyboard_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.setup_keyboard_map-380"><a href="#SystemSetup.setup_keyboard_map-380"><span class="linenos">380</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_keyboard_map-381"><a href="#SystemSetup.setup_keyboard_map-381"><span class="linenos">381</span></a><span class="sd">        Setup console keyboard</span>
</span><span id="SystemSetup.setup_keyboard_map-382"><a href="#SystemSetup.setup_keyboard_map-382"><span class="linenos">382</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_keyboard_map-383"><a href="#SystemSetup.setup_keyboard_map-383"><span class="linenos">383</span></a>        <span class="k">if</span> <span class="s1">&#39;keytable&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">:</span>
</span><span id="SystemSetup.setup_keyboard_map-384"><a href="#SystemSetup.setup_keyboard_map-384"><span class="linenos">384</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.setup_keyboard_map-385"><a href="#SystemSetup.setup_keyboard_map-385"><span class="linenos">385</span></a>                <span class="s1">&#39;Setting up keytable: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">])</span>
</span><span id="SystemSetup.setup_keyboard_map-386"><a href="#SystemSetup.setup_keyboard_map-386"><span class="linenos">386</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.setup_keyboard_map-387"><a href="#SystemSetup.setup_keyboard_map-387"><span class="linenos">387</span></a>            <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="SystemSetup.setup_keyboard_map-388"><a href="#SystemSetup.setup_keyboard_map-388"><span class="linenos">388</span></a>                <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span> <span class="s1">&#39;--keymap&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.setup_keyboard_map-389"><a href="#SystemSetup.setup_keyboard_map-389"><span class="linenos">389</span></a>                <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup.setup_keyboard_map-390"><a href="#SystemSetup.setup_keyboard_map-390"><span class="linenos">390</span></a>            <span class="p">):</span>
</span><span id="SystemSetup.setup_keyboard_map-391"><a href="#SystemSetup.setup_keyboard_map-391"><span class="linenos">391</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/vconsole.conf&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.setup_keyboard_map-392"><a href="#SystemSetup.setup_keyboard_map-392"><span class="linenos">392</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="SystemSetup.setup_keyboard_map-393"><a href="#SystemSetup.setup_keyboard_map-393"><span class="linenos">393</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.setup_keyboard_map-394"><a href="#SystemSetup.setup_keyboard_map-394"><span class="linenos">394</span></a>                    <span class="s1">&#39;--keymap=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">],</span>
</span><span id="SystemSetup.setup_keyboard_map-395"><a href="#SystemSetup.setup_keyboard_map-395"><span class="linenos">395</span></a>                <span class="p">],</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="SystemSetup.setup_keyboard_map-396"><a href="#SystemSetup.setup_keyboard_map-396"><span class="linenos">396</span></a>                <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SystemSetup.setup_keyboard_map-397"><a href="#SystemSetup.setup_keyboard_map-397"><span class="linenos">397</span></a>                    <span class="n">message</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\n</span>
</span><span id="SystemSetup.setup_keyboard_map-398"><a href="#SystemSetup.setup_keyboard_map-398"><span class="linenos">398</span></a><span class="s1">                        keyboard setup skipped because `systemd-firstboot --keymap` failed (code </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s1">):</span>
</span><span id="SystemSetup.setup_keyboard_map-399"><a href="#SystemSetup.setup_keyboard_map-399"><span class="linenos">399</span></a><span class="s1">                        </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">error</span><span class="si">}</span>
</span><span id="SystemSetup.setup_keyboard_map-400"><a href="#SystemSetup.setup_keyboard_map-400"><span class="linenos">400</span></a>
</span><span id="SystemSetup.setup_keyboard_map-401"><a href="#SystemSetup.setup_keyboard_map-401"><span class="linenos">401</span></a><span class="s1">                        This can happen for example if the specified keytable (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1">) is not available,</span>
</span><span id="SystemSetup.setup_keyboard_map-402"><a href="#SystemSetup.setup_keyboard_map-402"><span class="linenos">402</span></a><span class="s1">                        or if your system does not support the systemd way of managing keymaps.</span>
</span><span id="SystemSetup.setup_keyboard_map-403"><a href="#SystemSetup.setup_keyboard_map-403"><span class="linenos">403</span></a><span class="s1">                        Note that in both cases, systemd-firstboot&#39;s error message complains that the keymap is not installed.</span>
</span><span id="SystemSetup.setup_keyboard_map-404"><a href="#SystemSetup.setup_keyboard_map-404"><span class="linenos">404</span></a>
</span><span id="SystemSetup.setup_keyboard_map-405"><a href="#SystemSetup.setup_keyboard_map-405"><span class="linenos">405</span></a><span class="s1">                        If the keytable is missing, you might be able to install it for example via an additional package.</span>
</span><span id="SystemSetup.setup_keyboard_map-406"><a href="#SystemSetup.setup_keyboard_map-406"><span class="linenos">406</span></a><span class="s1">                        If your system doesn&#39;t support systemd&#39;s keymap management,</span>
</span><span id="SystemSetup.setup_keyboard_map-407"><a href="#SystemSetup.setup_keyboard_map-407"><span class="linenos">407</span></a><span class="s1">                        then you can use a distribution-specific method to set the keymap in a config.sh script.</span>
</span><span id="SystemSetup.setup_keyboard_map-408"><a href="#SystemSetup.setup_keyboard_map-408"><span class="linenos">408</span></a>
</span><span id="SystemSetup.setup_keyboard_map-409"><a href="#SystemSetup.setup_keyboard_map-409"><span class="linenos">409</span></a><span class="s1">                        You can try `localectl list-keymaps` to see if a particular distro supports systemd keymap management.</span>
</span><span id="SystemSetup.setup_keyboard_map-410"><a href="#SystemSetup.setup_keyboard_map-410"><span class="linenos">410</span></a><span class="s1">                    &#39;&#39;&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.setup_keyboard_map-411"><a href="#SystemSetup.setup_keyboard_map-411"><span class="linenos">411</span></a>                    <span class="k">raise</span> <span class="n">KiwiCommandError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="SystemSetup.setup_keyboard_map-412"><a href="#SystemSetup.setup_keyboard_map-412"><span class="linenos">412</span></a>            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/sysconfig/keyboard&#39;</span><span class="p">):</span>
</span><span id="SystemSetup.setup_keyboard_map-413"><a href="#SystemSetup.setup_keyboard_map-413"><span class="linenos">413</span></a>                <span class="n">Shell</span><span class="o">.</span><span class="n">run_common_function</span><span class="p">(</span>
</span><span id="SystemSetup.setup_keyboard_map-414"><a href="#SystemSetup.setup_keyboard_map-414"><span class="linenos">414</span></a>                    <span class="s1">&#39;baseUpdateSysConfig&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="SystemSetup.setup_keyboard_map-415"><a href="#SystemSetup.setup_keyboard_map-415"><span class="linenos">415</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/sysconfig/keyboard&#39;</span><span class="p">,</span> <span class="s1">&#39;KEYTABLE&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.setup_keyboard_map-416"><a href="#SystemSetup.setup_keyboard_map-416"><span class="linenos">416</span></a>                        <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;keytable&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
</span><span id="SystemSetup.setup_keyboard_map-417"><a href="#SystemSetup.setup_keyboard_map-417"><span class="linenos">417</span></a>                    <span class="p">]</span>
</span><span id="SystemSetup.setup_keyboard_map-418"><a href="#SystemSetup.setup_keyboard_map-418"><span class="linenos">418</span></a>                <span class="p">)</span>
</span><span id="SystemSetup.setup_keyboard_map-419"><a href="#SystemSetup.setup_keyboard_map-419"><span class="linenos">419</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup.setup_keyboard_map-420"><a href="#SystemSetup.setup_keyboard_map-420"><span class="linenos">420</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="SystemSetup.setup_keyboard_map-421"><a href="#SystemSetup.setup_keyboard_map-421"><span class="linenos">421</span></a>                    <span class="s1">&#39;keyboard setup skipped no capable &#39;</span>
</span><span id="SystemSetup.setup_keyboard_map-422"><a href="#SystemSetup.setup_keyboard_map-422"><span class="linenos">422</span></a>                    <span class="s1">&#39;systemd-firstboot or etc/sysconfig/keyboard found&#39;</span>
</span><span id="SystemSetup.setup_keyboard_map-423"><a href="#SystemSetup.setup_keyboard_map-423"><span class="linenos">423</span></a>                <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Setup console keyboard</p>
</div>


                            </div>
                            <div id="SystemSetup.setup_locale" class="classattr">
                                        <input id="SystemSetup.setup_locale-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_locale</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.setup_locale-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.setup_locale"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.setup_locale-425"><a href="#SystemSetup.setup_locale-425"><span class="linenos">425</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.setup_locale-426"><a href="#SystemSetup.setup_locale-426"><span class="linenos">426</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_locale-427"><a href="#SystemSetup.setup_locale-427"><span class="linenos">427</span></a><span class="sd">        Setup UTF8 system wide locale</span>
</span><span id="SystemSetup.setup_locale-428"><a href="#SystemSetup.setup_locale-428"><span class="linenos">428</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_locale-429"><a href="#SystemSetup.setup_locale-429"><span class="linenos">429</span></a>        <span class="k">if</span> <span class="s1">&#39;locale&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">:</span>
</span><span id="SystemSetup.setup_locale-430"><a href="#SystemSetup.setup_locale-430"><span class="linenos">430</span></a>            <span class="k">if</span> <span class="s1">&#39;POSIX&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
</span><span id="SystemSetup.setup_locale-431"><a href="#SystemSetup.setup_locale-431"><span class="linenos">431</span></a>                <span class="n">locale</span> <span class="o">=</span> <span class="s1">&#39;POSIX&#39;</span>
</span><span id="SystemSetup.setup_locale-432"><a href="#SystemSetup.setup_locale-432"><span class="linenos">432</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup.setup_locale-433"><a href="#SystemSetup.setup_locale-433"><span class="linenos">433</span></a>                <span class="n">locale</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.UTF-8&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup.setup_locale-434"><a href="#SystemSetup.setup_locale-434"><span class="linenos">434</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SystemSetup.setup_locale-435"><a href="#SystemSetup.setup_locale-435"><span class="linenos">435</span></a>                <span class="p">)</span>
</span><span id="SystemSetup.setup_locale-436"><a href="#SystemSetup.setup_locale-436"><span class="linenos">436</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.setup_locale-437"><a href="#SystemSetup.setup_locale-437"><span class="linenos">437</span></a>                <span class="s1">&#39;Setting up locale: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;locale&#39;</span><span class="p">])</span>
</span><span id="SystemSetup.setup_locale-438"><a href="#SystemSetup.setup_locale-438"><span class="linenos">438</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.setup_locale-439"><a href="#SystemSetup.setup_locale-439"><span class="linenos">439</span></a>            <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="SystemSetup.setup_locale-440"><a href="#SystemSetup.setup_locale-440"><span class="linenos">440</span></a>                <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span> <span class="s1">&#39;--locale&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.setup_locale-441"><a href="#SystemSetup.setup_locale-441"><span class="linenos">441</span></a>                <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup.setup_locale-442"><a href="#SystemSetup.setup_locale-442"><span class="linenos">442</span></a>            <span class="p">):</span>
</span><span id="SystemSetup.setup_locale-443"><a href="#SystemSetup.setup_locale-443"><span class="linenos">443</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/locale.conf&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.setup_locale-444"><a href="#SystemSetup.setup_locale-444"><span class="linenos">444</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="SystemSetup.setup_locale-445"><a href="#SystemSetup.setup_locale-445"><span class="linenos">445</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.setup_locale-446"><a href="#SystemSetup.setup_locale-446"><span class="linenos">446</span></a>                    <span class="s1">&#39;--locale=&#39;</span> <span class="o">+</span> <span class="n">locale</span>
</span><span id="SystemSetup.setup_locale-447"><a href="#SystemSetup.setup_locale-447"><span class="linenos">447</span></a>                <span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Setup UTF8 system wide locale</p>
</div>


                            </div>
                            <div id="SystemSetup.setup_timezone" class="classattr">
                                        <input id="SystemSetup.setup_timezone-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_timezone</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.setup_timezone-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.setup_timezone"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.setup_timezone-449"><a href="#SystemSetup.setup_timezone-449"><span class="linenos">449</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_timezone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.setup_timezone-450"><a href="#SystemSetup.setup_timezone-450"><span class="linenos">450</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_timezone-451"><a href="#SystemSetup.setup_timezone-451"><span class="linenos">451</span></a><span class="sd">        Setup timezone symlink</span>
</span><span id="SystemSetup.setup_timezone-452"><a href="#SystemSetup.setup_timezone-452"><span class="linenos">452</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_timezone-453"><a href="#SystemSetup.setup_timezone-453"><span class="linenos">453</span></a>        <span class="k">if</span> <span class="s1">&#39;timezone&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">:</span>
</span><span id="SystemSetup.setup_timezone-454"><a href="#SystemSetup.setup_timezone-454"><span class="linenos">454</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.setup_timezone-455"><a href="#SystemSetup.setup_timezone-455"><span class="linenos">455</span></a>                <span class="s1">&#39;Setting up timezone: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">])</span>
</span><span id="SystemSetup.setup_timezone-456"><a href="#SystemSetup.setup_timezone-456"><span class="linenos">456</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.setup_timezone-457"><a href="#SystemSetup.setup_timezone-457"><span class="linenos">457</span></a>            <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="SystemSetup.setup_timezone-458"><a href="#SystemSetup.setup_timezone-458"><span class="linenos">458</span></a>                <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span> <span class="s1">&#39;--timezone&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.setup_timezone-459"><a href="#SystemSetup.setup_timezone-459"><span class="linenos">459</span></a>                <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup.setup_timezone-460"><a href="#SystemSetup.setup_timezone-460"><span class="linenos">460</span></a>            <span class="p">):</span>
</span><span id="SystemSetup.setup_timezone-461"><a href="#SystemSetup.setup_timezone-461"><span class="linenos">461</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/localtime&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.setup_timezone-462"><a href="#SystemSetup.setup_timezone-462"><span class="linenos">462</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="SystemSetup.setup_timezone-463"><a href="#SystemSetup.setup_timezone-463"><span class="linenos">463</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;systemd-firstboot&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.setup_timezone-464"><a href="#SystemSetup.setup_timezone-464"><span class="linenos">464</span></a>                    <span class="s1">&#39;--timezone=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">]</span>
</span><span id="SystemSetup.setup_timezone-465"><a href="#SystemSetup.setup_timezone-465"><span class="linenos">465</span></a>                <span class="p">])</span>
</span><span id="SystemSetup.setup_timezone-466"><a href="#SystemSetup.setup_timezone-466"><span class="linenos">466</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup.setup_timezone-467"><a href="#SystemSetup.setup_timezone-467"><span class="linenos">467</span></a>                <span class="n">zoneinfo</span> <span class="o">=</span> <span class="s1">&#39;/usr/share/zoneinfo/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">]</span>
</span><span id="SystemSetup.setup_timezone-468"><a href="#SystemSetup.setup_timezone-468"><span class="linenos">468</span></a>                <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
</span><span id="SystemSetup.setup_timezone-469"><a href="#SystemSetup.setup_timezone-469"><span class="linenos">469</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup.setup_timezone-470"><a href="#SystemSetup.setup_timezone-470"><span class="linenos">470</span></a>                    <span class="s1">&#39;ln&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">zoneinfo</span><span class="p">,</span> <span class="s1">&#39;/etc/localtime&#39;</span>
</span><span id="SystemSetup.setup_timezone-471"><a href="#SystemSetup.setup_timezone-471"><span class="linenos">471</span></a>                <span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Setup timezone symlink</p>
</div>


                            </div>
                            <div id="SystemSetup.setup_groups" class="classattr">
                                        <input id="SystemSetup.setup_groups-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_groups</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.setup_groups-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.setup_groups"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.setup_groups-473"><a href="#SystemSetup.setup_groups-473"><span class="linenos">473</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.setup_groups-474"><a href="#SystemSetup.setup_groups-474"><span class="linenos">474</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_groups-475"><a href="#SystemSetup.setup_groups-475"><span class="linenos">475</span></a><span class="sd">        Add groups for configured users</span>
</span><span id="SystemSetup.setup_groups-476"><a href="#SystemSetup.setup_groups-476"><span class="linenos">476</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_groups-477"><a href="#SystemSetup.setup_groups-477"><span class="linenos">477</span></a>        <span class="n">system_users</span> <span class="o">=</span> <span class="n">Users</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="SystemSetup.setup_groups-478"><a href="#SystemSetup.setup_groups-478"><span class="linenos">478</span></a>
</span><span id="SystemSetup.setup_groups-479"><a href="#SystemSetup.setup_groups-479"><span class="linenos">479</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_users</span><span class="p">():</span>
</span><span id="SystemSetup.setup_groups-480"><a href="#SystemSetup.setup_groups-480"><span class="linenos">480</span></a>            <span class="n">group_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_names_and_ids_for_user</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
</span><span id="SystemSetup.setup_groups-481"><a href="#SystemSetup.setup_groups-481"><span class="linenos">481</span></a>            <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="n">group_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="SystemSetup.setup_groups-482"><a href="#SystemSetup.setup_groups-482"><span class="linenos">482</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">system_users</span><span class="o">.</span><span class="n">group_exists</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
</span><span id="SystemSetup.setup_groups-483"><a href="#SystemSetup.setup_groups-483"><span class="linenos">483</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding group </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
</span><span id="SystemSetup.setup_groups-484"><a href="#SystemSetup.setup_groups-484"><span class="linenos">484</span></a>                    <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_user_options</span><span class="p">(</span>
</span><span id="SystemSetup.setup_groups-485"><a href="#SystemSetup.setup_groups-485"><span class="linenos">485</span></a>                        <span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span>
</span><span id="SystemSetup.setup_groups-486"><a href="#SystemSetup.setup_groups-486"><span class="linenos">486</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup.setup_groups-487"><a href="#SystemSetup.setup_groups-487"><span class="linenos">487</span></a>                    <span class="n">system_users</span><span class="o">.</span><span class="n">group_add</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Add groups for configured users</p>
</div>


                            </div>
                            <div id="SystemSetup.setup_users" class="classattr">
                                        <input id="SystemSetup.setup_users-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_users</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.setup_users-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.setup_users"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.setup_users-489"><a href="#SystemSetup.setup_users-489"><span class="linenos">489</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.setup_users-490"><a href="#SystemSetup.setup_users-490"><span class="linenos">490</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_users-491"><a href="#SystemSetup.setup_users-491"><span class="linenos">491</span></a><span class="sd">        Add/Modify configured users</span>
</span><span id="SystemSetup.setup_users-492"><a href="#SystemSetup.setup_users-492"><span class="linenos">492</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_users-493"><a href="#SystemSetup.setup_users-493"><span class="linenos">493</span></a>        <span class="n">system_users</span> <span class="o">=</span> <span class="n">Users</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="SystemSetup.setup_users-494"><a href="#SystemSetup.setup_users-494"><span class="linenos">494</span></a>
</span><span id="SystemSetup.setup_users-495"><a href="#SystemSetup.setup_users-495"><span class="linenos">495</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_users</span><span class="p">():</span>
</span><span id="SystemSetup.setup_users-496"><a href="#SystemSetup.setup_users-496"><span class="linenos">496</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting up user </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
</span><span id="SystemSetup.setup_users-497"><a href="#SystemSetup.setup_users-497"><span class="linenos">497</span></a>            <span class="n">password</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_password</span><span class="p">()</span>
</span><span id="SystemSetup.setup_users-498"><a href="#SystemSetup.setup_users-498"><span class="linenos">498</span></a>            <span class="n">password_format</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_pwdformat</span><span class="p">()</span>
</span><span id="SystemSetup.setup_users-499"><a href="#SystemSetup.setup_users-499"><span class="linenos">499</span></a>            <span class="n">home_path</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_home</span><span class="p">()</span>
</span><span id="SystemSetup.setup_users-500"><a href="#SystemSetup.setup_users-500"><span class="linenos">500</span></a>            <span class="n">user_name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
</span><span id="SystemSetup.setup_users-501"><a href="#SystemSetup.setup_users-501"><span class="linenos">501</span></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
</span><span id="SystemSetup.setup_users-502"><a href="#SystemSetup.setup_users-502"><span class="linenos">502</span></a>            <span class="n">user_realname</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_realname</span><span class="p">()</span>
</span><span id="SystemSetup.setup_users-503"><a href="#SystemSetup.setup_users-503"><span class="linenos">503</span></a>            <span class="n">user_shell</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_shell</span><span class="p">()</span>
</span><span id="SystemSetup.setup_users-504"><a href="#SystemSetup.setup_users-504"><span class="linenos">504</span></a>            <span class="n">user_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="SystemSetup.setup_users-505"><a href="#SystemSetup.setup_users-505"><span class="linenos">505</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_names_and_ids_for_user</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="SystemSetup.setup_users-506"><a href="#SystemSetup.setup_users-506"><span class="linenos">506</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.setup_users-507"><a href="#SystemSetup.setup_users-507"><span class="linenos">507</span></a>
</span><span id="SystemSetup.setup_users-508"><a href="#SystemSetup.setup_users-508"><span class="linenos">508</span></a>            <span class="n">user_exists</span> <span class="o">=</span> <span class="n">system_users</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">user_name</span><span class="p">)</span>
</span><span id="SystemSetup.setup_users-509"><a href="#SystemSetup.setup_users-509"><span class="linenos">509</span></a>
</span><span id="SystemSetup.setup_users-510"><a href="#SystemSetup.setup_users-510"><span class="linenos">510</span></a>            <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_user_options</span><span class="p">(</span>
</span><span id="SystemSetup.setup_users-511"><a href="#SystemSetup.setup_users-511"><span class="linenos">511</span></a>                <span class="n">password_format</span><span class="o">=</span><span class="n">password_format</span><span class="p">,</span>
</span><span id="SystemSetup.setup_users-512"><a href="#SystemSetup.setup_users-512"><span class="linenos">512</span></a>                <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
</span><span id="SystemSetup.setup_users-513"><a href="#SystemSetup.setup_users-513"><span class="linenos">513</span></a>                <span class="n">user_shell</span><span class="o">=</span><span class="n">user_shell</span><span class="p">,</span>
</span><span id="SystemSetup.setup_users-514"><a href="#SystemSetup.setup_users-514"><span class="linenos">514</span></a>                <span class="n">user_groups</span><span class="o">=</span><span class="n">user_groups</span><span class="p">,</span>
</span><span id="SystemSetup.setup_users-515"><a href="#SystemSetup.setup_users-515"><span class="linenos">515</span></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="SystemSetup.setup_users-516"><a href="#SystemSetup.setup_users-516"><span class="linenos">516</span></a>                <span class="n">user_realname</span><span class="o">=</span><span class="n">user_realname</span><span class="p">,</span>
</span><span id="SystemSetup.setup_users-517"><a href="#SystemSetup.setup_users-517"><span class="linenos">517</span></a>                <span class="n">user_exists</span><span class="o">=</span><span class="n">user_exists</span><span class="p">,</span>
</span><span id="SystemSetup.setup_users-518"><a href="#SystemSetup.setup_users-518"><span class="linenos">518</span></a>                <span class="n">home_path</span><span class="o">=</span><span class="n">home_path</span>
</span><span id="SystemSetup.setup_users-519"><a href="#SystemSetup.setup_users-519"><span class="linenos">519</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.setup_users-520"><a href="#SystemSetup.setup_users-520"><span class="linenos">520</span></a>
</span><span id="SystemSetup.setup_users-521"><a href="#SystemSetup.setup_users-521"><span class="linenos">521</span></a>            <span class="n">group_msg</span> <span class="o">=</span> <span class="s1">&#39;--&gt; Primary group for user </span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup.setup_users-522"><a href="#SystemSetup.setup_users-522"><span class="linenos">522</span></a>                <span class="n">user_name</span><span class="p">,</span> <span class="n">user_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SystemSetup.setup_users-523"><a href="#SystemSetup.setup_users-523"><span class="linenos">523</span></a>            <span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_groups</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</span><span id="SystemSetup.setup_users-524"><a href="#SystemSetup.setup_users-524"><span class="linenos">524</span></a>
</span><span id="SystemSetup.setup_users-525"><a href="#SystemSetup.setup_users-525"><span class="linenos">525</span></a>            <span class="k">if</span> <span class="n">user_exists</span><span class="p">:</span>
</span><span id="SystemSetup.setup_users-526"><a href="#SystemSetup.setup_users-526"><span class="linenos">526</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Modifying user: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_name</span><span class="p">))</span>
</span><span id="SystemSetup.setup_users-527"><a href="#SystemSetup.setup_users-527"><span class="linenos">527</span></a>                <span class="k">if</span> <span class="n">group_msg</span><span class="p">:</span>
</span><span id="SystemSetup.setup_users-528"><a href="#SystemSetup.setup_users-528"><span class="linenos">528</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">group_msg</span><span class="p">)</span>
</span><span id="SystemSetup.setup_users-529"><a href="#SystemSetup.setup_users-529"><span class="linenos">529</span></a>                <span class="n">system_users</span><span class="o">.</span><span class="n">user_modify</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="SystemSetup.setup_users-530"><a href="#SystemSetup.setup_users-530"><span class="linenos">530</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup.setup_users-531"><a href="#SystemSetup.setup_users-531"><span class="linenos">531</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Adding user: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_name</span><span class="p">))</span>
</span><span id="SystemSetup.setup_users-532"><a href="#SystemSetup.setup_users-532"><span class="linenos">532</span></a>                <span class="k">if</span> <span class="n">group_msg</span><span class="p">:</span>
</span><span id="SystemSetup.setup_users-533"><a href="#SystemSetup.setup_users-533"><span class="linenos">533</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">group_msg</span><span class="p">)</span>
</span><span id="SystemSetup.setup_users-534"><a href="#SystemSetup.setup_users-534"><span class="linenos">534</span></a>                <span class="n">system_users</span><span class="o">.</span><span class="n">user_add</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="SystemSetup.setup_users-535"><a href="#SystemSetup.setup_users-535"><span class="linenos">535</span></a>                <span class="k">if</span> <span class="n">home_path</span><span class="p">:</span>
</span><span id="SystemSetup.setup_users-536"><a href="#SystemSetup.setup_users-536"><span class="linenos">536</span></a>                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.setup_users-537"><a href="#SystemSetup.setup_users-537"><span class="linenos">537</span></a>                        <span class="s1">&#39;--&gt; Setting permissions for </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">home_path</span><span class="p">)</span>
</span><span id="SystemSetup.setup_users-538"><a href="#SystemSetup.setup_users-538"><span class="linenos">538</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup.setup_users-539"><a href="#SystemSetup.setup_users-539"><span class="linenos">539</span></a>                    <span class="c1"># Emtpy group string assumes the login or default group</span>
</span><span id="SystemSetup.setup_users-540"><a href="#SystemSetup.setup_users-540"><span class="linenos">540</span></a>                    <span class="n">system_users</span><span class="o">.</span><span class="n">setup_home_for_user</span><span class="p">(</span>
</span><span id="SystemSetup.setup_users-541"><a href="#SystemSetup.setup_users-541"><span class="linenos">541</span></a>                        <span class="n">user_name</span><span class="p">,</span>
</span><span id="SystemSetup.setup_users-542"><a href="#SystemSetup.setup_users-542"><span class="linenos">542</span></a>                        <span class="n">user_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_groups</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.setup_users-543"><a href="#SystemSetup.setup_users-543"><span class="linenos">543</span></a>                        <span class="n">home_path</span>
</span><span id="SystemSetup.setup_users-544"><a href="#SystemSetup.setup_users-544"><span class="linenos">544</span></a>                    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Add/Modify configured users</p>
</div>


                            </div>
                            <div id="SystemSetup.setup_plymouth_splash" class="classattr">
                                        <input id="SystemSetup.setup_plymouth_splash-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_plymouth_splash</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.setup_plymouth_splash-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.setup_plymouth_splash"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.setup_plymouth_splash-546"><a href="#SystemSetup.setup_plymouth_splash-546"><span class="linenos">546</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_plymouth_splash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.setup_plymouth_splash-547"><a href="#SystemSetup.setup_plymouth_splash-547"><span class="linenos">547</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_plymouth_splash-548"><a href="#SystemSetup.setup_plymouth_splash-548"><span class="linenos">548</span></a><span class="sd">        Setup the KIWI configured splash theme as default</span>
</span><span id="SystemSetup.setup_plymouth_splash-549"><a href="#SystemSetup.setup_plymouth_splash-549"><span class="linenos">549</span></a>
</span><span id="SystemSetup.setup_plymouth_splash-550"><a href="#SystemSetup.setup_plymouth_splash-550"><span class="linenos">550</span></a><span class="sd">        The method uses the plymouth-set-default-theme tool to setup the</span>
</span><span id="SystemSetup.setup_plymouth_splash-551"><a href="#SystemSetup.setup_plymouth_splash-551"><span class="linenos">551</span></a><span class="sd">        theme for the plymouth splash system. Only in case the tool could</span>
</span><span id="SystemSetup.setup_plymouth_splash-552"><a href="#SystemSetup.setup_plymouth_splash-552"><span class="linenos">552</span></a><span class="sd">        be found in the image root, it is assumed plymouth splash is in</span>
</span><span id="SystemSetup.setup_plymouth_splash-553"><a href="#SystemSetup.setup_plymouth_splash-553"><span class="linenos">553</span></a><span class="sd">        use and the tool is called in a chroot operation</span>
</span><span id="SystemSetup.setup_plymouth_splash-554"><a href="#SystemSetup.setup_plymouth_splash-554"><span class="linenos">554</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_plymouth_splash-555"><a href="#SystemSetup.setup_plymouth_splash-555"><span class="linenos">555</span></a>        <span class="n">theme_setup</span> <span class="o">=</span> <span class="s1">&#39;plymouth-set-default-theme&#39;</span>
</span><span id="SystemSetup.setup_plymouth_splash-556"><a href="#SystemSetup.setup_plymouth_splash-556"><span class="linenos">556</span></a>        <span class="k">if</span> <span class="n">Path</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">theme_setup</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">):</span>
</span><span id="SystemSetup.setup_plymouth_splash-557"><a href="#SystemSetup.setup_plymouth_splash-557"><span class="linenos">557</span></a>            <span class="k">for</span> <span class="n">preferences</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_preferences_sections</span><span class="p">():</span>
</span><span id="SystemSetup.setup_plymouth_splash-558"><a href="#SystemSetup.setup_plymouth_splash-558"><span class="linenos">558</span></a>                <span class="n">splash_section_content</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="n">get_bootsplash_theme</span><span class="p">()</span>
</span><span id="SystemSetup.setup_plymouth_splash-559"><a href="#SystemSetup.setup_plymouth_splash-559"><span class="linenos">559</span></a>                <span class="k">if</span> <span class="n">splash_section_content</span><span class="p">:</span>
</span><span id="SystemSetup.setup_plymouth_splash-560"><a href="#SystemSetup.setup_plymouth_splash-560"><span class="linenos">560</span></a>                    <span class="n">splash_theme</span> <span class="o">=</span> <span class="n">splash_section_content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SystemSetup.setup_plymouth_splash-561"><a href="#SystemSetup.setup_plymouth_splash-561"><span class="linenos">561</span></a>                    <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup.setup_plymouth_splash-562"><a href="#SystemSetup.setup_plymouth_splash-562"><span class="linenos">562</span></a>                        <span class="p">[</span><span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">theme_setup</span><span class="p">,</span> <span class="n">splash_theme</span><span class="p">]</span>
</span><span id="SystemSetup.setup_plymouth_splash-563"><a href="#SystemSetup.setup_plymouth_splash-563"><span class="linenos">563</span></a>                    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Setup the KIWI configured splash theme as default</p>

<p>The method uses the plymouth-set-default-theme tool to setup the
theme for the plymouth splash system. Only in case the tool could
be found in the image root, it is assumed plymouth splash is in
use and the tool is called in a chroot operation</p>
</div>


                            </div>
                            <div id="SystemSetup.import_image_identifier" class="classattr">
                                        <input id="SystemSetup.import_image_identifier-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">import_image_identifier</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.import_image_identifier-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.import_image_identifier"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.import_image_identifier-565"><a href="#SystemSetup.import_image_identifier-565"><span class="linenos">565</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_image_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.import_image_identifier-566"><a href="#SystemSetup.import_image_identifier-566"><span class="linenos">566</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.import_image_identifier-567"><a href="#SystemSetup.import_image_identifier-567"><span class="linenos">567</span></a><span class="sd">        Create etc/ImageID identifier file</span>
</span><span id="SystemSetup.import_image_identifier-568"><a href="#SystemSetup.import_image_identifier-568"><span class="linenos">568</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.import_image_identifier-569"><a href="#SystemSetup.import_image_identifier-569"><span class="linenos">569</span></a>        <span class="n">image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
</span><span id="SystemSetup.import_image_identifier-570"><a href="#SystemSetup.import_image_identifier-570"><span class="linenos">570</span></a>        <span class="k">if</span> <span class="n">image_id</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc&#39;</span><span class="p">):</span>
</span><span id="SystemSetup.import_image_identifier-571"><a href="#SystemSetup.import_image_identifier-571"><span class="linenos">571</span></a>            <span class="n">image_id_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/ImageID&#39;</span>
</span><span id="SystemSetup.import_image_identifier-572"><a href="#SystemSetup.import_image_identifier-572"><span class="linenos">572</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.import_image_identifier-573"><a href="#SystemSetup.import_image_identifier-573"><span class="linenos">573</span></a>                <span class="s1">&#39;Creating image identifier: </span><span class="si">{0}</span><span class="s1"> in </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup.import_image_identifier-574"><a href="#SystemSetup.import_image_identifier-574"><span class="linenos">574</span></a>                    <span class="n">image_id</span><span class="p">,</span> <span class="n">image_id_file</span>
</span><span id="SystemSetup.import_image_identifier-575"><a href="#SystemSetup.import_image_identifier-575"><span class="linenos">575</span></a>                <span class="p">)</span>
</span><span id="SystemSetup.import_image_identifier-576"><a href="#SystemSetup.import_image_identifier-576"><span class="linenos">576</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.import_image_identifier-577"><a href="#SystemSetup.import_image_identifier-577"><span class="linenos">577</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_id_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">identifier</span><span class="p">:</span>
</span><span id="SystemSetup.import_image_identifier-578"><a href="#SystemSetup.import_image_identifier-578"><span class="linenos">578</span></a>                <span class="n">identifier</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Create etc/ImageID identifier file</p>
</div>


                            </div>
                            <div id="SystemSetup.set_selinux_file_contexts" class="classattr">
                                        <input id="SystemSetup.set_selinux_file_contexts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_selinux_file_contexts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">security_context_file</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.set_selinux_file_contexts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.set_selinux_file_contexts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.set_selinux_file_contexts-580"><a href="#SystemSetup.set_selinux_file_contexts-580"><span class="linenos">580</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_selinux_file_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">security_context_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.set_selinux_file_contexts-581"><a href="#SystemSetup.set_selinux_file_contexts-581"><span class="linenos">581</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.set_selinux_file_contexts-582"><a href="#SystemSetup.set_selinux_file_contexts-582"><span class="linenos">582</span></a><span class="sd">        Initialize the security context fields (extended attributes)</span>
</span><span id="SystemSetup.set_selinux_file_contexts-583"><a href="#SystemSetup.set_selinux_file_contexts-583"><span class="linenos">583</span></a><span class="sd">        on the files matching the security_context_file</span>
</span><span id="SystemSetup.set_selinux_file_contexts-584"><a href="#SystemSetup.set_selinux_file_contexts-584"><span class="linenos">584</span></a>
</span><span id="SystemSetup.set_selinux_file_contexts-585"><a href="#SystemSetup.set_selinux_file_contexts-585"><span class="linenos">585</span></a><span class="sd">        :param str security_context_file: path file name</span>
</span><span id="SystemSetup.set_selinux_file_contexts-586"><a href="#SystemSetup.set_selinux_file_contexts-586"><span class="linenos">586</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.set_selinux_file_contexts-587"><a href="#SystemSetup.set_selinux_file_contexts-587"><span class="linenos">587</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing SELinux file security contexts&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.set_selinux_file_contexts-588"><a href="#SystemSetup.set_selinux_file_contexts-588"><span class="linenos">588</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
</span><span id="SystemSetup.set_selinux_file_contexts-589"><a href="#SystemSetup.set_selinux_file_contexts-589"><span class="linenos">589</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;System is read-only, security context unchanged&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.set_selinux_file_contexts-590"><a href="#SystemSetup.set_selinux_file_contexts-590"><span class="linenos">590</span></a>            <span class="k">return</span>
</span><span id="SystemSetup.set_selinux_file_contexts-591"><a href="#SystemSetup.set_selinux_file_contexts-591"><span class="linenos">591</span></a>        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SystemSetup.set_selinux_file_contexts-592"><a href="#SystemSetup.set_selinux_file_contexts-592"><span class="linenos">592</span></a>        <span class="k">for</span> <span class="n">devname</span> <span class="ow">in</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_exclude_list_for_non_physical_devices</span><span class="p">():</span>
</span><span id="SystemSetup.set_selinux_file_contexts-593"><a href="#SystemSetup.set_selinux_file_contexts-593"><span class="linenos">593</span></a>            <span class="n">exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-e&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.set_selinux_file_contexts-594"><a href="#SystemSetup.set_selinux_file_contexts-594"><span class="linenos">594</span></a>            <span class="n">exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">devname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.set_selinux_file_contexts-595"><a href="#SystemSetup.set_selinux_file_contexts-595"><span class="linenos">595</span></a>        <span class="c1"># setfiles doesn&#39;t come with a stable command API and older versions</span>
</span><span id="SystemSetup.set_selinux_file_contexts-596"><a href="#SystemSetup.set_selinux_file_contexts-596"><span class="linenos">596</span></a>        <span class="c1"># needs a different invocation syntax. On older versions the usage</span>
</span><span id="SystemSetup.set_selinux_file_contexts-597"><a href="#SystemSetup.set_selinux_file_contexts-597"><span class="linenos">597</span></a>        <span class="c1"># information explicitly lists &quot;setfiles -c policyfile&quot; which is not</span>
</span><span id="SystemSetup.set_selinux_file_contexts-598"><a href="#SystemSetup.set_selinux_file_contexts-598"><span class="linenos">598</span></a>        <span class="c1"># present in newer versions. As setfiles doesn&#39;t come with a simple</span>
</span><span id="SystemSetup.set_selinux_file_contexts-599"><a href="#SystemSetup.set_selinux_file_contexts-599"><span class="linenos">599</span></a>        <span class="c1"># --version option, checking for this extra element in the usage</span>
</span><span id="SystemSetup.set_selinux_file_contexts-600"><a href="#SystemSetup.set_selinux_file_contexts-600"><span class="linenos">600</span></a>        <span class="c1"># was the only pointer I could come up with to differentiate the</span>
</span><span id="SystemSetup.set_selinux_file_contexts-601"><a href="#SystemSetup.set_selinux_file_contexts-601"><span class="linenos">601</span></a>        <span class="c1"># call options.</span>
</span><span id="SystemSetup.set_selinux_file_contexts-602"><a href="#SystemSetup.set_selinux_file_contexts-602"><span class="linenos">602</span></a>        <span class="k">if</span> <span class="n">CommandCapabilities</span><span class="o">.</span><span class="n">has_option_in_help</span><span class="p">(</span>
</span><span id="SystemSetup.set_selinux_file_contexts-603"><a href="#SystemSetup.set_selinux_file_contexts-603"><span class="linenos">603</span></a>            <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span> <span class="s1">&#39;setfiles -c policyfile&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;--help&#39;</span><span class="p">],</span>
</span><span id="SystemSetup.set_selinux_file_contexts-604"><a href="#SystemSetup.set_selinux_file_contexts-604"><span class="linenos">604</span></a>            <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span>
</span><span id="SystemSetup.set_selinux_file_contexts-605"><a href="#SystemSetup.set_selinux_file_contexts-605"><span class="linenos">605</span></a>        <span class="p">):</span>
</span><span id="SystemSetup.set_selinux_file_contexts-606"><a href="#SystemSetup.set_selinux_file_contexts-606"><span class="linenos">606</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup.set_selinux_file_contexts-607"><a href="#SystemSetup.set_selinux_file_contexts-607"><span class="linenos">607</span></a>                <span class="p">[</span>
</span><span id="SystemSetup.set_selinux_file_contexts-608"><a href="#SystemSetup.set_selinux_file_contexts-608"><span class="linenos">608</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.set_selinux_file_contexts-609"><a href="#SystemSetup.set_selinux_file_contexts-609"><span class="linenos">609</span></a>                    <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_selinux_policy_file</span><span class="p">(</span>
</span><span id="SystemSetup.set_selinux_file_contexts-610"><a href="#SystemSetup.set_selinux_file_contexts-610"><span class="linenos">610</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_selinux_policy</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;targeted&#39;</span>
</span><span id="SystemSetup.set_selinux_file_contexts-611"><a href="#SystemSetup.set_selinux_file_contexts-611"><span class="linenos">611</span></a>                    <span class="p">),</span> <span class="n">security_context_file</span>
</span><span id="SystemSetup.set_selinux_file_contexts-612"><a href="#SystemSetup.set_selinux_file_contexts-612"><span class="linenos">612</span></a>                <span class="p">]</span>
</span><span id="SystemSetup.set_selinux_file_contexts-613"><a href="#SystemSetup.set_selinux_file_contexts-613"><span class="linenos">613</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.set_selinux_file_contexts-614"><a href="#SystemSetup.set_selinux_file_contexts-614"><span class="linenos">614</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup.set_selinux_file_contexts-615"><a href="#SystemSetup.set_selinux_file_contexts-615"><span class="linenos">615</span></a>                <span class="p">[</span>
</span><span id="SystemSetup.set_selinux_file_contexts-616"><a href="#SystemSetup.set_selinux_file_contexts-616"><span class="linenos">616</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.set_selinux_file_contexts-617"><a href="#SystemSetup.set_selinux_file_contexts-617"><span class="linenos">617</span></a>                    <span class="s1">&#39;-F&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span>
</span><span id="SystemSetup.set_selinux_file_contexts-618"><a href="#SystemSetup.set_selinux_file_contexts-618"><span class="linenos">618</span></a>                <span class="p">]</span> <span class="o">+</span> <span class="n">exclude</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="SystemSetup.set_selinux_file_contexts-619"><a href="#SystemSetup.set_selinux_file_contexts-619"><span class="linenos">619</span></a>                    <span class="n">security_context_file</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span>
</span><span id="SystemSetup.set_selinux_file_contexts-620"><a href="#SystemSetup.set_selinux_file_contexts-620"><span class="linenos">620</span></a>                <span class="p">]</span>
</span><span id="SystemSetup.set_selinux_file_contexts-621"><a href="#SystemSetup.set_selinux_file_contexts-621"><span class="linenos">621</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.set_selinux_file_contexts-622"><a href="#SystemSetup.set_selinux_file_contexts-622"><span class="linenos">622</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup.set_selinux_file_contexts-623"><a href="#SystemSetup.set_selinux_file_contexts-623"><span class="linenos">623</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup.set_selinux_file_contexts-624"><a href="#SystemSetup.set_selinux_file_contexts-624"><span class="linenos">624</span></a>                <span class="p">[</span>
</span><span id="SystemSetup.set_selinux_file_contexts-625"><a href="#SystemSetup.set_selinux_file_contexts-625"><span class="linenos">625</span></a>                    <span class="s1">&#39;chroot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;setfiles&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.set_selinux_file_contexts-626"><a href="#SystemSetup.set_selinux_file_contexts-626"><span class="linenos">626</span></a>                    <span class="s1">&#39;-T0&#39;</span><span class="p">,</span> <span class="s1">&#39;-F&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_selinux_policy_file</span><span class="p">(</span>
</span><span id="SystemSetup.set_selinux_file_contexts-627"><a href="#SystemSetup.set_selinux_file_contexts-627"><span class="linenos">627</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_selinux_policy</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;targeted&#39;</span>
</span><span id="SystemSetup.set_selinux_file_contexts-628"><a href="#SystemSetup.set_selinux_file_contexts-628"><span class="linenos">628</span></a>                    <span class="p">)</span>
</span><span id="SystemSetup.set_selinux_file_contexts-629"><a href="#SystemSetup.set_selinux_file_contexts-629"><span class="linenos">629</span></a>                <span class="p">]</span> <span class="o">+</span> <span class="n">exclude</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="SystemSetup.set_selinux_file_contexts-630"><a href="#SystemSetup.set_selinux_file_contexts-630"><span class="linenos">630</span></a>                    <span class="n">security_context_file</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span>
</span><span id="SystemSetup.set_selinux_file_contexts-631"><a href="#SystemSetup.set_selinux_file_contexts-631"><span class="linenos">631</span></a>                <span class="p">]</span>
</span><span id="SystemSetup.set_selinux_file_contexts-632"><a href="#SystemSetup.set_selinux_file_contexts-632"><span class="linenos">632</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the security context fields (extended attributes)
on the files matching the security_context_file</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str security_context_file</strong>:  path file name</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.setup_selinux_file_contexts" class="classattr">
                                        <input id="SystemSetup.setup_selinux_file_contexts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_selinux_file_contexts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.setup_selinux_file_contexts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.setup_selinux_file_contexts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.setup_selinux_file_contexts-634"><a href="#SystemSetup.setup_selinux_file_contexts-634"><span class="linenos">634</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_selinux_file_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.setup_selinux_file_contexts-635"><a href="#SystemSetup.setup_selinux_file_contexts-635"><span class="linenos">635</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_selinux_file_contexts-636"><a href="#SystemSetup.setup_selinux_file_contexts-636"><span class="linenos">636</span></a><span class="sd">        Set SELinux file security contexts if the default context file is found</span>
</span><span id="SystemSetup.setup_selinux_file_contexts-637"><a href="#SystemSetup.setup_selinux_file_contexts-637"><span class="linenos">637</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.setup_selinux_file_contexts-638"><a href="#SystemSetup.setup_selinux_file_contexts-638"><span class="linenos">638</span></a>        <span class="n">security_context</span> <span class="o">=</span> <span class="s1">&#39;/etc/selinux/targeted/contexts/files/file_contexts&#39;</span>
</span><span id="SystemSetup.setup_selinux_file_contexts-639"><a href="#SystemSetup.setup_selinux_file_contexts-639"><span class="linenos">639</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="n">security_context</span><span class="p">):</span>
</span><span id="SystemSetup.setup_selinux_file_contexts-640"><a href="#SystemSetup.setup_selinux_file_contexts-640"><span class="linenos">640</span></a>            <span class="k">if</span> <span class="n">Path</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;setfiles&#39;</span><span class="p">,</span> <span class="n">access_mode</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">):</span>
</span><span id="SystemSetup.setup_selinux_file_contexts-641"><a href="#SystemSetup.setup_selinux_file_contexts-641"><span class="linenos">641</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">set_selinux_file_contexts</span><span class="p">(</span><span class="n">security_context</span><span class="p">)</span>
</span><span id="SystemSetup.setup_selinux_file_contexts-642"><a href="#SystemSetup.setup_selinux_file_contexts-642"><span class="linenos">642</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SystemSetup.setup_selinux_file_contexts-643"><a href="#SystemSetup.setup_selinux_file_contexts-643"><span class="linenos">643</span></a>                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="SystemSetup.setup_selinux_file_contexts-644"><a href="#SystemSetup.setup_selinux_file_contexts-644"><span class="linenos">644</span></a>                    <span class="s1">&#39;security_context found but setfiles tool not installed&#39;</span>
</span><span id="SystemSetup.setup_selinux_file_contexts-645"><a href="#SystemSetup.setup_selinux_file_contexts-645"><span class="linenos">645</span></a>                <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Set SELinux file security contexts if the default context file is found</p>
</div>


                            </div>
                            <div id="SystemSetup.export_modprobe_setup" class="classattr">
                                        <input id="SystemSetup.export_modprobe_setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">export_modprobe_setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">target_root_dir</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.export_modprobe_setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.export_modprobe_setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.export_modprobe_setup-647"><a href="#SystemSetup.export_modprobe_setup-647"><span class="linenos">647</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_modprobe_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.export_modprobe_setup-648"><a href="#SystemSetup.export_modprobe_setup-648"><span class="linenos">648</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.export_modprobe_setup-649"><a href="#SystemSetup.export_modprobe_setup-649"><span class="linenos">649</span></a><span class="sd">        Export etc/modprobe.d to given root_dir</span>
</span><span id="SystemSetup.export_modprobe_setup-650"><a href="#SystemSetup.export_modprobe_setup-650"><span class="linenos">650</span></a>
</span><span id="SystemSetup.export_modprobe_setup-651"><a href="#SystemSetup.export_modprobe_setup-651"><span class="linenos">651</span></a><span class="sd">        :param str target_root_dir: path name</span>
</span><span id="SystemSetup.export_modprobe_setup-652"><a href="#SystemSetup.export_modprobe_setup-652"><span class="linenos">652</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.export_modprobe_setup-653"><a href="#SystemSetup.export_modprobe_setup-653"><span class="linenos">653</span></a>        <span class="n">modprobe_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/modprobe.d&#39;</span>
</span><span id="SystemSetup.export_modprobe_setup-654"><a href="#SystemSetup.export_modprobe_setup-654"><span class="linenos">654</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">modprobe_config</span><span class="p">):</span>
</span><span id="SystemSetup.export_modprobe_setup-655"><a href="#SystemSetup.export_modprobe_setup-655"><span class="linenos">655</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Export modprobe configuration&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.export_modprobe_setup-656"><a href="#SystemSetup.export_modprobe_setup-656"><span class="linenos">656</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">target_root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.export_modprobe_setup-657"><a href="#SystemSetup.export_modprobe_setup-657"><span class="linenos">657</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataSync</span><span class="p">(</span>
</span><span id="SystemSetup.export_modprobe_setup-658"><a href="#SystemSetup.export_modprobe_setup-658"><span class="linenos">658</span></a>                <span class="n">modprobe_config</span><span class="p">,</span> <span class="n">target_root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/&#39;</span>
</span><span id="SystemSetup.export_modprobe_setup-659"><a href="#SystemSetup.export_modprobe_setup-659"><span class="linenos">659</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.export_modprobe_setup-660"><a href="#SystemSetup.export_modprobe_setup-660"><span class="linenos">660</span></a>            <span class="n">data</span><span class="o">.</span><span class="n">sync_data</span><span class="p">(</span>
</span><span id="SystemSetup.export_modprobe_setup-661"><a href="#SystemSetup.export_modprobe_setup-661"><span class="linenos">661</span></a>                <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-a&#39;</span><span class="p">]</span>
</span><span id="SystemSetup.export_modprobe_setup-662"><a href="#SystemSetup.export_modprobe_setup-662"><span class="linenos">662</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Export etc/modprobe.d to given root_dir</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str target_root_dir</strong>:  path name</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.export_flake_pilot_system_file_list" class="classattr">
                                        <input id="SystemSetup.export_flake_pilot_system_file_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">export_flake_pilot_system_file_list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.export_flake_pilot_system_file_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.export_flake_pilot_system_file_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.export_flake_pilot_system_file_list-664"><a href="#SystemSetup.export_flake_pilot_system_file_list-664"><span class="linenos">664</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_flake_pilot_system_file_list</span><span class="p">(</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-665"><a href="#SystemSetup.export_flake_pilot_system_file_list-665"><span class="linenos">665</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-666"><a href="#SystemSetup.export_flake_pilot_system_file_list-666"><span class="linenos">666</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-667"><a href="#SystemSetup.export_flake_pilot_system_file_list-667"><span class="linenos">667</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-668"><a href="#SystemSetup.export_flake_pilot_system_file_list-668"><span class="linenos">668</span></a><span class="sd">        Export image package file list to the target_dir</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-669"><a href="#SystemSetup.export_flake_pilot_system_file_list-669"><span class="linenos">669</span></a><span class="sd">        and filename</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-670"><a href="#SystemSetup.export_flake_pilot_system_file_list-670"><span class="linenos">670</span></a>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-671"><a href="#SystemSetup.export_flake_pilot_system_file_list-671"><span class="linenos">671</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-672"><a href="#SystemSetup.export_flake_pilot_system_file_list-672"><span class="linenos">672</span></a><span class="sd">        :param str file_name: file name</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-673"><a href="#SystemSetup.export_flake_pilot_system_file_list-673"><span class="linenos">673</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-674"><a href="#SystemSetup.export_flake_pilot_system_file_list-674"><span class="linenos">674</span></a>        <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-675"><a href="#SystemSetup.export_flake_pilot_system_file_list-675"><span class="linenos">675</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-676"><a href="#SystemSetup.export_flake_pilot_system_file_list-676"><span class="linenos">676</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-677"><a href="#SystemSetup.export_flake_pilot_system_file_list-677"><span class="linenos">677</span></a>        <span class="n">result_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-678"><a href="#SystemSetup.export_flake_pilot_system_file_list-678"><span class="linenos">678</span></a>        <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-679"><a href="#SystemSetup.export_flake_pilot_system_file_list-679"><span class="linenos">679</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_flake_pilot_system_file_list</span><span class="p">(</span><span class="n">result_file</span><span class="p">)</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-680"><a href="#SystemSetup.export_flake_pilot_system_file_list-680"><span class="linenos">680</span></a>            <span class="k">return</span> <span class="n">result_file</span>
</span><span id="SystemSetup.export_flake_pilot_system_file_list-681"><a href="#SystemSetup.export_flake_pilot_system_file_list-681"><span class="linenos">681</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span></pre></div>


            <div class="docstring"><p>Export image package file list to the target_dir
and filename</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str target_dir</strong>:  path name</li>
<li><strong>str file_name</strong>:  file name</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.export_package_list" class="classattr">
                                        <input id="SystemSetup.export_package_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">export_package_list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.export_package_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.export_package_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.export_package_list-683"><a href="#SystemSetup.export_package_list-683"><span class="linenos">683</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_package_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SystemSetup.export_package_list-684"><a href="#SystemSetup.export_package_list-684"><span class="linenos">684</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.export_package_list-685"><a href="#SystemSetup.export_package_list-685"><span class="linenos">685</span></a><span class="sd">        Export image package list as metadata reference</span>
</span><span id="SystemSetup.export_package_list-686"><a href="#SystemSetup.export_package_list-686"><span class="linenos">686</span></a><span class="sd">        used by the open buildservice</span>
</span><span id="SystemSetup.export_package_list-687"><a href="#SystemSetup.export_package_list-687"><span class="linenos">687</span></a>
</span><span id="SystemSetup.export_package_list-688"><a href="#SystemSetup.export_package_list-688"><span class="linenos">688</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="SystemSetup.export_package_list-689"><a href="#SystemSetup.export_package_list-689"><span class="linenos">689</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.export_package_list-690"><a href="#SystemSetup.export_package_list-690"><span class="linenos">690</span></a>        <span class="n">image_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_image_version</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;unspecified&#39;</span>
</span><span id="SystemSetup.export_package_list-691"><a href="#SystemSetup.export_package_list-691"><span class="linenos">691</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup.export_package_list-692"><a href="#SystemSetup.export_package_list-692"><span class="linenos">692</span></a>            <span class="p">[</span>
</span><span id="SystemSetup.export_package_list-693"><a href="#SystemSetup.export_package_list-693"><span class="linenos">693</span></a>                <span class="n">target_dir</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.export_package_list-694"><a href="#SystemSetup.export_package_list-694"><span class="linenos">694</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
</span><span id="SystemSetup.export_package_list-695"><a href="#SystemSetup.export_package_list-695"><span class="linenos">695</span></a>                <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span>
</span><span id="SystemSetup.export_package_list-696"><a href="#SystemSetup.export_package_list-696"><span class="linenos">696</span></a>                <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">image_version</span><span class="p">,</span>
</span><span id="SystemSetup.export_package_list-697"><a href="#SystemSetup.export_package_list-697"><span class="linenos">697</span></a>                <span class="s1">&#39;.packages&#39;</span>
</span><span id="SystemSetup.export_package_list-698"><a href="#SystemSetup.export_package_list-698"><span class="linenos">698</span></a>            <span class="p">]</span>
</span><span id="SystemSetup.export_package_list-699"><a href="#SystemSetup.export_package_list-699"><span class="linenos">699</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.export_package_list-700"><a href="#SystemSetup.export_package_list-700"><span class="linenos">700</span></a>        <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="SystemSetup.export_package_list-701"><a href="#SystemSetup.export_package_list-701"><span class="linenos">701</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="SystemSetup.export_package_list-702"><a href="#SystemSetup.export_package_list-702"><span class="linenos">702</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.export_package_list-703"><a href="#SystemSetup.export_package_list-703"><span class="linenos">703</span></a>        <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.export_package_list-704"><a href="#SystemSetup.export_package_list-704"><span class="linenos">704</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_package_list</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup.export_package_list-705"><a href="#SystemSetup.export_package_list-705"><span class="linenos">705</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup.export_package_list-706"><a href="#SystemSetup.export_package_list-706"><span class="linenos">706</span></a>        <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;dpkg&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.export_package_list-707"><a href="#SystemSetup.export_package_list-707"><span class="linenos">707</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_deb_package_list</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup.export_package_list-708"><a href="#SystemSetup.export_package_list-708"><span class="linenos">708</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup.export_package_list-709"><a href="#SystemSetup.export_package_list-709"><span class="linenos">709</span></a>        <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;pacman&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.export_package_list-710"><a href="#SystemSetup.export_package_list-710"><span class="linenos">710</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_pacman_package_list</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup.export_package_list-711"><a href="#SystemSetup.export_package_list-711"><span class="linenos">711</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup.export_package_list-712"><a href="#SystemSetup.export_package_list-712"><span class="linenos">712</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span></pre></div>


            <div class="docstring"><p>Export image package list as metadata reference
used by the open buildservice</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str target_dir</strong>:  path name</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.export_package_changes" class="classattr">
                                        <input id="SystemSetup.export_package_changes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">export_package_changes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.export_package_changes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.export_package_changes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.export_package_changes-714"><a href="#SystemSetup.export_package_changes-714"><span class="linenos">714</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_package_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SystemSetup.export_package_changes-715"><a href="#SystemSetup.export_package_changes-715"><span class="linenos">715</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.export_package_changes-716"><a href="#SystemSetup.export_package_changes-716"><span class="linenos">716</span></a><span class="sd">        Export image package changelog for comparision of</span>
</span><span id="SystemSetup.export_package_changes-717"><a href="#SystemSetup.export_package_changes-717"><span class="linenos">717</span></a><span class="sd">        actual changes of the installed packages</span>
</span><span id="SystemSetup.export_package_changes-718"><a href="#SystemSetup.export_package_changes-718"><span class="linenos">718</span></a>
</span><span id="SystemSetup.export_package_changes-719"><a href="#SystemSetup.export_package_changes-719"><span class="linenos">719</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="SystemSetup.export_package_changes-720"><a href="#SystemSetup.export_package_changes-720"><span class="linenos">720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.export_package_changes-721"><a href="#SystemSetup.export_package_changes-721"><span class="linenos">721</span></a>        <span class="n">image_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_image_version</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;unspecified&#39;</span>
</span><span id="SystemSetup.export_package_changes-722"><a href="#SystemSetup.export_package_changes-722"><span class="linenos">722</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_config</span><span class="o">.</span><span class="n">get_package_changes</span><span class="p">():</span>
</span><span id="SystemSetup.export_package_changes-723"><a href="#SystemSetup.export_package_changes-723"><span class="linenos">723</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup.export_package_changes-724"><a href="#SystemSetup.export_package_changes-724"><span class="linenos">724</span></a>                <span class="p">[</span>
</span><span id="SystemSetup.export_package_changes-725"><a href="#SystemSetup.export_package_changes-725"><span class="linenos">725</span></a>                    <span class="n">target_dir</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.export_package_changes-726"><a href="#SystemSetup.export_package_changes-726"><span class="linenos">726</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
</span><span id="SystemSetup.export_package_changes-727"><a href="#SystemSetup.export_package_changes-727"><span class="linenos">727</span></a>                    <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span>
</span><span id="SystemSetup.export_package_changes-728"><a href="#SystemSetup.export_package_changes-728"><span class="linenos">728</span></a>                    <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">image_version</span><span class="p">,</span>
</span><span id="SystemSetup.export_package_changes-729"><a href="#SystemSetup.export_package_changes-729"><span class="linenos">729</span></a>                    <span class="s1">&#39;.changes&#39;</span>
</span><span id="SystemSetup.export_package_changes-730"><a href="#SystemSetup.export_package_changes-730"><span class="linenos">730</span></a>                <span class="p">]</span>
</span><span id="SystemSetup.export_package_changes-731"><a href="#SystemSetup.export_package_changes-731"><span class="linenos">731</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.export_package_changes-732"><a href="#SystemSetup.export_package_changes-732"><span class="linenos">732</span></a>            <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="SystemSetup.export_package_changes-733"><a href="#SystemSetup.export_package_changes-733"><span class="linenos">733</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="SystemSetup.export_package_changes-734"><a href="#SystemSetup.export_package_changes-734"><span class="linenos">734</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.export_package_changes-735"><a href="#SystemSetup.export_package_changes-735"><span class="linenos">735</span></a>            <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.export_package_changes-736"><a href="#SystemSetup.export_package_changes-736"><span class="linenos">736</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_package_changes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup.export_package_changes-737"><a href="#SystemSetup.export_package_changes-737"><span class="linenos">737</span></a>                <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup.export_package_changes-738"><a href="#SystemSetup.export_package_changes-738"><span class="linenos">738</span></a>            <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;dpkg&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.export_package_changes-739"><a href="#SystemSetup.export_package_changes-739"><span class="linenos">739</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_export_deb_package_changes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup.export_package_changes-740"><a href="#SystemSetup.export_package_changes-740"><span class="linenos">740</span></a>                <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup.export_package_changes-741"><a href="#SystemSetup.export_package_changes-741"><span class="linenos">741</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span></pre></div>


            <div class="docstring"><p>Export image package changelog for comparision of
actual changes of the installed packages</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str target_dir</strong>:  path name</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.export_package_verification" class="classattr">
                                        <input id="SystemSetup.export_package_verification-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">export_package_verification</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.export_package_verification-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.export_package_verification"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.export_package_verification-743"><a href="#SystemSetup.export_package_verification-743"><span class="linenos">743</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_package_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SystemSetup.export_package_verification-744"><a href="#SystemSetup.export_package_verification-744"><span class="linenos">744</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.export_package_verification-745"><a href="#SystemSetup.export_package_verification-745"><span class="linenos">745</span></a><span class="sd">        Export package verification result as metadata reference</span>
</span><span id="SystemSetup.export_package_verification-746"><a href="#SystemSetup.export_package_verification-746"><span class="linenos">746</span></a><span class="sd">        used by the open buildservice</span>
</span><span id="SystemSetup.export_package_verification-747"><a href="#SystemSetup.export_package_verification-747"><span class="linenos">747</span></a>
</span><span id="SystemSetup.export_package_verification-748"><a href="#SystemSetup.export_package_verification-748"><span class="linenos">748</span></a><span class="sd">        :param str target_dir: path name</span>
</span><span id="SystemSetup.export_package_verification-749"><a href="#SystemSetup.export_package_verification-749"><span class="linenos">749</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.export_package_verification-750"><a href="#SystemSetup.export_package_verification-750"><span class="linenos">750</span></a>        <span class="n">image_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_image_version</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;unspecified&#39;</span>
</span><span id="SystemSetup.export_package_verification-751"><a href="#SystemSetup.export_package_verification-751"><span class="linenos">751</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SystemSetup.export_package_verification-752"><a href="#SystemSetup.export_package_verification-752"><span class="linenos">752</span></a>            <span class="p">[</span>
</span><span id="SystemSetup.export_package_verification-753"><a href="#SystemSetup.export_package_verification-753"><span class="linenos">753</span></a>                <span class="n">target_dir</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.export_package_verification-754"><a href="#SystemSetup.export_package_verification-754"><span class="linenos">754</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">xml_data</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
</span><span id="SystemSetup.export_package_verification-755"><a href="#SystemSetup.export_package_verification-755"><span class="linenos">755</span></a>                <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span>
</span><span id="SystemSetup.export_package_verification-756"><a href="#SystemSetup.export_package_verification-756"><span class="linenos">756</span></a>                <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">image_version</span><span class="p">,</span>
</span><span id="SystemSetup.export_package_verification-757"><a href="#SystemSetup.export_package_verification-757"><span class="linenos">757</span></a>                <span class="s1">&#39;.verified&#39;</span>
</span><span id="SystemSetup.export_package_verification-758"><a href="#SystemSetup.export_package_verification-758"><span class="linenos">758</span></a>            <span class="p">]</span>
</span><span id="SystemSetup.export_package_verification-759"><a href="#SystemSetup.export_package_verification-759"><span class="linenos">759</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.export_package_verification-760"><a href="#SystemSetup.export_package_verification-760"><span class="linenos">760</span></a>        <span class="n">packager</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_default_packager_tool</span><span class="p">(</span>
</span><span id="SystemSetup.export_package_verification-761"><a href="#SystemSetup.export_package_verification-761"><span class="linenos">761</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">get_package_manager</span><span class="p">()</span>
</span><span id="SystemSetup.export_package_verification-762"><a href="#SystemSetup.export_package_verification-762"><span class="linenos">762</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.export_package_verification-763"><a href="#SystemSetup.export_package_verification-763"><span class="linenos">763</span></a>        <span class="k">if</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;rpm&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.export_package_verification-764"><a href="#SystemSetup.export_package_verification-764"><span class="linenos">764</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_rpm_package_verification</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup.export_package_verification-765"><a href="#SystemSetup.export_package_verification-765"><span class="linenos">765</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup.export_package_verification-766"><a href="#SystemSetup.export_package_verification-766"><span class="linenos">766</span></a>        <span class="k">elif</span> <span class="n">packager</span> <span class="o">==</span> <span class="s1">&#39;dpkg&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.export_package_verification-767"><a href="#SystemSetup.export_package_verification-767"><span class="linenos">767</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_export_deb_package_verification</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="SystemSetup.export_package_verification-768"><a href="#SystemSetup.export_package_verification-768"><span class="linenos">768</span></a>            <span class="k">return</span> <span class="n">filename</span>
</span><span id="SystemSetup.export_package_verification-769"><a href="#SystemSetup.export_package_verification-769"><span class="linenos">769</span></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</span></pre></div>


            <div class="docstring"><p>Export package verification result as metadata reference
used by the open buildservice</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str target_dir</strong>:  path name</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.call_disk_script" class="classattr">
                                        <input id="SystemSetup.call_disk_script-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">call_disk_script</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.call_disk_script-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.call_disk_script"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.call_disk_script-771"><a href="#SystemSetup.call_disk_script-771"><span class="linenos">771</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_disk_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.call_disk_script-772"><a href="#SystemSetup.call_disk_script-772"><span class="linenos">772</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_disk_script-773"><a href="#SystemSetup.call_disk_script-773"><span class="linenos">773</span></a><span class="sd">        Call disk.sh script chrooted</span>
</span><span id="SystemSetup.call_disk_script-774"><a href="#SystemSetup.call_disk_script-774"><span class="linenos">774</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_disk_script-775"><a href="#SystemSetup.call_disk_script-775"><span class="linenos">775</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup.call_disk_script-776"><a href="#SystemSetup.call_disk_script-776"><span class="linenos">776</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_DISK_SYNC_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup.call_disk_script-777"><a href="#SystemSetup.call_disk_script-777"><span class="linenos">777</span></a>            <span class="n">root_is_mountpoint</span><span class="o">=</span><span class="kc">True</span>
</span><span id="SystemSetup.call_disk_script-778"><a href="#SystemSetup.call_disk_script-778"><span class="linenos">778</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Call disk.sh script chrooted</p>
</div>


                            </div>
                            <div id="SystemSetup.call_pre_disk_script" class="classattr">
                                        <input id="SystemSetup.call_pre_disk_script-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">call_pre_disk_script</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.call_pre_disk_script-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.call_pre_disk_script"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.call_pre_disk_script-780"><a href="#SystemSetup.call_pre_disk_script-780"><span class="linenos">780</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_pre_disk_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.call_pre_disk_script-781"><a href="#SystemSetup.call_pre_disk_script-781"><span class="linenos">781</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_pre_disk_script-782"><a href="#SystemSetup.call_pre_disk_script-782"><span class="linenos">782</span></a><span class="sd">        Call pre_disk_sync.sh script chrooted</span>
</span><span id="SystemSetup.call_pre_disk_script-783"><a href="#SystemSetup.call_pre_disk_script-783"><span class="linenos">783</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_pre_disk_script-784"><a href="#SystemSetup.call_pre_disk_script-784"><span class="linenos">784</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup.call_pre_disk_script-785"><a href="#SystemSetup.call_pre_disk_script-785"><span class="linenos">785</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">PRE_DISK_SYNC_SCRIPT</span>
</span><span id="SystemSetup.call_pre_disk_script-786"><a href="#SystemSetup.call_pre_disk_script-786"><span class="linenos">786</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Call pre_disk_sync.sh script chrooted</p>
</div>


                            </div>
                            <div id="SystemSetup.call_post_bootstrap_script" class="classattr">
                                        <input id="SystemSetup.call_post_bootstrap_script-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">call_post_bootstrap_script</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.call_post_bootstrap_script-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.call_post_bootstrap_script"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.call_post_bootstrap_script-788"><a href="#SystemSetup.call_post_bootstrap_script-788"><span class="linenos">788</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_post_bootstrap_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.call_post_bootstrap_script-789"><a href="#SystemSetup.call_post_bootstrap_script-789"><span class="linenos">789</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_post_bootstrap_script-790"><a href="#SystemSetup.call_post_bootstrap_script-790"><span class="linenos">790</span></a><span class="sd">        Call post_bootstrap.sh script chrooted</span>
</span><span id="SystemSetup.call_post_bootstrap_script-791"><a href="#SystemSetup.call_post_bootstrap_script-791"><span class="linenos">791</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_post_bootstrap_script-792"><a href="#SystemSetup.call_post_bootstrap_script-792"><span class="linenos">792</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup.call_post_bootstrap_script-793"><a href="#SystemSetup.call_post_bootstrap_script-793"><span class="linenos">793</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_BOOTSTRAP_SCRIPT</span>
</span><span id="SystemSetup.call_post_bootstrap_script-794"><a href="#SystemSetup.call_post_bootstrap_script-794"><span class="linenos">794</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Call post_bootstrap.sh script chrooted</p>
</div>


                            </div>
                            <div id="SystemSetup.call_config_script" class="classattr">
                                        <input id="SystemSetup.call_config_script-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">call_config_script</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.call_config_script-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.call_config_script"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.call_config_script-796"><a href="#SystemSetup.call_config_script-796"><span class="linenos">796</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_config_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.call_config_script-797"><a href="#SystemSetup.call_config_script-797"><span class="linenos">797</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_config_script-798"><a href="#SystemSetup.call_config_script-798"><span class="linenos">798</span></a><span class="sd">        Call config.sh script chrooted</span>
</span><span id="SystemSetup.call_config_script-799"><a href="#SystemSetup.call_config_script-799"><span class="linenos">799</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_config_script-800"><a href="#SystemSetup.call_config_script-800"><span class="linenos">800</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup.call_config_script-801"><a href="#SystemSetup.call_config_script-801"><span class="linenos">801</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_SCRIPT</span>
</span><span id="SystemSetup.call_config_script-802"><a href="#SystemSetup.call_config_script-802"><span class="linenos">802</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Call config.sh script chrooted</p>
</div>


                            </div>
                            <div id="SystemSetup.call_config_overlay_script" class="classattr">
                                        <input id="SystemSetup.call_config_overlay_script-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">call_config_overlay_script</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.call_config_overlay_script-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.call_config_overlay_script"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.call_config_overlay_script-804"><a href="#SystemSetup.call_config_overlay_script-804"><span class="linenos">804</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_config_overlay_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.call_config_overlay_script-805"><a href="#SystemSetup.call_config_overlay_script-805"><span class="linenos">805</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_config_overlay_script-806"><a href="#SystemSetup.call_config_overlay_script-806"><span class="linenos">806</span></a><span class="sd">        Call config-overlay.sh script chrooted</span>
</span><span id="SystemSetup.call_config_overlay_script-807"><a href="#SystemSetup.call_config_overlay_script-807"><span class="linenos">807</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_config_overlay_script-808"><a href="#SystemSetup.call_config_overlay_script-808"><span class="linenos">808</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup.call_config_overlay_script-809"><a href="#SystemSetup.call_config_overlay_script-809"><span class="linenos">809</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">POST_PREPARE_OVERLAY_SCRIPT</span>
</span><span id="SystemSetup.call_config_overlay_script-810"><a href="#SystemSetup.call_config_overlay_script-810"><span class="linenos">810</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Call config-overlay.sh script chrooted</p>
</div>


                            </div>
                            <div id="SystemSetup.call_config_host_overlay_script" class="classattr">
                                        <input id="SystemSetup.call_config_host_overlay_script-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">call_config_host_overlay_script</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.call_config_host_overlay_script-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.call_config_host_overlay_script"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.call_config_host_overlay_script-812"><a href="#SystemSetup.call_config_host_overlay_script-812"><span class="linenos">812</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_config_host_overlay_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.call_config_host_overlay_script-813"><a href="#SystemSetup.call_config_host_overlay_script-813"><span class="linenos">813</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_config_host_overlay_script-814"><a href="#SystemSetup.call_config_host_overlay_script-814"><span class="linenos">814</span></a><span class="sd">        Call config-host-overlay.sh script _NON_ chrooted</span>
</span><span id="SystemSetup.call_config_host_overlay_script-815"><a href="#SystemSetup.call_config_host_overlay_script-815"><span class="linenos">815</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_config_host_overlay_script-816"><a href="#SystemSetup.call_config_host_overlay_script-816"><span class="linenos">816</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script_no_chroot</span><span class="p">(</span>
</span><span id="SystemSetup.call_config_host_overlay_script-817"><a href="#SystemSetup.call_config_host_overlay_script-817"><span class="linenos">817</span></a>            <span class="n">name</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">POST_HOST_PREPARE_OVERLAY_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup.call_config_host_overlay_script-818"><a href="#SystemSetup.call_config_host_overlay_script-818"><span class="linenos">818</span></a>            <span class="n">option_list</span><span class="o">=</span><span class="p">[],</span>
</span><span id="SystemSetup.call_config_host_overlay_script-819"><a href="#SystemSetup.call_config_host_overlay_script-819"><span class="linenos">819</span></a>            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span>
</span><span id="SystemSetup.call_config_host_overlay_script-820"><a href="#SystemSetup.call_config_host_overlay_script-820"><span class="linenos">820</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Call config-host-overlay.sh script _NON_ chrooted</p>
</div>


                            </div>
                            <div id="SystemSetup.call_image_script" class="classattr">
                                        <input id="SystemSetup.call_image_script-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">call_image_script</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.call_image_script-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.call_image_script"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.call_image_script-822"><a href="#SystemSetup.call_image_script-822"><span class="linenos">822</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_image_script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.call_image_script-823"><a href="#SystemSetup.call_image_script-823"><span class="linenos">823</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_image_script-824"><a href="#SystemSetup.call_image_script-824"><span class="linenos">824</span></a><span class="sd">        Call images.sh script chrooted</span>
</span><span id="SystemSetup.call_image_script-825"><a href="#SystemSetup.call_image_script-825"><span class="linenos">825</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_image_script-826"><a href="#SystemSetup.call_image_script-826"><span class="linenos">826</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup.call_image_script-827"><a href="#SystemSetup.call_image_script-827"><span class="linenos">827</span></a>            <span class="n">defaults</span><span class="o">.</span><span class="n">PRE_CREATE_SCRIPT</span>
</span><span id="SystemSetup.call_image_script-828"><a href="#SystemSetup.call_image_script-828"><span class="linenos">828</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Call images.sh script chrooted</p>
</div>


                            </div>
                            <div id="SystemSetup.call_edit_boot_config_script" class="classattr">
                                        <input id="SystemSetup.call_edit_boot_config_script-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">call_edit_boot_config_script</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">filesystem</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">boot_part_id</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.call_edit_boot_config_script-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.call_edit_boot_config_script"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.call_edit_boot_config_script-830"><a href="#SystemSetup.call_edit_boot_config_script-830"><span class="linenos">830</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_edit_boot_config_script</span><span class="p">(</span>
</span><span id="SystemSetup.call_edit_boot_config_script-831"><a href="#SystemSetup.call_edit_boot_config_script-831"><span class="linenos">831</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">filesystem</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">boot_part_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SystemSetup.call_edit_boot_config_script-832"><a href="#SystemSetup.call_edit_boot_config_script-832"><span class="linenos">832</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.call_edit_boot_config_script-833"><a href="#SystemSetup.call_edit_boot_config_script-833"><span class="linenos">833</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_edit_boot_config_script-834"><a href="#SystemSetup.call_edit_boot_config_script-834"><span class="linenos">834</span></a><span class="sd">        Call configured editbootconfig script _NON_ chrooted</span>
</span><span id="SystemSetup.call_edit_boot_config_script-835"><a href="#SystemSetup.call_edit_boot_config_script-835"><span class="linenos">835</span></a>
</span><span id="SystemSetup.call_edit_boot_config_script-836"><a href="#SystemSetup.call_edit_boot_config_script-836"><span class="linenos">836</span></a><span class="sd">        Pass the boot filesystem name and the partition number of</span>
</span><span id="SystemSetup.call_edit_boot_config_script-837"><a href="#SystemSetup.call_edit_boot_config_script-837"><span class="linenos">837</span></a><span class="sd">        the boot partition as parameters to the call</span>
</span><span id="SystemSetup.call_edit_boot_config_script-838"><a href="#SystemSetup.call_edit_boot_config_script-838"><span class="linenos">838</span></a>
</span><span id="SystemSetup.call_edit_boot_config_script-839"><a href="#SystemSetup.call_edit_boot_config_script-839"><span class="linenos">839</span></a><span class="sd">        :param str filesystem: boot filesystem name</span>
</span><span id="SystemSetup.call_edit_boot_config_script-840"><a href="#SystemSetup.call_edit_boot_config_script-840"><span class="linenos">840</span></a><span class="sd">        :param int boot_part_id: boot partition number</span>
</span><span id="SystemSetup.call_edit_boot_config_script-841"><a href="#SystemSetup.call_edit_boot_config_script-841"><span class="linenos">841</span></a><span class="sd">        :param str working_directory: directory name</span>
</span><span id="SystemSetup.call_edit_boot_config_script-842"><a href="#SystemSetup.call_edit_boot_config_script-842"><span class="linenos">842</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_edit_boot_config_script-843"><a href="#SystemSetup.call_edit_boot_config_script-843"><span class="linenos">843</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script_no_chroot</span><span class="p">(</span>
</span><span id="SystemSetup.call_edit_boot_config_script-844"><a href="#SystemSetup.call_edit_boot_config_script-844"><span class="linenos">844</span></a>            <span class="n">name</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">EDIT_BOOT_CONFIG_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup.call_edit_boot_config_script-845"><a href="#SystemSetup.call_edit_boot_config_script-845"><span class="linenos">845</span></a>            <span class="n">option_list</span><span class="o">=</span><span class="p">[</span><span class="n">filesystem</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">boot_part_id</span><span class="p">)],</span>
</span><span id="SystemSetup.call_edit_boot_config_script-846"><a href="#SystemSetup.call_edit_boot_config_script-846"><span class="linenos">846</span></a>            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span>
</span><span id="SystemSetup.call_edit_boot_config_script-847"><a href="#SystemSetup.call_edit_boot_config_script-847"><span class="linenos">847</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Call configured editbootconfig script _NON_ chrooted</p>

<p>Pass the boot filesystem name and the partition number of
the boot partition as parameters to the call</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str filesystem</strong>:  boot filesystem name</li>
<li><strong>int boot_part_id</strong>:  boot partition number</li>
<li><strong>str working_directory</strong>:  directory name</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.call_edit_boot_install_script" class="classattr">
                                        <input id="SystemSetup.call_edit_boot_install_script-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">call_edit_boot_install_script</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">diskname</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">boot_device_node</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.call_edit_boot_install_script-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.call_edit_boot_install_script"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.call_edit_boot_install_script-849"><a href="#SystemSetup.call_edit_boot_install_script-849"><span class="linenos">849</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call_edit_boot_install_script</span><span class="p">(</span>
</span><span id="SystemSetup.call_edit_boot_install_script-850"><a href="#SystemSetup.call_edit_boot_install_script-850"><span class="linenos">850</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">diskname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">boot_device_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SystemSetup.call_edit_boot_install_script-851"><a href="#SystemSetup.call_edit_boot_install_script-851"><span class="linenos">851</span></a>        <span class="n">working_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SystemSetup.call_edit_boot_install_script-852"><a href="#SystemSetup.call_edit_boot_install_script-852"><span class="linenos">852</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.call_edit_boot_install_script-853"><a href="#SystemSetup.call_edit_boot_install_script-853"><span class="linenos">853</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_edit_boot_install_script-854"><a href="#SystemSetup.call_edit_boot_install_script-854"><span class="linenos">854</span></a><span class="sd">        Call configured editbootinstall script _NON_ chrooted</span>
</span><span id="SystemSetup.call_edit_boot_install_script-855"><a href="#SystemSetup.call_edit_boot_install_script-855"><span class="linenos">855</span></a>
</span><span id="SystemSetup.call_edit_boot_install_script-856"><a href="#SystemSetup.call_edit_boot_install_script-856"><span class="linenos">856</span></a><span class="sd">        Pass the disk file name and the device node of the boot partition</span>
</span><span id="SystemSetup.call_edit_boot_install_script-857"><a href="#SystemSetup.call_edit_boot_install_script-857"><span class="linenos">857</span></a><span class="sd">        as parameters to the call</span>
</span><span id="SystemSetup.call_edit_boot_install_script-858"><a href="#SystemSetup.call_edit_boot_install_script-858"><span class="linenos">858</span></a>
</span><span id="SystemSetup.call_edit_boot_install_script-859"><a href="#SystemSetup.call_edit_boot_install_script-859"><span class="linenos">859</span></a><span class="sd">        :param str diskname: file path name</span>
</span><span id="SystemSetup.call_edit_boot_install_script-860"><a href="#SystemSetup.call_edit_boot_install_script-860"><span class="linenos">860</span></a><span class="sd">        :param str boot_device_node: boot device node name</span>
</span><span id="SystemSetup.call_edit_boot_install_script-861"><a href="#SystemSetup.call_edit_boot_install_script-861"><span class="linenos">861</span></a><span class="sd">        :param str working_directory: directory name</span>
</span><span id="SystemSetup.call_edit_boot_install_script-862"><a href="#SystemSetup.call_edit_boot_install_script-862"><span class="linenos">862</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.call_edit_boot_install_script-863"><a href="#SystemSetup.call_edit_boot_install_script-863"><span class="linenos">863</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_script_no_chroot</span><span class="p">(</span>
</span><span id="SystemSetup.call_edit_boot_install_script-864"><a href="#SystemSetup.call_edit_boot_install_script-864"><span class="linenos">864</span></a>            <span class="n">name</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">EDIT_BOOT_INSTALL_SCRIPT</span><span class="p">,</span>
</span><span id="SystemSetup.call_edit_boot_install_script-865"><a href="#SystemSetup.call_edit_boot_install_script-865"><span class="linenos">865</span></a>            <span class="n">option_list</span><span class="o">=</span><span class="p">[</span><span class="n">diskname</span><span class="p">,</span> <span class="n">boot_device_node</span><span class="p">],</span>
</span><span id="SystemSetup.call_edit_boot_install_script-866"><a href="#SystemSetup.call_edit_boot_install_script-866"><span class="linenos">866</span></a>            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span>
</span><span id="SystemSetup.call_edit_boot_install_script-867"><a href="#SystemSetup.call_edit_boot_install_script-867"><span class="linenos">867</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Call configured editbootinstall script _NON_ chrooted</p>

<p>Pass the disk file name and the device node of the boot partition
as parameters to the call</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str diskname</strong>:  file path name</li>
<li><strong>str boot_device_node</strong>:  boot device node name</li>
<li><strong>str working_directory</strong>:  directory name</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.create_system_files" class="classattr">
                                        <input id="SystemSetup.create_system_files-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_system_files</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.create_system_files-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.create_system_files"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.create_system_files-869"><a href="#SystemSetup.create_system_files-869"><span class="linenos">869</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_system_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.create_system_files-870"><a href="#SystemSetup.create_system_files-870"><span class="linenos">870</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.create_system_files-871"><a href="#SystemSetup.create_system_files-871"><span class="linenos">871</span></a><span class="sd">        Create file list of packages to be used by flake-pilot</span>
</span><span id="SystemSetup.create_system_files-872"><a href="#SystemSetup.create_system_files-872"><span class="linenos">872</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.create_system_files-873"><a href="#SystemSetup.create_system_files-873"><span class="linenos">873</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_provide_system_files</span><span class="p">():</span>
</span><span id="SystemSetup.create_system_files-874"><a href="#SystemSetup.create_system_files-874"><span class="linenos">874</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">export_flake_pilot_system_file_list</span><span class="p">(</span>
</span><span id="SystemSetup.create_system_files-875"><a href="#SystemSetup.create_system_files-875"><span class="linenos">875</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_system_files_name</span><span class="p">()</span>
</span><span id="SystemSetup.create_system_files-876"><a href="#SystemSetup.create_system_files-876"><span class="linenos">876</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create file list of packages to be used by flake-pilot</p>
</div>


                            </div>
                            <div id="SystemSetup.create_fstab" class="classattr">
                                        <input id="SystemSetup.create_fstab-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_fstab</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fstab</span><span class="p">:</span> <span class="n"><a href="../utils/fstab.html#Fstab">kiwi.utils.fstab.Fstab</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.create_fstab-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.create_fstab"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.create_fstab-878"><a href="#SystemSetup.create_fstab-878"><span class="linenos">878</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_fstab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fstab</span><span class="p">:</span> <span class="n">Fstab</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.create_fstab-879"><a href="#SystemSetup.create_fstab-879"><span class="linenos">879</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.create_fstab-880"><a href="#SystemSetup.create_fstab-880"><span class="linenos">880</span></a><span class="sd">        Create etc/fstab from given Fstab object</span>
</span><span id="SystemSetup.create_fstab-881"><a href="#SystemSetup.create_fstab-881"><span class="linenos">881</span></a>
</span><span id="SystemSetup.create_fstab-882"><a href="#SystemSetup.create_fstab-882"><span class="linenos">882</span></a><span class="sd">        Custom fstab modifications are possible and handled</span>
</span><span id="SystemSetup.create_fstab-883"><a href="#SystemSetup.create_fstab-883"><span class="linenos">883</span></a><span class="sd">        in the following order:</span>
</span><span id="SystemSetup.create_fstab-884"><a href="#SystemSetup.create_fstab-884"><span class="linenos">884</span></a>
</span><span id="SystemSetup.create_fstab-885"><a href="#SystemSetup.create_fstab-885"><span class="linenos">885</span></a><span class="sd">        1. Look for an optional fstab.append file which allows</span>
</span><span id="SystemSetup.create_fstab-886"><a href="#SystemSetup.create_fstab-886"><span class="linenos">886</span></a><span class="sd">           to append custom fstab entries to the final fstab. Once</span>
</span><span id="SystemSetup.create_fstab-887"><a href="#SystemSetup.create_fstab-887"><span class="linenos">887</span></a><span class="sd">           embedded the fstab.append file will be deleted</span>
</span><span id="SystemSetup.create_fstab-888"><a href="#SystemSetup.create_fstab-888"><span class="linenos">888</span></a>
</span><span id="SystemSetup.create_fstab-889"><a href="#SystemSetup.create_fstab-889"><span class="linenos">889</span></a><span class="sd">        2. Look for an optional fstab.patch file which allows</span>
</span><span id="SystemSetup.create_fstab-890"><a href="#SystemSetup.create_fstab-890"><span class="linenos">890</span></a><span class="sd">           to patch the current contents of the fstab file with</span>
</span><span id="SystemSetup.create_fstab-891"><a href="#SystemSetup.create_fstab-891"><span class="linenos">891</span></a><span class="sd">           a given patch file. Once patched the fstab.patch file will</span>
</span><span id="SystemSetup.create_fstab-892"><a href="#SystemSetup.create_fstab-892"><span class="linenos">892</span></a><span class="sd">           be deleted</span>
</span><span id="SystemSetup.create_fstab-893"><a href="#SystemSetup.create_fstab-893"><span class="linenos">893</span></a>
</span><span id="SystemSetup.create_fstab-894"><a href="#SystemSetup.create_fstab-894"><span class="linenos">894</span></a><span class="sd">        3. Look for an optional fstab.script file which is called</span>
</span><span id="SystemSetup.create_fstab-895"><a href="#SystemSetup.create_fstab-895"><span class="linenos">895</span></a><span class="sd">           chrooted for the purpose of updating the fstab file as</span>
</span><span id="SystemSetup.create_fstab-896"><a href="#SystemSetup.create_fstab-896"><span class="linenos">896</span></a><span class="sd">           appropriate. Note: There is no validation in place that</span>
</span><span id="SystemSetup.create_fstab-897"><a href="#SystemSetup.create_fstab-897"><span class="linenos">897</span></a><span class="sd">           checks if the script actually handles fstab or any other</span>
</span><span id="SystemSetup.create_fstab-898"><a href="#SystemSetup.create_fstab-898"><span class="linenos">898</span></a><span class="sd">           file in the image rootfs. Once called the fstab.script</span>
</span><span id="SystemSetup.create_fstab-899"><a href="#SystemSetup.create_fstab-899"><span class="linenos">899</span></a><span class="sd">           file will be deleted</span>
</span><span id="SystemSetup.create_fstab-900"><a href="#SystemSetup.create_fstab-900"><span class="linenos">900</span></a>
</span><span id="SystemSetup.create_fstab-901"><a href="#SystemSetup.create_fstab-901"><span class="linenos">901</span></a><span class="sd">        :param object fstab: instance of Fstab</span>
</span><span id="SystemSetup.create_fstab-902"><a href="#SystemSetup.create_fstab-902"><span class="linenos">902</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.create_fstab-903"><a href="#SystemSetup.create_fstab-903"><span class="linenos">903</span></a>        <span class="n">fstab_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab&#39;</span>
</span><span id="SystemSetup.create_fstab-904"><a href="#SystemSetup.create_fstab-904"><span class="linenos">904</span></a>        <span class="n">fstab_append_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab.append&#39;</span>
</span><span id="SystemSetup.create_fstab-905"><a href="#SystemSetup.create_fstab-905"><span class="linenos">905</span></a>        <span class="n">fstab_patch_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab.patch&#39;</span>
</span><span id="SystemSetup.create_fstab-906"><a href="#SystemSetup.create_fstab-906"><span class="linenos">906</span></a>        <span class="n">fstab_script_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/fstab.script&#39;</span>
</span><span id="SystemSetup.create_fstab-907"><a href="#SystemSetup.create_fstab-907"><span class="linenos">907</span></a>
</span><span id="SystemSetup.create_fstab-908"><a href="#SystemSetup.create_fstab-908"><span class="linenos">908</span></a>        <span class="n">fstab</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">)</span>
</span><span id="SystemSetup.create_fstab-909"><a href="#SystemSetup.create_fstab-909"><span class="linenos">909</span></a>
</span><span id="SystemSetup.create_fstab-910"><a href="#SystemSetup.create_fstab-910"><span class="linenos">910</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fstab_append_file</span><span class="p">):</span>
</span><span id="SystemSetup.create_fstab-911"><a href="#SystemSetup.create_fstab-911"><span class="linenos">911</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fstab_io</span><span class="p">:</span>
</span><span id="SystemSetup.create_fstab-912"><a href="#SystemSetup.create_fstab-912"><span class="linenos">912</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fstab_append_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">append</span><span class="p">:</span>
</span><span id="SystemSetup.create_fstab-913"><a href="#SystemSetup.create_fstab-913"><span class="linenos">913</span></a>                    <span class="n">fstab_io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">append</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span id="SystemSetup.create_fstab-914"><a href="#SystemSetup.create_fstab-914"><span class="linenos">914</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">fstab_append_file</span><span class="p">)</span>
</span><span id="SystemSetup.create_fstab-915"><a href="#SystemSetup.create_fstab-915"><span class="linenos">915</span></a>
</span><span id="SystemSetup.create_fstab-916"><a href="#SystemSetup.create_fstab-916"><span class="linenos">916</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fstab_patch_file</span><span class="p">):</span>
</span><span id="SystemSetup.create_fstab-917"><a href="#SystemSetup.create_fstab-917"><span class="linenos">917</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup.create_fstab-918"><a href="#SystemSetup.create_fstab-918"><span class="linenos">918</span></a>                <span class="p">[</span><span class="s1">&#39;patch&#39;</span><span class="p">,</span> <span class="n">fstab_file</span><span class="p">,</span> <span class="n">fstab_patch_file</span><span class="p">]</span>
</span><span id="SystemSetup.create_fstab-919"><a href="#SystemSetup.create_fstab-919"><span class="linenos">919</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.create_fstab-920"><a href="#SystemSetup.create_fstab-920"><span class="linenos">920</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">fstab_patch_file</span><span class="p">)</span>
</span><span id="SystemSetup.create_fstab-921"><a href="#SystemSetup.create_fstab-921"><span class="linenos">921</span></a>
</span><span id="SystemSetup.create_fstab-922"><a href="#SystemSetup.create_fstab-922"><span class="linenos">922</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fstab_script_file</span><span class="p">):</span>
</span><span id="SystemSetup.create_fstab-923"><a href="#SystemSetup.create_fstab-923"><span class="linenos">923</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_call_script</span><span class="p">(</span>
</span><span id="SystemSetup.create_fstab-924"><a href="#SystemSetup.create_fstab-924"><span class="linenos">924</span></a>                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;etc/fstab.script&#39;</span><span class="p">,</span> <span class="n">path_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
</span><span id="SystemSetup.create_fstab-925"><a href="#SystemSetup.create_fstab-925"><span class="linenos">925</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.create_fstab-926"><a href="#SystemSetup.create_fstab-926"><span class="linenos">926</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">fstab_script_file</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create etc/fstab from given Fstab object</p>

<p>Custom fstab modifications are possible and handled
in the following order:</p>

<ol>
<li><p>Look for an optional fstab.append file which allows
to append custom fstab entries to the final fstab. Once
embedded the fstab.append file will be deleted</p></li>
<li><p>Look for an optional fstab.patch file which allows
to patch the current contents of the fstab file with
a given patch file. Once patched the fstab.patch file will
be deleted</p></li>
<li><p>Look for an optional fstab.script file which is called
chrooted for the purpose of updating the fstab file as
appropriate. Note: There is no validation in place that
checks if the script actually handles fstab or any other
file in the image rootfs. Once called the fstab.script
file will be deleted</p></li>
</ol>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>object fstab</strong>:  instance of Fstab</li>
</ul>
</div>


                            </div>
                            <div id="SystemSetup.create_init_link_from_linuxrc" class="classattr">
                                        <input id="SystemSetup.create_init_link_from_linuxrc-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_init_link_from_linuxrc</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.create_init_link_from_linuxrc-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.create_init_link_from_linuxrc"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.create_init_link_from_linuxrc-928"><a href="#SystemSetup.create_init_link_from_linuxrc-928"><span class="linenos">928</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_init_link_from_linuxrc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.create_init_link_from_linuxrc-929"><a href="#SystemSetup.create_init_link_from_linuxrc-929"><span class="linenos">929</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.create_init_link_from_linuxrc-930"><a href="#SystemSetup.create_init_link_from_linuxrc-930"><span class="linenos">930</span></a><span class="sd">        kiwi boot images provides the linuxrc script, however the kernel</span>
</span><span id="SystemSetup.create_init_link_from_linuxrc-931"><a href="#SystemSetup.create_init_link_from_linuxrc-931"><span class="linenos">931</span></a><span class="sd">        also expects an init executable to be present. This method creates</span>
</span><span id="SystemSetup.create_init_link_from_linuxrc-932"><a href="#SystemSetup.create_init_link_from_linuxrc-932"><span class="linenos">932</span></a><span class="sd">        a hard link to the linuxrc file</span>
</span><span id="SystemSetup.create_init_link_from_linuxrc-933"><a href="#SystemSetup.create_init_link_from_linuxrc-933"><span class="linenos">933</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.create_init_link_from_linuxrc-934"><a href="#SystemSetup.create_init_link_from_linuxrc-934"><span class="linenos">934</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup.create_init_link_from_linuxrc-935"><a href="#SystemSetup.create_init_link_from_linuxrc-935"><span class="linenos">935</span></a>            <span class="p">[</span><span class="s1">&#39;ln&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/linuxrc&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/init&#39;</span><span class="p">]</span>
</span><span id="SystemSetup.create_init_link_from_linuxrc-936"><a href="#SystemSetup.create_init_link_from_linuxrc-936"><span class="linenos">936</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>kiwi boot images provides the linuxrc script, however the kernel
also expects an init executable to be present. This method creates
a hard link to the linuxrc file</p>
</div>


                            </div>
                            <div id="SystemSetup.create_recovery_archive" class="classattr">
                                        <input id="SystemSetup.create_recovery_archive-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_recovery_archive</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="SystemSetup.create_recovery_archive-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SystemSetup.create_recovery_archive"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SystemSetup.create_recovery_archive-938"><a href="#SystemSetup.create_recovery_archive-938"><span class="linenos"> 938</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_recovery_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SystemSetup.create_recovery_archive-939"><a href="#SystemSetup.create_recovery_archive-939"><span class="linenos"> 939</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SystemSetup.create_recovery_archive-940"><a href="#SystemSetup.create_recovery_archive-940"><span class="linenos"> 940</span></a><span class="sd">        Create a compressed recovery archive from the root tree</span>
</span><span id="SystemSetup.create_recovery_archive-941"><a href="#SystemSetup.create_recovery_archive-941"><span class="linenos"> 941</span></a><span class="sd">        for use with kiwi&#39;s recvoery system. The method creates</span>
</span><span id="SystemSetup.create_recovery_archive-942"><a href="#SystemSetup.create_recovery_archive-942"><span class="linenos"> 942</span></a><span class="sd">        additional data into the image root filesystem which is</span>
</span><span id="SystemSetup.create_recovery_archive-943"><a href="#SystemSetup.create_recovery_archive-943"><span class="linenos"> 943</span></a><span class="sd">        deleted prior to the creation of a new recovery data set</span>
</span><span id="SystemSetup.create_recovery_archive-944"><a href="#SystemSetup.create_recovery_archive-944"><span class="linenos"> 944</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SystemSetup.create_recovery_archive-945"><a href="#SystemSetup.create_recovery_archive-945"><span class="linenos"> 945</span></a>        <span class="c1"># cleanup</span>
</span><span id="SystemSetup.create_recovery_archive-946"><a href="#SystemSetup.create_recovery_archive-946"><span class="linenos"> 946</span></a>        <span class="n">bash_comand</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SystemSetup.create_recovery_archive-947"><a href="#SystemSetup.create_recovery_archive-947"><span class="linenos"> 947</span></a>            <span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.*&#39;</span>
</span><span id="SystemSetup.create_recovery_archive-948"><a href="#SystemSetup.create_recovery_archive-948"><span class="linenos"> 948</span></a>        <span class="p">]</span>
</span><span id="SystemSetup.create_recovery_archive-949"><a href="#SystemSetup.create_recovery_archive-949"><span class="linenos"> 949</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bash_comand</span><span class="p">)])</span>
</span><span id="SystemSetup.create_recovery_archive-950"><a href="#SystemSetup.create_recovery_archive-950"><span class="linenos"> 950</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span><span class="p">[</span><span class="s1">&#39;recovery&#39;</span><span class="p">]:</span>
</span><span id="SystemSetup.create_recovery_archive-951"><a href="#SystemSetup.create_recovery_archive-951"><span class="linenos"> 951</span></a>            <span class="k">return</span>
</span><span id="SystemSetup.create_recovery_archive-952"><a href="#SystemSetup.create_recovery_archive-952"><span class="linenos"> 952</span></a>        <span class="c1"># recovery.tar</span>
</span><span id="SystemSetup.create_recovery_archive-953"><a href="#SystemSetup.create_recovery_archive-953"><span class="linenos"> 953</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating recovery tar archive&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-954"><a href="#SystemSetup.create_recovery_archive-954"><span class="linenos"> 954</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="SystemSetup.create_recovery_archive-955"><a href="#SystemSetup.create_recovery_archive-955"><span class="linenos"> 955</span></a>            <span class="s1">&#39;archive_name&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.create_recovery_archive-956"><a href="#SystemSetup.create_recovery_archive-956"><span class="linenos"> 956</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.create_recovery_archive-957"><a href="#SystemSetup.create_recovery_archive-957"><span class="linenos"> 957</span></a>            <span class="s1">&#39;archive_filecount&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.create_recovery_archive-958"><a href="#SystemSetup.create_recovery_archive-958"><span class="linenos"> 958</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar.files&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.create_recovery_archive-959"><a href="#SystemSetup.create_recovery_archive-959"><span class="linenos"> 959</span></a>            <span class="s1">&#39;archive_size&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.create_recovery_archive-960"><a href="#SystemSetup.create_recovery_archive-960"><span class="linenos"> 960</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar.size&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.create_recovery_archive-961"><a href="#SystemSetup.create_recovery_archive-961"><span class="linenos"> 961</span></a>            <span class="s1">&#39;partition_size&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.create_recovery_archive-962"><a href="#SystemSetup.create_recovery_archive-962"><span class="linenos"> 962</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.partition.size&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.create_recovery_archive-963"><a href="#SystemSetup.create_recovery_archive-963"><span class="linenos"> 963</span></a>            <span class="s1">&#39;partition_filesystem&#39;</span><span class="p">:</span>
</span><span id="SystemSetup.create_recovery_archive-964"><a href="#SystemSetup.create_recovery_archive-964"><span class="linenos"> 964</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar.filesystem&#39;</span>
</span><span id="SystemSetup.create_recovery_archive-965"><a href="#SystemSetup.create_recovery_archive-965"><span class="linenos"> 965</span></a>        <span class="p">}</span>
</span><span id="SystemSetup.create_recovery_archive-966"><a href="#SystemSetup.create_recovery_archive-966"><span class="linenos"> 966</span></a>        <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
</span><span id="SystemSetup.create_recovery_archive-967"><a href="#SystemSetup.create_recovery_archive-967"><span class="linenos"> 967</span></a>        <span class="n">archive</span> <span class="o">=</span> <span class="n">ArchiveTar</span><span class="p">(</span>
</span><span id="SystemSetup.create_recovery_archive-968"><a href="#SystemSetup.create_recovery_archive-968"><span class="linenos"> 968</span></a>            <span class="n">filename</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">],</span>
</span><span id="SystemSetup.create_recovery_archive-969"><a href="#SystemSetup.create_recovery_archive-969"><span class="linenos"> 969</span></a>            <span class="n">create_from_file_list</span><span class="o">=</span><span class="kc">False</span>
</span><span id="SystemSetup.create_recovery_archive-970"><a href="#SystemSetup.create_recovery_archive-970"><span class="linenos"> 970</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-971"><a href="#SystemSetup.create_recovery_archive-971"><span class="linenos"> 971</span></a>        <span class="n">archive</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="SystemSetup.create_recovery_archive-972"><a href="#SystemSetup.create_recovery_archive-972"><span class="linenos"> 972</span></a>            <span class="n">source_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="SystemSetup.create_recovery_archive-973"><a href="#SystemSetup.create_recovery_archive-973"><span class="linenos"> 973</span></a>            <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dev&#39;</span><span class="p">,</span> <span class="s1">&#39;proc&#39;</span><span class="p">,</span> <span class="s1">&#39;sys&#39;</span><span class="p">],</span>
</span><span id="SystemSetup.create_recovery_archive-974"><a href="#SystemSetup.create_recovery_archive-974"><span class="linenos"> 974</span></a>            <span class="n">options</span><span class="o">=</span><span class="p">[</span>
</span><span id="SystemSetup.create_recovery_archive-975"><a href="#SystemSetup.create_recovery_archive-975"><span class="linenos"> 975</span></a>                <span class="s1">&#39;--numeric-owner&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.create_recovery_archive-976"><a href="#SystemSetup.create_recovery_archive-976"><span class="linenos"> 976</span></a>                <span class="s1">&#39;--hard-dereference&#39;</span><span class="p">,</span>
</span><span id="SystemSetup.create_recovery_archive-977"><a href="#SystemSetup.create_recovery_archive-977"><span class="linenos"> 977</span></a>                <span class="s1">&#39;--preserve-permissions&#39;</span>
</span><span id="SystemSetup.create_recovery_archive-978"><a href="#SystemSetup.create_recovery_archive-978"><span class="linenos"> 978</span></a>            <span class="p">]</span>
</span><span id="SystemSetup.create_recovery_archive-979"><a href="#SystemSetup.create_recovery_archive-979"><span class="linenos"> 979</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-980"><a href="#SystemSetup.create_recovery_archive-980"><span class="linenos"> 980</span></a>        <span class="c1"># recovery.tar.filesystem</span>
</span><span id="SystemSetup.create_recovery_archive-981"><a href="#SystemSetup.create_recovery_archive-981"><span class="linenos"> 981</span></a>        <span class="n">recovery_filesystem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_state</span><span class="o">.</span><span class="n">build_type</span><span class="o">.</span><span class="n">get_filesystem</span><span class="p">()</span>
</span><span id="SystemSetup.create_recovery_archive-982"><a href="#SystemSetup.create_recovery_archive-982"><span class="linenos"> 982</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;partition_filesystem&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">partfs</span><span class="p">:</span>
</span><span id="SystemSetup.create_recovery_archive-983"><a href="#SystemSetup.create_recovery_archive-983"><span class="linenos"> 983</span></a>            <span class="n">partfs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_filesystem</span><span class="p">))</span>
</span><span id="SystemSetup.create_recovery_archive-984"><a href="#SystemSetup.create_recovery_archive-984"><span class="linenos"> 984</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.create_recovery_archive-985"><a href="#SystemSetup.create_recovery_archive-985"><span class="linenos"> 985</span></a>            <span class="s1">&#39;--&gt; Recovery partition filesystem: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_filesystem</span><span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-986"><a href="#SystemSetup.create_recovery_archive-986"><span class="linenos"> 986</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-987"><a href="#SystemSetup.create_recovery_archive-987"><span class="linenos"> 987</span></a>        <span class="c1"># recovery.tar.files</span>
</span><span id="SystemSetup.create_recovery_archive-988"><a href="#SystemSetup.create_recovery_archive-988"><span class="linenos"> 988</span></a>        <span class="n">bash_comand</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SystemSetup.create_recovery_archive-989"><a href="#SystemSetup.create_recovery_archive-989"><span class="linenos"> 989</span></a>            <span class="s1">&#39;tar&#39;</span><span class="p">,</span> <span class="s1">&#39;-tf&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">],</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;wc&#39;</span><span class="p">,</span> <span class="s1">&#39;-l&#39;</span>
</span><span id="SystemSetup.create_recovery_archive-990"><a href="#SystemSetup.create_recovery_archive-990"><span class="linenos"> 990</span></a>        <span class="p">]</span>
</span><span id="SystemSetup.create_recovery_archive-991"><a href="#SystemSetup.create_recovery_archive-991"><span class="linenos"> 991</span></a>        <span class="n">tar_files_call</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="SystemSetup.create_recovery_archive-992"><a href="#SystemSetup.create_recovery_archive-992"><span class="linenos"> 992</span></a>            <span class="p">[</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bash_comand</span><span class="p">)]</span>
</span><span id="SystemSetup.create_recovery_archive-993"><a href="#SystemSetup.create_recovery_archive-993"><span class="linenos"> 993</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-994"><a href="#SystemSetup.create_recovery_archive-994"><span class="linenos"> 994</span></a>        <span class="n">tar_files_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tar_files_call</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
</span><span id="SystemSetup.create_recovery_archive-995"><a href="#SystemSetup.create_recovery_archive-995"><span class="linenos"> 995</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_filecount&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">files</span><span class="p">:</span>
</span><span id="SystemSetup.create_recovery_archive-996"><a href="#SystemSetup.create_recovery_archive-996"><span class="linenos"> 996</span></a>            <span class="n">files</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tar_files_count</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">))</span>
</span><span id="SystemSetup.create_recovery_archive-997"><a href="#SystemSetup.create_recovery_archive-997"><span class="linenos"> 997</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.create_recovery_archive-998"><a href="#SystemSetup.create_recovery_archive-998"><span class="linenos"> 998</span></a>            <span class="s1">&#39;--&gt; Recovery file count: </span><span class="si">{0}</span><span class="s1"> files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tar_files_count</span><span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-999"><a href="#SystemSetup.create_recovery_archive-999"><span class="linenos"> 999</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-1000"><a href="#SystemSetup.create_recovery_archive-1000"><span class="linenos">1000</span></a>        <span class="c1"># recovery.tar.size</span>
</span><span id="SystemSetup.create_recovery_archive-1001"><a href="#SystemSetup.create_recovery_archive-1001"><span class="linenos">1001</span></a>        <span class="n">recovery_archive_size_bytes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">])</span>
</span><span id="SystemSetup.create_recovery_archive-1002"><a href="#SystemSetup.create_recovery_archive-1002"><span class="linenos">1002</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_size&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">size</span><span class="p">:</span>
</span><span id="SystemSetup.create_recovery_archive-1003"><a href="#SystemSetup.create_recovery_archive-1003"><span class="linenos">1003</span></a>            <span class="n">size</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_archive_size_bytes</span><span class="p">))</span>
</span><span id="SystemSetup.create_recovery_archive-1004"><a href="#SystemSetup.create_recovery_archive-1004"><span class="linenos">1004</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.create_recovery_archive-1005"><a href="#SystemSetup.create_recovery_archive-1005"><span class="linenos">1005</span></a>            <span class="s1">&#39;--&gt; Recovery uncompressed size: </span><span class="si">{0}</span><span class="s1"> mbytes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup.create_recovery_archive-1006"><a href="#SystemSetup.create_recovery_archive-1006"><span class="linenos">1006</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">recovery_archive_size_bytes</span> <span class="o">/</span> <span class="mi">1048576</span><span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-1007"><a href="#SystemSetup.create_recovery_archive-1007"><span class="linenos">1007</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-1008"><a href="#SystemSetup.create_recovery_archive-1008"><span class="linenos">1008</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-1009"><a href="#SystemSetup.create_recovery_archive-1009"><span class="linenos">1009</span></a>        <span class="c1"># recovery.tar.gz</span>
</span><span id="SystemSetup.create_recovery_archive-1010"><a href="#SystemSetup.create_recovery_archive-1010"><span class="linenos">1010</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--&gt; Compressing recovery archive&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-1011"><a href="#SystemSetup.create_recovery_archive-1011"><span class="linenos">1011</span></a>        <span class="n">compress</span> <span class="o">=</span> <span class="n">Compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/recovery.tar&#39;</span><span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-1012"><a href="#SystemSetup.create_recovery_archive-1012"><span class="linenos">1012</span></a>        <span class="n">compress</span><span class="o">.</span><span class="n">gzip</span><span class="p">()</span>
</span><span id="SystemSetup.create_recovery_archive-1013"><a href="#SystemSetup.create_recovery_archive-1013"><span class="linenos">1013</span></a>        <span class="c1"># recovery.partition.size</span>
</span><span id="SystemSetup.create_recovery_archive-1014"><a href="#SystemSetup.create_recovery_archive-1014"><span class="linenos">1014</span></a>        <span class="n">recovery_archive_gz_size_mbytes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="SystemSetup.create_recovery_archive-1015"><a href="#SystemSetup.create_recovery_archive-1015"><span class="linenos">1015</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.gz&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1048576</span>
</span><span id="SystemSetup.create_recovery_archive-1016"><a href="#SystemSetup.create_recovery_archive-1016"><span class="linenos">1016</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-1017"><a href="#SystemSetup.create_recovery_archive-1017"><span class="linenos">1017</span></a>        <span class="n">recovery_partition_mbytes</span> <span class="o">=</span> <span class="n">recovery_archive_gz_size_mbytes</span> \
</span><span id="SystemSetup.create_recovery_archive-1018"><a href="#SystemSetup.create_recovery_archive-1018"><span class="linenos">1018</span></a>            <span class="o">+</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_recovery_spare_mbytes</span><span class="p">()</span>
</span><span id="SystemSetup.create_recovery_archive-1019"><a href="#SystemSetup.create_recovery_archive-1019"><span class="linenos">1019</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;partition_size&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">gzsize</span><span class="p">:</span>
</span><span id="SystemSetup.create_recovery_archive-1020"><a href="#SystemSetup.create_recovery_archive-1020"><span class="linenos">1020</span></a>            <span class="n">gzsize</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recovery_partition_mbytes</span><span class="p">))</span>
</span><span id="SystemSetup.create_recovery_archive-1021"><a href="#SystemSetup.create_recovery_archive-1021"><span class="linenos">1021</span></a>        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.create_recovery_archive-1022"><a href="#SystemSetup.create_recovery_archive-1022"><span class="linenos">1022</span></a>            <span class="s1">&#39;--&gt; Recovery partition size: </span><span class="si">{0}</span><span class="s1"> mbytes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="SystemSetup.create_recovery_archive-1023"><a href="#SystemSetup.create_recovery_archive-1023"><span class="linenos">1023</span></a>                <span class="n">recovery_partition_mbytes</span>
</span><span id="SystemSetup.create_recovery_archive-1024"><a href="#SystemSetup.create_recovery_archive-1024"><span class="linenos">1024</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-1025"><a href="#SystemSetup.create_recovery_archive-1025"><span class="linenos">1025</span></a>        <span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-1026"><a href="#SystemSetup.create_recovery_archive-1026"><span class="linenos">1026</span></a>        <span class="c1"># delete recovery archive if inplace recovery is requested</span>
</span><span id="SystemSetup.create_recovery_archive-1027"><a href="#SystemSetup.create_recovery_archive-1027"><span class="linenos">1027</span></a>        <span class="c1"># In this mode the recovery archive is created at install time</span>
</span><span id="SystemSetup.create_recovery_archive-1028"><a href="#SystemSetup.create_recovery_archive-1028"><span class="linenos">1028</span></a>        <span class="c1"># and not at image creation time. However the recovery metadata</span>
</span><span id="SystemSetup.create_recovery_archive-1029"><a href="#SystemSetup.create_recovery_archive-1029"><span class="linenos">1029</span></a>        <span class="c1"># is preserved in order to be able to check if enough space</span>
</span><span id="SystemSetup.create_recovery_archive-1030"><a href="#SystemSetup.create_recovery_archive-1030"><span class="linenos">1030</span></a>        <span class="c1"># is available on the disk to create the recovery archive.</span>
</span><span id="SystemSetup.create_recovery_archive-1031"><a href="#SystemSetup.create_recovery_archive-1031"><span class="linenos">1031</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oemconfig</span><span class="p">[</span><span class="s1">&#39;recovery_inplace&#39;</span><span class="p">]:</span>
</span><span id="SystemSetup.create_recovery_archive-1032"><a href="#SystemSetup.create_recovery_archive-1032"><span class="linenos">1032</span></a>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="SystemSetup.create_recovery_archive-1033"><a href="#SystemSetup.create_recovery_archive-1033"><span class="linenos">1033</span></a>                <span class="s1">&#39;--&gt; Inplace recovery requested, deleting archive&#39;</span>
</span><span id="SystemSetup.create_recovery_archive-1034"><a href="#SystemSetup.create_recovery_archive-1034"><span class="linenos">1034</span></a>            <span class="p">)</span>
</span><span id="SystemSetup.create_recovery_archive-1035"><a href="#SystemSetup.create_recovery_archive-1035"><span class="linenos">1035</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;archive_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.gz&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a compressed recovery archive from the root tree
for use with kiwi's recvoery system. The method creates
additional data into the image root filesystem which is
deleted prior to the creation of a new recovery data set</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>