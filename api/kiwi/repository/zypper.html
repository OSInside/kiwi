<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>kiwi.repository.zypper API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../repository.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;kiwi.repository</a>

            <img src="https://osinside.github.io/kiwi/_static/kiwi-logo.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#RepositoryZypper">RepositoryZypper</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#RepositoryZypper.post_init">post_init</a>
                        </li>
                        <li>
                                <a class="function" href="#RepositoryZypper.setup_package_database_configuration">setup_package_database_configuration</a>
                        </li>
                        <li>
                                <a class="function" href="#RepositoryZypper.use_default_location">use_default_location</a>
                        </li>
                        <li>
                                <a class="function" href="#RepositoryZypper.runtime_config">runtime_config</a>
                        </li>
                        <li>
                                <a class="function" href="#RepositoryZypper.add_repo">add_repo</a>
                        </li>
                        <li>
                                <a class="function" href="#RepositoryZypper.import_trusted_keys">import_trusted_keys</a>
                        </li>
                        <li>
                                <a class="function" href="#RepositoryZypper.delete_repo">delete_repo</a>
                        </li>
                        <li>
                                <a class="function" href="#RepositoryZypper.delete_all_repos">delete_all_repos</a>
                        </li>
                        <li>
                                <a class="function" href="#RepositoryZypper.delete_repo_cache">delete_repo_cache</a>
                        </li>
                        <li>
                                <a class="function" href="#RepositoryZypper.cleanup_unused_repos">cleanup_unused_repos</a>
                        </li>
                        <li>
                                <a class="function" href="#RepositoryZypper.cleanup">cleanup</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../kiwi.html">kiwi</a><wbr>.<a href="./../repository.html">repository</a><wbr>.zypper    </h1>

                
                        <input id="mod-zypper-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-zypper-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1"># Copyright (c) 2015 SUSE Linux GmbH.  All rights reserved.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="c1">#</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="c1"># This file is part of kiwi.</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="c1">#</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="c1"># kiwi is free software: you can redistribute it and/or modify</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="c1"># it under the terms of the GNU General Public License as published by</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="c1"># (at your option) any later version.</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="c1">#</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="c1"># kiwi is distributed in the hope that it will be useful,</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="c1"># GNU General Public License for more details.</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="c1">#</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="c1"># You should have received a copy of the GNU General Public License</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="c1"># along with kiwi.  If not, see &lt;http://www.gnu.org/licenses/&gt;</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="c1">#</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">configparser</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigParser</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="c1"># project</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">kiwi.defaults</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">defaults</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.utils.temporary</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>    <span class="n">Temporary</span><span class="p">,</span> <span class="n">TmpT</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="p">)</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.defaults</span><span class="w"> </span><span class="kn">import</span> <span class="n">Defaults</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.command</span><span class="w"> </span><span class="kn">import</span> <span class="n">Command</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.repository.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">RepositoryBase</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.system.uri</span><span class="w"> </span><span class="kn">import</span> <span class="n">Uri</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.utils.rpm_database</span><span class="w"> </span><span class="kn">import</span> <span class="n">RpmDataBase</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">kiwi.utils.toenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToEnv</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="k">class</span><span class="w"> </span><span class="nc">RepositoryZypper</span><span class="p">(</span><span class="n">RepositoryBase</span><span class="p">):</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">    **Implements repo handling for zypper package manager**</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">    :param str shared_zypper_dir: shared directory between image root</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        and build system root</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">    :param str runtime_zypper_config_file: zypper runtime config file name</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">    :param str runtime_zypp_config_file: libzypp runtime config file name</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    :param list zypper_args: zypper caller args plus additional custom args</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    :param dict command_env: customized os.environ for zypper</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    :param object runtime_zypper_config: instance of :class:`ConfigParser`</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_args</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">        Post initialization method</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">        Store custom zypper arguments and create runtime configuration</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">        and environment</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">        :param list custom_args: zypper arguments</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span> <span class="o">=</span> <span class="n">TmpT</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span> <span class="o">=</span> <span class="n">TmpT</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span> <span class="o">=</span> <span class="n">custom_args</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_docs</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gpgcheck</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="c1"># extract custom arguments used for zypp config only</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="k">if</span> <span class="s1">&#39;exclude_docs&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="p">:</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;exclude_docs&#39;</span><span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exclude_docs</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="k">if</span> <span class="s1">&#39;check_signatures&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="p">:</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;check_signatures&#39;</span><span class="p">)</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gpgcheck</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="p">:</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>            <span class="k">if</span> <span class="s1">&#39;_install_langs&#39;</span> <span class="ow">in</span> <span class="n">argument</span><span class="p">:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="n">argument</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>            <span class="k">elif</span> <span class="s1">&#39;_target_arch&#39;</span> <span class="ow">in</span> <span class="n">argument</span><span class="p">:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="o">=</span> <span class="n">argument</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">:</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">)</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="p">:</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">repo_names</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="c1"># zypper support by default point all actions into the root</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="c1"># directory of the image system. This information is passed</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="c1"># as arguments to zypper and adapted if the call runs as</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="c1"># chrooted operation. Therefore the use of the shared location</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="c1"># via RootBind::mount_shared_directory is optional but</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="c1"># recommended to make use of the repo cache</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="n">manager_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_location</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>            <span class="s1">&#39;pkg-cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;packages&#39;</span><span class="p">]</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>            <span class="p">),</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>            <span class="s1">&#39;reposd-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/repos&#39;</span><span class="p">]</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>            <span class="p">),</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>            <span class="s1">&#39;credentials-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/credentials&#39;</span><span class="p">]</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>            <span class="p">),</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>            <span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/solv&#39;</span><span class="p">]</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>            <span class="p">),</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="s1">&#39;raw-cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/raw&#39;</span><span class="p">]</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>            <span class="p">),</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>            <span class="s1">&#39;cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper&#39;</span><span class="p">]</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>            <span class="p">)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="p">}</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span> <span class="o">=</span> <span class="n">Temporary</span><span class="p">(</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;kiwi_zypper.config&#39;</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">unmanaged_file</span><span class="p">()</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span> <span class="o">=</span> <span class="n">Temporary</span><span class="p">(</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;kiwi_zypp.config&#39;</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">unmanaged_file</span><span class="p">()</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>            <span class="s1">&#39;--non-interactive&#39;</span><span class="p">,</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>            <span class="s1">&#39;--gpg-auto-import-keys&#39;</span><span class="p">,</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>            <span class="s1">&#39;--pkg-cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;pkg-cache-dir&#39;</span><span class="p">],</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>            <span class="s1">&#39;--reposd-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">],</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>            <span class="s1">&#39;--solv-cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">],</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>            <span class="s1">&#39;--cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;cache-dir&#39;</span><span class="p">],</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>            <span class="s1">&#39;--raw-cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;raw-cache-dir&#39;</span><span class="p">],</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>            <span class="s1">&#39;--config&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_zypper_runtime_environment</span><span class="p">()</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="c1"># config file parameters for zypper tool</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="c1"># config file parameters for libzypp library</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>            <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;credentials.global.dir&#39;</span><span class="p">,</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;credentials-dir&#39;</span><span class="p">]</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="p">)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="p">:</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;arch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            <span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_docs</span><span class="p">:</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;rpm.install.excludedocs&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="p">)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpgcheck</span><span class="p">:</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>            <span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>            <span class="p">)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_write_runtime_config</span><span class="p">()</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_package_database_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">        Setup rpm macros for bootstrapping and image building</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">        1. Create the rpm image macro which persists during the build</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">        2. Create the rpm bootstrap macro to make sure for bootstrapping</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">           the rpm database location matches the host rpm database setup.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">           This macro only persists during the bootstrap phase. If the</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">           image was already bootstrapped a compat link is created instead.</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">        3. Create zypper compat link</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="n">rpmdb</span> <span class="o">=</span> <span class="n">RpmDataBase</span><span class="p">(</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_custom_rpm_image_macro_name</span><span class="p">()</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>        <span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">set_macro_from_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="n">rpmdb</span><span class="o">.</span><span class="n">write_config</span><span class="p">()</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="n">rpmdb</span> <span class="o">=</span> <span class="n">RpmDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>        <span class="k">if</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">has_rpm</span><span class="p">():</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">link_database_to_host_path</span><span class="p">()</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">set_database_to_host_path</span><span class="p">()</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="c1"># Zypper compat code:</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="c1">#</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="c1"># Manually adding the compat link /var/lib/rpm that points to the</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="c1"># rpmdb location as it is configured in the host rpm setup. The</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="c1"># host rpm setup is taken into account because import_trusted_keys</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="c1"># is called during the bootstrap phase where rpm (respectively zypper)</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>        <span class="c1"># is called from the host</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="c1">#</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="c1"># Usually it is expected that the package manager reads the</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        <span class="c1"># signing keys from the rpm database setup provisioned by rpm</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="c1"># itself (macro level) but zypper doesn&#39;t take the rpm macro</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="c1"># setup into account and relies on a hard coded path which we</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="c1"># can only provide as a symlink.</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="c1">#</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="c1"># That symlink is usually created by the rpm package when it gets</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="c1"># installed. However at that early phase when we import the</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="c1"># signing keys no rpm is installed yet nor any symlink exists.</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="c1"># Thus we have to create it here and hope to get rid of it in the</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="c1"># future.</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>        <span class="c1">#</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="c1"># For further details on the motivation in zypper please</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="c1"># refer to bsc#1112357</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="n">rpmdb</span><span class="o">.</span><span class="n">init_database</span><span class="p">()</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="n">image_rpm_compat_link</span> <span class="o">=</span> <span class="s1">&#39;/var/lib/rpm&#39;</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="n">host_rpm_dbpath</span> <span class="o">=</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">rpmdb_host</span><span class="o">.</span><span class="n">expand_query</span><span class="p">(</span><span class="s1">&#39;%_dbpath&#39;</span><span class="p">)</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        <span class="k">if</span> <span class="n">host_rpm_dbpath</span> <span class="o">!=</span> <span class="n">image_rpm_compat_link</span><span class="p">:</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image_rpm_compat_link</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                <span class="p">[</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>                    <span class="s1">&#39;ln&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-target-directory&#39;</span><span class="p">,</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;../..&#39;</span><span class="p">,</span> <span class="n">host_rpm_dbpath</span><span class="p">]),</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="n">image_rpm_compat_link</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>                <span class="p">],</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>            <span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">use_default_location</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        Setup zypper repository operations to store all data</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">        in the default places</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/zypp/repos.d&#39;</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;credentials-dir&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/zypp/credentials.d&#39;</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>            <span class="s1">&#39;--non-interactive&#39;</span><span class="p">,</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">LANG</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">runtime_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">        zypper runtime configuration and environment</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            <span class="s1">&#39;zypper_args&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span><span class="p">,</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>            <span class="s1">&#39;command_env&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="p">}</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_repo</span><span class="p">(</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">repo_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;rpm-md&#39;</span><span class="p">,</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="n">prio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dist</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">components</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">credentials_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="n">repo_gpgcheck</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pkg_gpgcheck</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="n">sourcetype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">customization_script</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="n">architectures</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a><span class="sd">        Add zypper repository</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="sd">        :param str name: repository name</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">        :param str uri: repository URI</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="sd">        :param str repo_type: repostory type name</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">        :param int prio: zypper repostory priority</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">        :param str dist: unused</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">        :param str components: unused</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        :param str user: credentials username</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        :param str secret: credentials password</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        :param str credentials_file: zypper credentials file</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        :param bool repo_gpgcheck: enable repository signature validation</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">        :param bool pkg_gpgcheck: enable package signature validation</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        :param str sourcetype: unused</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">        :param str customization_script:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">            custom script called after the repo file was created</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">        :param str architectures: unused</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="k">if</span> <span class="n">credentials_file</span><span class="p">:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>            <span class="n">repo_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;credentials-dir&#39;</span><span class="p">],</span> <span class="n">credentials_file</span><span class="p">]</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>            <span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">repo_secret</span><span class="p">):</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">repo_secret</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">secret</span><span class="p">:</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">uri</span><span class="p">,</span> <span class="s1">&#39;?credentials=&#39;</span><span class="p">,</span> <span class="n">credentials_file</span><span class="p">])</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">repo_secret</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">credentials</span><span class="p">:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                    <span class="n">credentials</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;username=</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>                        <span class="n">user</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>                    <span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>                    <span class="n">credentials</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;password=</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>                        <span class="n">secret</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>                    <span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="n">repo_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;.repo&#39;</span><span class="p">]</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="p">)</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">repo_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;.repo&#39;</span><span class="p">]))</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">repo_file</span><span class="p">):</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">repo_file</span><span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_backup_package_cache</span><span class="p">()</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="n">zypper_addrepo_command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;zypper&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>            <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="s1">&#39;addrepo&#39;</span><span class="p">,</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="s1">&#39;--refresh&#39;</span><span class="p">,</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>            <span class="s1">&#39;--keep-packages&#39;</span> <span class="k">if</span> <span class="n">Uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">is_remote</span><span class="p">()</span> <span class="k">else</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>            <span class="s1">&#39;--no-keep-packages&#39;</span><span class="p">,</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>            <span class="s1">&#39;--no-check&#39;</span><span class="p">,</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="n">uri</span><span class="p">,</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            <span class="n">name</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>        <span class="p">]</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>                <span class="n">zypper_addrepo_command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="c1"># for whatever reason zypper sometimes failes with</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="c1"># a &#39;failed to cache rpm database&#39; error. I could not</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="c1"># find any reason why and a simple recall of the exact</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="c1"># same command in the exact same environment works.</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="c1"># Thus the stupid but simple workaround to this problem</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="c1"># is try one recall before really failing</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                <span class="n">zypper_addrepo_command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>            <span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="n">repo_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        <span class="n">repo_config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">repo_file</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        <span class="n">baseurl</span> <span class="o">=</span> <span class="n">uri</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        <span class="n">uri_with_credentials_pattern</span> <span class="o">=</span> <span class="s1">&#39;^(.*):(.*)@(.*)$&#39;</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>        <span class="n">sensitive_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">uri_with_credentials_pattern</span><span class="p">,</span> <span class="n">baseurl</span><span class="p">)</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>        <span class="k">if</span> <span class="n">sensitive_match</span><span class="p">:</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>            <span class="c1"># rewrite baseurl with credentials information because zypper</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            <span class="c1"># addrepo does strange things with the provided url encoded data</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;baseurl&#39;</span><span class="p">,</span> <span class="n">baseurl</span><span class="p">)</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>            <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;repo_gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="n">repo_gpgcheck</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="p">)</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>        <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>            <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;pkg_gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="n">pkg_gpgcheck</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="p">)</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="k">if</span> <span class="n">prio</span><span class="p">:</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>            <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>                <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">prio</span><span class="p">)</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">repo_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">repo</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            <span class="n">repo_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>        <span class="k">if</span> <span class="n">customization_script</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">run_repo_customize</span><span class="p">(</span><span class="n">customization_script</span><span class="p">,</span> <span class="n">repo_file</span><span class="p">)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_package_cache</span><span class="p">()</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_trusted_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signing_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">        Imports trusted keys into the image</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="sd">        :param list signing_keys: list of the key files to import</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="n">rpmdb</span> <span class="o">=</span> <span class="n">RpmDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">signing_keys</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">import_signing_key_to_image</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">        Delete zypper repository</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">        :param str name: repository name</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>            <span class="p">[</span><span class="s1">&#39;zypper&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;removerepo&#39;</span><span class="p">,</span> <span class="n">name</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>            <span class="p">],</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_all_repos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">        Delete all zypper repositories</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">])</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">])</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_repo_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">        Delete zypper repository cache</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">        The cache data for each repository is stored in a list of</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">        directories of the same name as the repository name. The method</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a><span class="sd">        deletes these directories to cleanup the cache information</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">        :param str name: repository name</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;pkg-cache-dir&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">])</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>        <span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">])</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;raw-cache-dir&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">])</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>        <span class="p">)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_unused_repos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">        Delete unused zypper repositories</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a><span class="sd">        zypper creates a system solvable which is unwanted for the</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">        purpose of building images. In addition zypper fails with</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">        an error message &#39;Failed to cache rpm database&#39; if such a</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">        system solvable exists and a new root system is created</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="sd">        All other repository configurations which are not used for</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">        this build must be removed too, otherwise they are taken into</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">        account for the package installations</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="n">solv_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">]</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">solv_dir</span> <span class="o">+</span> <span class="s1">&#39;/@System&#39;</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        <span class="n">repos_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">]</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>        <span class="n">repo_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">repos_dir</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>        <span class="k">for</span> <span class="n">repo_file</span> <span class="ow">in</span> <span class="n">repo_files</span><span class="p">:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>            <span class="k">if</span> <span class="n">repo_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_names</span><span class="p">:</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">repos_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">repo_file</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_zypper_runtime_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>        <span class="k">for</span> <span class="n">zypper_dir</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">zypper_dir</span><span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="n">ToEnv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">PACKAGE_MANAGER_ENV_VARS</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>            <span class="n">LANG</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="n">ZYPP_CONF</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_write_runtime_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_backup_package_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">        preserve package cache which otherwise will be removed by</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">        zypper if no repo file is found. But this situation is</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">        normal for an image build process which setup and remove</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">        repos for building at runtime</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_move_package_cache</span><span class="p">(</span><span class="n">backup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_restore_package_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">        restore preserved package cache at the location passed to zypper</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_move_package_cache</span><span class="p">(</span><span class="n">restore</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_move_package_cache</span><span class="p">(</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">backup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">restore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="n">package_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_location</span> <span class="o">+</span> <span class="s1">&#39;/packages&#39;</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="n">package_cache_moved</span> <span class="o">=</span> <span class="n">package_cache</span> <span class="o">+</span> <span class="s1">&#39;.moved&#39;</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="k">if</span> <span class="n">backup</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">package_cache</span><span class="p">):</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>                <span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">package_cache</span><span class="p">,</span> <span class="n">package_cache_moved</span><span class="p">]</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>            <span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="k">elif</span> <span class="n">restore</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">package_cache_moved</span><span class="p">):</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                <span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">package_cache_moved</span><span class="p">,</span> <span class="n">package_cache</span><span class="p">]</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>            <span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="sd">        Delete intermediate zypp and zypper config files</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_package_cache</span><span class="p">()</span>
</span></pre></div>


            </section>
                <section id="RepositoryZypper">
                            <input id="RepositoryZypper-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">RepositoryZypper</span><wbr>(<span class="base"><a href="base.html#RepositoryBase">kiwi.repository.base.RepositoryBase</a></span>):

                <label class="view-source-button" for="RepositoryZypper-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper-38"><a href="#RepositoryZypper-38"><span class="linenos"> 38</span></a><span class="k">class</span><span class="w"> </span><span class="nc">RepositoryZypper</span><span class="p">(</span><span class="n">RepositoryBase</span><span class="p">):</span>
</span><span id="RepositoryZypper-39"><a href="#RepositoryZypper-39"><span class="linenos"> 39</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-40"><a href="#RepositoryZypper-40"><span class="linenos"> 40</span></a><span class="sd">    **Implements repo handling for zypper package manager**</span>
</span><span id="RepositoryZypper-41"><a href="#RepositoryZypper-41"><span class="linenos"> 41</span></a>
</span><span id="RepositoryZypper-42"><a href="#RepositoryZypper-42"><span class="linenos"> 42</span></a><span class="sd">    :param str shared_zypper_dir: shared directory between image root</span>
</span><span id="RepositoryZypper-43"><a href="#RepositoryZypper-43"><span class="linenos"> 43</span></a><span class="sd">        and build system root</span>
</span><span id="RepositoryZypper-44"><a href="#RepositoryZypper-44"><span class="linenos"> 44</span></a><span class="sd">    :param str runtime_zypper_config_file: zypper runtime config file name</span>
</span><span id="RepositoryZypper-45"><a href="#RepositoryZypper-45"><span class="linenos"> 45</span></a><span class="sd">    :param str runtime_zypp_config_file: libzypp runtime config file name</span>
</span><span id="RepositoryZypper-46"><a href="#RepositoryZypper-46"><span class="linenos"> 46</span></a><span class="sd">    :param list zypper_args: zypper caller args plus additional custom args</span>
</span><span id="RepositoryZypper-47"><a href="#RepositoryZypper-47"><span class="linenos"> 47</span></a><span class="sd">    :param dict command_env: customized os.environ for zypper</span>
</span><span id="RepositoryZypper-48"><a href="#RepositoryZypper-48"><span class="linenos"> 48</span></a><span class="sd">    :param object runtime_zypper_config: instance of :class:`ConfigParser`</span>
</span><span id="RepositoryZypper-49"><a href="#RepositoryZypper-49"><span class="linenos"> 49</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-50"><a href="#RepositoryZypper-50"><span class="linenos"> 50</span></a>
</span><span id="RepositoryZypper-51"><a href="#RepositoryZypper-51"><span class="linenos"> 51</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_args</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-52"><a href="#RepositoryZypper-52"><span class="linenos"> 52</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-53"><a href="#RepositoryZypper-53"><span class="linenos"> 53</span></a><span class="sd">        Post initialization method</span>
</span><span id="RepositoryZypper-54"><a href="#RepositoryZypper-54"><span class="linenos"> 54</span></a>
</span><span id="RepositoryZypper-55"><a href="#RepositoryZypper-55"><span class="linenos"> 55</span></a><span class="sd">        Store custom zypper arguments and create runtime configuration</span>
</span><span id="RepositoryZypper-56"><a href="#RepositoryZypper-56"><span class="linenos"> 56</span></a><span class="sd">        and environment</span>
</span><span id="RepositoryZypper-57"><a href="#RepositoryZypper-57"><span class="linenos"> 57</span></a>
</span><span id="RepositoryZypper-58"><a href="#RepositoryZypper-58"><span class="linenos"> 58</span></a><span class="sd">        :param list custom_args: zypper arguments</span>
</span><span id="RepositoryZypper-59"><a href="#RepositoryZypper-59"><span class="linenos"> 59</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-60"><a href="#RepositoryZypper-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span> <span class="o">=</span> <span class="n">TmpT</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper-61"><a href="#RepositoryZypper-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span> <span class="o">=</span> <span class="n">TmpT</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper-62"><a href="#RepositoryZypper-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span> <span class="o">=</span> <span class="n">custom_args</span>
</span><span id="RepositoryZypper-63"><a href="#RepositoryZypper-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_docs</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="RepositoryZypper-64"><a href="#RepositoryZypper-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gpgcheck</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="RepositoryZypper-65"><a href="#RepositoryZypper-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="RepositoryZypper-66"><a href="#RepositoryZypper-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="RepositoryZypper-67"><a href="#RepositoryZypper-67"><span class="linenos"> 67</span></a>
</span><span id="RepositoryZypper-68"><a href="#RepositoryZypper-68"><span class="linenos"> 68</span></a>        <span class="c1"># extract custom arguments used for zypp config only</span>
</span><span id="RepositoryZypper-69"><a href="#RepositoryZypper-69"><span class="linenos"> 69</span></a>        <span class="k">if</span> <span class="s1">&#39;exclude_docs&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="p">:</span>
</span><span id="RepositoryZypper-70"><a href="#RepositoryZypper-70"><span class="linenos"> 70</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;exclude_docs&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper-71"><a href="#RepositoryZypper-71"><span class="linenos"> 71</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exclude_docs</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="RepositoryZypper-72"><a href="#RepositoryZypper-72"><span class="linenos"> 72</span></a>
</span><span id="RepositoryZypper-73"><a href="#RepositoryZypper-73"><span class="linenos"> 73</span></a>        <span class="k">if</span> <span class="s1">&#39;check_signatures&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="p">:</span>
</span><span id="RepositoryZypper-74"><a href="#RepositoryZypper-74"><span class="linenos"> 74</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;check_signatures&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper-75"><a href="#RepositoryZypper-75"><span class="linenos"> 75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gpgcheck</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="RepositoryZypper-76"><a href="#RepositoryZypper-76"><span class="linenos"> 76</span></a>
</span><span id="RepositoryZypper-77"><a href="#RepositoryZypper-77"><span class="linenos"> 77</span></a>        <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="p">:</span>
</span><span id="RepositoryZypper-78"><a href="#RepositoryZypper-78"><span class="linenos"> 78</span></a>            <span class="k">if</span> <span class="s1">&#39;_install_langs&#39;</span> <span class="ow">in</span> <span class="n">argument</span><span class="p">:</span>
</span><span id="RepositoryZypper-79"><a href="#RepositoryZypper-79"><span class="linenos"> 79</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="n">argument</span>
</span><span id="RepositoryZypper-80"><a href="#RepositoryZypper-80"><span class="linenos"> 80</span></a>            <span class="k">elif</span> <span class="s1">&#39;_target_arch&#39;</span> <span class="ow">in</span> <span class="n">argument</span><span class="p">:</span>
</span><span id="RepositoryZypper-81"><a href="#RepositoryZypper-81"><span class="linenos"> 81</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="o">=</span> <span class="n">argument</span>
</span><span id="RepositoryZypper-82"><a href="#RepositoryZypper-82"><span class="linenos"> 82</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">:</span>
</span><span id="RepositoryZypper-83"><a href="#RepositoryZypper-83"><span class="linenos"> 83</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">)</span>
</span><span id="RepositoryZypper-84"><a href="#RepositoryZypper-84"><span class="linenos"> 84</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="p">:</span>
</span><span id="RepositoryZypper-85"><a href="#RepositoryZypper-85"><span class="linenos"> 85</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="p">)</span>
</span><span id="RepositoryZypper-86"><a href="#RepositoryZypper-86"><span class="linenos"> 86</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="RepositoryZypper-87"><a href="#RepositoryZypper-87"><span class="linenos"> 87</span></a>
</span><span id="RepositoryZypper-88"><a href="#RepositoryZypper-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">repo_names</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="RepositoryZypper-89"><a href="#RepositoryZypper-89"><span class="linenos"> 89</span></a>
</span><span id="RepositoryZypper-90"><a href="#RepositoryZypper-90"><span class="linenos"> 90</span></a>        <span class="c1"># zypper support by default point all actions into the root</span>
</span><span id="RepositoryZypper-91"><a href="#RepositoryZypper-91"><span class="linenos"> 91</span></a>        <span class="c1"># directory of the image system. This information is passed</span>
</span><span id="RepositoryZypper-92"><a href="#RepositoryZypper-92"><span class="linenos"> 92</span></a>        <span class="c1"># as arguments to zypper and adapted if the call runs as</span>
</span><span id="RepositoryZypper-93"><a href="#RepositoryZypper-93"><span class="linenos"> 93</span></a>        <span class="c1"># chrooted operation. Therefore the use of the shared location</span>
</span><span id="RepositoryZypper-94"><a href="#RepositoryZypper-94"><span class="linenos"> 94</span></a>        <span class="c1"># via RootBind::mount_shared_directory is optional but</span>
</span><span id="RepositoryZypper-95"><a href="#RepositoryZypper-95"><span class="linenos"> 95</span></a>        <span class="c1"># recommended to make use of the repo cache</span>
</span><span id="RepositoryZypper-96"><a href="#RepositoryZypper-96"><span class="linenos"> 96</span></a>        <span class="n">manager_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_location</span>
</span><span id="RepositoryZypper-97"><a href="#RepositoryZypper-97"><span class="linenos"> 97</span></a>
</span><span id="RepositoryZypper-98"><a href="#RepositoryZypper-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="RepositoryZypper-99"><a href="#RepositoryZypper-99"><span class="linenos"> 99</span></a>            <span class="s1">&#39;pkg-cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper-100"><a href="#RepositoryZypper-100"><span class="linenos">100</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;packages&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper-101"><a href="#RepositoryZypper-101"><span class="linenos">101</span></a>            <span class="p">),</span>
</span><span id="RepositoryZypper-102"><a href="#RepositoryZypper-102"><span class="linenos">102</span></a>            <span class="s1">&#39;reposd-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper-103"><a href="#RepositoryZypper-103"><span class="linenos">103</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/repos&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper-104"><a href="#RepositoryZypper-104"><span class="linenos">104</span></a>            <span class="p">),</span>
</span><span id="RepositoryZypper-105"><a href="#RepositoryZypper-105"><span class="linenos">105</span></a>            <span class="s1">&#39;credentials-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper-106"><a href="#RepositoryZypper-106"><span class="linenos">106</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/credentials&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper-107"><a href="#RepositoryZypper-107"><span class="linenos">107</span></a>            <span class="p">),</span>
</span><span id="RepositoryZypper-108"><a href="#RepositoryZypper-108"><span class="linenos">108</span></a>            <span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper-109"><a href="#RepositoryZypper-109"><span class="linenos">109</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/solv&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper-110"><a href="#RepositoryZypper-110"><span class="linenos">110</span></a>            <span class="p">),</span>
</span><span id="RepositoryZypper-111"><a href="#RepositoryZypper-111"><span class="linenos">111</span></a>            <span class="s1">&#39;raw-cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper-112"><a href="#RepositoryZypper-112"><span class="linenos">112</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/raw&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper-113"><a href="#RepositoryZypper-113"><span class="linenos">113</span></a>            <span class="p">),</span>
</span><span id="RepositoryZypper-114"><a href="#RepositoryZypper-114"><span class="linenos">114</span></a>            <span class="s1">&#39;cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper-115"><a href="#RepositoryZypper-115"><span class="linenos">115</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper-116"><a href="#RepositoryZypper-116"><span class="linenos">116</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-117"><a href="#RepositoryZypper-117"><span class="linenos">117</span></a>        <span class="p">}</span>
</span><span id="RepositoryZypper-118"><a href="#RepositoryZypper-118"><span class="linenos">118</span></a>
</span><span id="RepositoryZypper-119"><a href="#RepositoryZypper-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span> <span class="o">=</span> <span class="n">Temporary</span><span class="p">(</span>
</span><span id="RepositoryZypper-120"><a href="#RepositoryZypper-120"><span class="linenos">120</span></a>            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;kiwi_zypper.config&#39;</span>
</span><span id="RepositoryZypper-121"><a href="#RepositoryZypper-121"><span class="linenos">121</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">unmanaged_file</span><span class="p">()</span>
</span><span id="RepositoryZypper-122"><a href="#RepositoryZypper-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span> <span class="o">=</span> <span class="n">Temporary</span><span class="p">(</span>
</span><span id="RepositoryZypper-123"><a href="#RepositoryZypper-123"><span class="linenos">123</span></a>            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;kiwi_zypp.config&#39;</span>
</span><span id="RepositoryZypper-124"><a href="#RepositoryZypper-124"><span class="linenos">124</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">unmanaged_file</span><span class="p">()</span>
</span><span id="RepositoryZypper-125"><a href="#RepositoryZypper-125"><span class="linenos">125</span></a>
</span><span id="RepositoryZypper-126"><a href="#RepositoryZypper-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="RepositoryZypper-127"><a href="#RepositoryZypper-127"><span class="linenos">127</span></a>            <span class="s1">&#39;--non-interactive&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper-128"><a href="#RepositoryZypper-128"><span class="linenos">128</span></a>            <span class="s1">&#39;--gpg-auto-import-keys&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper-129"><a href="#RepositoryZypper-129"><span class="linenos">129</span></a>            <span class="s1">&#39;--pkg-cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;pkg-cache-dir&#39;</span><span class="p">],</span>
</span><span id="RepositoryZypper-130"><a href="#RepositoryZypper-130"><span class="linenos">130</span></a>            <span class="s1">&#39;--reposd-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">],</span>
</span><span id="RepositoryZypper-131"><a href="#RepositoryZypper-131"><span class="linenos">131</span></a>            <span class="s1">&#39;--solv-cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">],</span>
</span><span id="RepositoryZypper-132"><a href="#RepositoryZypper-132"><span class="linenos">132</span></a>            <span class="s1">&#39;--cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;cache-dir&#39;</span><span class="p">],</span>
</span><span id="RepositoryZypper-133"><a href="#RepositoryZypper-133"><span class="linenos">133</span></a>            <span class="s1">&#39;--raw-cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;raw-cache-dir&#39;</span><span class="p">],</span>
</span><span id="RepositoryZypper-134"><a href="#RepositoryZypper-134"><span class="linenos">134</span></a>            <span class="s1">&#39;--config&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span><span class="o">.</span><span class="n">name</span>
</span><span id="RepositoryZypper-135"><a href="#RepositoryZypper-135"><span class="linenos">135</span></a>        <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span>
</span><span id="RepositoryZypper-136"><a href="#RepositoryZypper-136"><span class="linenos">136</span></a>
</span><span id="RepositoryZypper-137"><a href="#RepositoryZypper-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_zypper_runtime_environment</span><span class="p">()</span>
</span><span id="RepositoryZypper-138"><a href="#RepositoryZypper-138"><span class="linenos">138</span></a>
</span><span id="RepositoryZypper-139"><a href="#RepositoryZypper-139"><span class="linenos">139</span></a>        <span class="c1"># config file parameters for zypper tool</span>
</span><span id="RepositoryZypper-140"><a href="#RepositoryZypper-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="RepositoryZypper-141"><a href="#RepositoryZypper-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper-142"><a href="#RepositoryZypper-142"><span class="linenos">142</span></a>
</span><span id="RepositoryZypper-143"><a href="#RepositoryZypper-143"><span class="linenos">143</span></a>        <span class="c1"># config file parameters for libzypp library</span>
</span><span id="RepositoryZypper-144"><a href="#RepositoryZypper-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="RepositoryZypper-145"><a href="#RepositoryZypper-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper-146"><a href="#RepositoryZypper-146"><span class="linenos">146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper-147"><a href="#RepositoryZypper-147"><span class="linenos">147</span></a>            <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;credentials.global.dir&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper-148"><a href="#RepositoryZypper-148"><span class="linenos">148</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;credentials-dir&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper-149"><a href="#RepositoryZypper-149"><span class="linenos">149</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper-150"><a href="#RepositoryZypper-150"><span class="linenos">150</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="p">:</span>
</span><span id="RepositoryZypper-151"><a href="#RepositoryZypper-151"><span class="linenos">151</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper-152"><a href="#RepositoryZypper-152"><span class="linenos">152</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;arch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span>
</span><span id="RepositoryZypper-153"><a href="#RepositoryZypper-153"><span class="linenos">153</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-154"><a href="#RepositoryZypper-154"><span class="linenos">154</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_docs</span><span class="p">:</span>
</span><span id="RepositoryZypper-155"><a href="#RepositoryZypper-155"><span class="linenos">155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper-156"><a href="#RepositoryZypper-156"><span class="linenos">156</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;rpm.install.excludedocs&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span>
</span><span id="RepositoryZypper-157"><a href="#RepositoryZypper-157"><span class="linenos">157</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-158"><a href="#RepositoryZypper-158"><span class="linenos">158</span></a>
</span><span id="RepositoryZypper-159"><a href="#RepositoryZypper-159"><span class="linenos">159</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpgcheck</span><span class="p">:</span>
</span><span id="RepositoryZypper-160"><a href="#RepositoryZypper-160"><span class="linenos">160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper-161"><a href="#RepositoryZypper-161"><span class="linenos">161</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span>
</span><span id="RepositoryZypper-162"><a href="#RepositoryZypper-162"><span class="linenos">162</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-163"><a href="#RepositoryZypper-163"><span class="linenos">163</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="RepositoryZypper-164"><a href="#RepositoryZypper-164"><span class="linenos">164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper-165"><a href="#RepositoryZypper-165"><span class="linenos">165</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span>
</span><span id="RepositoryZypper-166"><a href="#RepositoryZypper-166"><span class="linenos">166</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-167"><a href="#RepositoryZypper-167"><span class="linenos">167</span></a>
</span><span id="RepositoryZypper-168"><a href="#RepositoryZypper-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_write_runtime_config</span><span class="p">()</span>
</span><span id="RepositoryZypper-169"><a href="#RepositoryZypper-169"><span class="linenos">169</span></a>
</span><span id="RepositoryZypper-170"><a href="#RepositoryZypper-170"><span class="linenos">170</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_package_database_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-171"><a href="#RepositoryZypper-171"><span class="linenos">171</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-172"><a href="#RepositoryZypper-172"><span class="linenos">172</span></a><span class="sd">        Setup rpm macros for bootstrapping and image building</span>
</span><span id="RepositoryZypper-173"><a href="#RepositoryZypper-173"><span class="linenos">173</span></a>
</span><span id="RepositoryZypper-174"><a href="#RepositoryZypper-174"><span class="linenos">174</span></a><span class="sd">        1. Create the rpm image macro which persists during the build</span>
</span><span id="RepositoryZypper-175"><a href="#RepositoryZypper-175"><span class="linenos">175</span></a><span class="sd">        2. Create the rpm bootstrap macro to make sure for bootstrapping</span>
</span><span id="RepositoryZypper-176"><a href="#RepositoryZypper-176"><span class="linenos">176</span></a><span class="sd">           the rpm database location matches the host rpm database setup.</span>
</span><span id="RepositoryZypper-177"><a href="#RepositoryZypper-177"><span class="linenos">177</span></a><span class="sd">           This macro only persists during the bootstrap phase. If the</span>
</span><span id="RepositoryZypper-178"><a href="#RepositoryZypper-178"><span class="linenos">178</span></a><span class="sd">           image was already bootstrapped a compat link is created instead.</span>
</span><span id="RepositoryZypper-179"><a href="#RepositoryZypper-179"><span class="linenos">179</span></a><span class="sd">        3. Create zypper compat link</span>
</span><span id="RepositoryZypper-180"><a href="#RepositoryZypper-180"><span class="linenos">180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-181"><a href="#RepositoryZypper-181"><span class="linenos">181</span></a>        <span class="n">rpmdb</span> <span class="o">=</span> <span class="n">RpmDataBase</span><span class="p">(</span>
</span><span id="RepositoryZypper-182"><a href="#RepositoryZypper-182"><span class="linenos">182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_custom_rpm_image_macro_name</span><span class="p">()</span>
</span><span id="RepositoryZypper-183"><a href="#RepositoryZypper-183"><span class="linenos">183</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper-184"><a href="#RepositoryZypper-184"><span class="linenos">184</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">:</span>
</span><span id="RepositoryZypper-185"><a href="#RepositoryZypper-185"><span class="linenos">185</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">set_macro_from_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">)</span>
</span><span id="RepositoryZypper-186"><a href="#RepositoryZypper-186"><span class="linenos">186</span></a>        <span class="n">rpmdb</span><span class="o">.</span><span class="n">write_config</span><span class="p">()</span>
</span><span id="RepositoryZypper-187"><a href="#RepositoryZypper-187"><span class="linenos">187</span></a>
</span><span id="RepositoryZypper-188"><a href="#RepositoryZypper-188"><span class="linenos">188</span></a>        <span class="n">rpmdb</span> <span class="o">=</span> <span class="n">RpmDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="RepositoryZypper-189"><a href="#RepositoryZypper-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">has_rpm</span><span class="p">():</span>
</span><span id="RepositoryZypper-190"><a href="#RepositoryZypper-190"><span class="linenos">190</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">link_database_to_host_path</span><span class="p">()</span>
</span><span id="RepositoryZypper-191"><a href="#RepositoryZypper-191"><span class="linenos">191</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="RepositoryZypper-192"><a href="#RepositoryZypper-192"><span class="linenos">192</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">set_database_to_host_path</span><span class="p">()</span>
</span><span id="RepositoryZypper-193"><a href="#RepositoryZypper-193"><span class="linenos">193</span></a>        <span class="c1"># Zypper compat code:</span>
</span><span id="RepositoryZypper-194"><a href="#RepositoryZypper-194"><span class="linenos">194</span></a>        <span class="c1">#</span>
</span><span id="RepositoryZypper-195"><a href="#RepositoryZypper-195"><span class="linenos">195</span></a>        <span class="c1"># Manually adding the compat link /var/lib/rpm that points to the</span>
</span><span id="RepositoryZypper-196"><a href="#RepositoryZypper-196"><span class="linenos">196</span></a>        <span class="c1"># rpmdb location as it is configured in the host rpm setup. The</span>
</span><span id="RepositoryZypper-197"><a href="#RepositoryZypper-197"><span class="linenos">197</span></a>        <span class="c1"># host rpm setup is taken into account because import_trusted_keys</span>
</span><span id="RepositoryZypper-198"><a href="#RepositoryZypper-198"><span class="linenos">198</span></a>        <span class="c1"># is called during the bootstrap phase where rpm (respectively zypper)</span>
</span><span id="RepositoryZypper-199"><a href="#RepositoryZypper-199"><span class="linenos">199</span></a>        <span class="c1"># is called from the host</span>
</span><span id="RepositoryZypper-200"><a href="#RepositoryZypper-200"><span class="linenos">200</span></a>        <span class="c1">#</span>
</span><span id="RepositoryZypper-201"><a href="#RepositoryZypper-201"><span class="linenos">201</span></a>        <span class="c1"># Usually it is expected that the package manager reads the</span>
</span><span id="RepositoryZypper-202"><a href="#RepositoryZypper-202"><span class="linenos">202</span></a>        <span class="c1"># signing keys from the rpm database setup provisioned by rpm</span>
</span><span id="RepositoryZypper-203"><a href="#RepositoryZypper-203"><span class="linenos">203</span></a>        <span class="c1"># itself (macro level) but zypper doesn&#39;t take the rpm macro</span>
</span><span id="RepositoryZypper-204"><a href="#RepositoryZypper-204"><span class="linenos">204</span></a>        <span class="c1"># setup into account and relies on a hard coded path which we</span>
</span><span id="RepositoryZypper-205"><a href="#RepositoryZypper-205"><span class="linenos">205</span></a>        <span class="c1"># can only provide as a symlink.</span>
</span><span id="RepositoryZypper-206"><a href="#RepositoryZypper-206"><span class="linenos">206</span></a>        <span class="c1">#</span>
</span><span id="RepositoryZypper-207"><a href="#RepositoryZypper-207"><span class="linenos">207</span></a>        <span class="c1"># That symlink is usually created by the rpm package when it gets</span>
</span><span id="RepositoryZypper-208"><a href="#RepositoryZypper-208"><span class="linenos">208</span></a>        <span class="c1"># installed. However at that early phase when we import the</span>
</span><span id="RepositoryZypper-209"><a href="#RepositoryZypper-209"><span class="linenos">209</span></a>        <span class="c1"># signing keys no rpm is installed yet nor any symlink exists.</span>
</span><span id="RepositoryZypper-210"><a href="#RepositoryZypper-210"><span class="linenos">210</span></a>        <span class="c1"># Thus we have to create it here and hope to get rid of it in the</span>
</span><span id="RepositoryZypper-211"><a href="#RepositoryZypper-211"><span class="linenos">211</span></a>        <span class="c1"># future.</span>
</span><span id="RepositoryZypper-212"><a href="#RepositoryZypper-212"><span class="linenos">212</span></a>        <span class="c1">#</span>
</span><span id="RepositoryZypper-213"><a href="#RepositoryZypper-213"><span class="linenos">213</span></a>        <span class="c1"># For further details on the motivation in zypper please</span>
</span><span id="RepositoryZypper-214"><a href="#RepositoryZypper-214"><span class="linenos">214</span></a>        <span class="c1"># refer to bsc#1112357</span>
</span><span id="RepositoryZypper-215"><a href="#RepositoryZypper-215"><span class="linenos">215</span></a>        <span class="n">rpmdb</span><span class="o">.</span><span class="n">init_database</span><span class="p">()</span>
</span><span id="RepositoryZypper-216"><a href="#RepositoryZypper-216"><span class="linenos">216</span></a>        <span class="n">image_rpm_compat_link</span> <span class="o">=</span> <span class="s1">&#39;/var/lib/rpm&#39;</span>
</span><span id="RepositoryZypper-217"><a href="#RepositoryZypper-217"><span class="linenos">217</span></a>        <span class="n">host_rpm_dbpath</span> <span class="o">=</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">rpmdb_host</span><span class="o">.</span><span class="n">expand_query</span><span class="p">(</span><span class="s1">&#39;%_dbpath&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper-218"><a href="#RepositoryZypper-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="n">host_rpm_dbpath</span> <span class="o">!=</span> <span class="n">image_rpm_compat_link</span><span class="p">:</span>
</span><span id="RepositoryZypper-219"><a href="#RepositoryZypper-219"><span class="linenos">219</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="RepositoryZypper-220"><a href="#RepositoryZypper-220"><span class="linenos">220</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image_rpm_compat_link</span><span class="p">)</span>
</span><span id="RepositoryZypper-221"><a href="#RepositoryZypper-221"><span class="linenos">221</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-222"><a href="#RepositoryZypper-222"><span class="linenos">222</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RepositoryZypper-223"><a href="#RepositoryZypper-223"><span class="linenos">223</span></a>                <span class="p">[</span>
</span><span id="RepositoryZypper-224"><a href="#RepositoryZypper-224"><span class="linenos">224</span></a>                    <span class="s1">&#39;ln&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-target-directory&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper-225"><a href="#RepositoryZypper-225"><span class="linenos">225</span></a>                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;../..&#39;</span><span class="p">,</span> <span class="n">host_rpm_dbpath</span><span class="p">]),</span>
</span><span id="RepositoryZypper-226"><a href="#RepositoryZypper-226"><span class="linenos">226</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="n">image_rpm_compat_link</span>
</span><span id="RepositoryZypper-227"><a href="#RepositoryZypper-227"><span class="linenos">227</span></a>                <span class="p">],</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="RepositoryZypper-228"><a href="#RepositoryZypper-228"><span class="linenos">228</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-229"><a href="#RepositoryZypper-229"><span class="linenos">229</span></a>
</span><span id="RepositoryZypper-230"><a href="#RepositoryZypper-230"><span class="linenos">230</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">use_default_location</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-231"><a href="#RepositoryZypper-231"><span class="linenos">231</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-232"><a href="#RepositoryZypper-232"><span class="linenos">232</span></a><span class="sd">        Setup zypper repository operations to store all data</span>
</span><span id="RepositoryZypper-233"><a href="#RepositoryZypper-233"><span class="linenos">233</span></a><span class="sd">        in the default places</span>
</span><span id="RepositoryZypper-234"><a href="#RepositoryZypper-234"><span class="linenos">234</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-235"><a href="#RepositoryZypper-235"><span class="linenos">235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="RepositoryZypper-236"><a href="#RepositoryZypper-236"><span class="linenos">236</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/zypp/repos.d&#39;</span>
</span><span id="RepositoryZypper-237"><a href="#RepositoryZypper-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;credentials-dir&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="RepositoryZypper-238"><a href="#RepositoryZypper-238"><span class="linenos">238</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/zypp/credentials.d&#39;</span>
</span><span id="RepositoryZypper-239"><a href="#RepositoryZypper-239"><span class="linenos">239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="RepositoryZypper-240"><a href="#RepositoryZypper-240"><span class="linenos">240</span></a>            <span class="s1">&#39;--non-interactive&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper-241"><a href="#RepositoryZypper-241"><span class="linenos">241</span></a>        <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span>
</span><span id="RepositoryZypper-242"><a href="#RepositoryZypper-242"><span class="linenos">242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">LANG</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper-243"><a href="#RepositoryZypper-243"><span class="linenos">243</span></a>
</span><span id="RepositoryZypper-244"><a href="#RepositoryZypper-244"><span class="linenos">244</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">runtime_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="RepositoryZypper-245"><a href="#RepositoryZypper-245"><span class="linenos">245</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-246"><a href="#RepositoryZypper-246"><span class="linenos">246</span></a><span class="sd">        zypper runtime configuration and environment</span>
</span><span id="RepositoryZypper-247"><a href="#RepositoryZypper-247"><span class="linenos">247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-248"><a href="#RepositoryZypper-248"><span class="linenos">248</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="RepositoryZypper-249"><a href="#RepositoryZypper-249"><span class="linenos">249</span></a>            <span class="s1">&#39;zypper_args&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span><span class="p">,</span>
</span><span id="RepositoryZypper-250"><a href="#RepositoryZypper-250"><span class="linenos">250</span></a>            <span class="s1">&#39;command_env&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="RepositoryZypper-251"><a href="#RepositoryZypper-251"><span class="linenos">251</span></a>        <span class="p">}</span>
</span><span id="RepositoryZypper-252"><a href="#RepositoryZypper-252"><span class="linenos">252</span></a>
</span><span id="RepositoryZypper-253"><a href="#RepositoryZypper-253"><span class="linenos">253</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_repo</span><span class="p">(</span>
</span><span id="RepositoryZypper-254"><a href="#RepositoryZypper-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">repo_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;rpm-md&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper-255"><a href="#RepositoryZypper-255"><span class="linenos">255</span></a>        <span class="n">prio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dist</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">components</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RepositoryZypper-256"><a href="#RepositoryZypper-256"><span class="linenos">256</span></a>        <span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">credentials_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RepositoryZypper-257"><a href="#RepositoryZypper-257"><span class="linenos">257</span></a>        <span class="n">repo_gpgcheck</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pkg_gpgcheck</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="RepositoryZypper-258"><a href="#RepositoryZypper-258"><span class="linenos">258</span></a>        <span class="n">sourcetype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">customization_script</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RepositoryZypper-259"><a href="#RepositoryZypper-259"><span class="linenos">259</span></a>        <span class="n">architectures</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="RepositoryZypper-260"><a href="#RepositoryZypper-260"><span class="linenos">260</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-261"><a href="#RepositoryZypper-261"><span class="linenos">261</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-262"><a href="#RepositoryZypper-262"><span class="linenos">262</span></a><span class="sd">        Add zypper repository</span>
</span><span id="RepositoryZypper-263"><a href="#RepositoryZypper-263"><span class="linenos">263</span></a>
</span><span id="RepositoryZypper-264"><a href="#RepositoryZypper-264"><span class="linenos">264</span></a><span class="sd">        :param str name: repository name</span>
</span><span id="RepositoryZypper-265"><a href="#RepositoryZypper-265"><span class="linenos">265</span></a><span class="sd">        :param str uri: repository URI</span>
</span><span id="RepositoryZypper-266"><a href="#RepositoryZypper-266"><span class="linenos">266</span></a><span class="sd">        :param str repo_type: repostory type name</span>
</span><span id="RepositoryZypper-267"><a href="#RepositoryZypper-267"><span class="linenos">267</span></a><span class="sd">        :param int prio: zypper repostory priority</span>
</span><span id="RepositoryZypper-268"><a href="#RepositoryZypper-268"><span class="linenos">268</span></a><span class="sd">        :param str dist: unused</span>
</span><span id="RepositoryZypper-269"><a href="#RepositoryZypper-269"><span class="linenos">269</span></a><span class="sd">        :param str components: unused</span>
</span><span id="RepositoryZypper-270"><a href="#RepositoryZypper-270"><span class="linenos">270</span></a><span class="sd">        :param str user: credentials username</span>
</span><span id="RepositoryZypper-271"><a href="#RepositoryZypper-271"><span class="linenos">271</span></a><span class="sd">        :param str secret: credentials password</span>
</span><span id="RepositoryZypper-272"><a href="#RepositoryZypper-272"><span class="linenos">272</span></a><span class="sd">        :param str credentials_file: zypper credentials file</span>
</span><span id="RepositoryZypper-273"><a href="#RepositoryZypper-273"><span class="linenos">273</span></a><span class="sd">        :param bool repo_gpgcheck: enable repository signature validation</span>
</span><span id="RepositoryZypper-274"><a href="#RepositoryZypper-274"><span class="linenos">274</span></a><span class="sd">        :param bool pkg_gpgcheck: enable package signature validation</span>
</span><span id="RepositoryZypper-275"><a href="#RepositoryZypper-275"><span class="linenos">275</span></a><span class="sd">        :param str sourcetype: unused</span>
</span><span id="RepositoryZypper-276"><a href="#RepositoryZypper-276"><span class="linenos">276</span></a><span class="sd">        :param str customization_script:</span>
</span><span id="RepositoryZypper-277"><a href="#RepositoryZypper-277"><span class="linenos">277</span></a><span class="sd">            custom script called after the repo file was created</span>
</span><span id="RepositoryZypper-278"><a href="#RepositoryZypper-278"><span class="linenos">278</span></a><span class="sd">        :param str architectures: unused</span>
</span><span id="RepositoryZypper-279"><a href="#RepositoryZypper-279"><span class="linenos">279</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-280"><a href="#RepositoryZypper-280"><span class="linenos">280</span></a>        <span class="k">if</span> <span class="n">credentials_file</span><span class="p">:</span>
</span><span id="RepositoryZypper-281"><a href="#RepositoryZypper-281"><span class="linenos">281</span></a>            <span class="n">repo_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper-282"><a href="#RepositoryZypper-282"><span class="linenos">282</span></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;credentials-dir&#39;</span><span class="p">],</span> <span class="n">credentials_file</span><span class="p">]</span>
</span><span id="RepositoryZypper-283"><a href="#RepositoryZypper-283"><span class="linenos">283</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-284"><a href="#RepositoryZypper-284"><span class="linenos">284</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">repo_secret</span><span class="p">):</span>
</span><span id="RepositoryZypper-285"><a href="#RepositoryZypper-285"><span class="linenos">285</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">repo_secret</span><span class="p">)</span>
</span><span id="RepositoryZypper-286"><a href="#RepositoryZypper-286"><span class="linenos">286</span></a>
</span><span id="RepositoryZypper-287"><a href="#RepositoryZypper-287"><span class="linenos">287</span></a>            <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">secret</span><span class="p">:</span>
</span><span id="RepositoryZypper-288"><a href="#RepositoryZypper-288"><span class="linenos">288</span></a>                <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">uri</span><span class="p">,</span> <span class="s1">&#39;?credentials=&#39;</span><span class="p">,</span> <span class="n">credentials_file</span><span class="p">])</span>
</span><span id="RepositoryZypper-289"><a href="#RepositoryZypper-289"><span class="linenos">289</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">repo_secret</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">credentials</span><span class="p">:</span>
</span><span id="RepositoryZypper-290"><a href="#RepositoryZypper-290"><span class="linenos">290</span></a>                    <span class="n">credentials</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;username=</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="RepositoryZypper-291"><a href="#RepositoryZypper-291"><span class="linenos">291</span></a>                        <span class="n">user</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="RepositoryZypper-292"><a href="#RepositoryZypper-292"><span class="linenos">292</span></a>                    <span class="p">)</span>
</span><span id="RepositoryZypper-293"><a href="#RepositoryZypper-293"><span class="linenos">293</span></a>                    <span class="n">credentials</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;password=</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="RepositoryZypper-294"><a href="#RepositoryZypper-294"><span class="linenos">294</span></a>                        <span class="n">secret</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="RepositoryZypper-295"><a href="#RepositoryZypper-295"><span class="linenos">295</span></a>                    <span class="p">)</span>
</span><span id="RepositoryZypper-296"><a href="#RepositoryZypper-296"><span class="linenos">296</span></a>
</span><span id="RepositoryZypper-297"><a href="#RepositoryZypper-297"><span class="linenos">297</span></a>        <span class="n">repo_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper-298"><a href="#RepositoryZypper-298"><span class="linenos">298</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;.repo&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper-299"><a href="#RepositoryZypper-299"><span class="linenos">299</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper-300"><a href="#RepositoryZypper-300"><span class="linenos">300</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">repo_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;.repo&#39;</span><span class="p">]))</span>
</span><span id="RepositoryZypper-301"><a href="#RepositoryZypper-301"><span class="linenos">301</span></a>
</span><span id="RepositoryZypper-302"><a href="#RepositoryZypper-302"><span class="linenos">302</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">repo_file</span><span class="p">):</span>
</span><span id="RepositoryZypper-303"><a href="#RepositoryZypper-303"><span class="linenos">303</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">repo_file</span><span class="p">)</span>
</span><span id="RepositoryZypper-304"><a href="#RepositoryZypper-304"><span class="linenos">304</span></a>
</span><span id="RepositoryZypper-305"><a href="#RepositoryZypper-305"><span class="linenos">305</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_backup_package_cache</span><span class="p">()</span>
</span><span id="RepositoryZypper-306"><a href="#RepositoryZypper-306"><span class="linenos">306</span></a>        <span class="n">zypper_addrepo_command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;zypper&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="RepositoryZypper-307"><a href="#RepositoryZypper-307"><span class="linenos">307</span></a>            <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="RepositoryZypper-308"><a href="#RepositoryZypper-308"><span class="linenos">308</span></a>            <span class="s1">&#39;addrepo&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper-309"><a href="#RepositoryZypper-309"><span class="linenos">309</span></a>            <span class="s1">&#39;--refresh&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper-310"><a href="#RepositoryZypper-310"><span class="linenos">310</span></a>            <span class="s1">&#39;--keep-packages&#39;</span> <span class="k">if</span> <span class="n">Uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">is_remote</span><span class="p">()</span> <span class="k">else</span>
</span><span id="RepositoryZypper-311"><a href="#RepositoryZypper-311"><span class="linenos">311</span></a>            <span class="s1">&#39;--no-keep-packages&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper-312"><a href="#RepositoryZypper-312"><span class="linenos">312</span></a>            <span class="s1">&#39;--no-check&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper-313"><a href="#RepositoryZypper-313"><span class="linenos">313</span></a>            <span class="n">uri</span><span class="p">,</span>
</span><span id="RepositoryZypper-314"><a href="#RepositoryZypper-314"><span class="linenos">314</span></a>            <span class="n">name</span>
</span><span id="RepositoryZypper-315"><a href="#RepositoryZypper-315"><span class="linenos">315</span></a>        <span class="p">]</span>
</span><span id="RepositoryZypper-316"><a href="#RepositoryZypper-316"><span class="linenos">316</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="RepositoryZypper-317"><a href="#RepositoryZypper-317"><span class="linenos">317</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RepositoryZypper-318"><a href="#RepositoryZypper-318"><span class="linenos">318</span></a>                <span class="n">zypper_addrepo_command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="RepositoryZypper-319"><a href="#RepositoryZypper-319"><span class="linenos">319</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-320"><a href="#RepositoryZypper-320"><span class="linenos">320</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="RepositoryZypper-321"><a href="#RepositoryZypper-321"><span class="linenos">321</span></a>            <span class="c1"># for whatever reason zypper sometimes failes with</span>
</span><span id="RepositoryZypper-322"><a href="#RepositoryZypper-322"><span class="linenos">322</span></a>            <span class="c1"># a &#39;failed to cache rpm database&#39; error. I could not</span>
</span><span id="RepositoryZypper-323"><a href="#RepositoryZypper-323"><span class="linenos">323</span></a>            <span class="c1"># find any reason why and a simple recall of the exact</span>
</span><span id="RepositoryZypper-324"><a href="#RepositoryZypper-324"><span class="linenos">324</span></a>            <span class="c1"># same command in the exact same environment works.</span>
</span><span id="RepositoryZypper-325"><a href="#RepositoryZypper-325"><span class="linenos">325</span></a>            <span class="c1"># Thus the stupid but simple workaround to this problem</span>
</span><span id="RepositoryZypper-326"><a href="#RepositoryZypper-326"><span class="linenos">326</span></a>            <span class="c1"># is try one recall before really failing</span>
</span><span id="RepositoryZypper-327"><a href="#RepositoryZypper-327"><span class="linenos">327</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RepositoryZypper-328"><a href="#RepositoryZypper-328"><span class="linenos">328</span></a>                <span class="n">zypper_addrepo_command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="RepositoryZypper-329"><a href="#RepositoryZypper-329"><span class="linenos">329</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-330"><a href="#RepositoryZypper-330"><span class="linenos">330</span></a>
</span><span id="RepositoryZypper-331"><a href="#RepositoryZypper-331"><span class="linenos">331</span></a>        <span class="n">repo_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="RepositoryZypper-332"><a href="#RepositoryZypper-332"><span class="linenos">332</span></a>        <span class="n">repo_config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">repo_file</span><span class="p">)</span>
</span><span id="RepositoryZypper-333"><a href="#RepositoryZypper-333"><span class="linenos">333</span></a>
</span><span id="RepositoryZypper-334"><a href="#RepositoryZypper-334"><span class="linenos">334</span></a>        <span class="n">baseurl</span> <span class="o">=</span> <span class="n">uri</span>
</span><span id="RepositoryZypper-335"><a href="#RepositoryZypper-335"><span class="linenos">335</span></a>        <span class="n">uri_with_credentials_pattern</span> <span class="o">=</span> <span class="s1">&#39;^(.*):(.*)@(.*)$&#39;</span>
</span><span id="RepositoryZypper-336"><a href="#RepositoryZypper-336"><span class="linenos">336</span></a>        <span class="n">sensitive_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">uri_with_credentials_pattern</span><span class="p">,</span> <span class="n">baseurl</span><span class="p">)</span>
</span><span id="RepositoryZypper-337"><a href="#RepositoryZypper-337"><span class="linenos">337</span></a>        <span class="k">if</span> <span class="n">sensitive_match</span><span class="p">:</span>
</span><span id="RepositoryZypper-338"><a href="#RepositoryZypper-338"><span class="linenos">338</span></a>            <span class="c1"># rewrite baseurl with credentials information because zypper</span>
</span><span id="RepositoryZypper-339"><a href="#RepositoryZypper-339"><span class="linenos">339</span></a>            <span class="c1"># addrepo does strange things with the provided url encoded data</span>
</span><span id="RepositoryZypper-340"><a href="#RepositoryZypper-340"><span class="linenos">340</span></a>            <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;baseurl&#39;</span><span class="p">,</span> <span class="n">baseurl</span><span class="p">)</span>
</span><span id="RepositoryZypper-341"><a href="#RepositoryZypper-341"><span class="linenos">341</span></a>
</span><span id="RepositoryZypper-342"><a href="#RepositoryZypper-342"><span class="linenos">342</span></a>        <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper-343"><a href="#RepositoryZypper-343"><span class="linenos">343</span></a>            <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;repo_gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="n">repo_gpgcheck</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
</span><span id="RepositoryZypper-344"><a href="#RepositoryZypper-344"><span class="linenos">344</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper-345"><a href="#RepositoryZypper-345"><span class="linenos">345</span></a>        <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper-346"><a href="#RepositoryZypper-346"><span class="linenos">346</span></a>            <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;pkg_gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="n">pkg_gpgcheck</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
</span><span id="RepositoryZypper-347"><a href="#RepositoryZypper-347"><span class="linenos">347</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper-348"><a href="#RepositoryZypper-348"><span class="linenos">348</span></a>        <span class="k">if</span> <span class="n">prio</span><span class="p">:</span>
</span><span id="RepositoryZypper-349"><a href="#RepositoryZypper-349"><span class="linenos">349</span></a>            <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper-350"><a href="#RepositoryZypper-350"><span class="linenos">350</span></a>                <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">prio</span><span class="p">)</span>
</span><span id="RepositoryZypper-351"><a href="#RepositoryZypper-351"><span class="linenos">351</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-352"><a href="#RepositoryZypper-352"><span class="linenos">352</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">repo_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">repo</span><span class="p">:</span>
</span><span id="RepositoryZypper-353"><a href="#RepositoryZypper-353"><span class="linenos">353</span></a>            <span class="n">repo_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
</span><span id="RepositoryZypper-354"><a href="#RepositoryZypper-354"><span class="linenos">354</span></a>        <span class="k">if</span> <span class="n">customization_script</span><span class="p">:</span>
</span><span id="RepositoryZypper-355"><a href="#RepositoryZypper-355"><span class="linenos">355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">run_repo_customize</span><span class="p">(</span><span class="n">customization_script</span><span class="p">,</span> <span class="n">repo_file</span><span class="p">)</span>
</span><span id="RepositoryZypper-356"><a href="#RepositoryZypper-356"><span class="linenos">356</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_package_cache</span><span class="p">()</span>
</span><span id="RepositoryZypper-357"><a href="#RepositoryZypper-357"><span class="linenos">357</span></a>
</span><span id="RepositoryZypper-358"><a href="#RepositoryZypper-358"><span class="linenos">358</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_trusted_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signing_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-359"><a href="#RepositoryZypper-359"><span class="linenos">359</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-360"><a href="#RepositoryZypper-360"><span class="linenos">360</span></a><span class="sd">        Imports trusted keys into the image</span>
</span><span id="RepositoryZypper-361"><a href="#RepositoryZypper-361"><span class="linenos">361</span></a>
</span><span id="RepositoryZypper-362"><a href="#RepositoryZypper-362"><span class="linenos">362</span></a><span class="sd">        :param list signing_keys: list of the key files to import</span>
</span><span id="RepositoryZypper-363"><a href="#RepositoryZypper-363"><span class="linenos">363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-364"><a href="#RepositoryZypper-364"><span class="linenos">364</span></a>        <span class="n">rpmdb</span> <span class="o">=</span> <span class="n">RpmDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="RepositoryZypper-365"><a href="#RepositoryZypper-365"><span class="linenos">365</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">signing_keys</span><span class="p">:</span>
</span><span id="RepositoryZypper-366"><a href="#RepositoryZypper-366"><span class="linenos">366</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">import_signing_key_to_image</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="RepositoryZypper-367"><a href="#RepositoryZypper-367"><span class="linenos">367</span></a>
</span><span id="RepositoryZypper-368"><a href="#RepositoryZypper-368"><span class="linenos">368</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-369"><a href="#RepositoryZypper-369"><span class="linenos">369</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-370"><a href="#RepositoryZypper-370"><span class="linenos">370</span></a><span class="sd">        Delete zypper repository</span>
</span><span id="RepositoryZypper-371"><a href="#RepositoryZypper-371"><span class="linenos">371</span></a>
</span><span id="RepositoryZypper-372"><a href="#RepositoryZypper-372"><span class="linenos">372</span></a><span class="sd">        :param str name: repository name</span>
</span><span id="RepositoryZypper-373"><a href="#RepositoryZypper-373"><span class="linenos">373</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-374"><a href="#RepositoryZypper-374"><span class="linenos">374</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RepositoryZypper-375"><a href="#RepositoryZypper-375"><span class="linenos">375</span></a>            <span class="p">[</span><span class="s1">&#39;zypper&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="RepositoryZypper-376"><a href="#RepositoryZypper-376"><span class="linenos">376</span></a>                <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;removerepo&#39;</span><span class="p">,</span> <span class="n">name</span>
</span><span id="RepositoryZypper-377"><a href="#RepositoryZypper-377"><span class="linenos">377</span></a>            <span class="p">],</span>
</span><span id="RepositoryZypper-378"><a href="#RepositoryZypper-378"><span class="linenos">378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="RepositoryZypper-379"><a href="#RepositoryZypper-379"><span class="linenos">379</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper-380"><a href="#RepositoryZypper-380"><span class="linenos">380</span></a>
</span><span id="RepositoryZypper-381"><a href="#RepositoryZypper-381"><span class="linenos">381</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_all_repos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-382"><a href="#RepositoryZypper-382"><span class="linenos">382</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-383"><a href="#RepositoryZypper-383"><span class="linenos">383</span></a><span class="sd">        Delete all zypper repositories</span>
</span><span id="RepositoryZypper-384"><a href="#RepositoryZypper-384"><span class="linenos">384</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-385"><a href="#RepositoryZypper-385"><span class="linenos">385</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">])</span>
</span><span id="RepositoryZypper-386"><a href="#RepositoryZypper-386"><span class="linenos">386</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">])</span>
</span><span id="RepositoryZypper-387"><a href="#RepositoryZypper-387"><span class="linenos">387</span></a>
</span><span id="RepositoryZypper-388"><a href="#RepositoryZypper-388"><span class="linenos">388</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_repo_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-389"><a href="#RepositoryZypper-389"><span class="linenos">389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-390"><a href="#RepositoryZypper-390"><span class="linenos">390</span></a><span class="sd">        Delete zypper repository cache</span>
</span><span id="RepositoryZypper-391"><a href="#RepositoryZypper-391"><span class="linenos">391</span></a>
</span><span id="RepositoryZypper-392"><a href="#RepositoryZypper-392"><span class="linenos">392</span></a><span class="sd">        The cache data for each repository is stored in a list of</span>
</span><span id="RepositoryZypper-393"><a href="#RepositoryZypper-393"><span class="linenos">393</span></a><span class="sd">        directories of the same name as the repository name. The method</span>
</span><span id="RepositoryZypper-394"><a href="#RepositoryZypper-394"><span class="linenos">394</span></a><span class="sd">        deletes these directories to cleanup the cache information</span>
</span><span id="RepositoryZypper-395"><a href="#RepositoryZypper-395"><span class="linenos">395</span></a>
</span><span id="RepositoryZypper-396"><a href="#RepositoryZypper-396"><span class="linenos">396</span></a><span class="sd">        :param str name: repository name</span>
</span><span id="RepositoryZypper-397"><a href="#RepositoryZypper-397"><span class="linenos">397</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-398"><a href="#RepositoryZypper-398"><span class="linenos">398</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span>
</span><span id="RepositoryZypper-399"><a href="#RepositoryZypper-399"><span class="linenos">399</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;pkg-cache-dir&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">])</span>
</span><span id="RepositoryZypper-400"><a href="#RepositoryZypper-400"><span class="linenos">400</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper-401"><a href="#RepositoryZypper-401"><span class="linenos">401</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span>
</span><span id="RepositoryZypper-402"><a href="#RepositoryZypper-402"><span class="linenos">402</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">])</span>
</span><span id="RepositoryZypper-403"><a href="#RepositoryZypper-403"><span class="linenos">403</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper-404"><a href="#RepositoryZypper-404"><span class="linenos">404</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span>
</span><span id="RepositoryZypper-405"><a href="#RepositoryZypper-405"><span class="linenos">405</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;raw-cache-dir&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">])</span>
</span><span id="RepositoryZypper-406"><a href="#RepositoryZypper-406"><span class="linenos">406</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper-407"><a href="#RepositoryZypper-407"><span class="linenos">407</span></a>
</span><span id="RepositoryZypper-408"><a href="#RepositoryZypper-408"><span class="linenos">408</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_unused_repos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-409"><a href="#RepositoryZypper-409"><span class="linenos">409</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-410"><a href="#RepositoryZypper-410"><span class="linenos">410</span></a><span class="sd">        Delete unused zypper repositories</span>
</span><span id="RepositoryZypper-411"><a href="#RepositoryZypper-411"><span class="linenos">411</span></a>
</span><span id="RepositoryZypper-412"><a href="#RepositoryZypper-412"><span class="linenos">412</span></a><span class="sd">        zypper creates a system solvable which is unwanted for the</span>
</span><span id="RepositoryZypper-413"><a href="#RepositoryZypper-413"><span class="linenos">413</span></a><span class="sd">        purpose of building images. In addition zypper fails with</span>
</span><span id="RepositoryZypper-414"><a href="#RepositoryZypper-414"><span class="linenos">414</span></a><span class="sd">        an error message &#39;Failed to cache rpm database&#39; if such a</span>
</span><span id="RepositoryZypper-415"><a href="#RepositoryZypper-415"><span class="linenos">415</span></a><span class="sd">        system solvable exists and a new root system is created</span>
</span><span id="RepositoryZypper-416"><a href="#RepositoryZypper-416"><span class="linenos">416</span></a>
</span><span id="RepositoryZypper-417"><a href="#RepositoryZypper-417"><span class="linenos">417</span></a><span class="sd">        All other repository configurations which are not used for</span>
</span><span id="RepositoryZypper-418"><a href="#RepositoryZypper-418"><span class="linenos">418</span></a><span class="sd">        this build must be removed too, otherwise they are taken into</span>
</span><span id="RepositoryZypper-419"><a href="#RepositoryZypper-419"><span class="linenos">419</span></a><span class="sd">        account for the package installations</span>
</span><span id="RepositoryZypper-420"><a href="#RepositoryZypper-420"><span class="linenos">420</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-421"><a href="#RepositoryZypper-421"><span class="linenos">421</span></a>        <span class="n">solv_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper-422"><a href="#RepositoryZypper-422"><span class="linenos">422</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">solv_dir</span> <span class="o">+</span> <span class="s1">&#39;/@System&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper-423"><a href="#RepositoryZypper-423"><span class="linenos">423</span></a>
</span><span id="RepositoryZypper-424"><a href="#RepositoryZypper-424"><span class="linenos">424</span></a>        <span class="n">repos_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper-425"><a href="#RepositoryZypper-425"><span class="linenos">425</span></a>        <span class="n">repo_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">repos_dir</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="RepositoryZypper-426"><a href="#RepositoryZypper-426"><span class="linenos">426</span></a>        <span class="k">for</span> <span class="n">repo_file</span> <span class="ow">in</span> <span class="n">repo_files</span><span class="p">:</span>
</span><span id="RepositoryZypper-427"><a href="#RepositoryZypper-427"><span class="linenos">427</span></a>            <span class="k">if</span> <span class="n">repo_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_names</span><span class="p">:</span>
</span><span id="RepositoryZypper-428"><a href="#RepositoryZypper-428"><span class="linenos">428</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">repos_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">repo_file</span><span class="p">)</span>
</span><span id="RepositoryZypper-429"><a href="#RepositoryZypper-429"><span class="linenos">429</span></a>
</span><span id="RepositoryZypper-430"><a href="#RepositoryZypper-430"><span class="linenos">430</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_zypper_runtime_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="RepositoryZypper-431"><a href="#RepositoryZypper-431"><span class="linenos">431</span></a>        <span class="k">for</span> <span class="n">zypper_dir</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="RepositoryZypper-432"><a href="#RepositoryZypper-432"><span class="linenos">432</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">zypper_dir</span><span class="p">)</span>
</span><span id="RepositoryZypper-433"><a href="#RepositoryZypper-433"><span class="linenos">433</span></a>        <span class="n">ToEnv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">PACKAGE_MANAGER_ENV_VARS</span><span class="p">)</span>
</span><span id="RepositoryZypper-434"><a href="#RepositoryZypper-434"><span class="linenos">434</span></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="RepositoryZypper-435"><a href="#RepositoryZypper-435"><span class="linenos">435</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span>
</span><span id="RepositoryZypper-436"><a href="#RepositoryZypper-436"><span class="linenos">436</span></a>            <span class="n">LANG</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper-437"><a href="#RepositoryZypper-437"><span class="linenos">437</span></a>            <span class="n">ZYPP_CONF</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span><span class="o">.</span><span class="n">name</span>
</span><span id="RepositoryZypper-438"><a href="#RepositoryZypper-438"><span class="linenos">438</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper-439"><a href="#RepositoryZypper-439"><span class="linenos">439</span></a>
</span><span id="RepositoryZypper-440"><a href="#RepositoryZypper-440"><span class="linenos">440</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_write_runtime_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-441"><a href="#RepositoryZypper-441"><span class="linenos">441</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
</span><span id="RepositoryZypper-442"><a href="#RepositoryZypper-442"><span class="linenos">442</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="RepositoryZypper-443"><a href="#RepositoryZypper-443"><span class="linenos">443</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
</span><span id="RepositoryZypper-444"><a href="#RepositoryZypper-444"><span class="linenos">444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="RepositoryZypper-445"><a href="#RepositoryZypper-445"><span class="linenos">445</span></a>
</span><span id="RepositoryZypper-446"><a href="#RepositoryZypper-446"><span class="linenos">446</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_backup_package_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-447"><a href="#RepositoryZypper-447"><span class="linenos">447</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-448"><a href="#RepositoryZypper-448"><span class="linenos">448</span></a><span class="sd">        preserve package cache which otherwise will be removed by</span>
</span><span id="RepositoryZypper-449"><a href="#RepositoryZypper-449"><span class="linenos">449</span></a><span class="sd">        zypper if no repo file is found. But this situation is</span>
</span><span id="RepositoryZypper-450"><a href="#RepositoryZypper-450"><span class="linenos">450</span></a><span class="sd">        normal for an image build process which setup and remove</span>
</span><span id="RepositoryZypper-451"><a href="#RepositoryZypper-451"><span class="linenos">451</span></a><span class="sd">        repos for building at runtime</span>
</span><span id="RepositoryZypper-452"><a href="#RepositoryZypper-452"><span class="linenos">452</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-453"><a href="#RepositoryZypper-453"><span class="linenos">453</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_move_package_cache</span><span class="p">(</span><span class="n">backup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="RepositoryZypper-454"><a href="#RepositoryZypper-454"><span class="linenos">454</span></a>
</span><span id="RepositoryZypper-455"><a href="#RepositoryZypper-455"><span class="linenos">455</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_restore_package_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-456"><a href="#RepositoryZypper-456"><span class="linenos">456</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-457"><a href="#RepositoryZypper-457"><span class="linenos">457</span></a><span class="sd">        restore preserved package cache at the location passed to zypper</span>
</span><span id="RepositoryZypper-458"><a href="#RepositoryZypper-458"><span class="linenos">458</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-459"><a href="#RepositoryZypper-459"><span class="linenos">459</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_move_package_cache</span><span class="p">(</span><span class="n">restore</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="RepositoryZypper-460"><a href="#RepositoryZypper-460"><span class="linenos">460</span></a>
</span><span id="RepositoryZypper-461"><a href="#RepositoryZypper-461"><span class="linenos">461</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_move_package_cache</span><span class="p">(</span>
</span><span id="RepositoryZypper-462"><a href="#RepositoryZypper-462"><span class="linenos">462</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">backup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">restore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="RepositoryZypper-463"><a href="#RepositoryZypper-463"><span class="linenos">463</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-464"><a href="#RepositoryZypper-464"><span class="linenos">464</span></a>        <span class="n">package_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_location</span> <span class="o">+</span> <span class="s1">&#39;/packages&#39;</span>
</span><span id="RepositoryZypper-465"><a href="#RepositoryZypper-465"><span class="linenos">465</span></a>        <span class="n">package_cache_moved</span> <span class="o">=</span> <span class="n">package_cache</span> <span class="o">+</span> <span class="s1">&#39;.moved&#39;</span>
</span><span id="RepositoryZypper-466"><a href="#RepositoryZypper-466"><span class="linenos">466</span></a>        <span class="k">if</span> <span class="n">backup</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">package_cache</span><span class="p">):</span>
</span><span id="RepositoryZypper-467"><a href="#RepositoryZypper-467"><span class="linenos">467</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RepositoryZypper-468"><a href="#RepositoryZypper-468"><span class="linenos">468</span></a>                <span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">package_cache</span><span class="p">,</span> <span class="n">package_cache_moved</span><span class="p">]</span>
</span><span id="RepositoryZypper-469"><a href="#RepositoryZypper-469"><span class="linenos">469</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-470"><a href="#RepositoryZypper-470"><span class="linenos">470</span></a>        <span class="k">elif</span> <span class="n">restore</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">package_cache_moved</span><span class="p">):</span>
</span><span id="RepositoryZypper-471"><a href="#RepositoryZypper-471"><span class="linenos">471</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RepositoryZypper-472"><a href="#RepositoryZypper-472"><span class="linenos">472</span></a>                <span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">package_cache_moved</span><span class="p">,</span> <span class="n">package_cache</span><span class="p">]</span>
</span><span id="RepositoryZypper-473"><a href="#RepositoryZypper-473"><span class="linenos">473</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper-474"><a href="#RepositoryZypper-474"><span class="linenos">474</span></a>
</span><span id="RepositoryZypper-475"><a href="#RepositoryZypper-475"><span class="linenos">475</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper-476"><a href="#RepositoryZypper-476"><span class="linenos">476</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-477"><a href="#RepositoryZypper-477"><span class="linenos">477</span></a><span class="sd">        Delete intermediate zypp and zypper config files</span>
</span><span id="RepositoryZypper-478"><a href="#RepositoryZypper-478"><span class="linenos">478</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper-479"><a href="#RepositoryZypper-479"><span class="linenos">479</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
</span><span id="RepositoryZypper-480"><a href="#RepositoryZypper-480"><span class="linenos">480</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="RepositoryZypper-481"><a href="#RepositoryZypper-481"><span class="linenos">481</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
</span><span id="RepositoryZypper-482"><a href="#RepositoryZypper-482"><span class="linenos">482</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="RepositoryZypper-483"><a href="#RepositoryZypper-483"><span class="linenos">483</span></a>
</span><span id="RepositoryZypper-484"><a href="#RepositoryZypper-484"><span class="linenos">484</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
</span><span id="RepositoryZypper-485"><a href="#RepositoryZypper-485"><span class="linenos">485</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_package_cache</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p><strong>Implements repo handling for zypper package manager</strong></p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str shared_zypper_dir</strong>:  shared directory between image root
and build system root</li>
<li><strong>str runtime_zypper_config_file</strong>:  zypper runtime config file name</li>
<li><strong>str runtime_zypp_config_file</strong>:  libzypp runtime config file name</li>
<li><strong>list zypper_args</strong>:  zypper caller args plus additional custom args</li>
<li><strong>dict command_env</strong>:  customized os.environ for zypper</li>
<li><strong>object runtime_zypper_config</strong>:  instance of <code>ConfigParser</code></li>
</ul>
</div>


                            <div id="RepositoryZypper.post_init" class="classattr">
                                        <input id="RepositoryZypper.post_init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">post_init</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">custom_args</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="RepositoryZypper.post_init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper.post_init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper.post_init-51"><a href="#RepositoryZypper.post_init-51"><span class="linenos"> 51</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_args</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-52"><a href="#RepositoryZypper.post_init-52"><span class="linenos"> 52</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.post_init-53"><a href="#RepositoryZypper.post_init-53"><span class="linenos"> 53</span></a><span class="sd">        Post initialization method</span>
</span><span id="RepositoryZypper.post_init-54"><a href="#RepositoryZypper.post_init-54"><span class="linenos"> 54</span></a>
</span><span id="RepositoryZypper.post_init-55"><a href="#RepositoryZypper.post_init-55"><span class="linenos"> 55</span></a><span class="sd">        Store custom zypper arguments and create runtime configuration</span>
</span><span id="RepositoryZypper.post_init-56"><a href="#RepositoryZypper.post_init-56"><span class="linenos"> 56</span></a><span class="sd">        and environment</span>
</span><span id="RepositoryZypper.post_init-57"><a href="#RepositoryZypper.post_init-57"><span class="linenos"> 57</span></a>
</span><span id="RepositoryZypper.post_init-58"><a href="#RepositoryZypper.post_init-58"><span class="linenos"> 58</span></a><span class="sd">        :param list custom_args: zypper arguments</span>
</span><span id="RepositoryZypper.post_init-59"><a href="#RepositoryZypper.post_init-59"><span class="linenos"> 59</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.post_init-60"><a href="#RepositoryZypper.post_init-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span> <span class="o">=</span> <span class="n">TmpT</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper.post_init-61"><a href="#RepositoryZypper.post_init-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span> <span class="o">=</span> <span class="n">TmpT</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper.post_init-62"><a href="#RepositoryZypper.post_init-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span> <span class="o">=</span> <span class="n">custom_args</span>
</span><span id="RepositoryZypper.post_init-63"><a href="#RepositoryZypper.post_init-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_docs</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="RepositoryZypper.post_init-64"><a href="#RepositoryZypper.post_init-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gpgcheck</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="RepositoryZypper.post_init-65"><a href="#RepositoryZypper.post_init-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="RepositoryZypper.post_init-66"><a href="#RepositoryZypper.post_init-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="RepositoryZypper.post_init-67"><a href="#RepositoryZypper.post_init-67"><span class="linenos"> 67</span></a>
</span><span id="RepositoryZypper.post_init-68"><a href="#RepositoryZypper.post_init-68"><span class="linenos"> 68</span></a>        <span class="c1"># extract custom arguments used for zypp config only</span>
</span><span id="RepositoryZypper.post_init-69"><a href="#RepositoryZypper.post_init-69"><span class="linenos"> 69</span></a>        <span class="k">if</span> <span class="s1">&#39;exclude_docs&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-70"><a href="#RepositoryZypper.post_init-70"><span class="linenos"> 70</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;exclude_docs&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper.post_init-71"><a href="#RepositoryZypper.post_init-71"><span class="linenos"> 71</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exclude_docs</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="RepositoryZypper.post_init-72"><a href="#RepositoryZypper.post_init-72"><span class="linenos"> 72</span></a>
</span><span id="RepositoryZypper.post_init-73"><a href="#RepositoryZypper.post_init-73"><span class="linenos"> 73</span></a>        <span class="k">if</span> <span class="s1">&#39;check_signatures&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-74"><a href="#RepositoryZypper.post_init-74"><span class="linenos"> 74</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;check_signatures&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper.post_init-75"><a href="#RepositoryZypper.post_init-75"><span class="linenos"> 75</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gpgcheck</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="RepositoryZypper.post_init-76"><a href="#RepositoryZypper.post_init-76"><span class="linenos"> 76</span></a>
</span><span id="RepositoryZypper.post_init-77"><a href="#RepositoryZypper.post_init-77"><span class="linenos"> 77</span></a>        <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-78"><a href="#RepositoryZypper.post_init-78"><span class="linenos"> 78</span></a>            <span class="k">if</span> <span class="s1">&#39;_install_langs&#39;</span> <span class="ow">in</span> <span class="n">argument</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-79"><a href="#RepositoryZypper.post_init-79"><span class="linenos"> 79</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="n">argument</span>
</span><span id="RepositoryZypper.post_init-80"><a href="#RepositoryZypper.post_init-80"><span class="linenos"> 80</span></a>            <span class="k">elif</span> <span class="s1">&#39;_target_arch&#39;</span> <span class="ow">in</span> <span class="n">argument</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-81"><a href="#RepositoryZypper.post_init-81"><span class="linenos"> 81</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="o">=</span> <span class="n">argument</span>
</span><span id="RepositoryZypper.post_init-82"><a href="#RepositoryZypper.post_init-82"><span class="linenos"> 82</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-83"><a href="#RepositoryZypper.post_init-83"><span class="linenos"> 83</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">)</span>
</span><span id="RepositoryZypper.post_init-84"><a href="#RepositoryZypper.post_init-84"><span class="linenos"> 84</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-85"><a href="#RepositoryZypper.post_init-85"><span class="linenos"> 85</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="p">)</span>
</span><span id="RepositoryZypper.post_init-86"><a href="#RepositoryZypper.post_init-86"><span class="linenos"> 86</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="RepositoryZypper.post_init-87"><a href="#RepositoryZypper.post_init-87"><span class="linenos"> 87</span></a>
</span><span id="RepositoryZypper.post_init-88"><a href="#RepositoryZypper.post_init-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">repo_names</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="RepositoryZypper.post_init-89"><a href="#RepositoryZypper.post_init-89"><span class="linenos"> 89</span></a>
</span><span id="RepositoryZypper.post_init-90"><a href="#RepositoryZypper.post_init-90"><span class="linenos"> 90</span></a>        <span class="c1"># zypper support by default point all actions into the root</span>
</span><span id="RepositoryZypper.post_init-91"><a href="#RepositoryZypper.post_init-91"><span class="linenos"> 91</span></a>        <span class="c1"># directory of the image system. This information is passed</span>
</span><span id="RepositoryZypper.post_init-92"><a href="#RepositoryZypper.post_init-92"><span class="linenos"> 92</span></a>        <span class="c1"># as arguments to zypper and adapted if the call runs as</span>
</span><span id="RepositoryZypper.post_init-93"><a href="#RepositoryZypper.post_init-93"><span class="linenos"> 93</span></a>        <span class="c1"># chrooted operation. Therefore the use of the shared location</span>
</span><span id="RepositoryZypper.post_init-94"><a href="#RepositoryZypper.post_init-94"><span class="linenos"> 94</span></a>        <span class="c1"># via RootBind::mount_shared_directory is optional but</span>
</span><span id="RepositoryZypper.post_init-95"><a href="#RepositoryZypper.post_init-95"><span class="linenos"> 95</span></a>        <span class="c1"># recommended to make use of the repo cache</span>
</span><span id="RepositoryZypper.post_init-96"><a href="#RepositoryZypper.post_init-96"><span class="linenos"> 96</span></a>        <span class="n">manager_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_location</span>
</span><span id="RepositoryZypper.post_init-97"><a href="#RepositoryZypper.post_init-97"><span class="linenos"> 97</span></a>
</span><span id="RepositoryZypper.post_init-98"><a href="#RepositoryZypper.post_init-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="RepositoryZypper.post_init-99"><a href="#RepositoryZypper.post_init-99"><span class="linenos"> 99</span></a>            <span class="s1">&#39;pkg-cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-100"><a href="#RepositoryZypper.post_init-100"><span class="linenos">100</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;packages&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper.post_init-101"><a href="#RepositoryZypper.post_init-101"><span class="linenos">101</span></a>            <span class="p">),</span>
</span><span id="RepositoryZypper.post_init-102"><a href="#RepositoryZypper.post_init-102"><span class="linenos">102</span></a>            <span class="s1">&#39;reposd-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-103"><a href="#RepositoryZypper.post_init-103"><span class="linenos">103</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/repos&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper.post_init-104"><a href="#RepositoryZypper.post_init-104"><span class="linenos">104</span></a>            <span class="p">),</span>
</span><span id="RepositoryZypper.post_init-105"><a href="#RepositoryZypper.post_init-105"><span class="linenos">105</span></a>            <span class="s1">&#39;credentials-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-106"><a href="#RepositoryZypper.post_init-106"><span class="linenos">106</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/credentials&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper.post_init-107"><a href="#RepositoryZypper.post_init-107"><span class="linenos">107</span></a>            <span class="p">),</span>
</span><span id="RepositoryZypper.post_init-108"><a href="#RepositoryZypper.post_init-108"><span class="linenos">108</span></a>            <span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-109"><a href="#RepositoryZypper.post_init-109"><span class="linenos">109</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/solv&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper.post_init-110"><a href="#RepositoryZypper.post_init-110"><span class="linenos">110</span></a>            <span class="p">),</span>
</span><span id="RepositoryZypper.post_init-111"><a href="#RepositoryZypper.post_init-111"><span class="linenos">111</span></a>            <span class="s1">&#39;raw-cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-112"><a href="#RepositoryZypper.post_init-112"><span class="linenos">112</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper/raw&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper.post_init-113"><a href="#RepositoryZypper.post_init-113"><span class="linenos">113</span></a>            <span class="p">),</span>
</span><span id="RepositoryZypper.post_init-114"><a href="#RepositoryZypper.post_init-114"><span class="linenos">114</span></a>            <span class="s1">&#39;cache-dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-115"><a href="#RepositoryZypper.post_init-115"><span class="linenos">115</span></a>                <span class="p">[</span><span class="n">manager_base</span><span class="p">,</span> <span class="s1">&#39;zypper&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper.post_init-116"><a href="#RepositoryZypper.post_init-116"><span class="linenos">116</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper.post_init-117"><a href="#RepositoryZypper.post_init-117"><span class="linenos">117</span></a>        <span class="p">}</span>
</span><span id="RepositoryZypper.post_init-118"><a href="#RepositoryZypper.post_init-118"><span class="linenos">118</span></a>
</span><span id="RepositoryZypper.post_init-119"><a href="#RepositoryZypper.post_init-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span> <span class="o">=</span> <span class="n">Temporary</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-120"><a href="#RepositoryZypper.post_init-120"><span class="linenos">120</span></a>            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;kiwi_zypper.config&#39;</span>
</span><span id="RepositoryZypper.post_init-121"><a href="#RepositoryZypper.post_init-121"><span class="linenos">121</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">unmanaged_file</span><span class="p">()</span>
</span><span id="RepositoryZypper.post_init-122"><a href="#RepositoryZypper.post_init-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span> <span class="o">=</span> <span class="n">Temporary</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-123"><a href="#RepositoryZypper.post_init-123"><span class="linenos">123</span></a>            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;kiwi_zypp.config&#39;</span>
</span><span id="RepositoryZypper.post_init-124"><a href="#RepositoryZypper.post_init-124"><span class="linenos">124</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">unmanaged_file</span><span class="p">()</span>
</span><span id="RepositoryZypper.post_init-125"><a href="#RepositoryZypper.post_init-125"><span class="linenos">125</span></a>
</span><span id="RepositoryZypper.post_init-126"><a href="#RepositoryZypper.post_init-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="RepositoryZypper.post_init-127"><a href="#RepositoryZypper.post_init-127"><span class="linenos">127</span></a>            <span class="s1">&#39;--non-interactive&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper.post_init-128"><a href="#RepositoryZypper.post_init-128"><span class="linenos">128</span></a>            <span class="s1">&#39;--gpg-auto-import-keys&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper.post_init-129"><a href="#RepositoryZypper.post_init-129"><span class="linenos">129</span></a>            <span class="s1">&#39;--pkg-cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;pkg-cache-dir&#39;</span><span class="p">],</span>
</span><span id="RepositoryZypper.post_init-130"><a href="#RepositoryZypper.post_init-130"><span class="linenos">130</span></a>            <span class="s1">&#39;--reposd-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">],</span>
</span><span id="RepositoryZypper.post_init-131"><a href="#RepositoryZypper.post_init-131"><span class="linenos">131</span></a>            <span class="s1">&#39;--solv-cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">],</span>
</span><span id="RepositoryZypper.post_init-132"><a href="#RepositoryZypper.post_init-132"><span class="linenos">132</span></a>            <span class="s1">&#39;--cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;cache-dir&#39;</span><span class="p">],</span>
</span><span id="RepositoryZypper.post_init-133"><a href="#RepositoryZypper.post_init-133"><span class="linenos">133</span></a>            <span class="s1">&#39;--raw-cache-dir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;raw-cache-dir&#39;</span><span class="p">],</span>
</span><span id="RepositoryZypper.post_init-134"><a href="#RepositoryZypper.post_init-134"><span class="linenos">134</span></a>            <span class="s1">&#39;--config&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span><span class="o">.</span><span class="n">name</span>
</span><span id="RepositoryZypper.post_init-135"><a href="#RepositoryZypper.post_init-135"><span class="linenos">135</span></a>        <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span>
</span><span id="RepositoryZypper.post_init-136"><a href="#RepositoryZypper.post_init-136"><span class="linenos">136</span></a>
</span><span id="RepositoryZypper.post_init-137"><a href="#RepositoryZypper.post_init-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_zypper_runtime_environment</span><span class="p">()</span>
</span><span id="RepositoryZypper.post_init-138"><a href="#RepositoryZypper.post_init-138"><span class="linenos">138</span></a>
</span><span id="RepositoryZypper.post_init-139"><a href="#RepositoryZypper.post_init-139"><span class="linenos">139</span></a>        <span class="c1"># config file parameters for zypper tool</span>
</span><span id="RepositoryZypper.post_init-140"><a href="#RepositoryZypper.post_init-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="RepositoryZypper.post_init-141"><a href="#RepositoryZypper.post_init-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper.post_init-142"><a href="#RepositoryZypper.post_init-142"><span class="linenos">142</span></a>
</span><span id="RepositoryZypper.post_init-143"><a href="#RepositoryZypper.post_init-143"><span class="linenos">143</span></a>        <span class="c1"># config file parameters for libzypp library</span>
</span><span id="RepositoryZypper.post_init-144"><a href="#RepositoryZypper.post_init-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="RepositoryZypper.post_init-145"><a href="#RepositoryZypper.post_init-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper.post_init-146"><a href="#RepositoryZypper.post_init-146"><span class="linenos">146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-147"><a href="#RepositoryZypper.post_init-147"><span class="linenos">147</span></a>            <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;credentials.global.dir&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper.post_init-148"><a href="#RepositoryZypper.post_init-148"><span class="linenos">148</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;credentials-dir&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper.post_init-149"><a href="#RepositoryZypper.post_init-149"><span class="linenos">149</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper.post_init-150"><a href="#RepositoryZypper.post_init-150"><span class="linenos">150</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-151"><a href="#RepositoryZypper.post_init-151"><span class="linenos">151</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-152"><a href="#RepositoryZypper.post_init-152"><span class="linenos">152</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;arch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span>
</span><span id="RepositoryZypper.post_init-153"><a href="#RepositoryZypper.post_init-153"><span class="linenos">153</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper.post_init-154"><a href="#RepositoryZypper.post_init-154"><span class="linenos">154</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_docs</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-155"><a href="#RepositoryZypper.post_init-155"><span class="linenos">155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-156"><a href="#RepositoryZypper.post_init-156"><span class="linenos">156</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;rpm.install.excludedocs&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span>
</span><span id="RepositoryZypper.post_init-157"><a href="#RepositoryZypper.post_init-157"><span class="linenos">157</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper.post_init-158"><a href="#RepositoryZypper.post_init-158"><span class="linenos">158</span></a>
</span><span id="RepositoryZypper.post_init-159"><a href="#RepositoryZypper.post_init-159"><span class="linenos">159</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpgcheck</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-160"><a href="#RepositoryZypper.post_init-160"><span class="linenos">160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-161"><a href="#RepositoryZypper.post_init-161"><span class="linenos">161</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span>
</span><span id="RepositoryZypper.post_init-162"><a href="#RepositoryZypper.post_init-162"><span class="linenos">162</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper.post_init-163"><a href="#RepositoryZypper.post_init-163"><span class="linenos">163</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="RepositoryZypper.post_init-164"><a href="#RepositoryZypper.post_init-164"><span class="linenos">164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper.post_init-165"><a href="#RepositoryZypper.post_init-165"><span class="linenos">165</span></a>                <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span>
</span><span id="RepositoryZypper.post_init-166"><a href="#RepositoryZypper.post_init-166"><span class="linenos">166</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper.post_init-167"><a href="#RepositoryZypper.post_init-167"><span class="linenos">167</span></a>
</span><span id="RepositoryZypper.post_init-168"><a href="#RepositoryZypper.post_init-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_write_runtime_config</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Post initialization method</p>

<p>Store custom zypper arguments and create runtime configuration
and environment</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>list custom_args</strong>:  zypper arguments</li>
</ul>
</div>


                            </div>
                            <div id="RepositoryZypper.setup_package_database_configuration" class="classattr">
                                        <input id="RepositoryZypper.setup_package_database_configuration-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup_package_database_configuration</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="RepositoryZypper.setup_package_database_configuration-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper.setup_package_database_configuration"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper.setup_package_database_configuration-170"><a href="#RepositoryZypper.setup_package_database_configuration-170"><span class="linenos">170</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_package_database_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-171"><a href="#RepositoryZypper.setup_package_database_configuration-171"><span class="linenos">171</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-172"><a href="#RepositoryZypper.setup_package_database_configuration-172"><span class="linenos">172</span></a><span class="sd">        Setup rpm macros for bootstrapping and image building</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-173"><a href="#RepositoryZypper.setup_package_database_configuration-173"><span class="linenos">173</span></a>
</span><span id="RepositoryZypper.setup_package_database_configuration-174"><a href="#RepositoryZypper.setup_package_database_configuration-174"><span class="linenos">174</span></a><span class="sd">        1. Create the rpm image macro which persists during the build</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-175"><a href="#RepositoryZypper.setup_package_database_configuration-175"><span class="linenos">175</span></a><span class="sd">        2. Create the rpm bootstrap macro to make sure for bootstrapping</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-176"><a href="#RepositoryZypper.setup_package_database_configuration-176"><span class="linenos">176</span></a><span class="sd">           the rpm database location matches the host rpm database setup.</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-177"><a href="#RepositoryZypper.setup_package_database_configuration-177"><span class="linenos">177</span></a><span class="sd">           This macro only persists during the bootstrap phase. If the</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-178"><a href="#RepositoryZypper.setup_package_database_configuration-178"><span class="linenos">178</span></a><span class="sd">           image was already bootstrapped a compat link is created instead.</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-179"><a href="#RepositoryZypper.setup_package_database_configuration-179"><span class="linenos">179</span></a><span class="sd">        3. Create zypper compat link</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-180"><a href="#RepositoryZypper.setup_package_database_configuration-180"><span class="linenos">180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-181"><a href="#RepositoryZypper.setup_package_database_configuration-181"><span class="linenos">181</span></a>        <span class="n">rpmdb</span> <span class="o">=</span> <span class="n">RpmDataBase</span><span class="p">(</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-182"><a href="#RepositoryZypper.setup_package_database_configuration-182"><span class="linenos">182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">get_custom_rpm_image_macro_name</span><span class="p">()</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-183"><a href="#RepositoryZypper.setup_package_database_configuration-183"><span class="linenos">183</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-184"><a href="#RepositoryZypper.setup_package_database_configuration-184"><span class="linenos">184</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">:</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-185"><a href="#RepositoryZypper.setup_package_database_configuration-185"><span class="linenos">185</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">set_macro_from_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">)</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-186"><a href="#RepositoryZypper.setup_package_database_configuration-186"><span class="linenos">186</span></a>        <span class="n">rpmdb</span><span class="o">.</span><span class="n">write_config</span><span class="p">()</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-187"><a href="#RepositoryZypper.setup_package_database_configuration-187"><span class="linenos">187</span></a>
</span><span id="RepositoryZypper.setup_package_database_configuration-188"><a href="#RepositoryZypper.setup_package_database_configuration-188"><span class="linenos">188</span></a>        <span class="n">rpmdb</span> <span class="o">=</span> <span class="n">RpmDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-189"><a href="#RepositoryZypper.setup_package_database_configuration-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">has_rpm</span><span class="p">():</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-190"><a href="#RepositoryZypper.setup_package_database_configuration-190"><span class="linenos">190</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">link_database_to_host_path</span><span class="p">()</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-191"><a href="#RepositoryZypper.setup_package_database_configuration-191"><span class="linenos">191</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-192"><a href="#RepositoryZypper.setup_package_database_configuration-192"><span class="linenos">192</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">set_database_to_host_path</span><span class="p">()</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-193"><a href="#RepositoryZypper.setup_package_database_configuration-193"><span class="linenos">193</span></a>        <span class="c1"># Zypper compat code:</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-194"><a href="#RepositoryZypper.setup_package_database_configuration-194"><span class="linenos">194</span></a>        <span class="c1">#</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-195"><a href="#RepositoryZypper.setup_package_database_configuration-195"><span class="linenos">195</span></a>        <span class="c1"># Manually adding the compat link /var/lib/rpm that points to the</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-196"><a href="#RepositoryZypper.setup_package_database_configuration-196"><span class="linenos">196</span></a>        <span class="c1"># rpmdb location as it is configured in the host rpm setup. The</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-197"><a href="#RepositoryZypper.setup_package_database_configuration-197"><span class="linenos">197</span></a>        <span class="c1"># host rpm setup is taken into account because import_trusted_keys</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-198"><a href="#RepositoryZypper.setup_package_database_configuration-198"><span class="linenos">198</span></a>        <span class="c1"># is called during the bootstrap phase where rpm (respectively zypper)</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-199"><a href="#RepositoryZypper.setup_package_database_configuration-199"><span class="linenos">199</span></a>        <span class="c1"># is called from the host</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-200"><a href="#RepositoryZypper.setup_package_database_configuration-200"><span class="linenos">200</span></a>        <span class="c1">#</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-201"><a href="#RepositoryZypper.setup_package_database_configuration-201"><span class="linenos">201</span></a>        <span class="c1"># Usually it is expected that the package manager reads the</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-202"><a href="#RepositoryZypper.setup_package_database_configuration-202"><span class="linenos">202</span></a>        <span class="c1"># signing keys from the rpm database setup provisioned by rpm</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-203"><a href="#RepositoryZypper.setup_package_database_configuration-203"><span class="linenos">203</span></a>        <span class="c1"># itself (macro level) but zypper doesn&#39;t take the rpm macro</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-204"><a href="#RepositoryZypper.setup_package_database_configuration-204"><span class="linenos">204</span></a>        <span class="c1"># setup into account and relies on a hard coded path which we</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-205"><a href="#RepositoryZypper.setup_package_database_configuration-205"><span class="linenos">205</span></a>        <span class="c1"># can only provide as a symlink.</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-206"><a href="#RepositoryZypper.setup_package_database_configuration-206"><span class="linenos">206</span></a>        <span class="c1">#</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-207"><a href="#RepositoryZypper.setup_package_database_configuration-207"><span class="linenos">207</span></a>        <span class="c1"># That symlink is usually created by the rpm package when it gets</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-208"><a href="#RepositoryZypper.setup_package_database_configuration-208"><span class="linenos">208</span></a>        <span class="c1"># installed. However at that early phase when we import the</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-209"><a href="#RepositoryZypper.setup_package_database_configuration-209"><span class="linenos">209</span></a>        <span class="c1"># signing keys no rpm is installed yet nor any symlink exists.</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-210"><a href="#RepositoryZypper.setup_package_database_configuration-210"><span class="linenos">210</span></a>        <span class="c1"># Thus we have to create it here and hope to get rid of it in the</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-211"><a href="#RepositoryZypper.setup_package_database_configuration-211"><span class="linenos">211</span></a>        <span class="c1"># future.</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-212"><a href="#RepositoryZypper.setup_package_database_configuration-212"><span class="linenos">212</span></a>        <span class="c1">#</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-213"><a href="#RepositoryZypper.setup_package_database_configuration-213"><span class="linenos">213</span></a>        <span class="c1"># For further details on the motivation in zypper please</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-214"><a href="#RepositoryZypper.setup_package_database_configuration-214"><span class="linenos">214</span></a>        <span class="c1"># refer to bsc#1112357</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-215"><a href="#RepositoryZypper.setup_package_database_configuration-215"><span class="linenos">215</span></a>        <span class="n">rpmdb</span><span class="o">.</span><span class="n">init_database</span><span class="p">()</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-216"><a href="#RepositoryZypper.setup_package_database_configuration-216"><span class="linenos">216</span></a>        <span class="n">image_rpm_compat_link</span> <span class="o">=</span> <span class="s1">&#39;/var/lib/rpm&#39;</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-217"><a href="#RepositoryZypper.setup_package_database_configuration-217"><span class="linenos">217</span></a>        <span class="n">host_rpm_dbpath</span> <span class="o">=</span> <span class="n">rpmdb</span><span class="o">.</span><span class="n">rpmdb_host</span><span class="o">.</span><span class="n">expand_query</span><span class="p">(</span><span class="s1">&#39;%_dbpath&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-218"><a href="#RepositoryZypper.setup_package_database_configuration-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="n">host_rpm_dbpath</span> <span class="o">!=</span> <span class="n">image_rpm_compat_link</span><span class="p">:</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-219"><a href="#RepositoryZypper.setup_package_database_configuration-219"><span class="linenos">219</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-220"><a href="#RepositoryZypper.setup_package_database_configuration-220"><span class="linenos">220</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image_rpm_compat_link</span><span class="p">)</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-221"><a href="#RepositoryZypper.setup_package_database_configuration-221"><span class="linenos">221</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-222"><a href="#RepositoryZypper.setup_package_database_configuration-222"><span class="linenos">222</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-223"><a href="#RepositoryZypper.setup_package_database_configuration-223"><span class="linenos">223</span></a>                <span class="p">[</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-224"><a href="#RepositoryZypper.setup_package_database_configuration-224"><span class="linenos">224</span></a>                    <span class="s1">&#39;ln&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-target-directory&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-225"><a href="#RepositoryZypper.setup_package_database_configuration-225"><span class="linenos">225</span></a>                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;../..&#39;</span><span class="p">,</span> <span class="n">host_rpm_dbpath</span><span class="p">]),</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-226"><a href="#RepositoryZypper.setup_package_database_configuration-226"><span class="linenos">226</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="n">image_rpm_compat_link</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-227"><a href="#RepositoryZypper.setup_package_database_configuration-227"><span class="linenos">227</span></a>                <span class="p">],</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span>
</span><span id="RepositoryZypper.setup_package_database_configuration-228"><a href="#RepositoryZypper.setup_package_database_configuration-228"><span class="linenos">228</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Setup rpm macros for bootstrapping and image building</p>

<ol>
<li>Create the rpm image macro which persists during the build</li>
<li>Create the rpm bootstrap macro to make sure for bootstrapping
the rpm database location matches the host rpm database setup.
This macro only persists during the bootstrap phase. If the
image was already bootstrapped a compat link is created instead.</li>
<li>Create zypper compat link</li>
</ol>
</div>


                            </div>
                            <div id="RepositoryZypper.use_default_location" class="classattr">
                                        <input id="RepositoryZypper.use_default_location-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">use_default_location</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="RepositoryZypper.use_default_location-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper.use_default_location"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper.use_default_location-230"><a href="#RepositoryZypper.use_default_location-230"><span class="linenos">230</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">use_default_location</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper.use_default_location-231"><a href="#RepositoryZypper.use_default_location-231"><span class="linenos">231</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.use_default_location-232"><a href="#RepositoryZypper.use_default_location-232"><span class="linenos">232</span></a><span class="sd">        Setup zypper repository operations to store all data</span>
</span><span id="RepositoryZypper.use_default_location-233"><a href="#RepositoryZypper.use_default_location-233"><span class="linenos">233</span></a><span class="sd">        in the default places</span>
</span><span id="RepositoryZypper.use_default_location-234"><a href="#RepositoryZypper.use_default_location-234"><span class="linenos">234</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.use_default_location-235"><a href="#RepositoryZypper.use_default_location-235"><span class="linenos">235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="RepositoryZypper.use_default_location-236"><a href="#RepositoryZypper.use_default_location-236"><span class="linenos">236</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/zypp/repos.d&#39;</span>
</span><span id="RepositoryZypper.use_default_location-237"><a href="#RepositoryZypper.use_default_location-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;credentials-dir&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="RepositoryZypper.use_default_location-238"><a href="#RepositoryZypper.use_default_location-238"><span class="linenos">238</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">+</span> <span class="s1">&#39;/etc/zypp/credentials.d&#39;</span>
</span><span id="RepositoryZypper.use_default_location-239"><a href="#RepositoryZypper.use_default_location-239"><span class="linenos">239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="RepositoryZypper.use_default_location-240"><a href="#RepositoryZypper.use_default_location-240"><span class="linenos">240</span></a>            <span class="s1">&#39;--non-interactive&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper.use_default_location-241"><a href="#RepositoryZypper.use_default_location-241"><span class="linenos">241</span></a>        <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_args</span>
</span><span id="RepositoryZypper.use_default_location-242"><a href="#RepositoryZypper.use_default_location-242"><span class="linenos">242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">LANG</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Setup zypper repository operations to store all data
in the default places</p>
</div>


                            </div>
                            <div id="RepositoryZypper.runtime_config" class="classattr">
                                        <input id="RepositoryZypper.runtime_config-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">runtime_config</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="RepositoryZypper.runtime_config-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper.runtime_config"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper.runtime_config-244"><a href="#RepositoryZypper.runtime_config-244"><span class="linenos">244</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">runtime_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="RepositoryZypper.runtime_config-245"><a href="#RepositoryZypper.runtime_config-245"><span class="linenos">245</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.runtime_config-246"><a href="#RepositoryZypper.runtime_config-246"><span class="linenos">246</span></a><span class="sd">        zypper runtime configuration and environment</span>
</span><span id="RepositoryZypper.runtime_config-247"><a href="#RepositoryZypper.runtime_config-247"><span class="linenos">247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.runtime_config-248"><a href="#RepositoryZypper.runtime_config-248"><span class="linenos">248</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="RepositoryZypper.runtime_config-249"><a href="#RepositoryZypper.runtime_config-249"><span class="linenos">249</span></a>            <span class="s1">&#39;zypper_args&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span><span class="p">,</span>
</span><span id="RepositoryZypper.runtime_config-250"><a href="#RepositoryZypper.runtime_config-250"><span class="linenos">250</span></a>            <span class="s1">&#39;command_env&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="RepositoryZypper.runtime_config-251"><a href="#RepositoryZypper.runtime_config-251"><span class="linenos">251</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>zypper runtime configuration and environment</p>
</div>


                            </div>
                            <div id="RepositoryZypper.add_repo" class="classattr">
                                        <input id="RepositoryZypper.add_repo-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_repo</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">uri</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">repo_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;rpm-md&#39;</span>,</span><span class="param">	<span class="n">prio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dist</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">components</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">secret</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">credentials_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">repo_gpgcheck</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">pkg_gpgcheck</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">sourcetype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">customization_script</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">architectures</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="RepositoryZypper.add_repo-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper.add_repo"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper.add_repo-253"><a href="#RepositoryZypper.add_repo-253"><span class="linenos">253</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_repo</span><span class="p">(</span>
</span><span id="RepositoryZypper.add_repo-254"><a href="#RepositoryZypper.add_repo-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">repo_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;rpm-md&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper.add_repo-255"><a href="#RepositoryZypper.add_repo-255"><span class="linenos">255</span></a>        <span class="n">prio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dist</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">components</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RepositoryZypper.add_repo-256"><a href="#RepositoryZypper.add_repo-256"><span class="linenos">256</span></a>        <span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">credentials_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RepositoryZypper.add_repo-257"><a href="#RepositoryZypper.add_repo-257"><span class="linenos">257</span></a>        <span class="n">repo_gpgcheck</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pkg_gpgcheck</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="RepositoryZypper.add_repo-258"><a href="#RepositoryZypper.add_repo-258"><span class="linenos">258</span></a>        <span class="n">sourcetype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">customization_script</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RepositoryZypper.add_repo-259"><a href="#RepositoryZypper.add_repo-259"><span class="linenos">259</span></a>        <span class="n">architectures</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="RepositoryZypper.add_repo-260"><a href="#RepositoryZypper.add_repo-260"><span class="linenos">260</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper.add_repo-261"><a href="#RepositoryZypper.add_repo-261"><span class="linenos">261</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.add_repo-262"><a href="#RepositoryZypper.add_repo-262"><span class="linenos">262</span></a><span class="sd">        Add zypper repository</span>
</span><span id="RepositoryZypper.add_repo-263"><a href="#RepositoryZypper.add_repo-263"><span class="linenos">263</span></a>
</span><span id="RepositoryZypper.add_repo-264"><a href="#RepositoryZypper.add_repo-264"><span class="linenos">264</span></a><span class="sd">        :param str name: repository name</span>
</span><span id="RepositoryZypper.add_repo-265"><a href="#RepositoryZypper.add_repo-265"><span class="linenos">265</span></a><span class="sd">        :param str uri: repository URI</span>
</span><span id="RepositoryZypper.add_repo-266"><a href="#RepositoryZypper.add_repo-266"><span class="linenos">266</span></a><span class="sd">        :param str repo_type: repostory type name</span>
</span><span id="RepositoryZypper.add_repo-267"><a href="#RepositoryZypper.add_repo-267"><span class="linenos">267</span></a><span class="sd">        :param int prio: zypper repostory priority</span>
</span><span id="RepositoryZypper.add_repo-268"><a href="#RepositoryZypper.add_repo-268"><span class="linenos">268</span></a><span class="sd">        :param str dist: unused</span>
</span><span id="RepositoryZypper.add_repo-269"><a href="#RepositoryZypper.add_repo-269"><span class="linenos">269</span></a><span class="sd">        :param str components: unused</span>
</span><span id="RepositoryZypper.add_repo-270"><a href="#RepositoryZypper.add_repo-270"><span class="linenos">270</span></a><span class="sd">        :param str user: credentials username</span>
</span><span id="RepositoryZypper.add_repo-271"><a href="#RepositoryZypper.add_repo-271"><span class="linenos">271</span></a><span class="sd">        :param str secret: credentials password</span>
</span><span id="RepositoryZypper.add_repo-272"><a href="#RepositoryZypper.add_repo-272"><span class="linenos">272</span></a><span class="sd">        :param str credentials_file: zypper credentials file</span>
</span><span id="RepositoryZypper.add_repo-273"><a href="#RepositoryZypper.add_repo-273"><span class="linenos">273</span></a><span class="sd">        :param bool repo_gpgcheck: enable repository signature validation</span>
</span><span id="RepositoryZypper.add_repo-274"><a href="#RepositoryZypper.add_repo-274"><span class="linenos">274</span></a><span class="sd">        :param bool pkg_gpgcheck: enable package signature validation</span>
</span><span id="RepositoryZypper.add_repo-275"><a href="#RepositoryZypper.add_repo-275"><span class="linenos">275</span></a><span class="sd">        :param str sourcetype: unused</span>
</span><span id="RepositoryZypper.add_repo-276"><a href="#RepositoryZypper.add_repo-276"><span class="linenos">276</span></a><span class="sd">        :param str customization_script:</span>
</span><span id="RepositoryZypper.add_repo-277"><a href="#RepositoryZypper.add_repo-277"><span class="linenos">277</span></a><span class="sd">            custom script called after the repo file was created</span>
</span><span id="RepositoryZypper.add_repo-278"><a href="#RepositoryZypper.add_repo-278"><span class="linenos">278</span></a><span class="sd">        :param str architectures: unused</span>
</span><span id="RepositoryZypper.add_repo-279"><a href="#RepositoryZypper.add_repo-279"><span class="linenos">279</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.add_repo-280"><a href="#RepositoryZypper.add_repo-280"><span class="linenos">280</span></a>        <span class="k">if</span> <span class="n">credentials_file</span><span class="p">:</span>
</span><span id="RepositoryZypper.add_repo-281"><a href="#RepositoryZypper.add_repo-281"><span class="linenos">281</span></a>            <span class="n">repo_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper.add_repo-282"><a href="#RepositoryZypper.add_repo-282"><span class="linenos">282</span></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;credentials-dir&#39;</span><span class="p">],</span> <span class="n">credentials_file</span><span class="p">]</span>
</span><span id="RepositoryZypper.add_repo-283"><a href="#RepositoryZypper.add_repo-283"><span class="linenos">283</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-284"><a href="#RepositoryZypper.add_repo-284"><span class="linenos">284</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">repo_secret</span><span class="p">):</span>
</span><span id="RepositoryZypper.add_repo-285"><a href="#RepositoryZypper.add_repo-285"><span class="linenos">285</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">repo_secret</span><span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-286"><a href="#RepositoryZypper.add_repo-286"><span class="linenos">286</span></a>
</span><span id="RepositoryZypper.add_repo-287"><a href="#RepositoryZypper.add_repo-287"><span class="linenos">287</span></a>            <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">secret</span><span class="p">:</span>
</span><span id="RepositoryZypper.add_repo-288"><a href="#RepositoryZypper.add_repo-288"><span class="linenos">288</span></a>                <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">uri</span><span class="p">,</span> <span class="s1">&#39;?credentials=&#39;</span><span class="p">,</span> <span class="n">credentials_file</span><span class="p">])</span>
</span><span id="RepositoryZypper.add_repo-289"><a href="#RepositoryZypper.add_repo-289"><span class="linenos">289</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">repo_secret</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">credentials</span><span class="p">:</span>
</span><span id="RepositoryZypper.add_repo-290"><a href="#RepositoryZypper.add_repo-290"><span class="linenos">290</span></a>                    <span class="n">credentials</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;username=</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="RepositoryZypper.add_repo-291"><a href="#RepositoryZypper.add_repo-291"><span class="linenos">291</span></a>                        <span class="n">user</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-292"><a href="#RepositoryZypper.add_repo-292"><span class="linenos">292</span></a>                    <span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-293"><a href="#RepositoryZypper.add_repo-293"><span class="linenos">293</span></a>                    <span class="n">credentials</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;password=</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="RepositoryZypper.add_repo-294"><a href="#RepositoryZypper.add_repo-294"><span class="linenos">294</span></a>                        <span class="n">secret</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-295"><a href="#RepositoryZypper.add_repo-295"><span class="linenos">295</span></a>                    <span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-296"><a href="#RepositoryZypper.add_repo-296"><span class="linenos">296</span></a>
</span><span id="RepositoryZypper.add_repo-297"><a href="#RepositoryZypper.add_repo-297"><span class="linenos">297</span></a>        <span class="n">repo_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="RepositoryZypper.add_repo-298"><a href="#RepositoryZypper.add_repo-298"><span class="linenos">298</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;.repo&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper.add_repo-299"><a href="#RepositoryZypper.add_repo-299"><span class="linenos">299</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-300"><a href="#RepositoryZypper.add_repo-300"><span class="linenos">300</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">repo_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;.repo&#39;</span><span class="p">]))</span>
</span><span id="RepositoryZypper.add_repo-301"><a href="#RepositoryZypper.add_repo-301"><span class="linenos">301</span></a>
</span><span id="RepositoryZypper.add_repo-302"><a href="#RepositoryZypper.add_repo-302"><span class="linenos">302</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">repo_file</span><span class="p">):</span>
</span><span id="RepositoryZypper.add_repo-303"><a href="#RepositoryZypper.add_repo-303"><span class="linenos">303</span></a>            <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">repo_file</span><span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-304"><a href="#RepositoryZypper.add_repo-304"><span class="linenos">304</span></a>
</span><span id="RepositoryZypper.add_repo-305"><a href="#RepositoryZypper.add_repo-305"><span class="linenos">305</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_backup_package_cache</span><span class="p">()</span>
</span><span id="RepositoryZypper.add_repo-306"><a href="#RepositoryZypper.add_repo-306"><span class="linenos">306</span></a>        <span class="n">zypper_addrepo_command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;zypper&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="RepositoryZypper.add_repo-307"><a href="#RepositoryZypper.add_repo-307"><span class="linenos">307</span></a>            <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
</span><span id="RepositoryZypper.add_repo-308"><a href="#RepositoryZypper.add_repo-308"><span class="linenos">308</span></a>            <span class="s1">&#39;addrepo&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper.add_repo-309"><a href="#RepositoryZypper.add_repo-309"><span class="linenos">309</span></a>            <span class="s1">&#39;--refresh&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper.add_repo-310"><a href="#RepositoryZypper.add_repo-310"><span class="linenos">310</span></a>            <span class="s1">&#39;--keep-packages&#39;</span> <span class="k">if</span> <span class="n">Uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">is_remote</span><span class="p">()</span> <span class="k">else</span>
</span><span id="RepositoryZypper.add_repo-311"><a href="#RepositoryZypper.add_repo-311"><span class="linenos">311</span></a>            <span class="s1">&#39;--no-keep-packages&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper.add_repo-312"><a href="#RepositoryZypper.add_repo-312"><span class="linenos">312</span></a>            <span class="s1">&#39;--no-check&#39;</span><span class="p">,</span>
</span><span id="RepositoryZypper.add_repo-313"><a href="#RepositoryZypper.add_repo-313"><span class="linenos">313</span></a>            <span class="n">uri</span><span class="p">,</span>
</span><span id="RepositoryZypper.add_repo-314"><a href="#RepositoryZypper.add_repo-314"><span class="linenos">314</span></a>            <span class="n">name</span>
</span><span id="RepositoryZypper.add_repo-315"><a href="#RepositoryZypper.add_repo-315"><span class="linenos">315</span></a>        <span class="p">]</span>
</span><span id="RepositoryZypper.add_repo-316"><a href="#RepositoryZypper.add_repo-316"><span class="linenos">316</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="RepositoryZypper.add_repo-317"><a href="#RepositoryZypper.add_repo-317"><span class="linenos">317</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RepositoryZypper.add_repo-318"><a href="#RepositoryZypper.add_repo-318"><span class="linenos">318</span></a>                <span class="n">zypper_addrepo_command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="RepositoryZypper.add_repo-319"><a href="#RepositoryZypper.add_repo-319"><span class="linenos">319</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-320"><a href="#RepositoryZypper.add_repo-320"><span class="linenos">320</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="RepositoryZypper.add_repo-321"><a href="#RepositoryZypper.add_repo-321"><span class="linenos">321</span></a>            <span class="c1"># for whatever reason zypper sometimes failes with</span>
</span><span id="RepositoryZypper.add_repo-322"><a href="#RepositoryZypper.add_repo-322"><span class="linenos">322</span></a>            <span class="c1"># a &#39;failed to cache rpm database&#39; error. I could not</span>
</span><span id="RepositoryZypper.add_repo-323"><a href="#RepositoryZypper.add_repo-323"><span class="linenos">323</span></a>            <span class="c1"># find any reason why and a simple recall of the exact</span>
</span><span id="RepositoryZypper.add_repo-324"><a href="#RepositoryZypper.add_repo-324"><span class="linenos">324</span></a>            <span class="c1"># same command in the exact same environment works.</span>
</span><span id="RepositoryZypper.add_repo-325"><a href="#RepositoryZypper.add_repo-325"><span class="linenos">325</span></a>            <span class="c1"># Thus the stupid but simple workaround to this problem</span>
</span><span id="RepositoryZypper.add_repo-326"><a href="#RepositoryZypper.add_repo-326"><span class="linenos">326</span></a>            <span class="c1"># is try one recall before really failing</span>
</span><span id="RepositoryZypper.add_repo-327"><a href="#RepositoryZypper.add_repo-327"><span class="linenos">327</span></a>            <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RepositoryZypper.add_repo-328"><a href="#RepositoryZypper.add_repo-328"><span class="linenos">328</span></a>                <span class="n">zypper_addrepo_command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="RepositoryZypper.add_repo-329"><a href="#RepositoryZypper.add_repo-329"><span class="linenos">329</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-330"><a href="#RepositoryZypper.add_repo-330"><span class="linenos">330</span></a>
</span><span id="RepositoryZypper.add_repo-331"><a href="#RepositoryZypper.add_repo-331"><span class="linenos">331</span></a>        <span class="n">repo_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">(</span><span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-332"><a href="#RepositoryZypper.add_repo-332"><span class="linenos">332</span></a>        <span class="n">repo_config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">repo_file</span><span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-333"><a href="#RepositoryZypper.add_repo-333"><span class="linenos">333</span></a>
</span><span id="RepositoryZypper.add_repo-334"><a href="#RepositoryZypper.add_repo-334"><span class="linenos">334</span></a>        <span class="n">baseurl</span> <span class="o">=</span> <span class="n">uri</span>
</span><span id="RepositoryZypper.add_repo-335"><a href="#RepositoryZypper.add_repo-335"><span class="linenos">335</span></a>        <span class="n">uri_with_credentials_pattern</span> <span class="o">=</span> <span class="s1">&#39;^(.*):(.*)@(.*)$&#39;</span>
</span><span id="RepositoryZypper.add_repo-336"><a href="#RepositoryZypper.add_repo-336"><span class="linenos">336</span></a>        <span class="n">sensitive_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">uri_with_credentials_pattern</span><span class="p">,</span> <span class="n">baseurl</span><span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-337"><a href="#RepositoryZypper.add_repo-337"><span class="linenos">337</span></a>        <span class="k">if</span> <span class="n">sensitive_match</span><span class="p">:</span>
</span><span id="RepositoryZypper.add_repo-338"><a href="#RepositoryZypper.add_repo-338"><span class="linenos">338</span></a>            <span class="c1"># rewrite baseurl with credentials information because zypper</span>
</span><span id="RepositoryZypper.add_repo-339"><a href="#RepositoryZypper.add_repo-339"><span class="linenos">339</span></a>            <span class="c1"># addrepo does strange things with the provided url encoded data</span>
</span><span id="RepositoryZypper.add_repo-340"><a href="#RepositoryZypper.add_repo-340"><span class="linenos">340</span></a>            <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;baseurl&#39;</span><span class="p">,</span> <span class="n">baseurl</span><span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-341"><a href="#RepositoryZypper.add_repo-341"><span class="linenos">341</span></a>
</span><span id="RepositoryZypper.add_repo-342"><a href="#RepositoryZypper.add_repo-342"><span class="linenos">342</span></a>        <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper.add_repo-343"><a href="#RepositoryZypper.add_repo-343"><span class="linenos">343</span></a>            <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;repo_gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="n">repo_gpgcheck</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
</span><span id="RepositoryZypper.add_repo-344"><a href="#RepositoryZypper.add_repo-344"><span class="linenos">344</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-345"><a href="#RepositoryZypper.add_repo-345"><span class="linenos">345</span></a>        <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper.add_repo-346"><a href="#RepositoryZypper.add_repo-346"><span class="linenos">346</span></a>            <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;pkg_gpgcheck&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="n">pkg_gpgcheck</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
</span><span id="RepositoryZypper.add_repo-347"><a href="#RepositoryZypper.add_repo-347"><span class="linenos">347</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-348"><a href="#RepositoryZypper.add_repo-348"><span class="linenos">348</span></a>        <span class="k">if</span> <span class="n">prio</span><span class="p">:</span>
</span><span id="RepositoryZypper.add_repo-349"><a href="#RepositoryZypper.add_repo-349"><span class="linenos">349</span></a>            <span class="n">repo_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
</span><span id="RepositoryZypper.add_repo-350"><a href="#RepositoryZypper.add_repo-350"><span class="linenos">350</span></a>                <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">prio</span><span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-351"><a href="#RepositoryZypper.add_repo-351"><span class="linenos">351</span></a>            <span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-352"><a href="#RepositoryZypper.add_repo-352"><span class="linenos">352</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">repo_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">repo</span><span class="p">:</span>
</span><span id="RepositoryZypper.add_repo-353"><a href="#RepositoryZypper.add_repo-353"><span class="linenos">353</span></a>            <span class="n">repo_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-354"><a href="#RepositoryZypper.add_repo-354"><span class="linenos">354</span></a>        <span class="k">if</span> <span class="n">customization_script</span><span class="p">:</span>
</span><span id="RepositoryZypper.add_repo-355"><a href="#RepositoryZypper.add_repo-355"><span class="linenos">355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">run_repo_customize</span><span class="p">(</span><span class="n">customization_script</span><span class="p">,</span> <span class="n">repo_file</span><span class="p">)</span>
</span><span id="RepositoryZypper.add_repo-356"><a href="#RepositoryZypper.add_repo-356"><span class="linenos">356</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_package_cache</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Add zypper repository</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str name</strong>:  repository name</li>
<li><strong>str uri</strong>:  repository URI</li>
<li><strong>str repo_type</strong>:  repostory type name</li>
<li><strong>int prio</strong>:  zypper repostory priority</li>
<li><strong>str dist</strong>:  unused</li>
<li><strong>str components</strong>:  unused</li>
<li><strong>str user</strong>:  credentials username</li>
<li><strong>str secret</strong>:  credentials password</li>
<li><strong>str credentials_file</strong>:  zypper credentials file</li>
<li><strong>bool repo_gpgcheck</strong>:  enable repository signature validation</li>
<li><strong>bool pkg_gpgcheck</strong>:  enable package signature validation</li>
<li><strong>str sourcetype</strong>:  unused</li>
<li><strong>str customization_script</strong>: 
custom script called after the repo file was created</li>
<li><strong>str architectures</strong>:  unused</li>
</ul>
</div>


                            </div>
                            <div id="RepositoryZypper.import_trusted_keys" class="classattr">
                                        <input id="RepositoryZypper.import_trusted_keys-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">import_trusted_keys</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">signing_keys</span><span class="p">:</span> <span class="n">List</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="RepositoryZypper.import_trusted_keys-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper.import_trusted_keys"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper.import_trusted_keys-358"><a href="#RepositoryZypper.import_trusted_keys-358"><span class="linenos">358</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_trusted_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signing_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper.import_trusted_keys-359"><a href="#RepositoryZypper.import_trusted_keys-359"><span class="linenos">359</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.import_trusted_keys-360"><a href="#RepositoryZypper.import_trusted_keys-360"><span class="linenos">360</span></a><span class="sd">        Imports trusted keys into the image</span>
</span><span id="RepositoryZypper.import_trusted_keys-361"><a href="#RepositoryZypper.import_trusted_keys-361"><span class="linenos">361</span></a>
</span><span id="RepositoryZypper.import_trusted_keys-362"><a href="#RepositoryZypper.import_trusted_keys-362"><span class="linenos">362</span></a><span class="sd">        :param list signing_keys: list of the key files to import</span>
</span><span id="RepositoryZypper.import_trusted_keys-363"><a href="#RepositoryZypper.import_trusted_keys-363"><span class="linenos">363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.import_trusted_keys-364"><a href="#RepositoryZypper.import_trusted_keys-364"><span class="linenos">364</span></a>        <span class="n">rpmdb</span> <span class="o">=</span> <span class="n">RpmDataBase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span>
</span><span id="RepositoryZypper.import_trusted_keys-365"><a href="#RepositoryZypper.import_trusted_keys-365"><span class="linenos">365</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">signing_keys</span><span class="p">:</span>
</span><span id="RepositoryZypper.import_trusted_keys-366"><a href="#RepositoryZypper.import_trusted_keys-366"><span class="linenos">366</span></a>            <span class="n">rpmdb</span><span class="o">.</span><span class="n">import_signing_key_to_image</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Imports trusted keys into the image</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>list signing_keys</strong>:  list of the key files to import</li>
</ul>
</div>


                            </div>
                            <div id="RepositoryZypper.delete_repo" class="classattr">
                                        <input id="RepositoryZypper.delete_repo-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_repo</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="RepositoryZypper.delete_repo-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper.delete_repo"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper.delete_repo-368"><a href="#RepositoryZypper.delete_repo-368"><span class="linenos">368</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper.delete_repo-369"><a href="#RepositoryZypper.delete_repo-369"><span class="linenos">369</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.delete_repo-370"><a href="#RepositoryZypper.delete_repo-370"><span class="linenos">370</span></a><span class="sd">        Delete zypper repository</span>
</span><span id="RepositoryZypper.delete_repo-371"><a href="#RepositoryZypper.delete_repo-371"><span class="linenos">371</span></a>
</span><span id="RepositoryZypper.delete_repo-372"><a href="#RepositoryZypper.delete_repo-372"><span class="linenos">372</span></a><span class="sd">        :param str name: repository name</span>
</span><span id="RepositoryZypper.delete_repo-373"><a href="#RepositoryZypper.delete_repo-373"><span class="linenos">373</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.delete_repo-374"><a href="#RepositoryZypper.delete_repo-374"><span class="linenos">374</span></a>        <span class="n">Command</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RepositoryZypper.delete_repo-375"><a href="#RepositoryZypper.delete_repo-375"><span class="linenos">375</span></a>            <span class="p">[</span><span class="s1">&#39;zypper&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">zypper_args</span> <span class="o">+</span> <span class="p">[</span>
</span><span id="RepositoryZypper.delete_repo-376"><a href="#RepositoryZypper.delete_repo-376"><span class="linenos">376</span></a>                <span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;removerepo&#39;</span><span class="p">,</span> <span class="n">name</span>
</span><span id="RepositoryZypper.delete_repo-377"><a href="#RepositoryZypper.delete_repo-377"><span class="linenos">377</span></a>            <span class="p">],</span>
</span><span id="RepositoryZypper.delete_repo-378"><a href="#RepositoryZypper.delete_repo-378"><span class="linenos">378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">command_env</span>
</span><span id="RepositoryZypper.delete_repo-379"><a href="#RepositoryZypper.delete_repo-379"><span class="linenos">379</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Delete zypper repository</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str name</strong>:  repository name</li>
</ul>
</div>


                            </div>
                            <div id="RepositoryZypper.delete_all_repos" class="classattr">
                                        <input id="RepositoryZypper.delete_all_repos-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_all_repos</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="RepositoryZypper.delete_all_repos-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper.delete_all_repos"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper.delete_all_repos-381"><a href="#RepositoryZypper.delete_all_repos-381"><span class="linenos">381</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_all_repos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper.delete_all_repos-382"><a href="#RepositoryZypper.delete_all_repos-382"><span class="linenos">382</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.delete_all_repos-383"><a href="#RepositoryZypper.delete_all_repos-383"><span class="linenos">383</span></a><span class="sd">        Delete all zypper repositories</span>
</span><span id="RepositoryZypper.delete_all_repos-384"><a href="#RepositoryZypper.delete_all_repos-384"><span class="linenos">384</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.delete_all_repos-385"><a href="#RepositoryZypper.delete_all_repos-385"><span class="linenos">385</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">])</span>
</span><span id="RepositoryZypper.delete_all_repos-386"><a href="#RepositoryZypper.delete_all_repos-386"><span class="linenos">386</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Delete all zypper repositories</p>
</div>


                            </div>
                            <div id="RepositoryZypper.delete_repo_cache" class="classattr">
                                        <input id="RepositoryZypper.delete_repo_cache-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_repo_cache</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="RepositoryZypper.delete_repo_cache-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper.delete_repo_cache"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper.delete_repo_cache-388"><a href="#RepositoryZypper.delete_repo_cache-388"><span class="linenos">388</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_repo_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper.delete_repo_cache-389"><a href="#RepositoryZypper.delete_repo_cache-389"><span class="linenos">389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.delete_repo_cache-390"><a href="#RepositoryZypper.delete_repo_cache-390"><span class="linenos">390</span></a><span class="sd">        Delete zypper repository cache</span>
</span><span id="RepositoryZypper.delete_repo_cache-391"><a href="#RepositoryZypper.delete_repo_cache-391"><span class="linenos">391</span></a>
</span><span id="RepositoryZypper.delete_repo_cache-392"><a href="#RepositoryZypper.delete_repo_cache-392"><span class="linenos">392</span></a><span class="sd">        The cache data for each repository is stored in a list of</span>
</span><span id="RepositoryZypper.delete_repo_cache-393"><a href="#RepositoryZypper.delete_repo_cache-393"><span class="linenos">393</span></a><span class="sd">        directories of the same name as the repository name. The method</span>
</span><span id="RepositoryZypper.delete_repo_cache-394"><a href="#RepositoryZypper.delete_repo_cache-394"><span class="linenos">394</span></a><span class="sd">        deletes these directories to cleanup the cache information</span>
</span><span id="RepositoryZypper.delete_repo_cache-395"><a href="#RepositoryZypper.delete_repo_cache-395"><span class="linenos">395</span></a>
</span><span id="RepositoryZypper.delete_repo_cache-396"><a href="#RepositoryZypper.delete_repo_cache-396"><span class="linenos">396</span></a><span class="sd">        :param str name: repository name</span>
</span><span id="RepositoryZypper.delete_repo_cache-397"><a href="#RepositoryZypper.delete_repo_cache-397"><span class="linenos">397</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.delete_repo_cache-398"><a href="#RepositoryZypper.delete_repo_cache-398"><span class="linenos">398</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span>
</span><span id="RepositoryZypper.delete_repo_cache-399"><a href="#RepositoryZypper.delete_repo_cache-399"><span class="linenos">399</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;pkg-cache-dir&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">])</span>
</span><span id="RepositoryZypper.delete_repo_cache-400"><a href="#RepositoryZypper.delete_repo_cache-400"><span class="linenos">400</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper.delete_repo_cache-401"><a href="#RepositoryZypper.delete_repo_cache-401"><span class="linenos">401</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span>
</span><span id="RepositoryZypper.delete_repo_cache-402"><a href="#RepositoryZypper.delete_repo_cache-402"><span class="linenos">402</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">])</span>
</span><span id="RepositoryZypper.delete_repo_cache-403"><a href="#RepositoryZypper.delete_repo_cache-403"><span class="linenos">403</span></a>        <span class="p">)</span>
</span><span id="RepositoryZypper.delete_repo_cache-404"><a href="#RepositoryZypper.delete_repo_cache-404"><span class="linenos">404</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span>
</span><span id="RepositoryZypper.delete_repo_cache-405"><a href="#RepositoryZypper.delete_repo_cache-405"><span class="linenos">405</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;raw-cache-dir&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">])</span>
</span><span id="RepositoryZypper.delete_repo_cache-406"><a href="#RepositoryZypper.delete_repo_cache-406"><span class="linenos">406</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Delete zypper repository cache</p>

<p>The cache data for each repository is stored in a list of
directories of the same name as the repository name. The method
deletes these directories to cleanup the cache information</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>str name</strong>:  repository name</li>
</ul>
</div>


                            </div>
                            <div id="RepositoryZypper.cleanup_unused_repos" class="classattr">
                                        <input id="RepositoryZypper.cleanup_unused_repos-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cleanup_unused_repos</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="RepositoryZypper.cleanup_unused_repos-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper.cleanup_unused_repos"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper.cleanup_unused_repos-408"><a href="#RepositoryZypper.cleanup_unused_repos-408"><span class="linenos">408</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_unused_repos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-409"><a href="#RepositoryZypper.cleanup_unused_repos-409"><span class="linenos">409</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-410"><a href="#RepositoryZypper.cleanup_unused_repos-410"><span class="linenos">410</span></a><span class="sd">        Delete unused zypper repositories</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-411"><a href="#RepositoryZypper.cleanup_unused_repos-411"><span class="linenos">411</span></a>
</span><span id="RepositoryZypper.cleanup_unused_repos-412"><a href="#RepositoryZypper.cleanup_unused_repos-412"><span class="linenos">412</span></a><span class="sd">        zypper creates a system solvable which is unwanted for the</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-413"><a href="#RepositoryZypper.cleanup_unused_repos-413"><span class="linenos">413</span></a><span class="sd">        purpose of building images. In addition zypper fails with</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-414"><a href="#RepositoryZypper.cleanup_unused_repos-414"><span class="linenos">414</span></a><span class="sd">        an error message &#39;Failed to cache rpm database&#39; if such a</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-415"><a href="#RepositoryZypper.cleanup_unused_repos-415"><span class="linenos">415</span></a><span class="sd">        system solvable exists and a new root system is created</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-416"><a href="#RepositoryZypper.cleanup_unused_repos-416"><span class="linenos">416</span></a>
</span><span id="RepositoryZypper.cleanup_unused_repos-417"><a href="#RepositoryZypper.cleanup_unused_repos-417"><span class="linenos">417</span></a><span class="sd">        All other repository configurations which are not used for</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-418"><a href="#RepositoryZypper.cleanup_unused_repos-418"><span class="linenos">418</span></a><span class="sd">        this build must be removed too, otherwise they are taken into</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-419"><a href="#RepositoryZypper.cleanup_unused_repos-419"><span class="linenos">419</span></a><span class="sd">        account for the package installations</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-420"><a href="#RepositoryZypper.cleanup_unused_repos-420"><span class="linenos">420</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-421"><a href="#RepositoryZypper.cleanup_unused_repos-421"><span class="linenos">421</span></a>        <span class="n">solv_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;solv-cache-dir&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-422"><a href="#RepositoryZypper.cleanup_unused_repos-422"><span class="linenos">422</span></a>        <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">solv_dir</span> <span class="o">+</span> <span class="s1">&#39;/@System&#39;</span><span class="p">)</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-423"><a href="#RepositoryZypper.cleanup_unused_repos-423"><span class="linenos">423</span></a>
</span><span id="RepositoryZypper.cleanup_unused_repos-424"><a href="#RepositoryZypper.cleanup_unused_repos-424"><span class="linenos">424</span></a>        <span class="n">repos_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_zypper_dir</span><span class="p">[</span><span class="s1">&#39;reposd-dir&#39;</span><span class="p">]</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-425"><a href="#RepositoryZypper.cleanup_unused_repos-425"><span class="linenos">425</span></a>        <span class="n">repo_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">repos_dir</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-426"><a href="#RepositoryZypper.cleanup_unused_repos-426"><span class="linenos">426</span></a>        <span class="k">for</span> <span class="n">repo_file</span> <span class="ow">in</span> <span class="n">repo_files</span><span class="p">:</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-427"><a href="#RepositoryZypper.cleanup_unused_repos-427"><span class="linenos">427</span></a>            <span class="k">if</span> <span class="n">repo_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_names</span><span class="p">:</span>
</span><span id="RepositoryZypper.cleanup_unused_repos-428"><a href="#RepositoryZypper.cleanup_unused_repos-428"><span class="linenos">428</span></a>                <span class="n">Path</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="n">repos_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">repo_file</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Delete unused zypper repositories</p>

<p>zypper creates a system solvable which is unwanted for the
purpose of building images. In addition zypper fails with
an error message 'Failed to cache rpm database' if such a
system solvable exists and a new root system is created</p>

<p>All other repository configurations which are not used for
this build must be removed too, otherwise they are taken into
account for the package installations</p>
</div>


                            </div>
                            <div id="RepositoryZypper.cleanup" class="classattr">
                                        <input id="RepositoryZypper.cleanup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cleanup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="RepositoryZypper.cleanup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RepositoryZypper.cleanup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RepositoryZypper.cleanup-475"><a href="#RepositoryZypper.cleanup-475"><span class="linenos">475</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RepositoryZypper.cleanup-476"><a href="#RepositoryZypper.cleanup-476"><span class="linenos">476</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.cleanup-477"><a href="#RepositoryZypper.cleanup-477"><span class="linenos">477</span></a><span class="sd">        Delete intermediate zypp and zypper config files</span>
</span><span id="RepositoryZypper.cleanup-478"><a href="#RepositoryZypper.cleanup-478"><span class="linenos">478</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RepositoryZypper.cleanup-479"><a href="#RepositoryZypper.cleanup-479"><span class="linenos">479</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
</span><span id="RepositoryZypper.cleanup-480"><a href="#RepositoryZypper.cleanup-480"><span class="linenos">480</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypper_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="RepositoryZypper.cleanup-481"><a href="#RepositoryZypper.cleanup-481"><span class="linenos">481</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
</span><span id="RepositoryZypper.cleanup-482"><a href="#RepositoryZypper.cleanup-482"><span class="linenos">482</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_zypp_config_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Delete intermediate zypp and zypper config files</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="base.html#RepositoryBase">kiwi.repository.base.RepositoryBase</a></dt>
                                <dd id="RepositoryZypper.__init__" class="function"><a href="base.html#RepositoryBase.__init__">RepositoryBase</a></dd>
                <dd id="RepositoryZypper.root_bind" class="variable"><a href="base.html#RepositoryBase.root_bind">root_bind</a></dd>
                <dd id="RepositoryZypper.root_dir" class="variable"><a href="base.html#RepositoryBase.root_dir">root_dir</a></dd>
                <dd id="RepositoryZypper.shared_location" class="variable"><a href="base.html#RepositoryBase.shared_location">shared_location</a></dd>
                <dd id="RepositoryZypper.run_repo_customize" class="function"><a href="base.html#RepositoryBase.run_repo_customize">run_repo_customize</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>